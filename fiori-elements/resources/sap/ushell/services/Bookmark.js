// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ushell/Config","sap/ushell/library","sap/base/util/deepClone","sap/base/util/deepExtend","sap/base/Log"],function(e,r,o,t,a,n){"use strict";var i="sap.ushell.services.Bookmark";var s="X-SAP-UI2-HANA:hana?remoteId=HANA_CATALOG";var u=o.ContentNodeType;function c(){this._oLaunchPageServicePromise=sap.ushell.Container.getServiceAsync("LaunchPage");if(r.last("/core/spaces/enabled")){this._oPagesServicePromise=sap.ushell.Container.getServiceAsync("Pages")}this._addBookmarkToContentNodes=function(e,r,o,t){var a=r.map(function(r){if(r&&r.hasOwnProperty("type")&&r.isContainer){switch(r.type){case u.Page:return this.addBookmarkToPage(e,r.id,t);case u.HomepageGroup:return new Promise(function(e,o){this._oLaunchPageServicePromise.then(function(t){t.getGroupById(r.id).done(e).fail(o)})}.bind(this)).then(function(r){return this.addBookmarkToHomepageGroup(e,r,o,t)}.bind(this));default:return Promise.reject("Bookmark Service: The API needs to be called with a valid content node type. '"+r.type+"' is not supported.")}}return Promise.reject("Bookmark Service: Not a valid content node.")}.bind(this));return Promise.all(a)};this.addBookmark=function(o,t,a){var s=new e.Deferred;var u=r.last("/core/shell/enablePersonalization");var c=r.last("/core/spaces/enabled");var l=r.last("/core/spaces/myHome/enabled");if(!u&&(!c||!l)){return s.resolve().promise()}this._checkBookmarkParameters(o).then(function(){if(typeof t==="undefined"&&c){return sap.ushell.Container.getServiceAsync("Menu").then(function(e){return e.getDefaultSpace()}).then(function(e){var r=e&&e.children&&e.children[0];return r}).then(function(e){return this._addBookmarkToContentNodes(o,[e],false,a)}.bind(this))}if((typeof t==="undefined"||!t.hasOwnProperty("type"))&&!Array.isArray(t)){return this.addBookmarkToHomepageGroup(o,t,false,a)}var e=[].concat(t);return this._addBookmarkToContentNodes(o,e,false,a)}.bind(this)).then(s.resolve).catch(function(e){n.error("Error during Bookmark creation: ",e,i);s.reject(e)});return s.promise()};this.addCustomBookmark=function(e,r,o,n){var i=t(r);var s=a(i,{vizType:e,vizConfig:{"sap.flp":{chipConfig:i.chipConfig},"sap.platform.runtime":{includeManifest:!i.loadManifest}}});delete s.chipConfig;delete s.loadManifest;var u=[].concat(o);return this._addBookmarkToContentNodes(s,u,true,n)};this.addBookmarkToHomepageGroup=function(e,o,t,a){if(r.last("/core/spaces/enabled")){var n="Bookmark Service: The API is not available in spaces mode.";return Promise.reject(n)}return new Promise(function(r,n){this._oLaunchPageServicePromise.then(function(i){var s;if(t){s=i.addCustomBookmark(e,o,a)}else{s=i.addBookmark(e,o,a)}s.done(function(e){var t={tile:e,group:o};sap.ui.getCore().getEventBus().publish("sap.ushell.services.Bookmark","bookmarkTileAdded",t);r()}).fail(n)})}.bind(this))};this.addBookmarkToPage=function(e,o,t){if(!r.last("/core/spaces/enabled")){return Promise.reject("Bookmark Service: 'addBookmarkToPage' is not valid in launchpad homepage mode, use 'addBookmark' instead.")}var a=r.last("/core/shell/enablePersonalization");var n=r.last("/core/spaces/myHome/enabled");var i=r.last("/core/spaces/myHome/myHomePageId");if(!a&&(!n||n&&o!==i)){return Promise.reject("Bookmark Service: Add bookmark is not allowed as the personalization functionality is not enabled.")}if(e&&(typeof e.title!=="string"||typeof e.url!=="string")){return Promise.reject("Bookmark Service - Invalid bookmark data.")}return this._oPagesServicePromise.then(function(r){return r.addBookmarkToPage(o,e,undefined,t)})};this.addBookmarkByGroupId=function(o,t,a){var n=new e.Deferred;if(r.last("/core/spaces/enabled")){var i="Bookmark Service: The API 'addBookmarkByGroupId' is not supported in launchpad spaces mode.";return n.reject(i).promise()}this._oLaunchPageServicePromise.then(function(e){e.getGroups().done(function(e){var r=e.find(function(e){return e.id===t})||null;this.addBookmark(o,r,a).done(n.resolve).fail(n.reject)}.bind(this)).fail(n.reject)}.bind(this)).catch(n.reject);return n.promise()};this.getShellGroupIDs=function(o){var t=new e.Deferred;if(r.last("/core/spaces/enabled")){var a="Bookmark Service: The API 'getShellGroupIDs' is not supported in launchpad spaces mode.";return t.reject(a).promise()}this._oLaunchPageServicePromise.then(function(e){e.getGroupsForBookmarks(o).done(function(r){r=r.map(function(r){return{id:e.getGroupId(r.object),title:r.title}});t.resolve(r)}).fail(t.reject)});return t.promise()};this._doAddCatalogTileToGroup=function(e,r,o,t){this._oLaunchPageServicePromise.then(function(a){if(t){a.getGroups().fail(e.reject).done(function(i){var s=i.some(function(n){if(a.getGroupId(n)===t){this._addToGroup(o,e,r,n);return true}}.bind(this));if(!s){var u="Group '"+t+"' is unknown";n.error(u,null,"sap.ushell.services.Bookmark");e.reject(u)}}.bind(this))}else{a.getDefaultGroup().fail(e.reject).done(function(t){this._addToGroup(o,e,r,t)}.bind(this))}}.bind(this));return e.promise()};this._isSameCatalogTile=function(e,r,o){var t=o.getCatalogTileId(r);if(t===undefined){return false}return t.indexOf(e)===0};this._addToGroup=function(e,r,o,t){return this._oLaunchPageServicePromise.then(function(a){a.getCatalogTiles(e).fail(r.reject).done(function(i){var s=a.getGroupId(t);var u=i.some(function(e){if(this._isSameCatalogTile(o,e,a)){a.addTile(e,t).fail(r.reject).done(function(){r.resolve();sap.ui.getCore().getEventBus().publish("sap.ushell.services.Bookmark","catalogTileAdded",s)});return true}}.bind(this));if(!u){var c="No tile '"+o+"' in catalog '"+a.getCatalogId(e)+"'";n.error(c,null,"sap.ushell.services.Bookmark");r.reject(c)}}.bind(this))}.bind(this))};this.addCatalogTileToGroup=function(o,t,a){var i=new e.Deferred;var u;n.error("Deprecated API call of 'sap.ushell.Bookmark.addCatalogTileToGroup'. Please use 'addBookmark' instead",null,"sap.ushell.services.Bookmark");if(r.last("/core/spaces/enabled")){u="Bookmark Service: The API 'addCatalogTileToGroup' is not supported in launchpad spaces mode.";return i.reject(u).promise()}this._oLaunchPageServicePromise.then(function(e){var r=a?this._isMatchingRemoteCatalog:this._isLegacyHANACatalog;a=a||{id:s};e.onCatalogTileAdded(o);e.getCatalogs().fail(i.reject).done(function(s){var c;s.forEach(function(o){if(r(o,a,e)){if(!c){c=o}else{n.warning("More than one matching catalog: "+JSON.stringify(a),null,"sap.ushell.services.Bookmark")}}});if(c){this._doAddCatalogTileToGroup(i,o,c,t)}else{u="No matching catalog found: "+JSON.stringify(a);n.error(u,null,"sap.ushell.services.Bookmark");i.reject(u)}}.bind(this))}.bind(this));return i.promise()};this._checkBookmarkParameters=function(e){return Promise.resolve().then(function(){if(!e){throw new Error("Invalid Bookmark Data: No bookmark parameters passed.")}var r=e.dataSource;var o;if(r){if(r.type!=="OData"){throw new Error("Invalid Bookmark Data: Unknown data source type: "+r.type)}o=r.settings&&r.settings.odataVersion;var t=["2.0","4.0"];if(!t.includes(o)){throw new Error("Invalid Bookmark Data: Unknown OData version in the data source: "+o)}}if(e.serviceUrl){return sap.ushell.Container.getServiceAsync("ReferenceResolver").then(function(o){if(o.hasSemanticDateRanges(e.serviceUrl)&&!r){throw new Error("Invalid Bookmark Data: Provide a data source to use semantic date ranges.")}})}})};this._isMatchingRemoteCatalog=function(e,r,o){var t=o.getCatalogData(e);return t.remoteId===r.remoteId&&t.baseUrl.replace(/\/$/,"")===r.baseUrl.replace(/\/$/,"")};this._isLegacyHANACatalog=function(e,r,o){return o.getCatalogId(e)===s};this.countBookmarks=function(o,t){var a=new e.Deferred;if(r.last("/core/spaces/enabled")){this._oPagesServicePromise.then(function(e){return e.countBookmarks({url:o,contentProviderId:t})}).then(a.resolve,a.reject)}else{this._oLaunchPageServicePromise.then(function(e){e.countBookmarks(o,t).done(a.resolve).fail(a.reject)})}return a.promise()};this.countCustomBookmarks=function(e){if(!e||!e.url||!e.vizType){return Promise.reject("countCustomBookmarks: Some required parameters are missing.")}if(r.last("/core/spaces/enabled")){return this._oPagesServicePromise.then(function(r){return r.countBookmarks(e)})}return this._oLaunchPageServicePromise.then(function(r){return r.countCustomBookmarks(e)})};this.deleteBookmarks=function(o,t){var a=new e.Deferred;if(r.last("/core/spaces/enabled")){this._oPagesServicePromise.then(function(e){return e.deleteBookmarks({url:o,contentProviderId:t})}).then(a.resolve,a.reject)}else{this._oLaunchPageServicePromise.then(function(e){e.deleteBookmarks(o,t).done(function(e){sap.ui.getCore().getEventBus().publish("sap.ushell.services.Bookmark","bookmarkTileDeleted",o);a.resolve(e)}).fail(a.reject)})}return a.promise()};this.deleteCustomBookmarks=function(e){if(!e||!e.url||!e.vizType){return Promise.reject("deleteCustomBookmarks: Some required parameters are missing.")}if(r.last("/core/spaces/enabled")){return this._oPagesServicePromise.then(function(r){return r.deleteBookmarks(e)})}return this._oLaunchPageServicePromise.then(function(r){return r.deleteCustomBookmarks(e)}).then(function(){sap.ui.getCore().getEventBus().publish("sap.ushell.services.Bookmark","bookmarkTileDeleted",e.url)})};this.updateBookmarks=function(o,t,a){var n=new e.Deferred;if(r.last("/core/spaces/enabled")){this._oPagesServicePromise.then(function(e){return e.updateBookmarks({url:o,contentProviderId:a},t)}).then(n.resolve,n.reject)}else{this._oLaunchPageServicePromise.then(function(e){e.updateBookmarks(o,t,a).done(n.resolve).fail(n.reject)})}return n.promise()};this.updateCustomBookmarks=function(e,o){if(!e||!e.url||!e.vizType){return Promise.reject("deleteCustomBookmarks: Some required parameters are missing.")}var t=a({},o,{vizConfig:{"sap.flp":{chipConfig:o.chipConfig},"sap.platform.runtime":{includeManifest:!o.loadManifest}}});delete t.chipConfig;delete t.loadManifest;if(r.last("/core/spaces/enabled")){return this._oPagesServicePromise.then(function(r){return r.updateBookmarks(e,t)})}return this._oLaunchPageServicePromise.then(function(r){return r.updateCustomBookmarks(e,t)})};this.getContentNodes=function(){if(r.last("/core/spaces/enabled")){return sap.ushell.Container.getServiceAsync("Menu").then(function(e){return e.getContentNodes()})}return new Promise(function(e,r){this._oLaunchPageServicePromise.then(function(o){o.getGroupsForBookmarks().done(function(r){var t=r.map(function(e){return{id:o.getGroupId(e.object),label:e.title,type:u.HomepageGroup,isContainer:true}});e(t)}).fail(r)})}.bind(this))}}c.hasNoAdapter=true;return c},true);