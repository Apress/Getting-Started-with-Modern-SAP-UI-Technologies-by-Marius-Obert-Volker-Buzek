// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/thirdparty/jquery","sap/ushell/components/applicationIntegration/application/PostMessageAPIInterface","sap/ushell/services/_PluginManager/Extensions","sap/ushell/UI5ComponentType","sap/ushell/utils"],function(e,n,i,t,o,r){"use strict";var a="sap.ushell.services.PluginManager";var s="sap-ushell-plugin-type";var l="RendererExtensions";var u="sap.ushell.components.shell.defaults";var g=[l,"UserDefaults","UserImage","AppWarmup"];function c(c,f,p){var d=this;this._oPluginCollection={};this._oCategoryLoadingProgress={};this._mInitializedComponentPromise={};this._sPluginAgentsNames="";this._oConfig=p&&p.config||{};if(this._oConfig.isBlueBox===undefined){this._oConfig.isBlueBox=false}g.forEach(function(e){d._oPluginCollection[e]={};d._oCategoryLoadingProgress[e]=new n.Deferred});this._handlePluginCreation=function(n,i,t,o){var s=this,l=s._oPluginCollection[n][i];r.setPerformanceMark("FLP -- PluginManager.loadPlugin["+n+"]["+i+"]");try{if(l.hasOwnProperty("component")){if(s._mInitializedComponentPromise.hasOwnProperty(l.component)){s._mInitializedComponentPromise[l.component].then(function(){s._instantiateComponent(l,t,o)},function(){s._instantiateComponent(l,t,o)})}else{s._mInitializedComponentPromise[l.component]=s._instantiateComponent(l,t,o)}}else{e.error("Invalid plugin configuration. The plugin "+i+" must contain a <component> key",a)}}catch(n){e.error("Error while loading bootstrap plugin: "+l.component||"",a);if(t){t.reject(n)}}};this._getFileNameForXhrAuth=function(){return"Component-preload.js"};this._handleXhrAuthentication=function(i,t){var o;if(i&&["true",true,"X"].indexOf(i["sap-ushell-xhr-authentication"])>-1){if(!t){e.error(["Illegal state: configuration parameter 'sap-ushell-xhr-authentication-timeout' set, but no component URL specified.","XHR authentication request will not be sent. Please check the target mapping definitions for plug-ins","and the application index."].join(" "),undefined,a);return n.when()}if(i.hasOwnProperty("sap-ushell-xhr-authentication-timeout")){o=parseInt(i["sap-ushell-xhr-authentication-timeout"],10);if(isNaN(o)){e.error(["Invalid value for configuration parameter 'sap-ushell-xhr-authentication-timeout' for plug-in component with URL '",t,"': '",i["sap-ushell-xhr-authentication-timeout"],"' is not a number. Timeout will be ignored."].join(""),undefined,a)}else{sap.ushell.Container.setXhrLogonTimeout(t,o)}}return n.ajax(t+"/"+this._getFileNameForXhrAuth(),{dataType:"text"})}return n.when()};this._instantiateComponent=function(i,r,s){var l=new n.Deferred,u=JSON.parse(JSON.stringify(i)),g={ui5ComponentName:u.component,url:u.url,getExtensions:t.bind(null,i.component)};function c(n){return function(i){n=n||"Cannot create UI5 plugin component: (componentId/appdescrId :"+g.ui5ComponentName+")\n"+i+" properties "+JSON.stringify(g)+"\n This indicates a plugin misconfiguration, see e.g. Note 2316443.";i=i||"";e.error(n,i.stack,a);if(r){r.reject.apply(this,arguments)}l.reject.apply(this,arguments)}}u.name=u.component;delete u.component;g.applicationDependencies=u;if(u.config){g.applicationConfiguration=u.config;delete u.config}g.loadDefaultDependencies=false;if(s!==undefined){g.oPostMessageInterface=s}sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(e){this._handleXhrAuthentication(g.applicationConfiguration,u.url).done(function(){e.createComponent(g,{},[],o.Plugin).done(function(e){if(r){r.resolve(e)}l.resolve.apply(this,arguments)}).fail(c())}).fail(c("XHR logon for FLP plugin failed"))}.bind(this)).catch(c());return l.promise()};this.getSupportedPluginCategories=function(){return JSON.parse(JSON.stringify(g))};this.getRegisteredPlugins=function(){return JSON.parse(JSON.stringify(this._oPluginCollection))};this.registerPlugins=function(n){var i=this,t,o,r,u=[],c,f;if(!n){return}if(this._oConfig.isBlueBox===true){c=new URLSearchParams(window.location.search).get("sap-plugins");if(c&&c.length>0){c=","+c+","}else{c=undefined}}Object.keys(n).sort().forEach(function(p){t=n[p]||{};o=t.config||{};r=o[s]||"";if(t.enabled===false){return}if(!i._isFormFactorSupported(t)){e.info("Plugin '"+p+"' filtered from result: form factor not supported");return}if(i._oConfig.isBlueBox===true){if(t.config&&t.config["sap-plugin-agent"]===true){f=t.config["sap-plugin-agent-id"]||p;if(c){if(c.indexOf(","+f+",")<0){return}}else{return}}}if(t.enabled===undefined){t.enabled=true}if(t.hasOwnProperty("module")){var d=(t.module||"").replace(/\./g,"/");e.error("Plugin "+p+" cannot get registered, because the module mechanism for plugins is not valid anymore. Plugins need to be defined as SAPUI5 components.",a);try{sap.ui.requireSync(d)}catch(n){e.error("Plugin module "+d+" is not found.")}return}if(o&&o.hasOwnProperty(s)){if(g&&Array.prototype.indexOf.call(g,r)!==-1){if(u.indexOf(r)===-1){u.push(r)}i._oPluginCollection[r][p]=JSON.parse(JSON.stringify(t))}else{e.warning("Plugin "+p+" will not be inserted into the plugin collection of the PluginManager, because of unsupported category "+r,a)}}else{i._oPluginCollection[l][p]=JSON.parse(JSON.stringify(t));if(u.indexOf(l)===-1){u.push(l)}}});try{if(i._oConfig.isBlueBox!==true){i._buildNamesOfPluginsWithAgents()}}catch(n){e.error("failed to build plugin agents names list",n.message||n.toString(),"sap.ushell.services.PluginManager")}u.forEach(function(e){if(i._oCategoryLoadingProgress.hasOwnProperty(e)&&i._oCategoryLoadingProgress[e].state()==="resolved"){i.loadPlugins(e)}})};this._isFormFactorSupported=function(e){var n=e.deviceTypes,i=r.getFormFactor();if(n&&n[i]===false){return false}return true};this.getPluginLoadingPromise=function(e){if(this._oCategoryLoadingProgress.hasOwnProperty(e)){return this._oCategoryLoadingProgress[e].promise()}};this.loadPlugins=function(t){var o=this,s,c,f,p;r.setPerformanceMark("FLP -- PluginManager.startLoadPlugins["+t+"]");if(t===l){p=i.getInterface()}if(g&&Array.prototype.indexOf.call(g,t)!==-1){if(o._oCategoryLoadingProgress[t].pluginLoadingTriggered===undefined){o._oCategoryLoadingProgress[t].pluginLoadingTriggered=true}if(Object.keys(o._oPluginCollection[t]).length>0){s=[];f=Object.keys(o._oPluginCollection[t]);if(new URLSearchParams(window.location.search).get("sap-ushell-xx-pluginmode")==="discard"&&(t==="RendererExtensions"||t==="AppWarmup")){f=f.filter(function(e){return o._oPluginCollection[t][e].component===u})}f.forEach(function(e){var i=o._oPluginCollection[t][e];if(!i.loaded){i.loaded=true;c=new n.Deferred;s.push(c.promise());o._handlePluginCreation(t,e,c,p)}});if(s.length>0){n.when.apply(undefined,s).done(function(){r.setPerformanceMark("FLP -- PluginManager.endLoadPlugins["+t+"]");o._oCategoryLoadingProgress[t].resolve()}).fail(o._oCategoryLoadingProgress[t].reject.bind())}}else{o._oCategoryLoadingProgress[t].resolve()}}else{e.error("Plugins with category "+t+" cannot be loaded by the PluginManager",a);o._oCategoryLoadingProgress[t].reject("Plugins with category "+t+" cannot be loaded by the PluginManager")}return o._oCategoryLoadingProgress[t].promise()};this._buildNamesOfPluginsWithAgents=function(){var e=this,n="",i;Object.keys(e._oPluginCollection).forEach(function(t){Object.keys(e._oPluginCollection[t]).forEach(function(o){i=e._oPluginCollection[t][o];if(i&&i.enabled&&i.enabled===true){if(i.config&&i.config["sap-plugin-agent"]===true){n+=(i.config["sap-plugin-agent-id"]||o)+","}}})});if(n.endsWith(",")){n=n.slice(0,-1)}this._sPluginAgentsNames=n};this._getNamesOfPluginsWithAgents=function(){return this._sPluginAgentsNames}}c.hasNoAdapter=true;return c},true);