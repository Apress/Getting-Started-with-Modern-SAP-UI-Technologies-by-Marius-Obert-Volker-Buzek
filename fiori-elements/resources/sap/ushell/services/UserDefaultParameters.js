// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepEqual","sap/base/util/deepExtend","sap/base/util/isEmptyObject","sap/ui/base/EventProvider","sap/ui/thirdparty/jquery","sap/ushell/utils"],function(e,t,a,n,r,i,s){"use strict";var o="valueStored";var u=["value","noEdit","noStore","extendedValue","alwaysAskPlugin"];function l(l,f,d,c){this._aPlugins=[];this._oUserDefaultParametersNames={};this._oWasParameterPersisted={};var h=this;var m=new r;function v(e){var t=typeof e.getComponentData==="function"&&e.getComponentData()&&e.getComponentData().config&&e.getComponentData().config["sap-priority"]||0;if(typeof t!=="number"||isNaN(t)){return 0}return t}this._insertPluginOrdered=function(e,t){var a=v(t),n,r;for(n=0;n<e.length&&t;++n){r=v(e[n]);if(t&&a>r){e.splice(n,0,t);t=undefined}}if(t){e.push(t)}return e};this.registerPlugin=function(e){this._aPlugins=this._insertPluginOrdered(this._aPlugins,e)};this._getUserDefaultValueFromPlugin=function(t,a,n,r){var i;if(typeof t.getUserDefault==="function"){i=new Promise(function(i,s){t.getUserDefault(a,r,n).done(function(s){var o=s||r;var u=this._getComponentNameOfPlugin(t);e.debug('[UserDefaults] Fetched "'+a+'" for SystemContext='+n.id+" from Plugin="+u,JSON.stringify(o,null,2));i(o)}.bind(this)).fail(function(){e.error('invocation of getUserDefault("'+a+'") for plugin '+h._getComponentNameOfPlugin(t)+" rejected.",null,"sap.ushell.services.UserDefaultParameters");i(r)})}.bind(this))}else{i=Promise.resolve(r)}return i};this._iterateOverPluginsToGetDefaultValue=function(t,a,n,r){return new Promise(function(i,s){r.loadPlugins("UserDefaults").done(function(){var e=this._aPlugins.reduce(function(e,a){var r=e.then(this._getUserDefaultValueFromPlugin.bind(this,a,t,n));return r}.bind(this),Promise.resolve(a));e.then(i)}.bind(this)).fail(function(){e.error("Cannot get value for "+t+". One or more plugins could not be loaded.");s("Initialization of plugins failed")})}.bind(this))};this._getStoreDate=function(){return(new Date).toString()};this._storeValue=function(e,t,a,n){if(a&&t.extendedValue){return sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(r){return new Promise(function(i){r.getUserDefaultParameterNames(n).done(function(r){var s=this._extractKeyArrays(r);var o=s.extended.indexOf(e)<0;this._saveParameterValue(e,t,a,o,n).then(i)}.bind(this)).fail(function(){this._saveParameterValue(e,t,a,false,n).then(i)}.bind(this))}.bind(this))}.bind(this))}return this._saveParameterValue(e,t,a,false,n)};this._saveParameterValue=function(e,t,n,r,i){if(r){t.extendedValue=undefined}if(n&&this._valueIsEmpty(t)){t=undefined;this._oWasParameterPersisted[e]=false}else{t._shellData=a({storeDate:this._getStoreDate()},t._shellData)}return sap.ushell.Container.getServiceAsync("UserDefaultParameterPersistence").then(function(a){return new Promise(function(n){a.saveParameterValue(e,t,i).always(function(){var a={parameterName:e,parameterValue:s.clone(t||{}),systemContext:i};m.fireEvent(o,a);n(e)})})})};this._getPersistedValue=function(e,t){return new Promise(function(a,n){sap.ushell.Container.getServiceAsync("UserDefaultParameterPersistence").then(function(r){r.loadParameterValue(e,t).done(a).fail(n)})})};this._valueIsEmpty=function(e){return!e||!e.value&&!e.extendedValue};this._haveSameMembersValue=function(e,a,n){return n.every(function(n){return e[n]===a[n]||t(e[n],a[n])})};this._getUserDefaultParameterNames=function(e){if(!this._oUserDefaultParametersNames[e.id]){this._oUserDefaultParametersNames[e.id]=new Promise(function(t){sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(a){a.getUserDefaultParameterNames(e).done(function(e){var a=this._extractKeyArrays(e);var n=a.extended;var r=a.allParameters;var i=this._arrayToObject(r);t({aAllParameterNames:r,aExtendedParameterNames:n,oMetadataObject:i})}.bind(this))}.bind(this))}.bind(this))}return this._oUserDefaultParametersNames[e.id]};this._isRelevantParameter=function(e,t){return this._getUserDefaultParameterNames(t).then(function(t){if(!t.aAllParameterNames||t.aAllParameterNames.indexOf(e)===-1){throw new Error('The given parameter "'+e+'" is not part of the list of parameters for the given system context.')}})};this.hasRelevantMaintainableParameters=function(e){var t=false;var a=[];return new Promise(function(r){this._getUserDefaultParameterNames(e).then(function(s){if(!n(s)&&s.aAllParameterNames){s.aAllParameterNames.forEach(function(n){var r=this.getValue(n,e);a.push(r);r.done(function(e){if(e&&!e.hasOwnProperty("noEdit")){t=true}})}.bind(this));i.when.apply(undefined,a).done(function(){r(t)}).fail(function(){r()})}else{r()}}.bind(this))}.bind(this))};this.getValue=function(e,t){var a=new i.Deferred;this._isRelevantParameter(e,t).then(function(){return this._getPersistedValue(e,t).then(function(t){this._oWasParameterPersisted[e]=true;return t||{}}.bind(this)).catch(function(){return{value:undefined}})}.bind(this)).then(function(e){var t=s.clone(e);var n=!e._shellData&&this._valueIsEmpty(e)||e.noStore||e.alwaysAskPlugin;if(!n){a.resolve(e);return}return Promise.all([t,e,sap.ushell.Container.getServiceAsync("PluginManager")])}.bind(this)).then(function(n){var r=n[0];var i=n[1];var s=n[2];return this._iterateOverPluginsToGetDefaultValue(e,i,t,s).then(function(n){if(!this._oWasParameterPersisted[e]||!this._haveSameMembersValue(r,n,u)){this._oWasParameterPersisted[e]=true;this._storeValue(e,n,false,t).then(function(){a.resolve(n)})}else{a.resolve(n)}}.bind(this)).catch(a.reject)}.bind(this)).catch(function(){a.resolve({value:undefined})});return a.promise()};this._addParameterValuesToParameters=function(e,t,a){var n=new i.Deferred;var r=[];t.forEach(function(t){var n=this.getValue(t,a);r.push(n);n.done(function(a){e[t].valueObject=a})}.bind(this));i.when.apply(i,r).done(n.resolve.bind(n,e)).fail(n.reject.bind(n,e));return n.promise()};this._arrayToObject=function(e){var t={};e.forEach(function(e){t[e]={}});return t};this._getComponentNameOfPlugin=function(e){try{return e.getMetadata().getComponentName()||""}catch(e){return"'name of plugin could not be determined'"}};this._getEditorDataAndValue=function(t,n,r,s,o){var u=this;var l=[];var f=[];this._aPlugins.forEach(function(t){if(typeof t.getEditorMetadata==="function"){var a=new i.Deferred;l.push(a);try{var n=l.length-1;t.getEditorMetadata(s,o).done(function(e){f[n]=e}).always(a.resolve).fail(function(){e.error("EditorMetadata for plugin "+u._getComponentNameOfPlugin(t)+"cannot be invoked.",null,"sap.ushell.services.UserDefaultParameters");a.resolve()})}catch(t){e.error("Error invoking getEditorMetaData on plugin: "+t+t.stack,null,"sap.ushell.services.UserDefaultParameters");a.resolve()}}});i.when.apply(i,l).done(function(){var i=[];var l=f.reverse().reduce(function(e,t){n.forEach(function(a){if(t[a]&&t[a].editorMetadata){e[a].editorMetadata=t[a].editorMetadata}});return e},s);n.forEach(function(e){if(!(l[e]&&l[e].editorMetadata)){i.push(e)}});u._addParameterValuesToParameters(l,n,o).done(function(n){var s=a({},n),o;r.forEach(function(e){if(s[e]){s[e].editorMetadata=s[e].editorMetadata||{};s[e].editorMetadata.extendedUsage=true}});o=Object.keys(s).splice(0);o.forEach(function(e){var t;if(s[e].valueObject&&s[e].valueObject.noEdit===true){delete s[e];t=i.indexOf(e);if(t>=0){i.splice(t,1)}}});if(i.length>0){e.error('The following parameter names have no editor metadata and thus likely no configured plugin:\n"'+i.join('",\n"')+'".')}t.resolve(s)}).fail(t.reject.bind(t))})};this.editorGetParameters=function(t){var a=new i.Deferred;Promise.all([sap.ushell.Container.getServiceAsync("PluginManager"),this._getUserDefaultParameterNames(t)]).then(function(n){var r=n[0];var i=n[1];if(i.oMetadataObject.length===0){a.resolve({})}else{r.loadPlugins("UserDefaults").done(function(){this._getEditorDataAndValue(a,i.aAllParameterNames,i.aExtendedParameterNames,i.oMetadataObject,t)}.bind(this)).fail(function(){e.error("One or more plugins could not be loaded");a.reject("Initialization of plugins failed")})}}.bind(this));return a.promise()};this._extractKeyArrays=function(e){var t={simple:e&&e.simple&&Object.keys(e.simple).sort()||[],extended:e&&e.extended&&Object.keys(e.extended).sort()||[]};var a=t.extended.filter(function(e){return t.simple.indexOf(e)<0});t.allParameters=t.simple.concat(a).sort();return t};this.editorSetValue=function(e,t,a){var n=new i.Deferred;this._storeValue(e,t,true,a).then(n.resolve);return n.promise()};this.attachValueStored=function(e){m.attachEvent(o,e)};this.detachValueStored=function(e){m.detachEvent(o,e)}}l.hasNoAdapter=true;return l},true);