// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ushell/utils","sap/ushell/services/AppConfiguration","sap/base/Log","sap/ushell/utils/UrlParsing"],function(e,t,r,n,a){"use strict";function i(e,t,r){this._oServiceConfig=r;this._oCrossAppNavigationServicePromise=sap.ushell.Container.getServiceAsync("CrossApplicationNavigation");this._oPersonalizationServicePromise=sap.ushell.Container.getServiceAsync("Personalization");this._oHashCodeCache={"":0}}i.STATISTIC_COLLECTION_WINDOW_DAYS=90;i.PERS_CONTAINER_KEY_PREFIX="ushell.smartnav.";i.ONE_DAY_IN_MILLISECOND=24*60*60*1e3;i.prototype.getLinks=function(t){var a=new e.Deferred;n.error("Call to deprecated service: 'SmartNavigation.getLinks'. Please use 'CrossApplicationNavigation.getLinks' instead",null,"sap.ushell.services.SmartNavigation");this._oCrossAppNavigationServicePromise.then(function(i){var o=i.getLinks(t);if(!this._isTrackingEnabled(this._oServiceConfig)){o.done(a.resolve).fail(a.reject);return}var s=r.getCurrentApplication();var l=s.sShellHash;var c=s.componentHandle;if(s.componentHandle){c=s.componentHandle.getInstance()}if(!l){n.warning("Call to SmartNavigation#getLinks() simply delegated to CrossApplicationNavigation#getLinks()"+" because AppConfiguration#getCurrentApplication()#sShellHash evaluates to undefined.");o.done(a.resolve).fail(a.reject);return}var u=this._getNavigationOccurrences(l,c);e.when(o,u).done(function(e,t){if(t.length===0){a.resolve(e);return}var r=this._prepareLinksForSorting(e,t);e=r.sort(function(e,t){return t.clickCount-e.clickCount});a.resolve(e)}.bind(this)).fail(a.reject)}.bind(this)).catch(a.reject);return a.promise()};i.prototype.toExternal=function(e){var t=arguments;n.error("Call to deprecated service: 'SmartNavigation.toExternal'. Please use 'CrossApplicationNavigation.toExternal' instead",null,"sap.ushell.services.SmartNavigation");this._oCrossAppNavigationServicePromise.then(function(a){if(!this._isTrackingEnabled(this._oServiceConfig)){a.toExternal.apply(a,t);return}var i=r.getCurrentApplication();var o=i.sShellHash;var s=i.componentHandle;if(i.componentHandle){s=i.componentHandle.getInstance()}if(!o){n.warning("Current shell hash could not be identified. Navigation will not be tracked.",null,"sap.ushell.services.SmartNavigation");a.toExternal.apply(a,t);return}var l=this._getHashFromOArgs(e.target);if(!l){n.warning("Destination hash does not conform with the ushell guidelines. Navigation will not be tracked.",null,"sap.ushell.services.SmartNavigation");a.toExternal.apply(a,t);return}this._recordNavigationOccurrences(o,l,s).then(function(){a.toExternal.apply(a,t)})}.bind(this))};i.prototype.hrefForExternal=function(){n.error("Deprecated API call of 'sap.ushell.services.SmartNavigation.hrefForExternal'. Please use 'hrefForExternalAsync' instead.",null,"sap.ushell.services.SmartNavigation");var e=sap.ushell.Container.getService("CrossApplicationNavigation");return e.hrefForExternal.apply(e,arguments)};i.prototype.hrefForExternalAsync=function(){var e=arguments;n.error("Call to deprecated service: 'SmartNavigation.hrefForExternalAsync'. Please use 'CrossApplicationNavigation.hrefForExternalAsync' instead",null,"sap.ushell.services.SmartNavigation");return this._oCrossAppNavigationServicePromise.then(function(t){return t.hrefForExternalAsync.apply(t,e)})};i.prototype.getPrimaryIntent=function(){var t=new e.Deferred;var r=arguments;n.error("Call to deprecated service: 'SmartNavigation.getPrimaryIntent'. Please use 'CrossApplicationNavigation.getPrimaryIntent' instead",null,"sap.ushell.services.SmartNavigation");this._oCrossAppNavigationServicePromise.then(function(e){e.getPrimaryIntent.apply(e,r).done(t.resolve).fail(t.reject)}).catch(t.reject);return t.promise()};i.prototype.trackNavigation=function(t){n.error("Call to deprecated service: 'SmartNavigation.trackNavigation'.",null,"sap.ushell.services.SmartNavigation");if(!this._isTrackingEnabled(this._oServiceConfig)){n.debug("Call to SmartNavigation#trackNavigation() ignored because Service is not enabled via Configuration",null,"sap.ushell.services.SmartNavigation");return e.when(null)}var a=t.target;var i=r.getCurrentApplication();var o=i.sShellHash;var s;if(!o){n.warning("Call to SmartNavigation#trackNavigation() simply ignored"+" because AppConfiguration#getCurrentApplication()#sShellHash evaluates to undefined.");return e.when(null)}s=this._getHashFromOArgs(a);if(!s){n.warning("Navigation not tracked - no valid destination provided",null,"sap.ushell.services.SmartNavigation");return e.when(null)}n.debug("Navigation to "+s+" was tracked out of "+o,null,"sap.ushell.services.SmartNavigation");return this._recordNavigationOccurrences(o,s,i.componentHandle.getInstance())};i.prototype._isTrackingEnabled=function(e){return t.isDefined(e)&&t.isDefined(e.config)&&t.isDefined(e.config.isTrackingEnabled)?e.config.isTrackingEnabled:false};i.prototype._getHashCode=function(e){var t=e+"";if(this._oHashCodeCache[t]){return this._oHashCodeCache[t]}var r=0;var n=t.length;while(n--){r=(r<<5)-r+(t.charCodeAt(n)|0);r|=0}this._oHashCodeCache[t]=r;return r};i.prototype._getBaseHashPart=function(e){var t=a.parseShellHash(e);if(t&&t.semanticObject&&t.action){return t.semanticObject+"-"+t.action}throw"Invalid intent `"+e+"`"};i.prototype._getHashFromOArgs=function(e){if(!e){return null}if(e.shellHash&&a.parseShellHash(e.shellHash)){return this._getBaseHashPart(e.shellHash)}if(e.semanticObject&&e.action){return e.semanticObject+"-"+e.action}return null};i.prototype._getPersContainerKey=function(e){return i.PERS_CONTAINER_KEY_PREFIX+this._getHashCode(e)};i.prototype._getNavigationOccurrences=function(t,r){var n=new e.Deferred;var a=this._getPersContainerKey(t);this._oPersonalizationServicePromise.then(function(e){var t=e.getContainer(a,{keyCategory:e.constants.keyCategory.FIXED_KEY,writeFrequency:e.constants.writeFrequency.HIGH,clientStorageAllowed:true},r);t.done(function(e){var t=e.getItemKeys();var r=t.map(function(t){var r=e.getItemValue(t);var n=Object.keys(r.actions);return n.map(function(e){var n=r.actions[e];var a=n.dailyFrequency.reduce(function(e,t){return e+t},0);return{intent:t+"-"+e,clickCount:a}})});var a=r.reduce(function(e,t){Array.prototype.push.apply(e,t);return e},[]);n.resolve(a)})}).catch(n.reject);return n.promise()};i.prototype._prepareLinksForSorting=function(e,t){var r={};t.forEach(function(e){r[e.intent]=e});e.forEach(function(e){var t=this._getBaseHashPart(e.intent);var n=r[t];e.clickCount=n?n.clickCount:0}.bind(this));return e};i.prototype._recordNavigationOccurrences=function(t,r,n){var i=a.parseShellHash(r);var o=this._getPersContainerKey(t);var s=i.semanticObject;var l=new e.Deferred;this._oPersonalizationServicePromise.then(function(e){var t=e.getContainer(o,{keyCategory:e.constants.keyCategory.FIXED_KEY,writeFrequency:e.constants.writeFrequency.HIGH,clientStorageAllowed:true},n);t.done(function(e){var t=e.getItemValue(s);var r=i.action;if(!t){t={actions:{},latestVisit:Date.now(),dailyFrequency:[0]}}var n=t.actions[r];if(!n){n={latestVisit:Date.now(),dailyFrequency:[0]};t.actions[r]=n}this._updateHistoryEntryWithCurrentUsage(t);this._updateHistoryEntryWithCurrentUsage(n);e.setItemValue(s,t);e.save().done(l.resolve).fail(l.reject)}.bind(this)).fail(l.reject)}.bind(this)).catch(l.reject);return l.promise()};i.prototype._updateHistoryEntryWithCurrentUsage=function(e){var t=Date.now();var r=t-e.latestVisit;var n=Math.floor(r/i.ONE_DAY_IN_MILLISECOND);while(n--){e.dailyFrequency.unshift(0);if(e.dailyFrequency.length>i.STATISTIC_COLLECTION_WINDOW_DAYS){e.dailyFrequency.pop()}}++e.dailyFrequency[0];e.latestVisit=t;return e};i.hasNoAdapter=true;return i});