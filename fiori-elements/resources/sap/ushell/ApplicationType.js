// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend","sap/base/util/ObjectPath","sap/ui/core/Configuration","sap/ui/core/routing/History","sap/ui/thirdparty/URI","sap/ushell/_ApplicationType/guiResolution","sap/ushell/_ApplicationType/systemAlias","sap/ushell/_ApplicationType/utils","sap/ushell/_ApplicationType/wdaResolution","sap/ushell/Config","sap/ushell/URLTemplateProcessor","sap/ushell/User","sap/ushell/utils","sap/ui/thirdparty/hasher"],function(e,t,a,n,r,s,i,o,p,l,u,c,f,d,m){"use strict";var h=new s(document.URL).search(true)["iframe-url"];function y(e,t,a){var n=e.inbound;var r=n&&n.resolutionResult;var s;if(n&&r){if(r["sap.wda"]){s=l.constructFullWDAResolutionResult(e,t,a)}else{s=l.constructWDAResolutionResult(e,t,a)}}if(s){s.then(function(t){M(e,t);return t})}return s}function v(e,t,a){return i.generateTRResolutionResult(e,t,a).then(function(t){M(e,t);return t})}function g(e,a,n){var r=new s(a);var i=e.inbound;var l=i&&i.resolutionResult;var u=t({},e.mappedIntentParamsPlusSimpleDefaults);var c;var f;if(u["sap-system"]){c=u["sap-system"][0];delete u["sap-system"]}if(u["sap-system-src"]){f=u["sap-system-src"][0];delete u["sap-system-src"]}return new Promise(function(t,a){o.spliceSapSystemIntoURI(r,l.systemAlias,c,f,"WCF",l.systemAliasSemantics||o.SYSTEM_ALIAS_SEMANTICS.applied,n).done(function(a){var n=p.getURLParsing().paramsToString(u),r=p.appendParametersToUrl(n,a.toString());var s={url:r,text:l.text||"",additionalInformation:l.additionalInformation||"",applicationType:"WCF",fullWidth:true};M(e,s);C(s,"WCF");t(s)}).fail(function(e){a(e)})})}function P(a,n,r){var s=a.inbound;var i={};["applicationType","additionalInformation","applicationDependencies"].forEach(function(e){if(s.resolutionResult.hasOwnProperty(e)){i[e]=s.resolutionResult[e]}});i.url=n;if(i.applicationDependencies&&typeof i.url==="undefined"){i.url=""}if(typeof i.url==="undefined"){i.url="";e.warning("The component url is undefined. We set it to empty string avoid rejection of the promise")}var o=t({},a.mappedIntentParamsPlusSimpleDefaults);i.reservedParameters={};var l={"sap-ui-fl-max-layer":true,"sap-ui-fl-control-variant-id":true,"sap-ui-fl-version":true};Object.keys(l).forEach(function(e){var t=o[e];if(t){delete o[e];i.reservedParameters[e]=t}});a.mappedDefaultedParamNames=a.mappedDefaultedParamNames.filter(function(e){return!l[e]});if(a.mappedDefaultedParamNames.length>0){o["sap-ushell-defaultedParameterNames"]=[JSON.stringify(a.mappedDefaultedParamNames)]}var u=o["sap-system"]&&o["sap-system"][0];var c=o["sap-system-src"]&&o["sap-system-src"][0];i["sap-system"]=u;if(typeof c==="string"){i["sap-system-src"]=c}a.effectiveParameters=o;var f=p.getURLParsing().paramsToString(o);if(f){i.url=i.url+(i.url.indexOf("?")<0?"?":"&")+f}if(typeof s.resolutionResult.ui5ComponentName!=="undefined"){i.ui5ComponentName=s.resolutionResult.ui5ComponentName}i.text=s.title;return Promise.resolve(i)}function S(t){var a=undefined;var n=m.getHash()||window.location.hash;var r=n.lastIndexOf("&/");var s=1;if(r>0){if(t&&t.capabilities&&t.capabilities.appFrameworkId==="UI5"){s=2}a=n.substring(r+s);try{if(a&&a.length>0){a=decodeURIComponent(a)}}catch(t){e.warning("inner route should be double encoded",t,"sap.ushell.ApplicationType.getInnerAppRoute")}}return a}function A(e){var t=e.targetNavigationMode;if(t===undefined||t===""){t="inplace"}return t}function R(){var e=window.hasher&&window.hasher.getHash();var t="";if(e&&e.length>0&&e.indexOf("sap-iapp-state=")>0){var a=/(?:sap-iapp-state=)([^&/\\]+)/.exec(e);if(a&&a.length===2){t=a[1]}}return t}function w(){return new Promise(function(e){Promise.all([sap.ushell.Container.getServiceAsync("UserInfo"),sap.ushell.Container.getServiceAsync("PluginManager"),d.getUi5VersionAsync()]).then(function(t){var a=t[0];var s=t[1];var i=t[2];var o=a.getUser();var p=o.getContentDensity()||(document.body.classList.contains("sapUiSizeCompact")?"compact":"cozy");var l=o.getTheme();if(l.indexOf("sap_")!==0){var c=f.prototype.constants.themeFormat.THEME_NAME_PLUS_URL;l=o.getTheme(c)}var d=n.getLanguage&&n.getLanguage();var m=n.getSAPLogonLanguage&&n.getSAPLogonLanguage();var h=window.location.protocol+"//"+window.location.host+"/comsapuitheming.runtime/themeroot/v1";var y=0;if(u.last("/core/shell/sessionTimeoutIntervalInMinutes")>0){y=u.last("/core/shell/sessionTimeoutIntervalInMinutes")}var v=false;if(window["sap-ui-debug"]!==false&&window["sap-ui-debug"]!==undefined){v=window["sap-ui-debug"]}e({language:d,logonLanguage:m,theme:l,themeServiceRoot:h,isDebugMode:v,ui5Version:i,contentDensity:p,sapPlugins:s._getNamesOfPluginsWithAgents(),innerAppState:R(),sessionTimeout:y,historyDirection:r.getInstance().getDirection()||""})})})}function I(e){var t;switch(e){case"inplace":t="embedded";break;case"explace":t="newWindow";break;default:t=e||"newWindow"}return t}function b(t,a){var n=I(t);var r=d.getMember(a,"sap|integration.navMode");switch(r){case"inplace":return"embedded";case"explace":if(n==="embedded"){return"newWindowThenEmbedded"}if(["newWindowThenEmbedded","newWindow"].indexOf(n)>=0){return n}e.error("App-defined navigation mode was ignored","Application requests to be opened in a new window but no expected navigation mode was defined on the template","sap.ushell.ApplicationType");default:return n}}function U(e,t,a){var n=d.clone(e);n.navigationMode=b(e.navigationMode,t);n.appId=a(e.appId||"");n.technicalAppComponentId=a(e.technicalAppComponentId||"");n.appSupportInfo=t["sap.app"]&&t["sap.app"].ach;n.appFrameworkId=e.appFrameworkId;delete n.urlTransformation;return n}function T(e,t,a){var n={appParams:{},system:undefined};if(a.mappedIntentParamsPlusSimpleDefaults){n.appParams=JSON.parse(JSON.stringify(a.mappedIntentParamsPlusSimpleDefaults))}var r=d.getMember(t,"sap|app.destination");if(typeof r==="string"&&r.length>0){n.system=e.systemAliases[r]&&JSON.parse(JSON.stringify(e.systemAliases[r]));if(typeof n.system==="object"){n.system.alias=r}}return n}function L(e,t,a){return new Promise(function(n,r){var i=new s(e);var o=i.query(true);var p=true;var l=["sap-language","sap-theme","sap-shell","sap-ui-app-id","transaction","sap-iframe-hint","sap-keep-alive","sap-ui-versionedLibCss","sap-wd-configId"];if(a&&a.mandatoryUrlParams){l=l.concat(a.mandatoryUrlParams.split(","));l=l.filter(function(e,t){return l.indexOf(e)===t})}if(t==="explace"){p=false}sap.ushell.Container.getServiceAsync("ShellNavigation").then(function(t){t.compactParams(o,l,undefined,p).done(function(t){if(!t.hasOwnProperty("sap-intent-param")){n(e);return}var a;if(t["sap-theme"]){var r="sap-theme="+t["sap-theme"];t["sap-theme"]="sap-theme-temp-placeholder";i.query(t);a=i.toString();a=a.replace("sap-theme=sap-theme-temp-placeholder",r)}else{i.query(t);a=i.toString()}n(a)}).fail(function(e){r(e)})})})}function C(e,t){if(t){E(e,"sap-iframe-hint",t)}}function M(e,t){var a=e.intentParamsPlusAllDefaults;if(a&&a["sap-post"]&&a["sap-post"][0]==="false"){t.openWithPostByAppParam=false}}function O(e){var t=e.extendedInfo.appParams["sap-keep-alive"];if(t!==undefined){E(e,"sap-keep-alive",t[0])}}function x(e){var t=u.last("/core/spaces/enabled");if(t===true){E(e,"sap-spaces",t)}}function D(e,t,a){var n=d.getMember(t,"sap|integration.urlTemplateId");if(n==="urltemplate.url-dynamic"&&e.url.indexOf("sap-language=")===-1){E(e,"sap-language",a.env.language)}}function E(e,t,a){if(e.url){var n=e.url.indexOf("#");var r=e.url;var s="";if(n>0){r=e.url.slice(0,n);s=e.url.slice(n)}e.url=r+(r.indexOf("?")>=0?"&":"?")+t+"="+a+s}}function W(t,n,r){return new Promise(function(n){var r=t.inbound;var s=r.templateContext;var i=s.payload.capabilities||{};if(t.mappedIntentParamsPlusSimpleDefaults&&t.mappedIntentParamsPlusSimpleDefaults.hasOwnProperty("sap-ushell-innerAppRoute")){var o=window.hasher.getHash();if(t.mappedIntentParamsPlusSimpleDefaults["sap-ushell-innerAppRoute"].length>0&&o.indexOf("&/")===-1){o+="&/"+t.mappedIntentParamsPlusSimpleDefaults["sap-ushell-innerAppRoute"];window.hasher.replaceHash(o)}}var p={innerAppRoute:S(s.payload)||t.parsedIntent.appSpecificRoute,targetNavMode:A(t),defaultParameterNames:t.mappedDefaultedParamNames,startupParameter:t.mappedIntentParamsPlusSimpleDefaults,remoteApplication:{remoteSO:undefined,remoteAction:undefined}};w().then(function(o){p.env=o;var l=a.get(["sap.integration","urlTemplateParams","query"],s.siteAppSection)||{};if(l.hasOwnProperty("sap-cssurl")){p.env.themeServiceRoot=undefined;p.env.theme=undefined}if(i.appFrameworkId==="UI5"&&p.startupParameter){for(var u in p.startupParameter){if(u!=="sap-ushell-innerAppRoute"){p.startupParameter[u][0]=encodeURIComponent(p.startupParameter[u][0])}if(u==="sap-shell-so"){p.remoteApplication.remoteSO=p.startupParameter[u][0]}if(u==="sap-shell-action"){p.remoteApplication.remoteAction=p.startupParameter[u][0]}}if(t.mappedDefaultedParamNames&&t.mappedDefaultedParamNames.length>0){var f=t.mappedDefaultedParamNames.filter(function(e){return e!=="sap-shell-so"&&e!=="sap-shell-action"&&e!=="sap-system"});p.startupParameter["sap-ushell-defaultedParameterNames"]=[JSON.stringify(f)]}delete p.startupParameter["sap-shell-so"];delete p.startupParameter["sap-shell-action"]}var m="/universal_search/search?query=",y=p.innerAppRoute&&p.innerAppRoute.indexOf(m),v;if(y===0){v=p.innerAppRoute.substring(m.length);p.innerAppRoute="/JAMSEARCHPATHH?JAMSEARCHVALUEE=VALUEE"}var g=c.expand(s.payload,s.site,p,s.siteAppSection,"startupParameter");if(y===0){g=g.replace("/JAMSEARCHPATHH?JAMSEARCHVALUEE=VALUEE",m+encodeURIComponent(v))}if(p.env.theme===undefined){g=g.replace("&sap-theme=","")}if(i.appFrameworkId==="UI5"&&document.URL.indexOf("#")>0){var P=g.split("#"),S=P[1].split("&/"),A=sap.ushell.Container.getFLPUrl(true).split("#"),R=A[1].split("&/");g=P[0]+"#"+R[0]+(S.length>1?"&/"+S[1]:"");e.debug("- created URL with fixed hash: "+g,"sap.ushell.ApplicationType")}var w=function(e){var t=d.clone(s.payload);t.urlTemplate=e;return c.expand(t,s.site,p,s.siteAppSection,"startupParameter")};var I={applicationType:"URL",text:r.title,appCapabilities:U(i,s.siteAppSection,w),url:g,extendedInfo:T(s.site,s.siteAppSection,t),contentProviderId:r.contentProviderId||"",systemAlias:s.siteAppSection["sap.app"]&&s.siteAppSection["sap.app"].destination||s.siteAppSection.destination||""};C(I,I.appCapabilities.appFrameworkId);O(I);x(I);D(I,s.siteAppSection,p);var b=new Promise(function(e){sap.ushell.Container.getServiceAsync("URLTemplate").then(function(t){sap.ui.require(["sap/ushell/components/applicationIntegration/application/BlueBoxesCache"],function(a){var n=a.get(I.url)===undefined;t.handlePostTemplateProcessing(I.url,s.siteAppSection,n).then(e)})})});b.then(function(e){if(h&&e.indexOf("ui5appruntime.html")>0){var t=e.split("?");t[0]=h;e=t.join("?")}I.url=e;N(I.url,i,s).then(function(e){I.url=e;if(I.url&&typeof I.url==="string"&&I.url.indexOf("sap-iframe-hint=GUI")>0){n(I)}else{L(I.url,p.targetNavMode,i).then(function(e){I.url=e;n(I)},function(){n(I)})}})})})})}function N(t,n,r){return new Promise(function(i){var o=n.urlTransformation||{enabled:false};if(F(o,r)){var p=new s(t);var l=o.transformations[0];var u=l.service.uri;var f=c.prepareExpandData({urlTemplate:"",parameters:{names:u.queryOptions}},{},{urlComponent:{query:p.query(),fragment:p.fragment()}},r.siteAppSection,"");var d=s.expand("{+rootPath}/{+resourcePath}{?queryParams*}",{rootPath:u.rootPath,resourcePath:u.resourcePath,queryParams:f.oResolvedParameters}).toString();sap.ui.require(["sap/ui/thirdparty/datajs"],function(n){n.read({requestUri:d,headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"}},function(n){var r=a.get("transformAppLaunchQueryString.value",n);if(r===undefined){r=a.get("transformAppLaunchIntent.value",n)}if(r===undefined){r=a.get("transformAppLaunchQueryString.queryString",n)}e.info("URL Transformation Succeeded",JSON.stringify({URLBeforeTransformation:t,URLAfterTransformation:r}),"sap.ushell.ApplicationType");var s=l.sourceURLComponent;if(s===undefined){s="query"}if(s==="query"||s==="fragment"){t=p[s].apply(p,[r]).toString()}else{e.error("The "+s+" component of the URL in URI.js is not transformed","","sap.ushell.ApplicationType")}i(t)},function(a){e.error("URL Transformation Failed",JSON.stringify(a),"sap.ushell.ApplicationType");i(t)})})}else{i(t)}})}function F(e,t){if(typeof e.enabled==="boolean"){return e.enabled}var a=c.prepareExpandData({urlTemplate:"",parameters:{names:{enabled:e.enabled}}},{},{},t.siteAppSection,"");return typeof a.oResolvedParameters.enabled==="boolean"?a.oResolvedParameters.enabled:false}function q(e,a,n){var r=e.inbound;var i=r&&r.resolutionResult;var l={};var c=new s(a);var f=t({},e.mappedIntentParamsPlusSimpleDefaults);if(e.inbound&&e.inbound.action==="launchURL"&&e.inbound.semanticObject==="Shell"){delete f["sap-external-url"]}var d=f["sap-system"]&&f["sap-system"][0];var m=f["sap-system-src"]&&f["sap-system-src"][0];l["sap-system"]=d;delete f["sap-system"];if(typeof m==="string"){l["sap-system-src"]=m;delete f["sap-system-src"]}return new Promise(function(e,t){if(p.absoluteUrlDefinedByUser(c,i.systemAlias,i.systemAliasSemantics)){e(a)}else{o.spliceSapSystemIntoURI(c,i.systemAlias,d,m,"URL",i.systemAliasSemantics||o.SYSTEM_ALIAS_SEMANTICS.applied,n).fail(t).done(function(t){var a=t.toString();e(a)})}}).then(function(e){var t=false,a,n=u.last("/core/navigation/flpURLDetectionPattern"),r=new RegExp(n);if(f&&f.hasOwnProperty("sap-params-append")){delete f["sap-params-append"];t=true}a=p.getURLParsing().paramsToString(f);return r.test(e)||t===true?p.appendParametersToIntentURL(f,e):p.appendParametersToUrl(a,e)},Promise.reject.bind(Promise)).then(function(e){["additionalInformation","applicationDependencies","systemAlias"].forEach(function(e){if(r.resolutionResult.hasOwnProperty(e)){l[e]=r.resolutionResult[e]}});l.url=e;l.text=r.title;l.applicationType="URL";return Promise.resolve(l)},Promise.reject.bind(Promise))}var j={URL:{type:"URL",defaultFullWidthSetting:true,generateResolutionResult:function(e){var t=e.inbound.hasOwnProperty("templateContext");return t?W.apply(null,arguments):q.apply(null,arguments)},easyAccessMenu:{intent:"Shell-startURL",resolver:null,showSystemSelectionInUserMenu:true,showSystemSelectionInSapMenu:false,systemSelectionPriority:1}},WDA:{type:"WDA",defaultFullWidthSetting:true,enableWdaCompatibilityMode:u.last("/core/navigation/enableWdaCompatibilityMode"),generateResolutionResult:y,easyAccessMenu:{intent:"Shell-startWDA",resolver:l.resolveEasyAccessMenuIntentWDA,showSystemSelectionInUserMenu:true,showSystemSelectionInSapMenu:true,systemSelectionPriority:2}},TR:{type:"TR",defaultFullWidthSetting:true,generateResolutionResult:v,easyAccessMenu:{intent:"Shell-startGUI",resolver:i.resolveEasyAccessMenuIntentWebgui,showSystemSelectionInUserMenu:true,showSystemSelectionInSapMenu:true,systemSelectionPriority:3}},NWBC:{type:"NWBC",defaultFullWidthSetting:true},WCF:{type:"WCF",generateResolutionResult:g,defaultFullWidthSetting:true},SAPUI5:{type:"SAPUI5",generateResolutionResult:P,defaultFullWidthSetting:false}};function k(){return Object.keys(j).map(function(e){return j[e]}).filter(function(e){return typeof e.easyAccessMenu==="object"})}function H(){var e={};k().forEach(function(t){e[t.easyAccessMenu.intent]=t.easyAccessMenu.resolver});return function(t,a){if(e[t]&&(!a||a!=="SAPUI5")){return e[t]}return null}}function _(e){return!!j[e]&&j[e].defaultFullWidthSetting}Object.defineProperty(j,"enum",{value:Object.keys(j).reduce(function(e,t){if(j[t].type){e[t]=j[t].type}return e},{})});var J={getEasyAccessMenuResolver:H(),getEasyAccessMenuDefinitions:k,getDefaultFullWidthSetting:_,handleURLTransformation:N};Object.keys(J).forEach(function(e){Object.defineProperty(j,e,{value:J[e]})});return j},false);