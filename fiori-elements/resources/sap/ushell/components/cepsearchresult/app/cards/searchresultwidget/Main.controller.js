//Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/resource/ResourceModel","sap/m/HBox","./controls/SearchResultList","sap/ushell/components/cepsearchresult/app/util/SearchResultManager"],function(e,t,a,s,i){"use strict";return e.extend("sap.ushell.components.cepsearchresult.app.cards.searchresultwidget.Main",{onInit:function(){this.oView=this.getView();var e=this.getOwnerComponent();this.oCard=e.oCard;this.oResourceModel=new t({bundleName:"sap.ushell.components.cepsearchresult.app.cards.searchresultwidget.i18n.i18n"});this.oView.setModel(this.oResourceModel,"card_i18n");this.oView.setModel(this.oCard.getModel("parameters"),"parameters");this.sCategories=e.getCategories();this.sSearchTerm=e.getSearchTerm();var a=e.getEdition();if(this.oCard._oSearchResultManager){this.oSearchResultManager=this.oCard._oSearchResultManager}else if(a==="custom"){this.oSearchResultManager=new i(e.getConfig())}else{this.oSearchResultManager=new i(e.getEdition())}this.oCard._oSearchResultManager=this.oSearchResultManager;this.oSearchResultManager._loaded.then(this.initUIAsync.bind(this))},initUIAsync:function(){this.oView.setModel(this.oSearchResultManager.getResourceModel(),"cati18n");this.oCategoriesModel=this.oSearchResultManager.getCategoriesModel(this.sCategories);this.oCategoriesModel.getProperty("/").forEach(function(e){if(!e){return}if(!this.oCard._oCategoriesModel){this.oCard._oCategoriesModel={}}var t;if(!this.oCard._oCategoriesModel[e.name]){t=this.oSearchResultManager.createSearchResultModel(e.name,this.oCard,this.oCategoriesModel);this.oCard._oCategoriesModel[e.name]=t}t=this.oCard._oCategoriesModel[e.name];this._notifyStateChange(e.name,"loading",-1);var s=this._createList(t,e);var i=new a({items:[s]});i.addStyleClass("sapFCard");i.addStyleClass("sapUiCEPCatCard");this.oView.byId("content").addItem(i)}.bind(this));this.oView.setVisible(true)},_createList:function(e,t){var a=new s({noDataText:"{category>_status/dataStatusText}",category:"{category>}",paging:"{= ${category>list/paging}}",viewAll:false,view:"{category>list/_currentView}",items:"{path:'data>'}",template:"{= ${category>list/item/template}}"});if(this.sCategories==="all"){a.setViewAll(true);a.attachShowAll(function(e){this._navigateTo(e.getParameter("category"))}.bind(this))}if(this.sSearchTerm){a.setHighlightTerm(this.sSearchTerm)}a.applyModelContexts(e,{category:"/",data:"/list/data/_result",count:"/list/data/_count"});a.attachItemPress(function(e){var t=e.getParameter("listItem").getBindingContext("data").getProperty("url");document.location.hash=t});a.attachFetchData(function(a){var s=a.getParameters();e.setProperty("/list/paginator/pageSize",s.pageSize);e.fetchCategoryData(s.page).then(function(){this._notifyStateChange(t.name,"ok",e.getProperty("/list/data/_count"))}.bind(this))}.bind(this));a.loadForVisibleItemCount(e.getProperty("/list/paginator/pageSize"),this.oCard.getDomRef());return a},_notifyStateChange:function(e,t,a){this.oCard.fireAction({type:"Custom",parameters:{categoryStateChange:{name:e,state:t,count:a}}})},_navigateTo:function(e){this.getOwnerComponent().oCard.fireAction({type:"Navigation",parameters:{category:e}})}})});