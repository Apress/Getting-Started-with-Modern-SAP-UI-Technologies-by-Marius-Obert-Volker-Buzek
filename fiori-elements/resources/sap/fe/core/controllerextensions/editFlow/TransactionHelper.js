/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/controllerextensions/editFlow/draft","sap/fe/core/controllerextensions/editFlow/operations","sap/fe/core/controllerextensions/editFlow/sticky","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/fe/core/helpers/DeleteHelper","sap/fe/core/helpers/FPMHelper","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/ResourceModelHelper","sap/fe/core/helpers/StableIdHelper","sap/fe/core/library","sap/m/Button","sap/m/Dialog","sap/m/MessageBox","sap/m/MessageToast","sap/m/Popover","sap/m/Text","sap/m/VBox","sap/ui/core/Core","sap/ui/core/Fragment","sap/ui/core/library","sap/ui/core/util/XMLPreprocessor","sap/ui/core/XMLTemplateProcessor","sap/ui/model/json/JSONModel","../../helpers/MetaModelFunction","../../helpers/ToES6Promise"],function(e,t,n,a,o,r,s,i,c,l,d,u,g,f,p,C,h,m,b,y,E,w,A,x,D,P,T,M){"use strict";var v=T.getRequiredPropertiesFromInsertRestrictions;var O=T.getNonComputedVisibleFields;var _=u.generate;var I=d.getResourceModel;const S=g.CreationMode;const N=g.ProgrammingModel;const B=A.ValueState;function R(e){if(e&&e.getMetadata&&e.getMetadata().getName()==="sap.ui.base.Event"){e={}}return e||{}}let k=function(){function d(){}var u=d.prototype;u.busyLock=function e(t,a){n.lock(t.getModel("ui"),a)};u.busyUnlock=function e(t,a){n.unlock(t.getModel("ui"),a)};u.getProgrammingModel=function e(t){let n;if(t.isA("sap.ui.model.odata.v4.Context")){n=t.getPath()}else{n=(t.isRelative()?t.getResolvedPath():t.getPath())??""}const a=t.getModel().getMetaModel();if(l.isDraftSupported(a,n)){return N.Draft}else if(l.isStickySessionSupported(a)){return N.Sticky}else{return N.NonDraft}};u.validateDocument=function e(t,n,a){const o=n&&n.customValidationFunction;if(o){const e=o.substring(0,o.lastIndexOf(".")||-1).replace(/\./gi,"/"),r=o.substring(o.lastIndexOf(".")+1,o.length),s=n.data;delete s["@$ui5.context.isTransient"];return c.validationWrapper(e,r,s,a,t)}return Promise.resolve([])};u.createDocument=async function t(n,a,r,s,i){const c=n.getModel(),d=c.getMetaModel(),u=d.getMetaPath(n.getHeaderContext().getPath()),f=r.getRouterProxy().getHash(),p=r.getComponentData(),C=p&&p.startupParameters||{},h=!n.isRelative()?this._getNewAction(C,f,d,u):undefined;const m={$$patchWithoutSideEffects:true};const b=d.getObject(`${u}/@com.sap.vocabularies.Common.v1.Messages/$Path`);let y="/busy";let w=d.getObject(`${u}@com.sap.vocabularies.Common.v1.DefaultValuesFunction`)||d.getObject(`${l.getTargetEntitySet(d.getContext(u))}@com.sap.vocabularies.Common.v1.DefaultValuesFunction`);let A;let x;if(w){if(d.getObject(`${u}@com.sap.vocabularies.Common.v1.DefaultValuesFunction`)&&l.getTargetEntitySet(d.getContext(u))!==u){A=true}else{A=false}}if(b){m["$select"]=b}const D=R(a);if(!n){throw new Error("Binding required for new document creation")}const P=this.getProgrammingModel(n);if(P!==N.Draft&&P!==N.Sticky){throw new Error("Create document only allowed for draft or sticky session supported services")}if(D.busyMode==="Local"){y=`/busyLocal/${D.busyId}`}D.beforeCreateCallBack=i?null:D.beforeCreateCallBack;this.busyLock(r,y);const T=E.getLibraryResourceBundle("sap.fe.core");let v;try{if(h){v=await this.callAction(h,{contexts:n.getHeaderContext(),showActionParameterDialog:true,label:this._getSpecificCreateActionDialogLabel(d,u,h,T),bindingParameters:m,parentControl:D.parentControl,bIsCreateAction:true,skipParameterDialog:D.skipParameterDialog},null,r,s)}else{const a=D.creationMode!==S.CreationRow&&D.creationMode!==S.Inline;const l=a?O(d,u,r):[];w=i?null:w;let g,f;if(w){if(A){g=n.getContext()&&`${d.getMetaPath(n.getContext().getPath())}/${w}`;f=n.getContext()}else{g=n.getHeaderContext()&&`${d.getMetaPath(n.getHeaderContext().getPath())}/${w}`;f=n.getHeaderContext()}}const p=g&&d.createBindingContext(g);try{let a;try{const e=p&&p.getObject()&&p.getObject()[0].$IsBound?await o.callBoundFunction(w,f,c):await o.callFunctionImport(w,c);if(e){a=e.getObject()}}catch(t){e.error(`Error while executing the function ${w}`,t);throw t}D.data=a?Object.assign({},a,D.data):D.data;if(D.data){delete D.data["@odata.context"]}if(l.length>0){v=await this._launchDialogWithKeyFields(n,l,c,D,r,s);x=v.newContext}else{if(D.beforeCreateCallBack){await M(D.beforeCreateCallBack({contextPath:n&&n.getPath()}))}x=n.create(D.data,true,D.createAtEnd,D.inactive);if(!D.inactive){v=await this.onAfterCreateCompletion(n,x,D)}}}catch(t){e.error("Error while creating the new document",t);throw t}}x=x||v;await s.showMessageDialog({control:D.parentControl});return x}catch(e){var _;await s.showMessageDialog({control:D.parentControl});if((e===g.Constants.ActionExecutionFailed||e===g.Constants.CancelActionDialog)&&(_=x)!==null&&_!==void 0&&_.isTransient()){x.delete("$direct")}throw e}finally{this.busyUnlock(r,y)}};u._isDraftEnabled=function e(t){const n=t[0];const a=this.getProgrammingModel(n);return a===N.Draft};u.deleteDocument=function e(t,n,a,o,r){const c=E.getLibraryResourceBundle("sap.fe.core");let l;this.busyLock(a);const d=Array.isArray(t)?[...t]:[t];return new Promise((e,t)=>{try{const u=this._isDraftEnabled(n.selectedContexts||d);const g=[];const h=[];if(n){if(!n.numberOfSelectedContexts){if(u){const e=d.find(e=>{const t=e.getObject();return t.IsActiveEntity===true&&t.HasDraftEntity===true&&t.DraftAdministrativeData&&t.DraftAdministrativeData.InProcessByUser&&!t.DraftAdministrativeData.DraftIsCreatedByMe});if(e){const n=e.getObject().DraftAdministrativeData.InProcessByUser;C.show(o.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_SINGLE_OBJECT_LOCKED",[n]),{title:o.getText("C_COMMON_DELETE"),onClose:t});return}}n=R(n);let e="";if(n.title){if(n.description){l=[n.title+" ",n.description]}else{l=[n.title,""]}e=o.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO",l,n.entitySetName)}else{e=o.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",undefined,n.entitySetName)}h.push({type:"deletableContexts",contexts:d,text:e,selected:true,control:"text"})}else{let e=d.length;if(u){e+=n.draftsWithNonDeletableActive.length+n.draftsWithDeletableActive.length+n.unSavedContexts.length+n.createModeContexts.length;i.updateDraftOptionsForDeletableTexts(n,d,e,o,g,h)}else{const t=i.getNonDeletableText(n,e,o);if(t){g.push(t)}}i.updateOptionsForDeletableTexts(n,d,o,h)}}i.updateContentForDeleteDialog(h,g);const m=new y({items:g});const b=c.getText("C_COMMON_DELETE");const E=async()=>{this.busyLock(a);try{await i.deleteConfirmHandler(h,n,r,o,a,u);e()}catch(e){t()}finally{this.busyUnlock(a)}};let w=false;const A=new p({title:b,state:"Warning",content:[m],ariaLabelledBy:g,beginButton:new f({text:c.getText("C_COMMON_DELETE"),type:"Emphasized",press:function(){s.removeBoundTransitionMessages();w=true;A.close();E()}}),endButton:new f({text:o.getText("C_COMMON_DIALOG_CANCEL"),press:function(){A.close()}}),afterClose:function(){A.destroy();if(!w){t()}}});if(n.noDialog){E()}else{A.addStyleClass("sapUiContentPadding");A.open()}}finally{this.busyUnlock(a)}})};u.editDocument=async function e(t,n,o,s){const i=this.getProgrammingModel(t);if(!t){throw new Error("Binding context to active document is required")}if(i!==N.Draft&&i!==N.Sticky){throw new Error("Edit is only allowed for draft or sticky session supported services")}this.busyLock(o);s.removeTransitionMessages();try{const e=i===N.Draft?await a.createDraftFromActiveDocument(t,o,{bPreserveChanges:true,oView:n}):await r.editDocumentInStickySession(t,o);await s.showMessageDialog();return e}catch(e){await s.showMessages({concurrentEditFlag:true});throw e}finally{this.busyUnlock(o)}};u.cancelDocument=async function e(t,n,o,s,i,c,l){if(!t){throw new Error("No context exists. Pass a meaningful context")}this.busyLock(o);const d=R(n);const u=t.getModel();const g=this.getProgrammingModel(t);if(g!==N.Draft&&g!==N.Sticky){throw new Error("Cancel document only allowed for draft or sticky session supported services")}try{let e=false;if(g===N.Draft&&!l){const e=u.bindContext(`${t.getPath()}/DraftAdministrativeData`).getBoundContext();const n=await e.requestObject();if(n){l=n.CreationDateTime!==n.LastChangeDateTime}}if(!d.skipDiscardPopover){await this._confirmDiscard(d.cancelButton,l,s)}if(t.isKeepAlive()){t.setKeepAlive(false)}if(d.beforeCancelCallBack){await d.beforeCancelCallBack({context:t})}if(g===N.Draft){if(c){if(t.hasPendingChanges()){t.getBinding().resetChanges()}e=await a.deleteDraft(t,o)}else{const n=u.bindContext(`${t.getPath()}/SiblingEntity`).getBoundContext();try{const a=await n.requestCanonicalPath();if(t.hasPendingChanges()){t.getBinding().resetChanges()}e=u.bindContext(a).getBoundContext()}finally{await a.deleteDraft(t,o)}}}else{const n=await r.discardDocument(t);if(n){if(n.hasPendingChanges()){n.getBinding().resetChanges()}if(!c){n.refresh();e=n}}}i.removeTransitionMessages();await i.showMessages();return e}catch(e){await i.showMessages();throw e}finally{this.busyUnlock(o)}};u.saveDocument=async function e(n,o,i,c,l,d,u){const g=this.getProgrammingModel(n);if(g!==N.Sticky&&g!==N.Draft){throw new Error("Save is only allowed for draft or sticky session supported services")}d.removeTransitionMessages();try{this.busyLock(o);const e=g===N.Draft?await a.activateDocument(n,o,{},d):await r.activateDocument(n,o);const t=s.getMessages().concat(s.getMessages(true,true));if(!(t.length===1&&t[0].type===A.MessageType.Success)){h.show(u?i.getText("C_TRANSACTION_HELPER_OBJECT_CREATED"):i.getText("C_TRANSACTION_HELPER_OBJECT_SAVED"))}return e}catch(e){if(c&&(l===null||l===void 0?void 0:l.length)>0){l.forEach(e=>{if(!t.hasTransientContext(e)){o.getSideEffectsService().requestSideEffectsForNavigationProperty(e.getPath(),n)}})}await d.showMessages();throw e}finally{this.busyUnlock(o)}};u.callAction=async function e(t,n,a,r,s){n=R(n);let i,c;const l=n.bindingParameters;if(!t){throw new Error("Provide name of action to be executed")}const d=t.split("/")[1];t=d||t;i=d?undefined:n.contexts;if(i&&(Array.isArray(i)&&i.length||!Array.isArray(i))){i=Array.isArray(i)?i[0]:i;c=i.getModel()}if(n.model){c=n.model}if(!c){throw new Error("Pass a context for a bound action or pass the model for an unbound action")}const u=r.getSideEffectsService().getODataActionSideEffects(t,i)||{};try{let e;if(i&&c){e=await o.callBoundAction(t,n.contexts,c,r,{parameterValues:n.parameterValues,invocationGrouping:n.invocationGrouping,label:n.label,skipParameterDialog:n.skipParameterDialog,mBindingParameters:l,entitySetName:n.entitySetName,additionalSideEffect:u,onSubmitted:()=>{s.removeTransitionMessages();this.busyLock(r)},onResponse:()=>{this.busyUnlock(r)},parentControl:n.parentControl,controlId:n.controlId,internalModelContext:n.internalModelContext,operationAvailableMap:n.operationAvailableMap,bIsCreateAction:n.bIsCreateAction,bGetBoundContext:n.bGetBoundContext,bObjectPage:n.bObjectPage,messageHandler:s,defaultValuesExtensionFunction:n.defaultValuesExtensionFunction,selectedItems:n.contexts})}else{e=await o.callActionImport(t,c,r,{parameterValues:n.parameterValues,label:n.label,skipParameterDialog:n.skipParameterDialog,bindingParameters:l,entitySetName:n.entitySetName,onSubmitted:()=>{this.busyLock(r)},onResponse:()=>{this.busyUnlock(r)},parentControl:n.parentControl,internalModelContext:n.internalModelContext,operationAvailableMap:n.operationAvailableMap,messageHandler:s,bObjectPage:n.bObjectPage})}await this._handleActionResponse(s,n,t);return e}catch(e){await this._handleActionResponse(s,n,t);throw e}};u._handleActionResponse=function e(t,n,a){const o=s.getMessages(true,true);const r=n.label?n.label:a;if(o.length>0&&n&&n.internalModelContext){n.internalModelContext.setProperty("sActionName",n.label?n.label:a)}let i;if(n.controlId){i=n.parentControl.byId(n.controlId)}else{i=n.parentControl}return t.showMessages({sActionName:r,control:i})};u.handleValidationError=function e(){const t=E.getMessageManager(),n=t.getMessageModel().getData().filter(function(e){if(e.validation){return e}});t.removeMessages(n)};u._createPopover=function e(t){return new m(t)};u._confirmDiscard=function e(t,n,a){if(!n){this.handleValidationError();return Promise.resolve()}t.setEnabled(false);return new Promise((e,n)=>{const o=this._createPopover({showHeader:false,placement:"Top"});o.addStyleClass("sapUiContentPadding");const r=new b({text:a.getText("C_TRANSACTION_HELPER_DRAFT_DISCARD_MESSAGE")});const s=new f({text:a.getText("C_TRANSACTION_HELPER_DRAFT_DISCARD_BUTTON"),width:"100%",press:()=>{this.handleValidationError();o.data("continueDiscard",true);o.close()},ariaLabelledBy:[r]});o.addContent(new y({items:[r,s]}));o.attachBeforeOpen(()=>{o.setInitialFocus(s)});o.attachAfterClose(()=>{t.setEnabled(true);if(o.data("continueDiscard")){e()}else{n()}});o.openBy(t,false)})};u._onFieldChange=function e(t,n,a,o){a.removeTransitionMessages();const r=t.getSource();const s=t.getParameter("promise");if(s){return s.then(function(e){r.setValue(e);o();return r.getValue()}).catch(function(e){if(e!==""){n.setEnabled(false)}else{r.setValue(e);o()}})}};u._launchDialogWithKeyFields=function e(a,o,r,s,i,c){let l;const d=s.parentControl;const u=r.bindList(a.getPath(),a.getContext(),[],[],{$$updateGroupId:"submitLater"});u.refreshInternal=function(){};const f=u.create(s.data,true);return new Promise(async(e,C)=>{const h="sap/fe/core/controls/NonComputedVisibleKeyFieldsDialog";const m=D.loadTemplate(h,"fragment"),b=I(d),y=r.getMetaModel(),E=[],A=a.isRelative()?a.getResolvedPath():a.getPath(),T=y.createBindingContext(A),O=y.getMetaPath(A);for(const e in o){E.push(y.createBindingContext(`${O}/${o[e]}`))}const S=new P(E);const N=S.createBindingContext("/");const R=v(O,y);const k=new P(R);const L=k.createBindingContext("/");const F=await x.process(m,{name:h},{bindingContexts:{entitySet:T,fields:N,requiredProperties:L},models:{entitySet:T.getModel(),fields:N.getModel(),metaModel:y,requiredProperties:k}});let H=[];const $={};let U;const j=async function(){let e=false;try{const t=await Promise.all(H.map(function(e){return e.getFields()[0]}).filter(function(e){return e.getRequired()||e.getValueState()===B.Error}).map(async function(e){const t=e.getId();if(t in $){try{const n=await $[t];return e.getValue()===""?undefined:n}catch(e){return undefined}}return e.getValue()===""?undefined:e.getValue()}));e=t.every(function(e){if(Array.isArray(e)){e=e[0]}return e!==undefined&&e!==null&&e!==""})}catch(t){e=false}U.setEnabled(e)};const V={handleChange:e=>{const t=e.getParameter("id");$[t]=this._onFieldChange(e,U,c,j)},handleLiveChange:e=>{const t=e.getParameter("id");const n=e.getParameter("value");$[t]=n;j()}};const W=await w.load({definition:F,controller:V});let G;const q=function(){if(G.error){C(G.error)}else{e(G.response)}l.close()};l=new p(_(["CreateDialog",O]),{title:b.getText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE"),content:[W],beginButton:{text:b.getText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE_BUTTON"),type:"Emphasized",press:async e=>{const t=e.getSource();t.setEnabled(false);n.lock(l);s.bIsCreateDialog=true;try{const e=await Promise.all(Object.keys($).map(async function(e){const t=await $[e];const n={};n[e]=t;return n}));if(s.beforeCreateCallBack){await M(s.beforeCreateCallBack({contextPath:a&&a.getPath(),createParameters:e}))}const t=f.getObject();const n={};Object.keys(t).forEach(function(e){const a=y.getObject(`${O}/${e}`);if(a&&a.$kind==="NavigationProperty"){return}n[e]=t[e]});const o=a.create(n,true,s.createAtEnd,s.inactive);const r=this.onAfterCreateCompletion(a,o,s);let i=await r;if(!i||i&&i.bKeepDialogOpen!==true){i=i??{};l.setBindingContext(null);i.newContext=o;G={response:i};q()}}catch(e){if(e!==g.Constants.CreationFailed){G={error:e};q()}else{t.setEnabled(true)}}finally{n.unlock(l);c.showMessages()}}},endButton:{text:b.getText("C_COMMON_ACTION_PARAMETER_DIALOG_CANCEL"),press:function(){G={error:g.Constants.CancelActionDialog};q()}},afterClose:function(){var e;(e=l.getBindingContext("internal"))===null||e===void 0?void 0:e.setProperty("isCreateDialogOpen",false);l.destroy();u.destroy()}});H=W===null||W===void 0?void 0:W.getAggregation("form").getAggregation("formContainers")[0].getAggregation("formElements");if(d&&d.addDependent){d.addDependent(l)}U=l.getBeginButton();l.setBindingContext(f);try{await t.setUserDefaults(i,E,f,false,s.createAction,s.data);j();l.getBindingContext("internal").setProperty("isCreateDialogOpen",true);l.open()}catch(e){await c.showMessages();throw e}})};u.onAfterCreateCompletion=function t(n,a,o){let r;const s=new Promise(e=>{r=e});const i=e=>{const t=e.getParameter("context"),o=e.getParameter("success");if(t===a){n.detachCreateCompleted(i,this);r(o)}};const c=()=>{a.created().then(undefined,function(){e.trace("transient creation context deleted")}).catch(function(t){e.trace("transient creation context deletion error",t)})};n.attachCreateCompleted(i,this);return s.then(e=>{if(!e){if(!o.keepTransientContextOnFailed){c();n.resetChanges();n.getModel().resetChanges(n.getUpdateGroupId());throw g.Constants.CreationFailed}return{bKeepDialogOpen:true}}else{return a.created()}})};u._getNewAction=function e(t,n,a,o){let r;if(t&&t.preferredMode&&n.toUpperCase().indexOf("I-ACTION=CREATEWITH")>-1){const e=t.preferredMode[0];r=e.toUpperCase().indexOf("CREATEWITH:")>-1?e.substr(e.lastIndexOf(":")+1):undefined}else if(t&&t.preferredMode&&n.toUpperCase().indexOf("I-ACTION=AUTOCREATEWITH")>-1){const e=t.preferredMode[0];r=e.toUpperCase().indexOf("AUTOCREATEWITH:")>-1?e.substr(e.lastIndexOf(":")+1):undefined}else{r=a&&a.getObject!==undefined?a.getObject(`${o}@com.sap.vocabularies.Session.v1.StickySessionSupported/NewAction`)||a.getObject(`${o}@com.sap.vocabularies.Common.v1.DraftRoot/NewAction`):undefined}return r};u._getSpecificCreateActionDialogLabel=function e(t,n,a,o){const r=function(){if(t&&t.getObject(`${n}/@com.sap.vocabularies.UI.v1.LineItem`)){const e=t.getObject(`${n}/@com.sap.vocabularies.UI.v1.LineItem`).findIndex(function(e){const t=e.Action?e.Action.split("("):undefined;return t?t[0]===a:false});return e>-1?t.getObject(`${n}/@com.sap.vocabularies.UI.v1.LineItem`)[e].Label:undefined}else{return undefined}};return r()||t&&t.getObject(`${n}/${a}@com.sap.vocabularies.Common.v1.Label`)||o&&o.getText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE")};return d}();const L=new k;return L},false);