/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log", "sap/fe/core/helpers/ResourceModelHelper", "sap/fe/core/library", "sap/m/MessageBox", "sap/ui/core/Core", "../../operationsHelper"], function (Log, ResourceModelHelper, FELibrary, MessageBox, Core, operationsHelper) {
  "use strict";

  var getResourceModel = ResourceModelHelper.getResourceModel;
  const ProgrammingModel = FELibrary.ProgrammingModel;
  /**
   * Opens a sticky session to edit a document.
   *
   * @function
   * @name sap.fe.core.actions.sticky#editDocumentInStickySession
   * @memberof sap.fe.core.actions.sticky
   * @static
   * @param context Context of the document to be edited
   * @param appComponent The AppComponent
   * @returns A Promise resolved when the sticky session is in edit mode
   * @private
   * @ui5-restricted
   */
  async function editDocumentInStickySession(context, appComponent) {
    const model = context.getModel(),
      metaModel = model.getMetaModel(),
      metaPath = metaModel.getMetaPath(context.getPath()),
      editActionAnnotation = metaModel.getObject(`${metaPath}@com.sap.vocabularies.Session.v1.StickySessionSupported/EditAction`);
    if (!editActionAnnotation) {
      throw new Error(`Edit Action for Sticky Session not found for ${metaPath}`);
    }
    const resourceModel = getResourceModel(appComponent);
    const actionName = resourceModel.getText("C_COMMON_OBJECT_PAGE_EDIT");
    const editAction = model.bindContext(`${editActionAnnotation}(...)`, context, {
      $$inheritExpandSelect: true
    });
    const groupId = "direct";
    const editPromise = editAction.execute(groupId, undefined, operationsHelper.fnOnStrictHandlingFailed.bind(sticky, groupId, {
      label: actionName,
      model
    }, resourceModel, null, null, null, undefined, undefined));
    model.submitBatch(groupId);
    const newContext = await editPromise;
    const sideEffects = appComponent.getSideEffectsService().getODataActionSideEffects(editActionAnnotation, newContext);
    if (sideEffects !== null && sideEffects !== void 0 && sideEffects.triggerActions && sideEffects.triggerActions.length) {
      await appComponent.getSideEffectsService().requestSideEffectsForODataAction(sideEffects, newContext);
    }
    return newContext;
  }
  /**
   * Activates a document and closes the sticky session.
   *
   * @function
   * @name sap.fe.core.actions.sticky#activateDocument
   * @memberof sap.fe.core.actions.sticky
   * @static
   * @param context Context of the document to be activated
   * @param appComponent Context of the document to be activated
   * @returns A promise resolve when the sticky session is activated
   * @private
   * @ui5-restricted
   */
  async function activateDocument(context, appComponent) {
    const model = context.getModel(),
      metaModel = model.getMetaModel(),
      metaPath = metaModel.getMetaPath(context.getPath()),
      saveActionAnnotation = metaModel.getObject(`${metaPath}@com.sap.vocabularies.Session.v1.StickySessionSupported/SaveAction`);
    if (!saveActionAnnotation) {
      throw new Error(`Save Action for Sticky Session not found for ${metaPath}`);
    }
    const resourceModel = getResourceModel(appComponent);
    const actionName = resourceModel.getText("C_OP_OBJECT_PAGE_SAVE");
    const saveAction = model.bindContext(`${saveActionAnnotation}(...)`, context, {
      $$inheritExpandSelect: true
    });
    const groupId = "direct";
    const savePromise = saveAction.execute(groupId, undefined, operationsHelper.fnOnStrictHandlingFailed.bind(sticky, groupId, {
      label: actionName,
      model
    }, resourceModel, null, null, null, undefined, undefined));
    model.submitBatch(groupId);
    try {
      return await savePromise;
    } catch (err) {
      const messagesPath = metaModel.getObject(`${metaPath}/@${"com.sap.vocabularies.Common.v1.Messages"}/$Path`);
      if (messagesPath) {
        try {
          await appComponent.getSideEffectsService().requestSideEffects([messagesPath], context);
        } catch (error) {
          Log.error("Error while requesting side effects", error);
        }
      }
      throw err;
    }
  }
  /**
   * Discards a document and closes sticky session.
   *
   * @function
   * @name sap.fe.core.actions.sticky#discardDocument
   * @memberof sap.fe.core.actions.sticky
   * @static
   * @param context Context of the document to be discarded
   * @returns A promise resolved when the document is dicarded
   * @private
   * @ui5-restricted
   */
  function discardDocument(context) {
    const model = context.getModel(),
      metaModel = model.getMetaModel(),
      metaPath = metaModel.getMetaPath(context.getPath()),
      discardActionAnnotation = metaModel.getObject(`${metaPath}@com.sap.vocabularies.Session.v1.StickySessionSupported/DiscardAction`);
    if (!discardActionAnnotation) {
      throw new Error(`Discard Action for Sticky Session not found for ${metaPath}`);
    }
    const discardAction = model.bindContext(`/${discardActionAnnotation}(...)`);
    const discardPromise = discardAction.execute("direct").then(function () {
      return context;
    });
    model.submitBatch("direct");
    return discardPromise;
  }

  /**
   * Process the Data loss confirmation.
   *
   * @function
   * @name sap.fe.core.actions.sticky#discardDocument
   * @memberof sap.fe.core.actions.sticky
   * @static
   * @param fnProcess Function to execute after confirmation
   * @param view Current view
   * @param programmingModel Programming Model of the current page
   * @returns `void` i think
   * @private
   * @ui5-restricted
   */
  function processDataLossConfirmation(fnProcess, view, programmingModel) {
    const uiEditable = view.getModel("ui").getProperty("/isEditable"),
      resourceBundle = Core.getLibraryResourceBundle("sap.fe.templates"),
      warningMsg = resourceBundle && resourceBundle.getText("T_COMMON_UTILS_NAVIGATION_AWAY_MSG"),
      confirmButtonTxt = resourceBundle && resourceBundle.getText("T_COMMON_UTILS_NAVIGATION_AWAY_CONFIRM_BUTTON"),
      cancelButtonTxt = resourceBundle && resourceBundle.getText("T_COMMON_UTILS_NAVIGATION_AWAY_CANCEL_BUTTON");
    if (programmingModel === ProgrammingModel.Sticky && uiEditable) {
      return MessageBox.warning(warningMsg, {
        actions: [confirmButtonTxt, cancelButtonTxt],
        emphasizedAction: confirmButtonTxt,
        onClose: function (actionText) {
          if (actionText === confirmButtonTxt) {
            Log.info("Navigation confirmed.");
            fnProcess();
          } else {
            Log.info("Navigation rejected.");
          }
        }
      });
    }
    return fnProcess();
  }

  /**
   * Static functions for the sticky session programming model
   *
   * @namespace
   * @alias sap.fe.core.actions.sticky
   * @private
   * @experimental This module is only for experimental use! <br/><b>This is only a POC and maybe deleted</b>
   * @since 1.54.0
   */
  const sticky = {
    editDocumentInStickySession: editDocumentInStickySession,
    activateDocument: activateDocument,
    discardDocument: discardDocument,
    processDataLossConfirmation: processDataLossConfirmation
  };
  return sticky;
}, false);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQcm9ncmFtbWluZ01vZGVsIiwiRkVMaWJyYXJ5IiwiZWRpdERvY3VtZW50SW5TdGlja3lTZXNzaW9uIiwiY29udGV4dCIsImFwcENvbXBvbmVudCIsIm1vZGVsIiwiZ2V0TW9kZWwiLCJtZXRhTW9kZWwiLCJnZXRNZXRhTW9kZWwiLCJtZXRhUGF0aCIsImdldE1ldGFQYXRoIiwiZ2V0UGF0aCIsImVkaXRBY3Rpb25Bbm5vdGF0aW9uIiwiZ2V0T2JqZWN0IiwiRXJyb3IiLCJyZXNvdXJjZU1vZGVsIiwiZ2V0UmVzb3VyY2VNb2RlbCIsImFjdGlvbk5hbWUiLCJnZXRUZXh0IiwiZWRpdEFjdGlvbiIsImJpbmRDb250ZXh0IiwiJCRpbmhlcml0RXhwYW5kU2VsZWN0IiwiZ3JvdXBJZCIsImVkaXRQcm9taXNlIiwiZXhlY3V0ZSIsInVuZGVmaW5lZCIsIm9wZXJhdGlvbnNIZWxwZXIiLCJmbk9uU3RyaWN0SGFuZGxpbmdGYWlsZWQiLCJiaW5kIiwic3RpY2t5IiwibGFiZWwiLCJzdWJtaXRCYXRjaCIsIm5ld0NvbnRleHQiLCJzaWRlRWZmZWN0cyIsImdldFNpZGVFZmZlY3RzU2VydmljZSIsImdldE9EYXRhQWN0aW9uU2lkZUVmZmVjdHMiLCJ0cmlnZ2VyQWN0aW9ucyIsImxlbmd0aCIsInJlcXVlc3RTaWRlRWZmZWN0c0Zvck9EYXRhQWN0aW9uIiwiYWN0aXZhdGVEb2N1bWVudCIsInNhdmVBY3Rpb25Bbm5vdGF0aW9uIiwic2F2ZUFjdGlvbiIsInNhdmVQcm9taXNlIiwiZXJyIiwibWVzc2FnZXNQYXRoIiwicmVxdWVzdFNpZGVFZmZlY3RzIiwiZXJyb3IiLCJMb2ciLCJkaXNjYXJkRG9jdW1lbnQiLCJkaXNjYXJkQWN0aW9uQW5ub3RhdGlvbiIsImRpc2NhcmRBY3Rpb24iLCJkaXNjYXJkUHJvbWlzZSIsInRoZW4iLCJwcm9jZXNzRGF0YUxvc3NDb25maXJtYXRpb24iLCJmblByb2Nlc3MiLCJ2aWV3IiwicHJvZ3JhbW1pbmdNb2RlbCIsInVpRWRpdGFibGUiLCJnZXRQcm9wZXJ0eSIsInJlc291cmNlQnVuZGxlIiwiQ29yZSIsImdldExpYnJhcnlSZXNvdXJjZUJ1bmRsZSIsIndhcm5pbmdNc2ciLCJjb25maXJtQnV0dG9uVHh0IiwiY2FuY2VsQnV0dG9uVHh0IiwiU3RpY2t5IiwiTWVzc2FnZUJveCIsIndhcm5pbmciLCJhY3Rpb25zIiwiZW1waGFzaXplZEFjdGlvbiIsIm9uQ2xvc2UiLCJhY3Rpb25UZXh0IiwiaW5mbyJdLCJzb3VyY2VSb290IjoiLiIsInNvdXJjZXMiOlsic3RpY2t5LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbW1vbkFubm90YXRpb25UZXJtcyB9IGZyb20gXCJAc2FwLXV4L3ZvY2FidWxhcmllcy10eXBlcy92b2NhYnVsYXJpZXMvQ29tbW9uXCI7XG5pbXBvcnQgTG9nIGZyb20gXCJzYXAvYmFzZS9Mb2dcIjtcbmltcG9ydCB0eXBlIEFwcENvbXBvbmVudCBmcm9tIFwic2FwL2ZlL2NvcmUvQXBwQ29tcG9uZW50XCI7XG5pbXBvcnQgeyBnZXRSZXNvdXJjZU1vZGVsIH0gZnJvbSBcInNhcC9mZS9jb3JlL2hlbHBlcnMvUmVzb3VyY2VNb2RlbEhlbHBlclwiO1xuaW1wb3J0IEZFTGlicmFyeSBmcm9tIFwic2FwL2ZlL2NvcmUvbGlicmFyeVwiO1xuaW1wb3J0IE1lc3NhZ2VCb3ggZnJvbSBcInNhcC9tL01lc3NhZ2VCb3hcIjtcbmltcG9ydCBDb3JlIGZyb20gXCJzYXAvdWkvY29yZS9Db3JlXCI7XG5pbXBvcnQgdHlwZSBWaWV3IGZyb20gXCJzYXAvdWkvY29yZS9tdmMvVmlld1wiO1xuaW1wb3J0IHR5cGUgQ29udGV4dCBmcm9tIFwic2FwL3VpL21vZGVsL29kYXRhL3Y0L0NvbnRleHRcIjtcbmltcG9ydCBvcGVyYXRpb25zSGVscGVyIGZyb20gXCIuLi8uLi9vcGVyYXRpb25zSGVscGVyXCI7XG5cbmNvbnN0IFByb2dyYW1taW5nTW9kZWwgPSBGRUxpYnJhcnkuUHJvZ3JhbW1pbmdNb2RlbDtcbi8qKlxuICogT3BlbnMgYSBzdGlja3kgc2Vzc2lvbiB0byBlZGl0IGEgZG9jdW1lbnQuXG4gKlxuICogQGZ1bmN0aW9uXG4gKiBAbmFtZSBzYXAuZmUuY29yZS5hY3Rpb25zLnN0aWNreSNlZGl0RG9jdW1lbnRJblN0aWNreVNlc3Npb25cbiAqIEBtZW1iZXJvZiBzYXAuZmUuY29yZS5hY3Rpb25zLnN0aWNreVxuICogQHN0YXRpY1xuICogQHBhcmFtIGNvbnRleHQgQ29udGV4dCBvZiB0aGUgZG9jdW1lbnQgdG8gYmUgZWRpdGVkXG4gKiBAcGFyYW0gYXBwQ29tcG9uZW50IFRoZSBBcHBDb21wb25lbnRcbiAqIEByZXR1cm5zIEEgUHJvbWlzZSByZXNvbHZlZCB3aGVuIHRoZSBzdGlja3kgc2Vzc2lvbiBpcyBpbiBlZGl0IG1vZGVcbiAqIEBwcml2YXRlXG4gKiBAdWk1LXJlc3RyaWN0ZWRcbiAqL1xuYXN5bmMgZnVuY3Rpb24gZWRpdERvY3VtZW50SW5TdGlja3lTZXNzaW9uKGNvbnRleHQ6IENvbnRleHQsIGFwcENvbXBvbmVudDogQXBwQ29tcG9uZW50KTogUHJvbWlzZTxDb250ZXh0PiB7XG5cdGNvbnN0IG1vZGVsID0gY29udGV4dC5nZXRNb2RlbCgpLFxuXHRcdG1ldGFNb2RlbCA9IG1vZGVsLmdldE1ldGFNb2RlbCgpLFxuXHRcdG1ldGFQYXRoID0gbWV0YU1vZGVsLmdldE1ldGFQYXRoKGNvbnRleHQuZ2V0UGF0aCgpKSxcblx0XHRlZGl0QWN0aW9uQW5ub3RhdGlvbiA9IG1ldGFNb2RlbC5nZXRPYmplY3QoYCR7bWV0YVBhdGh9QGNvbS5zYXAudm9jYWJ1bGFyaWVzLlNlc3Npb24udjEuU3RpY2t5U2Vzc2lvblN1cHBvcnRlZC9FZGl0QWN0aW9uYCk7XG5cblx0aWYgKCFlZGl0QWN0aW9uQW5ub3RhdGlvbikge1xuXHRcdHRocm93IG5ldyBFcnJvcihgRWRpdCBBY3Rpb24gZm9yIFN0aWNreSBTZXNzaW9uIG5vdCBmb3VuZCBmb3IgJHttZXRhUGF0aH1gKTtcblx0fVxuXHRjb25zdCByZXNvdXJjZU1vZGVsID0gZ2V0UmVzb3VyY2VNb2RlbChhcHBDb21wb25lbnQpO1xuXHRjb25zdCBhY3Rpb25OYW1lID0gcmVzb3VyY2VNb2RlbC5nZXRUZXh0KFwiQ19DT01NT05fT0JKRUNUX1BBR0VfRURJVFwiKTtcblx0Y29uc3QgZWRpdEFjdGlvbiA9IG1vZGVsLmJpbmRDb250ZXh0KGAke2VkaXRBY3Rpb25Bbm5vdGF0aW9ufSguLi4pYCwgY29udGV4dCwgeyAkJGluaGVyaXRFeHBhbmRTZWxlY3Q6IHRydWUgfSk7XG5cdGNvbnN0IGdyb3VwSWQgPSBcImRpcmVjdFwiO1xuXHRjb25zdCBlZGl0UHJvbWlzZSA9IGVkaXRBY3Rpb24uZXhlY3V0ZShcblx0XHRncm91cElkLFxuXHRcdHVuZGVmaW5lZCxcblx0XHRvcGVyYXRpb25zSGVscGVyLmZuT25TdHJpY3RIYW5kbGluZ0ZhaWxlZC5iaW5kKFxuXHRcdFx0c3RpY2t5LFxuXHRcdFx0Z3JvdXBJZCxcblx0XHRcdHsgbGFiZWw6IGFjdGlvbk5hbWUsIG1vZGVsIH0sXG5cdFx0XHRyZXNvdXJjZU1vZGVsLFxuXHRcdFx0bnVsbCxcblx0XHRcdG51bGwsXG5cdFx0XHRudWxsLFxuXHRcdFx0dW5kZWZpbmVkLFxuXHRcdFx0dW5kZWZpbmVkXG5cdFx0KVxuXHQpO1xuXHRtb2RlbC5zdWJtaXRCYXRjaChncm91cElkKTtcblxuXHRjb25zdCBuZXdDb250ZXh0OiBDb250ZXh0ID0gYXdhaXQgZWRpdFByb21pc2U7XG5cdGNvbnN0IHNpZGVFZmZlY3RzID0gYXBwQ29tcG9uZW50LmdldFNpZGVFZmZlY3RzU2VydmljZSgpLmdldE9EYXRhQWN0aW9uU2lkZUVmZmVjdHMoZWRpdEFjdGlvbkFubm90YXRpb24sIG5ld0NvbnRleHQpO1xuXHRpZiAoc2lkZUVmZmVjdHM/LnRyaWdnZXJBY3Rpb25zICYmIHNpZGVFZmZlY3RzLnRyaWdnZXJBY3Rpb25zLmxlbmd0aCkge1xuXHRcdGF3YWl0IGFwcENvbXBvbmVudC5nZXRTaWRlRWZmZWN0c1NlcnZpY2UoKS5yZXF1ZXN0U2lkZUVmZmVjdHNGb3JPRGF0YUFjdGlvbihzaWRlRWZmZWN0cywgbmV3Q29udGV4dCk7XG5cdH1cblx0cmV0dXJuIG5ld0NvbnRleHQ7XG59XG4vKipcbiAqIEFjdGl2YXRlcyBhIGRvY3VtZW50IGFuZCBjbG9zZXMgdGhlIHN0aWNreSBzZXNzaW9uLlxuICpcbiAqIEBmdW5jdGlvblxuICogQG5hbWUgc2FwLmZlLmNvcmUuYWN0aW9ucy5zdGlja3kjYWN0aXZhdGVEb2N1bWVudFxuICogQG1lbWJlcm9mIHNhcC5mZS5jb3JlLmFjdGlvbnMuc3RpY2t5XG4gKiBAc3RhdGljXG4gKiBAcGFyYW0gY29udGV4dCBDb250ZXh0IG9mIHRoZSBkb2N1bWVudCB0byBiZSBhY3RpdmF0ZWRcbiAqIEBwYXJhbSBhcHBDb21wb25lbnQgQ29udGV4dCBvZiB0aGUgZG9jdW1lbnQgdG8gYmUgYWN0aXZhdGVkXG4gKiBAcmV0dXJucyBBIHByb21pc2UgcmVzb2x2ZSB3aGVuIHRoZSBzdGlja3kgc2Vzc2lvbiBpcyBhY3RpdmF0ZWRcbiAqIEBwcml2YXRlXG4gKiBAdWk1LXJlc3RyaWN0ZWRcbiAqL1xuYXN5bmMgZnVuY3Rpb24gYWN0aXZhdGVEb2N1bWVudChjb250ZXh0OiBDb250ZXh0LCBhcHBDb21wb25lbnQ6IEFwcENvbXBvbmVudCkge1xuXHRjb25zdCBtb2RlbCA9IGNvbnRleHQuZ2V0TW9kZWwoKSxcblx0XHRtZXRhTW9kZWwgPSBtb2RlbC5nZXRNZXRhTW9kZWwoKSxcblx0XHRtZXRhUGF0aCA9IG1ldGFNb2RlbC5nZXRNZXRhUGF0aChjb250ZXh0LmdldFBhdGgoKSksXG5cdFx0c2F2ZUFjdGlvbkFubm90YXRpb24gPSBtZXRhTW9kZWwuZ2V0T2JqZWN0KGAke21ldGFQYXRofUBjb20uc2FwLnZvY2FidWxhcmllcy5TZXNzaW9uLnYxLlN0aWNreVNlc3Npb25TdXBwb3J0ZWQvU2F2ZUFjdGlvbmApO1xuXG5cdGlmICghc2F2ZUFjdGlvbkFubm90YXRpb24pIHtcblx0XHR0aHJvdyBuZXcgRXJyb3IoYFNhdmUgQWN0aW9uIGZvciBTdGlja3kgU2Vzc2lvbiBub3QgZm91bmQgZm9yICR7bWV0YVBhdGh9YCk7XG5cdH1cblxuXHRjb25zdCByZXNvdXJjZU1vZGVsID0gZ2V0UmVzb3VyY2VNb2RlbChhcHBDb21wb25lbnQpO1xuXHRjb25zdCBhY3Rpb25OYW1lID0gcmVzb3VyY2VNb2RlbC5nZXRUZXh0KFwiQ19PUF9PQkpFQ1RfUEFHRV9TQVZFXCIpO1xuXHRjb25zdCBzYXZlQWN0aW9uID0gbW9kZWwuYmluZENvbnRleHQoYCR7c2F2ZUFjdGlvbkFubm90YXRpb259KC4uLilgLCBjb250ZXh0LCB7ICQkaW5oZXJpdEV4cGFuZFNlbGVjdDogdHJ1ZSB9KTtcblx0Y29uc3QgZ3JvdXBJZCA9IFwiZGlyZWN0XCI7XG5cblx0Y29uc3Qgc2F2ZVByb21pc2UgPSBzYXZlQWN0aW9uLmV4ZWN1dGUoXG5cdFx0Z3JvdXBJZCxcblx0XHR1bmRlZmluZWQsXG5cdFx0b3BlcmF0aW9uc0hlbHBlci5mbk9uU3RyaWN0SGFuZGxpbmdGYWlsZWQuYmluZChcblx0XHRcdHN0aWNreSxcblx0XHRcdGdyb3VwSWQsXG5cdFx0XHR7IGxhYmVsOiBhY3Rpb25OYW1lLCBtb2RlbCB9LFxuXHRcdFx0cmVzb3VyY2VNb2RlbCxcblx0XHRcdG51bGwsXG5cdFx0XHRudWxsLFxuXHRcdFx0bnVsbCxcblx0XHRcdHVuZGVmaW5lZCxcblx0XHRcdHVuZGVmaW5lZFxuXHRcdClcblx0KTtcblxuXHRtb2RlbC5zdWJtaXRCYXRjaChncm91cElkKTtcblxuXHR0cnkge1xuXHRcdHJldHVybiBhd2FpdCBzYXZlUHJvbWlzZTtcblx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0Y29uc3QgbWVzc2FnZXNQYXRoID0gbWV0YU1vZGVsLmdldE9iamVjdChgJHttZXRhUGF0aH0vQCR7Q29tbW9uQW5ub3RhdGlvblRlcm1zLk1lc3NhZ2VzfS8kUGF0aGApIGFzIHN0cmluZyB8IHVuZGVmaW5lZDtcblxuXHRcdGlmIChtZXNzYWdlc1BhdGgpIHtcblx0XHRcdHRyeSB7XG5cdFx0XHRcdGF3YWl0IGFwcENvbXBvbmVudC5nZXRTaWRlRWZmZWN0c1NlcnZpY2UoKS5yZXF1ZXN0U2lkZUVmZmVjdHMoW21lc3NhZ2VzUGF0aF0sIGNvbnRleHQpO1xuXHRcdFx0fSBjYXRjaCAoZXJyb3I6IHVua25vd24pIHtcblx0XHRcdFx0TG9nLmVycm9yKFwiRXJyb3Igd2hpbGUgcmVxdWVzdGluZyBzaWRlIGVmZmVjdHNcIiwgZXJyb3IgYXMgc3RyaW5nKTtcblx0XHRcdH1cblx0XHR9XG5cdFx0dGhyb3cgZXJyO1xuXHR9XG59XG4vKipcbiAqIERpc2NhcmRzIGEgZG9jdW1lbnQgYW5kIGNsb3NlcyBzdGlja3kgc2Vzc2lvbi5cbiAqXG4gKiBAZnVuY3Rpb25cbiAqIEBuYW1lIHNhcC5mZS5jb3JlLmFjdGlvbnMuc3RpY2t5I2Rpc2NhcmREb2N1bWVudFxuICogQG1lbWJlcm9mIHNhcC5mZS5jb3JlLmFjdGlvbnMuc3RpY2t5XG4gKiBAc3RhdGljXG4gKiBAcGFyYW0gY29udGV4dCBDb250ZXh0IG9mIHRoZSBkb2N1bWVudCB0byBiZSBkaXNjYXJkZWRcbiAqIEByZXR1cm5zIEEgcHJvbWlzZSByZXNvbHZlZCB3aGVuIHRoZSBkb2N1bWVudCBpcyBkaWNhcmRlZFxuICogQHByaXZhdGVcbiAqIEB1aTUtcmVzdHJpY3RlZFxuICovXG5mdW5jdGlvbiBkaXNjYXJkRG9jdW1lbnQoY29udGV4dDogQ29udGV4dCkge1xuXHRjb25zdCBtb2RlbCA9IGNvbnRleHQuZ2V0TW9kZWwoKSxcblx0XHRtZXRhTW9kZWwgPSBtb2RlbC5nZXRNZXRhTW9kZWwoKSxcblx0XHRtZXRhUGF0aCA9IG1ldGFNb2RlbC5nZXRNZXRhUGF0aChjb250ZXh0LmdldFBhdGgoKSksXG5cdFx0ZGlzY2FyZEFjdGlvbkFubm90YXRpb24gPSBtZXRhTW9kZWwuZ2V0T2JqZWN0KGAke21ldGFQYXRofUBjb20uc2FwLnZvY2FidWxhcmllcy5TZXNzaW9uLnYxLlN0aWNreVNlc3Npb25TdXBwb3J0ZWQvRGlzY2FyZEFjdGlvbmApO1xuXG5cdGlmICghZGlzY2FyZEFjdGlvbkFubm90YXRpb24pIHtcblx0XHR0aHJvdyBuZXcgRXJyb3IoYERpc2NhcmQgQWN0aW9uIGZvciBTdGlja3kgU2Vzc2lvbiBub3QgZm91bmQgZm9yICR7bWV0YVBhdGh9YCk7XG5cdH1cblxuXHRjb25zdCBkaXNjYXJkQWN0aW9uID0gbW9kZWwuYmluZENvbnRleHQoYC8ke2Rpc2NhcmRBY3Rpb25Bbm5vdGF0aW9ufSguLi4pYCk7XG5cdGNvbnN0IGRpc2NhcmRQcm9taXNlID0gZGlzY2FyZEFjdGlvbi5leGVjdXRlKFwiZGlyZWN0XCIpLnRoZW4oZnVuY3Rpb24gKCkge1xuXHRcdHJldHVybiBjb250ZXh0O1xuXHR9KTtcblx0bW9kZWwuc3VibWl0QmF0Y2goXCJkaXJlY3RcIik7XG5cdHJldHVybiBkaXNjYXJkUHJvbWlzZTtcbn1cblxuLyoqXG4gKiBQcm9jZXNzIHRoZSBEYXRhIGxvc3MgY29uZmlybWF0aW9uLlxuICpcbiAqIEBmdW5jdGlvblxuICogQG5hbWUgc2FwLmZlLmNvcmUuYWN0aW9ucy5zdGlja3kjZGlzY2FyZERvY3VtZW50XG4gKiBAbWVtYmVyb2Ygc2FwLmZlLmNvcmUuYWN0aW9ucy5zdGlja3lcbiAqIEBzdGF0aWNcbiAqIEBwYXJhbSBmblByb2Nlc3MgRnVuY3Rpb24gdG8gZXhlY3V0ZSBhZnRlciBjb25maXJtYXRpb25cbiAqIEBwYXJhbSB2aWV3IEN1cnJlbnQgdmlld1xuICogQHBhcmFtIHByb2dyYW1taW5nTW9kZWwgUHJvZ3JhbW1pbmcgTW9kZWwgb2YgdGhlIGN1cnJlbnQgcGFnZVxuICogQHJldHVybnMgYHZvaWRgIGkgdGhpbmtcbiAqIEBwcml2YXRlXG4gKiBAdWk1LXJlc3RyaWN0ZWRcbiAqL1xuZnVuY3Rpb24gcHJvY2Vzc0RhdGFMb3NzQ29uZmlybWF0aW9uKGZuUHJvY2VzczogRnVuY3Rpb24sIHZpZXc6IFZpZXcsIHByb2dyYW1taW5nTW9kZWw6IHN0cmluZykge1xuXHRjb25zdCB1aUVkaXRhYmxlID0gdmlldy5nZXRNb2RlbChcInVpXCIpLmdldFByb3BlcnR5KFwiL2lzRWRpdGFibGVcIiksXG5cdFx0cmVzb3VyY2VCdW5kbGUgPSBDb3JlLmdldExpYnJhcnlSZXNvdXJjZUJ1bmRsZShcInNhcC5mZS50ZW1wbGF0ZXNcIiksXG5cdFx0d2FybmluZ01zZyA9IHJlc291cmNlQnVuZGxlICYmIHJlc291cmNlQnVuZGxlLmdldFRleHQoXCJUX0NPTU1PTl9VVElMU19OQVZJR0FUSU9OX0FXQVlfTVNHXCIpLFxuXHRcdGNvbmZpcm1CdXR0b25UeHQgPSByZXNvdXJjZUJ1bmRsZSAmJiByZXNvdXJjZUJ1bmRsZS5nZXRUZXh0KFwiVF9DT01NT05fVVRJTFNfTkFWSUdBVElPTl9BV0FZX0NPTkZJUk1fQlVUVE9OXCIpLFxuXHRcdGNhbmNlbEJ1dHRvblR4dCA9IHJlc291cmNlQnVuZGxlICYmIHJlc291cmNlQnVuZGxlLmdldFRleHQoXCJUX0NPTU1PTl9VVElMU19OQVZJR0FUSU9OX0FXQVlfQ0FOQ0VMX0JVVFRPTlwiKTtcblxuXHRpZiAocHJvZ3JhbW1pbmdNb2RlbCA9PT0gUHJvZ3JhbW1pbmdNb2RlbC5TdGlja3kgJiYgdWlFZGl0YWJsZSkge1xuXHRcdHJldHVybiBNZXNzYWdlQm94Lndhcm5pbmcod2FybmluZ01zZywge1xuXHRcdFx0YWN0aW9uczogW2NvbmZpcm1CdXR0b25UeHQsIGNhbmNlbEJ1dHRvblR4dF0sXG5cdFx0XHRlbXBoYXNpemVkQWN0aW9uOiBjb25maXJtQnV0dG9uVHh0LFxuXHRcdFx0b25DbG9zZTogZnVuY3Rpb24gKGFjdGlvblRleHQ6IHN0cmluZykge1xuXHRcdFx0XHRpZiAoYWN0aW9uVGV4dCA9PT0gY29uZmlybUJ1dHRvblR4dCkge1xuXHRcdFx0XHRcdExvZy5pbmZvKFwiTmF2aWdhdGlvbiBjb25maXJtZWQuXCIpO1xuXHRcdFx0XHRcdGZuUHJvY2VzcygpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdExvZy5pbmZvKFwiTmF2aWdhdGlvbiByZWplY3RlZC5cIik7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9KTtcblx0fVxuXHRyZXR1cm4gZm5Qcm9jZXNzKCk7XG59XG5cbi8qKlxuICogU3RhdGljIGZ1bmN0aW9ucyBmb3IgdGhlIHN0aWNreSBzZXNzaW9uIHByb2dyYW1taW5nIG1vZGVsXG4gKlxuICogQG5hbWVzcGFjZVxuICogQGFsaWFzIHNhcC5mZS5jb3JlLmFjdGlvbnMuc3RpY2t5XG4gKiBAcHJpdmF0ZVxuICogQGV4cGVyaW1lbnRhbCBUaGlzIG1vZHVsZSBpcyBvbmx5IGZvciBleHBlcmltZW50YWwgdXNlISA8YnIvPjxiPlRoaXMgaXMgb25seSBhIFBPQyBhbmQgbWF5YmUgZGVsZXRlZDwvYj5cbiAqIEBzaW5jZSAxLjU0LjBcbiAqL1xuY29uc3Qgc3RpY2t5ID0ge1xuXHRlZGl0RG9jdW1lbnRJblN0aWNreVNlc3Npb246IGVkaXREb2N1bWVudEluU3RpY2t5U2Vzc2lvbixcblx0YWN0aXZhdGVEb2N1bWVudDogYWN0aXZhdGVEb2N1bWVudCxcblx0ZGlzY2FyZERvY3VtZW50OiBkaXNjYXJkRG9jdW1lbnQsXG5cdHByb2Nlc3NEYXRhTG9zc0NvbmZpcm1hdGlvbjogcHJvY2Vzc0RhdGFMb3NzQ29uZmlybWF0aW9uXG59O1xuXG5leHBvcnQgZGVmYXVsdCBzdGlja3k7XG4iXSwibWFwcGluZ3MiOiI7QUFBQTtBQUFBO0FBQUE7Ozs7O0VBV0EsTUFBTUEsZ0JBQWdCLEdBQUdDLFNBQVMsQ0FBQ0QsZ0JBQWdCO0VBQ25EO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0VBQ0EsZUFBZUUsMkJBQTJCLENBQUNDLE9BQWdCLEVBQUVDLFlBQTBCLEVBQW9CO0lBQzFHLE1BQU1DLEtBQUssR0FBR0YsT0FBTyxDQUFDRyxRQUFRLEVBQUU7TUFDL0JDLFNBQVMsR0FBR0YsS0FBSyxDQUFDRyxZQUFZLEVBQUU7TUFDaENDLFFBQVEsR0FBR0YsU0FBUyxDQUFDRyxXQUFXLENBQUNQLE9BQU8sQ0FB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