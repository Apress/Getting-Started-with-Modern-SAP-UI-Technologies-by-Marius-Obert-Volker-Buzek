/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/collaboration/ActivityBase","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/converters/MetaModelConverter","sap/m/MessageBox"],function(t,e,n,o,i,s){"use strict";var r={};var c=o.CollaborationUtils;var a=o.Activity;var l=n.isCollaborationConnected;var d=n.initializeCollaboration;var g=n.endCollaboration;var f=n.broadcastCollaborationMessage;const u="/collaboration/myActivity";const p="/collaboration/activeUsers";const C="/collaboration/activities";const v="$auto.sync";const h=function(t){const e=t.getModel("internal");return l(e)};r.isConnected=h;const y=function(t,e,n,o,i,s){if(h(t)){const r=t.getModel("internal");const c=Array.isArray(n)?n.join("|"):n;const l=s===null||s===void 0?void 0:s.join("|");const d=r.getProperty(u);if(e===a.LiveChange){if(d===c){return}else{r.setProperty(u,c)}}else{if(e===a.Undo&&d===null){return}r.setProperty(u,null)}f(e,c,r,o,i,l)}};r.send=y;const b=function(t){return t.getModel().getMetaModel().getObject("/@com.sap.vocabularies.Common.v1.WebSocketBaseURL")};const M=function(t){const e=(t===null||t===void 0?void 0:t.getBindingContext)&&t.getBindingContext();return!!(e&&b(e))};r.isCollaborationEnabled=M;const P=async function(t){const e=t.getModel("internal");const n=c.getMe(t);if(!n){return}const o=t.getBindingContext();const i=b(o);const s=o.getModel().getServiceUrl();if(!i){return}const r=await o.requestProperty("DraftAdministrativeData/DraftUUID");if(!r){return}d(n,i,r,s,e,e=>{x(e,t)});e.setProperty(u,null)};r.connect=P;const m=function(t){const e=t.getModel("internal");g(e)};r.disconnect=m;function x(t,e){var n;const o=e.getModel("internal");let i=o.getProperty(p);let s;let r;const l=R(e,t.clientContent);t.userAction=t.userAction||t.clientAction;const d={id:t.userID,name:t.userDescription,initials:c.formatInitials(t.userDescription),color:c.getUserColor(t.userID,i,[])};let g=d;switch(t.userAction){case a.Join:case a.JoinEcho:if(i.findIndex(t=>t.id===d.id)===-1){i.unshift(d);o.setProperty(p,i)}if(t.userAction===a.Join){f(a.JoinEcho,o.getProperty(u),o)}if(t.userAction===a.JoinEcho){if(t.clientContent){t.userAction=a.LiveChange;x(t,e)}}break;case a.Leave:i=i.filter(t=>t.id!==d.id||t.me);o.setProperty(p,i);const v=o.getProperty(C)||{};const h=function(t){if(Array.isArray(t)){return t.filter(t=>t.id!==d.id)}else{for(const e in t){t[e]=h(t[e])}return t}};h(v);o.setProperty(C,v);break;case a.Change:E(e,t);break;case a.Create:B(e,t);break;case a.Delete:O(e,t);break;case a.Activate:A(e,t.clientContent,c.getText("C_COLLABORATIONDRAFT_ACTIVATE",d.name));break;case a.Discard:A(e,t.clientContent,c.getText("C_COLLABORATIONDRAFT_DISCARD",d.name));break;case a.Action:S(e,t);break;case a.LiveChange:g=d;g.key=w(t.clientContent);let y="";const b=l.split("/");for(let t=1;t<b.length-1;t++){y+=`/${b[t]}`;if(!o.getProperty(C+y)){o.setProperty(C+y,{})}}s=o.getProperty(C+l);s=(n=s)!==null&&n!==void 0&&n.slice?s.slice():[];s.push(g);o.setProperty(C+l,s);break;case a.Undo:s=o.getProperty(C+l);r=w(t.clientContent);o.setProperty(C+l,s.filter(t=>t.key!==r));break}}function A(e,n,o){m(e);s.information(o);e.getBindingContext().getBinding().resetChanges().then(function(){L(n,e)}).catch(function(){t.error("Pending Changes could not be reset - still navigating to active instance");L(n,e)})}function E(t,e){const n=e.clientContent.split("|");const o=t.getModel().getMetaModel();const i=t.getModel("internal");n.forEach(t=>{var e;const n=o.getMetaPath(t);const s=w(t);let r=i.getProperty(C+n)||[];r=((e=r)===null||e===void 0?void 0:e.filter)&&r.filter(t=>t.key!==s);if(r){i.setProperty(C+n,r)}});const s=T(t);const r=s.getBindingContext();const c=n.map(e=>D(t,e));s.getController().editFlow.updateDocument(r,Promise.all(c))}async function D(e,n){const o=e.getModel().getMetaModel();const s=o.getMetaContext(n);const r=i.getInvolvedDataModelObjects(s);const a=n.substring(0,n.lastIndexOf("/"));const l=F(e,a);const d=a.substring(0,a.lastIndexOf("("));const g=d.substring(0,d.lastIndexOf("/"));const f=g?F(e,g):undefined;if(!l&&!f){return}try{const t=[];const i=c.getAppComponent(e).getSideEffectsService();if(l){const e=o.getMetaPath(l.getPath());const s=o.getMetaPath(n).replace(e,"").slice(1);t.push(i.requestSideEffects([s],l,v))}const s=i.computeFieldGroupIds(r.targetEntityType.fullyQualifiedName,r.targetObject.fullyQualifiedName);if(s.length){const n=e.getController();const o=n._sideEffects.getSideEffectsMapForFieldGroups(s,l||f);Object.keys(o).forEach(e=>{const i=o[e];t.push(n._sideEffects.requestSideEffects(i.sideEffects,i.context,v))})}await Promise.all(t)}catch(e){t.error("Failed to update data after change:"+e);throw e}}function O(t,e){const n=T(t);const o=n.getBindingContext();const i=o.getPath();const r=e.clientContent.split("|");const a=r.find(t=>i.startsWith(t));if(a){s.information(c.getText("C_COLLABORATIONDRAFT_DELETE",e.userDescription),{onClose:()=>{const e=o.getModel().getKeepAliveContext(a);e.setKeepAlive(false);const i=I(t,r[0]);n.getController().editFlow.updateDocument(n.getBindingContext(),i);n.getController()._routing.navigateBackFromContext(e)}})}else{const e=I(t,r[0]);n.getController().editFlow.updateDocument(n.getBindingContext(),e)}}function B(t,e){const n=T(t);const o=e.clientContent.split("|");const i=I(t,o[0]);n.getController().editFlow.updateDocument(n.getBindingContext(),i)}async function I(e,n){const o=c.getAppComponent(e);const i=n.substring(0,n.lastIndexOf("/"));const s=F(e,i);if(s){try{const t=[];const e=s.getModel().getMetaModel();const i=e.getMetaPath(n);const r=e.getMetaPath(s.getPath());const c=i.replace(`${r}/`,"");const a=o.getSideEffectsService();t.push(a.requestSideEffects([c],s,v));t.push(a.requestSideEffectsForNavigationProperty(c,s,v));await Promise.all(t)}catch(e){t.error("Failed to update data after collection update:"+e)}}}function S(t,e){var n;const o=T(t);const i=e.clientContent.split("|");const s=e.clientTriggeredActionName||"";const r=(n=e.clientRequestedProperties)===null||n===void 0?void 0:n.split("|");const c=e.clientRefreshListBinding==="true";const a=i.map(e=>k(t,e,s,r));if(c){a.push(I(t,i[0]))}o.getController().editFlow.updateDocument(o.getBindingContext(),Promise.all(a))}async function k(t,e,n,o){const s=F(t,e);if(!s){return}const r=c.getAppComponent(t);const a=r.getSideEffectsService();const l=a.getODataActionSideEffects(n,s);const d=[];if(l){var g;if((g=l.pathExpressions)!==null&&g!==void 0&&g.length){d.push(a.requestSideEffects(l.pathExpressions,s,v))}}if(o&&o.length>0){const n=t.getModel().getMetaModel();const r=R(t,e);const c=i.getInvolvedDataModelObjects(n.getContext(r));const l=c.targetEntityType.entityProperties.map(t=>t.name).filter(t=>o.includes(t));if(l.length>0){d.push(a.requestSideEffects(l,s,v))}}await Promise.all(d)}function F(t,e){if(!e){return undefined}const n=[];while(!e.endsWith(")")){n.unshift(e);e=e.substring(0,e.lastIndexOf("/"))}n.unshift(e);const o=e.substring(0,e.lastIndexOf("("));let i;let s=T(t).getBindingContext();while(s&&!i){var r;if(n.indexOf(s.getPath())>=0){i=s}s=(r=s.getBinding())===null||r===void 0?void 0:r.getContext()}if(i){return i}const c=T(t).getBindingContext().getModel();const a=c.getAllBindings().find(t=>{const e=t.isRelative()?t.getResolvedPath():t.getPath();return t.isA("sap.ui.model.odata.v4.ODataListBinding")&&e===o});i=a===null||a===void 0?void 0:a.getAllCurrentContexts().find(t=>n.indexOf(t.getPath())>=0);return i}function L(t,e){const n=T(e);const o=e.getModel().bindContext(t).getBoundContext();n.getController().routing.navigate(o)}function T(t){const n=c.getAppComponent(t);return e.getCurrentPageView(n)}function w(t){return t.substring(t.lastIndexOf("(")+1,t.lastIndexOf(")"))}function R(t,e){let n="";if(e){const o=e.split("|")[0];n=t.getModel().getMetaModel().getMetaPath(o)}return n}return{connect:P,disconnect:m,isConnected:h,isCollaborationEnabled:M,send:y}},false);