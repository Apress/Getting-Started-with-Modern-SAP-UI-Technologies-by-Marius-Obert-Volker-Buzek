/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/core/helpers/ClassSupport","sap/fe/core/helpers/KeepAliveHelper","sap/fe/core/helpers/ModelHelper","sap/fe/navigation/library","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/mdc/p13n/StateUtil"],function(t,e,r,i,n,o,a,p,s,l,c){"use strict";var f,d,u,y,g,S,h,v,b,w,C,O,A,I,m,P,R,_,j,B,V,E,x,K,D,H,F,M,k,N,T,$,U,z,L,q,G,Q,J,W,X,Y,Z,tt,et,rt,it,nt,ot;var at=i.publicExtension;var pt=i.privateExtension;var st=i.finalExtension;var lt=i.extensible;var ct=i.defineUI5Class;function ft(t,e){t.prototype=Object.create(e.prototype);t.prototype.constructor=t;dt(t,e)}function dt(t,e){dt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,r){e.__proto__=r;return e};return dt(t,e)}function ut(t,e,r,i,n){var o={};Object.keys(i).forEach(function(t){o[t]=i[t]});o.enumerable=!!o.enumerable;o.configurable=!!o.configurable;if("value"in o||o.initializer){o.writable=true}o=r.slice().reverse().reduce(function(r,i){return i(t,e,r)||r},o);if(n&&o.initializer!==void 0){o.value=o.initializer?o.initializer.call(n):void 0;o.initializer=undefined}if(o.initializer===void 0){Object.defineProperty(t,e,o);o=null}return o}const yt="#additionalStates",gt=a.NavType;const St={"sap.ui.fl.variants.VariantManagement":{retrieve:function(t){return{variantId:t.getCurrentVariantKey()}},apply:async function(e,r){try{if(r&&r.variantId!==undefined&&r.variantId!==e.getCurrentVariantKey()){const i=this._checkIfVariantIdIsAvailable(e,r.variantId);let n;if(i){n=r.variantId}else{n=e.getStandardVariantKey();this.controlsVariantIdUnavailable.push(...e.getFor())}try{await l.activateVariant({element:e,variantReference:n});await this._setInitialStatesForDeltaCompute(e)}catch(r){t.error(r);this.invalidateInitialStateForApply.push(...e.getFor());await this._setInitialStatesForDeltaCompute(e)}}else{this._setInitialStatesForDeltaCompute(e)}}catch(e){t.error(e)}}},"sap.m.IconTabBar":{retrieve:function(t){return{selectedKey:t.getSelectedKey()}},apply:function(t,e){if(e&&e.selectedKey){const r=t.getItems().find(function(t){return t.getKey()===e.selectedKey});if(r){t.setSelectedItem(r)}}}},"sap.ui.mdc.FilterBar":{retrieve:async function(t){const e=this.getStateKey(t);const r=await c.retrieveExternalState(t);const i=t.getPropertyInfoSet();const n=r.filter||{};i.filter(function(t){return Object.keys(n).length>0&&t.path&&n[t.path]&&(t.removeFromAppState||n[t.path].length===0)}).forEach(function(t){if(t.path){delete n[t.path]}});return this._getControlState(e,r)},apply:async function(e,r){try{if(r){const t=(r===null||r===void 0?void 0:r.initialState)&&this.invalidateInitialStateForApply.indexOf(e.getId())===-1&&this.controlsVariantIdUnavailable.indexOf(e.getId())===-1;if(t){const t=await c.diffState(e,r.initialState,r.fullState);return c.applyExternalState(e,t)}else{return c.applyExternalState(e,(r===null||r===void 0?void 0:r.fullState)??r)}}}catch(e){t.error(e)}}},"sap.ui.mdc.Table":{retrieve:async function(t){const e=this.getStateKey(t);const r=await c.retrieveExternalState(t);return this._getControlState(e,r)},apply:async function(e,r){try{if(r){const t=(r===null||r===void 0?void 0:r.initialState)&&this.invalidateInitialStateForApply.indexOf(e.getId())===-1&&this.controlsVariantIdUnavailable.indexOf(e.getId())===-1;if(t){var i;if(r.initialState&&!((i=r.initialState)!==null&&i!==void 0&&i.supplementaryConfig)){r.initialState.supplementaryConfig={}}const t=await c.diffState(e,r.initialState,r.fullState);return c.applyExternalState(e,t)}else{if(!r.supplementaryConfig){r.supplementaryConfig={}}return c.applyExternalState(e,(r===null||r===void 0?void 0:r.fullState)??r)}}}catch(e){t.error(e)}},refreshBinding:function(e){const r=e.getRowBinding();if(r){const t=r.getRootBinding();if(t===r){r.refresh()}else{const t=r.getHeaderContext();const e=r.getGroupId();if(t){t.requestSideEffects([{$NavigationPropertyPath:""}],e)}}}else{t.info(`Table: ${e.getId()} was not refreshed. No binding found!`)}}},"sap.ui.mdc.Chart":{retrieve:function(t){return c.retrieveExternalState(t)},apply:function(t,e){if(e){return c.applyExternalState(t,e)}}},"sap.uxap.ObjectPageLayout":{retrieve:function(t){return{selectedSection:t.getSelectedSection()}},apply:function(t,e){if(e){t.setSelectedSection(e.selectedSection)}},refreshBinding:function(e){const i=e.getBindingContext();const a=i&&i.getBinding();if(a){const t=o.getMetaPathForContext(i);const p=n.getControlRefreshStrategyForContextPath(e,t);if(p==="self"){const e=i.getModel(),n=e.getMetaModel(),o=r.getContextPathProperties(n,t,{$kind:"NavigationProperty"})||{},p=Object.keys(o).reduce(function(t,e){if(o[e].$isCollection!==true){t.push({$NavigationPropertyPath:e})}return t},[]),s=[{$PropertyPath:"*"}],l=a.getGroupId();i.requestSideEffects(s.concat(p),l)}else if(p==="includingDependents"){a.refresh()}}else{t.info(`ObjectPage: ${e.getId()} was not refreshed. No binding found!`)}}},"sap.fe.macros.table.QuickFilterContainer":{retrieve:function(t){return{selectedKey:t.getSelectorKey()}},apply:function(t,e){if(e!==null&&e!==void 0&&e.selectedKey){t.setSelectorKey(e.selectedKey)}}},"sap.m.SegmentedButton":{retrieve:function(t){return{selectedKey:t.getSelectedKey()}},apply:function(t,e){if(e!==null&&e!==void 0&&e.selectedKey){t.setSelectedKey(e.selectedKey)}}},"sap.m.Select":{retrieve:function(t){return{selectedKey:t.getSelectedKey()}},apply:function(t,e){if(e!==null&&e!==void 0&&e.selectedKey){t.setSelectedKey(e.selectedKey)}}},"sap.f.DynamicPage":{retrieve:function(t){return{headerExpanded:t.getHeaderExpanded()}},apply:function(t,e){if(e){t.setHeaderExpanded(e.headerExpanded)}}},"sap.ui.core.mvc.View":{retrieve:function(t){const e=t.getController();if(e&&e.viewState){return e.viewState.retrieveViewState(e.viewState)}return{}},apply:function(t,e,r){const i=t.getController();if(i&&i.viewState){return i.viewState.applyViewState(e,r)}},refreshBinding:function(t){const e=t.getController();if(e&&e.viewState){return e.viewState.refreshViewBindings()}}},"sap.ui.core.ComponentContainer":{retrieve:function(t){const e=t.getComponentInstance();if(e){return this.retrieveControlState(e.getRootControl())}return{}},apply:function(t,e,r){const i=t.getComponentInstance();if(i){return this.applyControlState(i.getRootControl(),e,r)}}}};let ht=(f=ct("sap.fe.core.controllerextensions.ViewState"),d=at(),u=st(),y=at(),g=lt(s.After),S=pt(),h=st(),v=pt(),b=st(),w=at(),C=lt(s.After),O=at(),A=lt(s.After),I=at(),m=lt(s.After),P=pt(),R=st(),_=at(),j=lt(s.After),B=pt(),V=st(),E=at(),x=lt(s.After),K=at(),D=st(),H=at(),F=st(),M=at(),k=lt(s.After),N=pt(),T=st(),$=at(),U=lt(s.Instead),z=at(),L=st(),q=pt(),G=at(),Q=lt(s.After),J=at(),W=lt(s.After),X=at(),Y=lt(s.After),Z=pt(),tt=at(),et=lt(s.After),rt=pt(),it=st(),f(nt=(ot=function(r){ft(i,r);function i(){var e;e=r.call(this)||this;e.initialControlStatesMapper={};e.controlsVariantIdUnavailable=[];e.invalidateInitialStateForApply=[];e.viewStateControls=[];e._setInitialStatesForDeltaCompute=async r=>{try{const t=e.viewStateControls;const i=[];const n=[];let o=[];const a=(r===null||r===void 0?void 0:r.getFor())??[];t.filter(function(t){return t&&(!r||a.indexOf(t.getId())>-1)&&(t.isA("sap.ui.mdc.Table")||t.isA("sap.ui.mdc.FilterBar")||t.isA("sap.ui.mdc.Chart"))}).forEach(t=>{if(r){e._addEventListenersToVariantManagement(r,a)}const o=c.retrieveExternalState(t);i.push(o);n.push(e.getStateKey(t))});o=await Promise.all(i);o.forEach((t,r)=>{e.initialControlStatesMapper[n[r]]=t})}catch(e){t.error(e)}};e._iRetrievingStateCounter=0;e._pInitialStateApplied=new Promise(t=>{e._pInitialStateAppliedResolve=t});return e}var n=i.prototype;n.refreshViewBindings=async function t(){const e=await this.collectResults(this.base.viewState.adaptBindingRefreshControls);let r=Promise.resolve();e.filter(t=>t&&t.isA&&t.isA("sap.ui.base.ManagedObject")).forEach(t=>{r=r.then(this.refreshControlBinding.bind(this,t))});return r};n.adaptBindingRefreshControls=function t(e){};n.refreshControlBinding=function e(r){const i=this.getControlRefreshBindingHandler(r);let n=Promise.resolve();if(typeof i.refreshBinding!=="function"){t.info(`refreshBinding handler for control: ${r.getMetadata().getName()} is not provided`)}else{n=n.then(i.refreshBinding.bind(this,r))}return n};n.getControlRefreshBindingHandler=function t(e){const r={};if(e){for(const t in St){if(e.isA(t)){r["refreshBinding"]=St[t].refreshBinding||{};break}}}this.base.viewState.adaptBindingRefreshHandler(e,r);return r};n.adaptBindingRefreshHandler=function t(e,r){};n.onSuspend=function t(){};n.onRestore=function t(){};n.destroy=function t(){delete this._pInitialStateAppliedResolve;r.prototype.destroy.call(this)};n.collectResults=function t(e){const r=[];for(var i=arguments.length,n=new Array(i>1?i-1:0),o=1;o<i;o++){n[o-1]=arguments[o]}n.push(r);e.apply(this,n);return Promise.all(r)};n.adaptControlStateHandler=function t(e,r){};n.getControlStateHandler=function t(e){const r=[],i=[];if(e){for(const t in St){if(e.isA(t)){r.push(Object.assign({},St[t]));break}}}this.base.viewState.adaptControlStateHandler(e,i);return r.concat(i)};n.adaptStateControls=function t(e){};n.getStateKey=function t(e){return this.getView().getLocalId(e.getId())||e.getId()};n.retrieveViewState=async function t(){++this._iRetrievingStateCounter;let r;try{await this._pInitialStateApplied;const t=await this.collectResults(this.base.viewState.adaptStateControls);const i=await Promise.all(t.filter(function(t){return t&&t.isA&&t.isA("sap.ui.base.ManagedObject")}).map(t=>this.retrieveControlState(t).then(e=>({key:this.getStateKey(t),value:e}))));r=i.reduce(function(t,r){const i={};i[r.key]=r.value;return e(t,i)},{});const n=await Promise.resolve(this._retrieveAdditionalStates());if(n&&Object.keys(n).length){r[yt]=n}}finally{--this._iRetrievingStateCounter}return this._iRetrievingStateCounter===0?r:undefined};n.retrieveAdditionalStates=function t(e){};n._retrieveAdditionalStates=function t(){const e={};this.base.viewState.retrieveAdditionalStates(e);return e};n.retrieveControlState=function t(r){const i=this.getControlStateHandler(r);return Promise.all(i.map(t=>{if(typeof t.retrieve!=="function"){throw new Error(`controlStateHandler.retrieve is not a function for control: ${r.getMetadata().getName()}`)}return t.retrieve.call(this,r)})).then(t=>t.reduce(function(t,r){return e(t,r)},{}))};n.applyInitialStateOnly=function t(){return true};n.applyViewState=async function e(r,i){if(this.base.viewState.applyInitialStateOnly()&&this._getInitialStateApplied()){return}try{await this.collectResults(this.base.viewState.onBeforeStateApplied);const t=await this.collectResults(this.base.viewState.adaptStateControls);this.viewStateControls=t;let e=Promise.resolve();let n=false;const o=t.reduce((t,e)=>{if(!e){return t}const r=e.isA("sap.ui.fl.variants.VariantManagement");if(!n){n=r}t=r?[e,...t]:[...t,e];return t},[]);if(!n){this._setInitialStatesForDeltaCompute()}o.filter(function(t){return t.isA("sap.ui.base.ManagedObject")}).forEach(t=>{const n=this.getStateKey(t);e=e.then(this.applyControlState.bind(this,t,r?r[n]:undefined,i))});await e;if(i.navigationType===gt.iAppState){await this.collectResults(this.base.viewState.applyAdditionalStates,r?r[yt]:undefined)}else{await this.collectResults(this.base.viewState.applyNavigationParameters,i);await this.collectResults(this.base.viewState._applyNavigationParametersToFilterbar,i)}}finally{try{await this.collectResults(this.base.viewState.onAfterStateApplied);this._setInitialStateApplied()}catch(e){t.error(e)}}};n._checkIfVariantIdIsAvailable=function t(e,r){const i=e.getVariants();let n=false;i.forEach(function(t){if(t.key===r){n=true}});return n};n._setInitialStateApplied=function t(){if(this._pInitialStateAppliedResolve){const t=this._pInitialStateAppliedResolve;delete this._pInitialStateAppliedResolve;t()}};n._getInitialStateApplied=function t(){return!this._pInitialStateAppliedResolve};n.onBeforeStateApplied=function t(e){};n.onAfterStateApplied=function t(e){};n.applyAdditionalStates=function t(e,r){};n._applyNavigationParametersToFilterbar=function t(e,r){};n.applyNavigationParameters=function t(e,r){};n.applyControlState=function t(e,r,i){const n=this.getControlStateHandler(e);let o=Promise.resolve();n.forEach(t=>{if(typeof t.apply!=="function"){throw new Error(`controlStateHandler.apply is not a function for control: ${e.getMetadata().getName()}`)}o=o.then(t.apply.bind(this,e,r,i))});return o};n.getInterface=function t(){return this};n._getControlState=function t(e,r){const i=this.initialControlStatesMapper;if(Object.keys(i).length>0&&i[e]){if(Object.keys(i[e]).length===0){i[e]={...r}}return{fullState:r,initialState:i[e]}}return r};n._addEventListenersToVariantManagement=function t(e,r){const i={variantManagedControls:r};const n=()=>{this._updateInitialStatesOnVariantChange(r)};e.attachSave(i,n,{});e.attachSelect(i,n,{})};n._updateInitialStatesOnVariantChange=function t(e){const r=this.initialControlStatesMapper;Object.keys(r).forEach(t=>{for(const i of e){if(i.indexOf(t)>-1){r[t]={}}}})};return i}(p),ut(ot.prototype,"refreshViewBindings",[d,u],Object.getOwnPropertyDescriptor(ot.prototype,"refreshViewBindings"),ot.prototype),ut(ot.prototype,"adaptBindingRefreshControls",[y,g],Object.getOwnPropertyDescriptor(ot.prototype,"adaptBindingRefreshControls"),ot.prototype),ut(ot.prototype,"refreshControlBinding",[S,h],Object.getOwnPropertyDescriptor(ot.prototype,"refreshControlBinding"),ot.prototype),ut(ot.prototype,"getControlRefreshBindingHandler",[v,b],Object.getOwnPropertyDescriptor(ot.prototype,"getControlRefreshBindingHandler"),ot.prototype),ut(ot.prototype,"adaptBindingRefreshHandler",[w,C],Object.getOwnPropertyDescriptor(ot.prototype,"adaptBindingRefreshHandler"),ot.prototype),ut(ot.prototype,"onSuspend",[O,A],Object.getOwnPropertyDescriptor(ot.prototype,"onSuspend"),ot.prototype),ut(ot.prototype,"onRestore",[I,m],Object.getOwnPropertyDescriptor(ot.prototype,"onRestore"),ot.prototype),ut(ot.prototype,"collectResults",[P,R],Object.getOwnPropertyDescriptor(ot.prototype,"collectResults"),ot.prototype),ut(ot.prototype,"adaptControlStateHandler",[_,j],Object.getOwnPropertyDescriptor(ot.prototype,"adaptControlStateHandler"),ot.prototype),ut(ot.prototype,"getControlStateHandler",[B,V],Object.getOwnPropertyDescriptor(ot.prototype,"getControlStateHandler"),ot.prototype),ut(ot.prototype,"adaptStateControls",[E,x],Object.getOwnPropertyDescriptor(ot.prototype,"adaptStateControls"),ot.prototype),ut(ot.prototype,"getStateKey",[K,D],Object.getOwnPropertyDescriptor(ot.prototype,"getStateKey"),ot.prototype),ut(ot.prototype,"retrieveViewState",[H,F],Object.getOwnPropertyDescriptor(ot.prototype,"retrieveViewState"),ot.prototype),ut(ot.prototype,"retrieveAdditionalStates",[M,k],Object.getOwnPropertyDescriptor(ot.prototype,"retrieveAdditionalStates"),ot.prototype),ut(ot.prototype,"retrieveControlState",[N,T],Object.getOwnPropertyDescriptor(ot.prototype,"retrieveControlState"),ot.prototype),ut(ot.prototype,"applyInitialStateOnly",[$,U],Object.getOwnPropertyDescriptor(ot.prototype,"applyInitialStateOnly"),ot.prototype),ut(ot.prototype,"applyViewState",[z,L],Object.getOwnPropertyDescriptor(ot.prototype,"applyViewState"),ot.prototype),ut(ot.prototype,"_checkIfVariantIdIsAvailable",[q],Object.getOwnPropertyDescriptor(ot.prototype,"_checkIfVariantIdIsAvailable"),ot.prototype),ut(ot.prototype,"onBeforeStateApplied",[G,Q],Object.getOwnPropertyDescriptor(ot.prototype,"onBeforeStateApplied"),ot.prototype),ut(ot.prototype,"onAfterStateApplied",[J,W],Object.getOwnPropertyDescriptor(ot.prototype,"onAfterStateApplied"),ot.prototype),ut(ot.prototype,"applyAdditionalStates",[X,Y],Object.getOwnPropertyDescriptor(ot.prototype,"applyAdditionalStates"),ot.prototype),ut(ot.prototype,"_applyNavigationParametersToFilterbar",[Z],Object.getOwnPropertyDescriptor(ot.prototype,"_applyNavigationParametersToFilterbar"),ot.prototype),ut(ot.prototype,"applyNavigationParameters",[tt,et],Object.getOwnPropertyDescriptor(ot.prototype,"applyNavigationParameters"),ot.prototype),ut(ot.prototype,"applyControlState",[rt,it],Object.getOwnPropertyDescriptor(ot.prototype,"applyControlState"),ot.prototype),ot))||nt);return ht},false);