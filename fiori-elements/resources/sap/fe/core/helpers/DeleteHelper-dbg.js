/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/controllerextensions/editFlow/draft","sap/m/CheckBox","sap/m/MessageToast","sap/m/Text"],function(e,t,n,o,s){"use strict";var l={};let i;(function(e){e["deletableContexts"]="deletableContexts";e["draftsWithDeletableActive"]="draftsWithDeletableActive";e["createModeContexts"]="createModeContexts";e["unSavedContexts"]="unSavedContexts";e["draftsWithNonDeletableActive"]="draftsWithNonDeletableActive";e["draftsToDeleteBeforeActive"]="draftsToDeleteBeforeActive"})(i||(i={}));l.DeleteOptionTypes=i;let E;(function(e){e["CHECKBOX"]="checkBox";e["TEXT"]="text"})(E||(E={}));l.DeleteDialogContentControl=E;function r(e,t,n,o){o.forEach(e=>{const t=n.indexOf(e);if(t!==-1){n.splice(t,1)}});e.setProperty(t,[]);return[...n]}function a(e,t){let n=e.getProperty("selectedContexts")||[];if(t.type===i.deletableContexts){n=r(e,i.deletableContexts,n,e.getProperty(i.deletableContexts)||[]);n=r(e,i.createModeContexts,n,e.getProperty(i.createModeContexts)||[]);const t=e.getProperty(i.draftsWithDeletableActive)||[];const o=t.map(e=>e.draft);n=r(e,i.draftsWithDeletableActive,n,o)}else{const o=e.getProperty(t.type)||[];n=r(e,t.type,n,o)}e.setProperty("selectedContexts",n);e.setProperty("numberOfSelectedContexts",n.length)}function _(e,t,n,s){const{internalModelContext:l,entitySetName:i}=e;if(l){if(l.getProperty("deleteEnabled")!=undefined){t.forEach(e=>{if(e.selected){a(l,e)}})}l.setProperty("deleteEnabled",t.some(e=>!e.selected))}if(n.length===1){o.show(s.getText("C_TRANSACTION_HELPER_DELETE_TOAST_SINGULAR",undefined,i))}else{o.show(s.getText("C_TRANSACTION_HELPER_DELETE_TOAST_PLURAL",undefined,i))}}function T(e){const t=e.getObject()["DraftAdministrativeData"];return t&&t["InProcessByUser"]||""}function c(e,t,n){let o="";if(t===1&&n.length===1){const t=T(n[0]);o=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_SINGLE_OBJECT_LOCKED",[t])}else if(n.length==1){const s=T(n[0]);o=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_ONE_OBJECT_LOCKED",[t,s])}else if(n.length>1){o=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_LOCKED",[n.length,t])}return o}function f(e,t,n){let o="";if(n===t){if(t===1){o=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_ONLY_DRAFT_OF_NON_DELETABLE_ACTIVE")}else{o=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_ONLY_DRAFTS_OF_NON_DELETABLE_ACTIVE")}}else if(t===1){o=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_DRAFT_OF_NON_DELETABLE_ACTIVE")}else{o=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_DRAFTS_OF_NON_DELETABLE_ACTIVE")}return o}function C(e){const t=e.getObject()["DraftAdministrativeData"];let n="";if(t){n=t["LastChangedByUserDescription"]||t["LastChangedByUser"]||""}return n}function N(e,t,n,o){let s="",l="",i=false;if(t===1&&n.length===1){const t=C(n[0]);s=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_UNSAVED_CHANGES",[t]);i=true}else if(t===n.length){s=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_UNSAVED_CHANGES_MULTIPLE_OBJECTS");i=true}else if(o===n.length){if(n.length===1){const t=C(n[0]);s=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_UNSAVED_AND_FEW_OBJECTS_LOCKED_SINGULAR",[t])}else{s=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_UNSAVED_AND_FEW_OBJECTS_LOCKED_PLURAL")}i=true}else if(o>n.length){if(n.length===1){const t=C(n[0]);l=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_UNSAVED_SINGULAR",[t])}else{l=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_UNSAVED_PLURAL")}}return{infoTxt:s,optionTxt:l,optionWithoutTxt:i}}function A(e,t,n){const{numberOfSelectedContexts:o,lockedContexts:l=[],draftsWithNonDeletableActive:i=[]}=e;const E=o-(l.length+t-i.length);let r="";if(E>0&&(t===0||i.length===t)){if(l.length>0){if(E===1){r=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_ALL_REMAINING_NON_DELETABLE_SINGULAR")}else{r=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_ALL_REMAINING_NON_DELETABLE_PLURAL")}}else if(E===1){r=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_SINGLE_AND_ONE_OBJECT_NON_DELETABLE")}else{r=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_MULTIPLE_AND_ALL_OBJECT_NON_DELETABLE")}}else if(E===1){r=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_ONE_OBJECT_NON_DELETABLE",[o])}else if(E>1){r=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_NON_DELETABLE",[E,o])}return r?new s({text:r}):undefined}function d(e,t){return t.reduce((e,t)=>t.selected&&t.type!==i.draftsToDeleteBeforeActive?e.concat(t.contexts):e,e)}function D(e){const t=[];return e.reduce((e,t)=>t.selected&&t.type===i.draftsToDeleteBeforeActive?e.concat(t.contexts):e,t)}function g(e,t,n,o,l,r){const{numberOfSelectedContexts:a,draftsWithDeletableActive:_,unSavedContexts:T,createModeContexts:c,lockedContexts:f,draftsWithNonDeletableActive:C}=e;let N="";if(_.length>0){const e=[];_.forEach(n=>{if(n.draft.getProperty("DraftAdministrativeData/InProcessByUser")){e.push(n.draft)}t.push(n.siblingInfo.targetContext)});if(e.length>0){r.push({type:i.draftsToDeleteBeforeActive,contexts:e,selected:true})}}if(c.length>0){c.forEach(e=>t.push(e))}if(f.length>0){N=h.getLockedObjectsText(o,a,f)||"";l.push(new s({text:N}))}const A=a!=n-C.length+f.length;const d=A&&h.getNonDeletableText(e,n,o);if(d){l.push(d)}if(T.length>0){const e=h.getUnsavedContextsText(o,a,T,n)||{};if(e.infoTxt){l.push(new s({text:e.infoTxt}))}if(e.optionTxt||e.optionWithoutTxt){r.push({type:i.unSavedContexts,contexts:T,text:e.optionTxt,selected:true,control:E.CHECKBOX})}}if(C.length>0){const e=h.getNonDeletableActivesOfDraftsText(o,C.length,n)||"";if(e){r.push({type:i.draftsWithNonDeletableActive,contexts:C,text:e,selected:true,control:n>0?E.CHECKBOX:E.TEXT})}}}function O(e,t){if(e.length===1){const n=e[0];if(n.text){t.push(new s({text:n.text}))}}else if(e.length>1){e.forEach(e=>{if(e.control==="text"&&e.text){t.push(new s({text:e.text}))}});e.forEach(e=>{if(e.control==="checkBox"&&e.text){t.push(new n({text:e.text,selected:true,select:function(t){const n=t.getSource();const o=n.getSelected();e.selected=o}}))}})}}function L(e,t,n,o){const{numberOfSelectedContexts:s,entitySetName:l,parentControl:r,description:a,lockedContexts:_,draftsWithNonDeletableActive:T,unSavedContexts:c}=e;const f=t.length+T.length+c.length;const C=s-(_.length+f-T.length);if(s===1&&s===t.length){const e=t[0].getObject();const s=r;const _=s&&s.getParent().getIdentifierColumn();let T;let c=[];if(_){const t=_?e[_]:undefined;const o=a&&a.path?e[a.path]:undefined;if(t){if(o&&a&&_!==a.path){c=[t+" ",o]}else{c=[t,""]}T=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO",c,l)}else{T=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",undefined,l)}}else{T=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",undefined,l)}o.push({type:i.deletableContexts,contexts:t,text:T,selected:true,control:E.TEXT})}else if(c.length!==f&&s>0&&(t.length>0||c.length>0&&T.length>0)){if(s>t.length&&C+_.length>0){let e="";if(f===1){e=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR_NON_DELETABLE",undefined,l)}else{e=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_PLURAL_NON_DELETABLE",undefined,l)}o.unshift({type:i.deletableContexts,contexts:t,text:e,selected:true,control:E.TEXT})}else{const e=f===1?n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",undefined,l):n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_PLURAL",undefined,l);o.push({type:i.deletableContexts,contexts:t,text:e,selected:true,control:E.TEXT})}}}async function x(n,o,s,l,i,E){try{const r=h.getConfirmedDeletableContext([],n);const a=D(n);const{beforeDeleteCallBack:_,parentControl:T}=o;if(_){await _({contexts:r})}if(r&&r.length){try{const s=r.length===1?true:false;const _=[];await Promise.allSettled(a.map(function(n){try{return t.deleteDraft(n,i,s)}catch(t){e.error(`FE : core : DeleteHelper : Error while discrding draft with path : ${n.getPath()}`);_.push(t)}}));await Promise.all(r.map(function(e){if(E&&!e.getProperty("IsActiveEntity")){return t.deleteDraft(e,i,s)}return e.delete()}));h.afterDeleteProcess(o,n,r,l);if(_.length>0){throw Error(`FE : core : DeleteHelper : Errors on draft delete : ${_}`)}}catch(e){await s.showMessageDialog({control:T});throw e}}}catch(e){await s.showMessages();throw e}}async function I(e,n){const o=n.map(e=>{const n=e.getModel().getMetaModel().getMetaContext(e.getCanonicalPath());const o=n.getProperty("@Org.OData.Capabilities.V1.DeleteRestrictions/Deletable/$Path");const s=!o&&n.getProperty("@Org.OData.Capabilities.V1.DeleteRestrictions/Deletable")!==false;const l={context:e,isDraftRoot:!!n.getProperty("@com.sap.vocabularies.Common.v1.DraftRoot"),isDraftNode:!!n.getProperty("@com.sap.vocabularies.Common.v1.DraftNode"),isActive:true,hasActive:false,hasDraft:false,locked:false,deletable:o?e.getProperty(o):s,siblingPromise:Promise.resolve(undefined),siblingInfo:undefined,siblingDeletable:false};if(l.isDraftRoot){var i;l.locked=!!((i=e.getObject("DraftAdministrativeData"))!==null&&i!==void 0&&i.InProcessByUser);l.hasDraft=e.getProperty("HasDraftEntity")}if(l.isDraftRoot){l.isActive=e.getProperty("IsActiveEntity");l.hasActive=e.getProperty("HasActiveEntity");if(!l.isActive&&l.hasActive){l.siblingPromise=t.computeSiblingInformation(e,e).then(async e=>{l.siblingInfo=e;if(o){var t;l.siblingDeletable=await(e===null||e===void 0?void 0:(t=e.targetContext)===null||t===void 0?void 0:t.requestProperty(o))}else{l.siblingDeletable=s}})}}return l});await Promise.all(o.map(e=>e.siblingPromise));const s=[{key:"draftsWithDeletableActive",value:o.filter(e=>e.isDraftRoot&&!e.isActive&&e.hasActive&&e.siblingDeletable)},{key:"draftsWithNonDeletableActive",value:o.filter(e=>e.isDraftRoot&&!e.isActive&&e.hasActive&&!e.siblingDeletable)},{key:"lockedContexts",value:o.filter(e=>e.isDraftRoot&&e.isActive&&e.hasDraft&&e.locked)},{key:"unSavedContexts",value:o.filter(e=>e.isDraftRoot&&e.isActive&&e.hasDraft&&!e.locked)},{key:"deletableContexts",value:o.filter(e=>!e.isDraftRoot&&!e.isDraftNode&&e.deletable||e.isDraftRoot&&e.isActive&&!e.hasDraft&&e.deletable||e.isDraftRoot&&!e.isActive&&!e.hasActive||e.isDraftNode&&e.deletable)}];for(const{key:t,value:n}of s){e.setProperty(t,n.map(e=>t==="draftsWithDeletableActive"?{draft:e.context,siblingInfo:e.siblingInfo}:e.context))}}const h={getNonDeletableText:A,deleteConfirmHandler:x,updateOptionsForDeletableTexts:L,updateContentForDeleteDialog:O,updateDraftOptionsForDeletableTexts:g,getConfirmedDeletableContext:d,getLockedObjectsText:c,getUnsavedContextsText:N,getNonDeletableActivesOfDraftsText:f,afterDeleteProcess:_,updateDeleteInfoForSelectedContexts:I};return h},false);