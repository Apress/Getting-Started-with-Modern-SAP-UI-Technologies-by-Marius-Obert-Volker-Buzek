/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/converters/controls/Common/Table","sap/fe/core/converters/controls/ListReport/VisualFilters","sap/fe/core/converters/helpers/ConfigurableObject","sap/fe/core/converters/helpers/IssueManager","sap/fe/core/converters/helpers/Key","sap/fe/core/helpers/BindingToolkit","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/PropertyHelper","../Common/DataVisualization"],function(e,t,n,o,i,a,r,l,s,c,u){"use strict";var d={};var v=u.getSelectionVariant;var p=c.getAssociatedUnitPropertyPath;var f=c.getAssociatedTimezonePropertyPath;var g=c.getAssociatedTextPropertyPath;var h=c.getAssociatedCurrencyPropertyPath;var y=s.enhanceDataModelPath;var m=l.isNavigationProperty;var P=l.isMultipleNavigationProperty;var b=l.isEntitySet;var F=l.isComplexType;var S=a.getExpressionFromAnnotation;var T=a.compileExpression;var E=i.KeyHelper;var x=o.IssueType;var O=o.IssueSeverity;var C=o.IssueCategory;var D=n.Placement;var I=n.OverrideType;var A=n.insertCustomElements;var N=t.getVisualFilters;var U=e.isFilteringCaseSensitive;var R=e.getTypeConfig;var M=e.getSelectionVariantConfiguration;var w;(function(e){e["Default"]="Default";e["Slot"]="Slot"})(w||(w={}));const V="Edm.String";const $="sap.ui.model.odata.type.String";function k(e){const t={};e.Data.forEach(n=>{if(n.$Type==="com.sap.vocabularies.UI.v1.DataField"){var o,i;t[n.Value.path]={group:e.fullyQualifiedName,groupLabel:T(S(e.Label||((o=e.annotations)===null||o===void 0?void 0:(i=o.Common)===null||i===void 0?void 0:i.Label)||e.qualifier))||e.qualifier}}});return t}function L(e){return e.reduce((e,t)=>{t.propertyNames.forEach(t=>{e[t]=true});return e},{})}function j(e,t){if(t&&e.length>0){return e.every(e=>e.enableAnalytics&&t===e.annotation.collection)}return false}function q(e,t){const n=[];return e.map(e=>{const o=e.control.filters;const i=[];for(const e in o){if(Array.isArray(o[e].paths)){const a=o[e].paths;a.forEach(e=>{if(e&&e.annotationPath&&n.indexOf(e.annotationPath)===-1){n.push(e.annotationPath);const o=M(e.annotationPath,t);if(o){i.push(o)}}})}}return i}).reduce((e,t)=>e.concat(t),[])}const H=function(e,t){const n=t.split("/");let o;let i="";while(n.length){let t=n.shift();o=o?`${o}/${t}`:t;const a=e.resolvePath(o);if(P(a)){t+="*"}i=i?`${i}/${t}`:t}return i};const B=function(e,t,n,o,i){var a,r,l;if(t&&t.targetType===undefined&&(o||((a=t.annotations)===null||a===void 0?void 0:(r=a.UI)===null||r===void 0?void 0:(l=r.Hidden)===null||l===void 0?void 0:l.valueOf())!==true)){var s,c,u,d,v,p,f,g;const o=i.getAnnotationEntityType(t);return{key:E.getSelectionFieldKeyFromPath(n),annotationPath:i.getAbsoluteAnnotationPath(n),conditionPath:H(e,n),availability:((s=t.annotations)===null||s===void 0?void 0:(c=s.UI)===null||c===void 0?void 0:(u=c.HiddenFilter)===null||u===void 0?void 0:u.valueOf())===true?"Hidden":"Adaptation",label:T(S(((d=t.annotations.Common)===null||d===void 0?void 0:(v=d.Label)===null||v===void 0?void 0:v.valueOf())||t.name)),group:o.name,groupLabel:T(S((o===null||o===void 0?void 0:(p=o.annotations)===null||p===void 0?void 0:(f=p.Common)===null||f===void 0?void 0:(g=f.Label)===null||g===void 0?void 0:g.valueOf())||o.name))}}return undefined};const W=function(e,t,n,o,i){const a={};if(n){n.forEach(n=>{const r=n.name;const l=(t?`${t}/`:"")+r;const s=B(e,n,l,o,i);if(s){a[l]=s}})}return a};const K=function(e,t,n,o){let i={};if(t){t.forEach(t=>{let a;const r=e.resolvePath(t);if(r===undefined){return}if(m(r)){a=W(e,t,r.targetType.entityProperties,n,o)}else if(F(r.targetType)){a=W(e,t,r.targetType.properties,n,o)}else{const i=t.includes("/")?t.split("/").splice(0,1).join("/"):"";a=W(e,i,[r],n,o)}i={...i,...a}})}return i};const J=function(e,t,n,o){let i=e[t];if(i){delete e[t]}else{i=B(o,o.resolvePath(t),t,true,n)}if(!i){var a;(a=n.getDiagnostics())===null||a===void 0?void 0:a.addIssue(C.Annotation,O.High,x.MISSING_SELECTIONFIELD)}if(i){var r,l;i.availability=i.availability==="Hidden"?"Hidden":"Default";i.isParameter=!!((r=o.annotations)!==null&&r!==void 0&&(l=r.Common)!==null&&l!==void 0&&l.ResultContext)}return i};const G=function(e,t,n,o,i){const a=[];const r={};const l=t.entityProperties;i===null||i===void 0?void 0:i.forEach(e=>{r[e.value]=true});if(e&&e.length>0){e===null||e===void 0?void 0:e.forEach(e=>{const r=e.PropertyName;const l=r===null||r===void 0?void 0:r.value;const s={};i===null||i===void 0?void 0:i.forEach(e=>{s[e.value]=true});if(l&&!(l in o)){if(!(l in s)){const e=X(l,n,t);if(e){a.push(e)}}}})}else if(l){l.forEach(e=>{var i,l;const s=(i=e.annotations)===null||i===void 0?void 0:(l=i.Common)===null||l===void 0?void 0:l.FilterDefaultValue;const c=e.name;if(!(c in o)){if(s&&!(c in r)){const e=X(c,n,t);if(e){a.push(e)}}}})}return a};function z(e){var t,n;const o=e.getDataModelObjectPath();const i=o.startingEntitySet.entityType;const a=!!((t=i.annotations)!==null&&t!==void 0&&(n=t.Common)!==null&&n!==void 0&&n.ResultContext)&&!o.targetEntitySet;const r=a&&e.getConverterContextFor(`/${o.startingEntitySet.name}`);return r?i.entityProperties.map(function(e){return J({},e.name,r,i)}):[]}const Q=function(e,t,n){const o=t.length===0||t.every(e=>!e.applySupported.enableSearch);const i=e.length===0||e.every(e=>(e.enableAnalytics||e.control.type==="TreeTable")&&!e.enableBasicSearch);const a=n.getContextPath();if(a&&o&&i){return true}else{return false}};d.getFilterBarHideBasicSearch=Q;const _=function(e,t){const n=t.getManifestWrapper().getFilterConfiguration();const o=(n===null||n===void 0?void 0:n.filterFields)||{};const i=K(e,Object.keys(o).map(e=>E.getPathFromSelectionFieldKey(e)),true,t);const a={};for(const n in o){const r=o[n];const l=E.getPathFromSelectionFieldKey(n);const s=i[l];const c=r.type==="Slot"?w.Slot:w.Default;const u=r&&r!==null&&r!==void 0&&r.visualFilter?N(e,t,n,o):undefined;a[n]={key:n,type:c,slotName:(r===null||r===void 0?void 0:r.slotName)||n,annotationPath:s===null||s===void 0?void 0:s.annotationPath,conditionPath:(s===null||s===void 0?void 0:s.conditionPath)||l,template:r.template,label:r.label,position:r.position||{placement:D.After},availability:r.availability||"Default",settings:r.settings,visualFilter:u,required:r.required}}return a};d.getManifestFilterFields=_;const X=function(e,t,n){return J({},e,t,n)};d.getFilterField=X;const Y=function(e,t){let n=[];if(e&&e[t]){n=e[t].map(function(e){return e.value})}return n};d.getFilterRestrictions=Y;const Z=function(e){const t={};if(e&&e.FilterExpressionRestrictions){e.FilterExpressionRestrictions.forEach(function(e){var n;if((n=e.Property)!==null&&n!==void 0&&n.value&&e.AllowedExpressions){var o;if(t[(o=e.Property)===null||o===void 0?void 0:o.value]){var i;t[(i=e.Property)===null||i===void 0?void 0:i.value].push(e.AllowedExpressions.toString())}else{var a;t[(a=e.Property)===null||a===void 0?void 0:a.value]=[e.AllowedExpressions.toString()]}}})}return t};d.getFilterAllowedExpression=Z;const ee=function(){return{name:"$search",path:"$search",dataType:$,maxConditions:1}};const te=function(){return{name:"$editState",path:"$editState",groupLabel:"",group:"",dataType:$,hiddenFilter:false}};const ne=function(e){var t;const n=e.getEntitySet();return b(n)?(t=n.annotations.Capabilities)===null||t===void 0?void 0:t.SearchRestrictions:undefined};const oe=function(e,t){var n,o,i;const a=(n=e.getEntitySet())===null||n===void 0?void 0:(o=n.annotations)===null||o===void 0?void 0:(i=o.Capabilities)===null||i===void 0?void 0:i.NavigationRestrictions;const r=a&&a.RestrictedProperties;return r&&r.find(function(e){return e&&e.NavigationProperty&&e.NavigationProperty.value===t})};d.getNavigationRestrictions=oe;const ie=function(e){return{key:e.key,annotationPath:e.annotationPath,conditionPath:e.conditionPath,name:e.conditionPath,label:e.label,hiddenFilter:e.availability==="Hidden",display:"Value",isParameter:e.isParameter,caseSensitive:e.caseSensitive,availability:e.availability,position:e.position,type:e.type,template:e.template,menu:e.menu,required:e.required}};const ae=function(e){const t=["SingleValue","MultiValue","SingleRange","MultiRange","SearchExpression","MultiRangeOrSearchExpression"];e.sort(function(e,n){return t.indexOf(e)-t.indexOf(n)});return e[0]};d.getSpecificAllowedExpression=ae;const re=function(e,t){var n,o,i,a,r,l;const s=e===null||e===void 0?void 0:(n=e.Common)===null||n===void 0?void 0:n.Text,c=s&&(e&&(e===null||e===void 0?void 0:(o=e.Common)===null||o===void 0?void 0:(i=o.Text)===null||i===void 0?void 0:(a=i.annotations)===null||a===void 0?void 0:(r=a.UI)===null||r===void 0?void 0:r.TextArrangement)||t&&(t===null||t===void 0?void 0:(l=t.UI)===null||l===void 0?void 0:l.TextArrangement));if(c){if(c.valueOf()==="UI.TextArrangementType/TextOnly"){return"Description"}else if(c.valueOf()==="UI.TextArrangementType/TextLast"){return"ValueDescription"}return"DescriptionValue"}return s?"DescriptionValue":"Value"};d.displayMode=re;const le=function(e,t,n){var o;let i=ie(t);const a=t.annotationPath;if(!a){return i}const r=e.getConverterContextFor(a).getDataModelObjectPath().targetObject;const l=r===null||r===void 0?void 0:r.annotations;const s=e===null||e===void 0?void 0:(o=e.getDataModelObjectPath().targetObject)===null||o===void 0?void 0:o.annotations;const c=n.formatOptions;const u=n.constraints;i=Object.assign(i,{formatOptions:c,constraints:u,display:re(l,s)});return i};d.fetchPropertyInfo=le;const se=function(e){let t=true;switch(e.filterExpression){case"SearchExpression":case"SingleRange":case"SingleValue":t=false;break;default:break}if(e.type&&e.type.indexOf("Boolean")>0){t=false}return t};d.isMultiValue=se;const ce=function(e){return(e.$Type==="com.sap.vocabularies.UI.v1.DataField"||e.$Type==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"||e.$Type==="com.sap.vocabularies.UI.v1.DataFieldWithNavigationPath")&&e.Value.path.includes("/")};const ue=function(e,t,n){var o;const i=(o=e.Value)===null||o===void 0?void 0:o.$target;if(i){const e=g(i)||h(i)||p(i)||f(i);const o=e?y(t.getDataModelObjectPath(),e).navigationProperties:undefined;if(o!==null&&o!==void 0&&o.length){const e=o[0].name;if(!n.includes(e)){n.push(e)}}}};const de=function(e,t,n){var o,i,a;switch(t.$Type){case"com.sap.vocabularies.UI.v1.DataFieldForAnnotation":switch((o=t.Target)===null||o===void 0?void 0:(i=o.$target)===null||i===void 0?void 0:i.$Type){case"com.sap.vocabularies.UI.v1.FieldGroupType":(a=t.Target.$target.Data)===null||a===void 0?void 0:a.forEach(t=>{de(e,t,n)});break;default:break}break;case"com.sap.vocabularies.UI.v1.DataField":case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":case"com.sap.vocabularies.UI.v1.DataFieldWithNavigationPath":if(ce(t)){const o=y(n.getDataModelObjectPath(),t.Value.path).navigationProperties[0].name;if(!e.includes(o)){e.push(o)}}ue(t,n,e);break;default:break}return e};const ve=function(e){var t,n,o;let i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];let a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"";let r=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;let l=arguments.length>4?arguments[4]:undefined;const s=q(i,e);const c=L(s);const u=e.getEntityType();const d=a&&((t=e.getEntityTypeAnnotation(a))===null||t===void 0?void 0:t.annotation)||((n=u.annotations)===null||n===void 0?void 0:(o=n.UI)===null||o===void 0?void 0:o.SelectionFields)||[];let p=[];if(i.length===0&&!!l){var f;(f=e.getEntityTypeAnnotation(l).annotation)===null||f===void 0?void 0:f.forEach(t=>{p=de(p,t,e)})}const g={...W(u,"",u.entityProperties,r,e),...K(u,p,false,e),...K(u,e.getManifestWrapper().getFilterConfiguration().navigationProperties,r,e)};let h=[];const y=v(u,e);if(y){h=y.SelectOptions}const m=(d===null||d===void 0?void 0:d.reduce((t,n)=>{const o=n.value;if(!(o in c)){let n;if(a.startsWith("@com.sap.vocabularies.UI.v1.SelectionFields")){n=""}else{n=a.split("/@com.sap.vocabularies.UI.v1.SelectionFields")[0]}const i=n?n+"/"+o:o;const r=J(g,i,e,u);if(r){r.group="";r.groupLabel="";t.push(r)}}return t},[]))||[];const P=G(h,u,e,c,d);return{excludedFilterProperties:c,entityType:u,annotatedSelectionFields:d,filterFields:g,propertyInfoFields:m,defaultFilterFields:P}};const pe=function(e){const t=R(e,e===null||e===void 0?void 0:e.type);if((e===null||e===void 0?void 0:e.type)===V&&(t.constraints.nullable===undefined||t.constraints.nullable===true)){t.formatOptions.parseKeepsEmptyString=false}return t};d.fetchTypeConfig=pe;const fe=function(e,t,n,o){let i=le(t,e,o[e.key]),a="";if(e.conditionPath){a=e.conditionPath.replace(/\+|\*/g,"")}if(i){i=Object.assign(i,{maxConditions:!i.isParameter&&se(i)?-1:1,required:e.required??(i.isParameter||n.indexOf(a)>=0),caseSensitive:U(t),dataType:o[e.key].type})}return i};d.assignDataTypeToPropertyInfo=fe;const ge=function(e,t,n){var o;const i=[];const a={};if(n){e=e.concat(n)}e.forEach(function(e){if(e.annotationPath){const n=t.getConverterContextFor(e.annotationPath);const o=n.getDataModelObjectPath().targetObject;i.push(o===null||o===void 0?void 0:o.type);const r=pe(o);a[e.key]=r}else{i.push(V);a[e.key]={type:$}}});const l=t.getEntitySet();const s=b(l)?(o=l.annotations.Capabilities)===null||o===void 0?void 0:o.FilterRestrictions:undefined;const c={};c.RequiredProperties=Y(s,"RequiredProperties")||[];c.NonFilterableProperties=Y(s,"NonFilterableProperties")||[];c.FilterAllowedExpressions=Z(s);const u=t.getContextPath();const d=u.split("/");if(d.length>2){const e=d[d.length-1];d.splice(-1,1);const n=oe(t,e);const o=n&&n.FilterRestrictions;c.RequiredProperties=c.RequiredProperties.concat(Y(o,"RequiredProperties")||[]);c.NonFilterableProperties=c.NonFilterableProperties.concat(Y(o,"NonFilterableProperties")||[]);c.FilterAllowedExpressions={...Z(o)||{},...c.FilterAllowedExpressions}}const v=c.RequiredProperties;const p=c.NonFilterableProperties;const f=[];e.forEach(function(e){const n=e.conditionPath.replace(/\+|\*/g,"");if(p.indexOf(n)===-1){const n=fe(e,t,v,a);f.push(n)}});const g=t.getDataModelObjectPath();if(r.isObjectPathDraftSupported(g)){f.push(te())}const h=ne(t);const y=Boolean(h&&!h.Searchable);if(u&&y!==true){if(!h||h!==null&&h!==void 0&&h.Searchable){f.push(ee())}}return f};d.processSelectionFields=ge;const he=function(e,t,n){return A(e,_(t,n),{availability:I.overwrite,label:I.overwrite,type:I.overwrite,position:I.overwrite,slotName:I.overwrite,template:I.overwrite,settings:I.overwrite,visualFilter:I.overwrite,required:I.overwrite})};d.insertCustomManifestElements=he;const ye=function(e){var t,n;let o=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];let i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"";let a=arguments.length>3?arguments[3]:undefined;let r=arguments.length>4?arguments[4]:undefined;const l=ve(e,o,i,a,r);const s=z(e);let c=JSON.parse(JSON.stringify(l.propertyInfoFields));const u=l.entityType;c=s.concat(c);c=he(c,u,e);const d=ge(c,e,l.defaultFilterFields);d.sort(function(e,t){if(e.groupLabel===undefined||e.groupLabel===null){return-1}if(t.groupLabel===undefined||t.groupLabel===null){return 1}return e.groupLabel.localeCompare(t.groupLabel)});let v=JSON.stringify(d);v=v.replace(/\{/g,"\\{");v=v.replace(/\}/g,"\\}");const p=v;let f=JSON.parse(JSON.stringify(l.propertyInfoFields));f=s.concat(f);const g=l.excludedFilterProperties;const h=u===null||u===void 0?void 0:(t=u.annotations)===null||t===void 0?void 0:(n=t.UI)===null||n===void 0?void 0:n.FilterFacets;let y={};const m=e.getAnnotationsByTerm("UI","com.sap.vocabularies.UI.v1.FieldGroup");if(h===undefined||h.length<0){for(const e in m){y={...y,...k(m[e])}}}else{y=h.reduce((e,t)=>{for(let d=0;d<(t===null||t===void 0?void 0:(n=t.Target)===null||n===void 0?void 0:(o=n.$target)===null||o===void 0?void 0:(i=o.Data)===null||i===void 0?void 0:i.length);d++){var n,o,i,a,r,l,s,c,u;e[t===null||t===void 0?void 0:(a=t.Target)===null||a===void 0?void 0:(r=a.$target)===null||r===void 0?void 0:(l=r.Data[d])===null||l===void 0?void 0:(s=l.Value)===null||s===void 0?void 0:s.path]={group:t===null||t===void 0?void 0:(c=t.ID)===null||c===void 0?void 0:c.toString(),groupLabel:t===null||t===void 0?void 0:(u=t.Label)===null||u===void 0?void 0:u.toString()}}return e},{})}const P=l.filterFields;let b=f.concat(Object.keys(P).filter(e=>!(e in g)).map(e=>Object.assign(P[e],y[e])));const F=e.getContextPath();if(j(o,F)){const e=o[0].aggregates;if(e){const t=Object.keys(e).map(t=>e[t].relativePath);b=b.filter(e=>t.indexOf(e.key)===-1)}}const S=he(b,u,e);const T=U(e);S.forEach(e=>{e.caseSensitive=T});return{selectionFields:S,sPropertyInfo:p}};d.getSelectionFields=ye;const me=function(e,t,n){const o=Y(t,"RequiredProperties");const i=ne(e);const a=Boolean(i&&!i.Searchable);if(o.length>0||a||(n===null||n===void 0?void 0:n.FetchValues)===2){return true}return false};d.getExpandFilterFields=me;return d},false);