/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/converters/helpers/Aggregation","sap/fe/core/converters/helpers/IssueManager","sap/fe/core/helpers/BindingToolkit","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/FilterTemplating"],function(t,e,i,o,n,l){"use strict";var a={};var r=l.isPropertyFilterable;var v=l.getIsRequired;var d=n.checkFilterExpressionRestrictions;var s=o.isEntitySet;var u=i.not;var g=i.compileExpression;var c=e.IssueType;var f=e.IssueSeverity;var p=e.IssueCategory;var P=t.AggregationHelper;const y=function(t,e,i){var o,n,l,a;let r,v,d;let s;const u=i.getCustomAggregateDefinitions();let g=i.getTransAggregations();let c=[];if(e!==null&&e!==void 0&&(o=e.$target)!==null&&o!==void 0&&o.Measures){var f,p,P;c=u.filter(function(t){var i,o,n;return t.qualifier===(e===null||e===void 0?void 0:(i=e.$target)===null||i===void 0?void 0:(o=i.Measures)===null||o===void 0?void 0:(n=o[0])===null||n===void 0?void 0:n.value)});s=c.length>0?c[0].qualifier:e===null||e===void 0?void 0:(f=e.$target)===null||f===void 0?void 0:(p=f.Measures)===null||p===void 0?void 0:(P=p[0])===null||P===void 0?void 0:P.value}if(!c[0]&&e!==null&&e!==void 0&&(n=e.$target)!==null&&n!==void 0&&n.DynamicMeasures){var y,h;s=t.getConverterContextFor(t.getAbsoluteAnnotationPath((y=e.$target.DynamicMeasures)===null||y===void 0?void 0:(h=y[0])===null||h===void 0?void 0:h.value)).getDataModelObjectPath().targetObject.Name;g=i.getAggregatedProperties("AggregatedProperty")}else{g=i.getAggregatedProperties("AggregatedProperties")[0]}const m=e===null||e===void 0?void 0:(l=e.$target)===null||l===void 0?void 0:(a=l.Dimensions[0])===null||a===void 0?void 0:a.value;if(u.some(function(t){return t.qualifier===s})){r=s}else if(g&&g[0]){g.some(function(t){if(t.Name===s){r=t===null||t===void 0?void 0:t.AggregatableProperty.value}})}const A=i.getAggregatableProperties();const L=i.getGroupableProperties();if(A&&A.length){for(const t of A){var E;if((t===null||t===void 0?void 0:(E=t.Property)===null||E===void 0?void 0:E.value)===r){d=true}}}if(L&&L.length){for(const t of L){if((t===null||t===void 0?void 0:t.value)===m){v=true}}}return d&&v};function h(t,e,i,o){var n;let l;const a=o[i];if(a!==null&&a!==void 0&&(n=a.visualFilter)!==null&&n!==void 0&&n.valueList){var h,m,A,L,E,I;const o=a===null||a===void 0?void 0:(h=a.visualFilter)===null||h===void 0?void 0:h.valueList;const n=o.split("#");const gt=n.length>1?`ValueList#${n[1]}`:n[0];const ct=t.resolvePath(i);const ft=ct===null||ct===void 0?void 0:(m=ct.annotations)===null||m===void 0?void 0:(A=m.Common)===null||A===void 0?void 0:A[gt];const pt=(ct===null||ct===void 0?void 0:(L=ct.annotations)===null||L===void 0?void 0:(E=L.Common)===null||E===void 0?void 0:(I=E.ValueListWithFixedValues)===null||I===void 0?void 0:I.valueOf())||false;if(ft){var C,S;const t=ft===null||ft===void 0?void 0:ft.CollectionPath.toString();const o=e.getConverterContextFor(`/${t||((C=e.getEntitySet())===null||C===void 0?void 0:C.name)}`);const n=ft===null||ft===void 0?void 0:ft.Parameters;let a;const h=[];let m=[];const A=o.getParameterEntityType();m=A?A.keys.map(function(t){return t.name}):[];if(e.getContextPath()===o.getContextPath()){m.forEach(function(t){h.push({localDataProperty:t,valueListProperty:t})})}if(n){for(const t of n){var D;const e=(D=t.LocalDataProperty)===null||D===void 0?void 0:D.value;const n=t.ValueListProperty;if(((t===null||t===void 0?void 0:t.$Type)==="com.sap.vocabularies.Common.v1.ValueListParameterInOut"||(t===null||t===void 0?void 0:t.$Type)==="com.sap.vocabularies.Common.v1.ValueListParameterOut")&&i===e){a=t}if(((t===null||t===void 0?void 0:t.$Type)==="com.sap.vocabularies.Common.v1.ValueListParameterInOut"||(t===null||t===void 0?void 0:t.$Type)==="com.sap.vocabularies.Common.v1.ValueListParameterIn")&&i!==e){const t=r(o,n);if(!t){h.push({localDataProperty:e,valueListProperty:n})}}}}if(h&&h.length){h.forEach(function(t){const n=g(d(e.getConverterContextFor(e.getAbsoluteAnnotationPath(t===null||t===void 0?void 0:t.localDataProperty)).getDataModelObjectPath(),["SingleValue"]));const l=g(d(o.getConverterContextFor(o.getAbsoluteAnnotationPath(t===null||t===void 0?void 0:t.valueListProperty)).getDataModelObjectPath(),["SingleValue"]));if(l==="true"&&n==="false"){throw new Error(`FilterRestrictions of ${i} in MainEntitySet and ValueListEntitySet are different`)}})}const L=ft===null||ft===void 0?void 0:ft.PresentationVariantQualifier;const E=ft===null||ft===void 0?void 0:ft.SelectionVariantQualifier;const I=o===null||o===void 0?void 0:(S=o.getEntityType().annotations.UI)===null||S===void 0?void 0:S[`PresentationVariant#${L}`];const gt=new P(o.getEntityType(),o);if(!gt.isAnalyticsSupported()){return undefined}if(I){var V;const n=I===null||I===void 0?void 0:I.Visualizations;const r=`/${ft===null||ft===void 0?void 0:ft.CollectionPath}`||`/${o===null||o===void 0?void 0:(V=o.getEntitySet())===null||V===void 0?void 0:V.name}`;l={};l.contextPath=r;l.isValueListWithFixedValues=pt;let P;for(const t of n){var T;if(((T=t.$target)===null||T===void 0?void 0:T.term)==="com.sap.vocabularies.UI.v1.Chart"){P=t;break}}if(P){var $,F,O,M,R,b,x,N,U,H,q,w,j,Q;const r=y(o,P,gt);if(!r){return}const L=($=P)===null||$===void 0?void 0:(F=$.$target)===null||F===void 0?void 0:(O=F.Dimensions[0])===null||O===void 0?void 0:(M=O.$target)===null||M===void 0?void 0:(R=M.annotations)===null||R===void 0?void 0:(b=R.UI)===null||b===void 0?void 0:(x=b.Hidden)===null||x===void 0?void 0:x.valueOf();const C=(N=P)===null||N===void 0?void 0:(U=N.$target)===null||U===void 0?void 0:(H=U.Dimensions[0])===null||H===void 0?void 0:(q=H.$target)===null||q===void 0?void 0:(w=q.annotations)===null||w===void 0?void 0:(j=w.UI)===null||j===void 0?void 0:(Q=j.HiddenFilter)===null||Q===void 0?void 0:Q.valueOf();if(L===true||C===true){return}else if(n&&n.length){var _,k,G,W,z,B,J,K,X,Y;l.chartAnnotation=P?o===null||o===void 0?void 0:o.getAbsoluteAnnotationPath(`${P.$target.fullyQualifiedName}/$AnnotationPath/`):undefined;const n=(_=o.getEntitySet())===null||_===void 0?void 0:_.name;let r;const y=o===null||o===void 0?void 0:o.getRelativeAnnotationPath(`${I.fullyQualifiedName}/`,o.getEntityType());if(A){r=o.getContextPath()+"/"+y}else{r="/"+n+"/"+y}l.presentationAnnotation=I?r:undefined;l.outParameter=(k=a)===null||k===void 0?void 0:(G=k.LocalDataProperty)===null||G===void 0?void 0:G.value;l.inParameters=h;l.valuelistProperty=(W=a)===null||W===void 0?void 0:W.ValueListProperty;const L=d(e.getConverterContextFor(e.getAbsoluteAnnotationPath(i)).getDataModelObjectPath(),["SingleRange","MultiRange"]);if(g(L)==="true"){e.getDiagnostics().addIssue(p.Annotation,f.High,c.MALFORMED_VISUALFILTERS.VALUELIST);return undefined}const C=d(e.getConverterContextFor(e.getAbsoluteAnnotationPath(i)).getDataModelObjectPath(),["SingleValue"]);l.multipleSelectionAllowed=g(u(C));l.required=v(e,i);let S;if(E){var Z,tt;S=o===null||o===void 0?void 0:(Z=o.getEntityTypeAnnotation(`@UI.SelectionVariant#${E}`))===null||Z===void 0?void 0:Z.annotation;let t;const e=o===null||o===void 0?void 0:o.getRelativeAnnotationPath(`${(tt=S)===null||tt===void 0?void 0:tt.fullyQualifiedName}/`,o.getEntityType());if(A){t=o.getContextPath()+"/"+e}else{t="/"+n+"/"+e}l.selectionVariantAnnotation=S?t:undefined}let D=[];if(A){var et,it,ot,nt,lt;const i=t.split("/")[0];const o=t.split("/")[1];const n=e.getConverterContextFor(`/${i}`);const l=n===null||n===void 0?void 0:(et=n.getDataModelObjectPath().startingEntitySet)===null||et===void 0?void 0:(it=et.annotations)===null||it===void 0?void 0:(ot=it.Capabilities)===null||ot===void 0?void 0:(nt=ot.NavigationRestrictions)===null||nt===void 0?void 0:nt.RestrictedProperties;const a=l===null||l===void 0?void 0:l.find(t=>{var e;if(((e=t.NavigationProperty)===null||e===void 0?void 0:e.type)==="NavigationPropertyPath"){return t.NavigationProperty.value===o}});D=(a===null||a===void 0?void 0:(lt=a.FilterRestrictions)===null||lt===void 0?void 0:lt.RequiredProperties)??[]}else{const t=o===null||o===void 0?void 0:o.getEntitySet();if(s(t)){var at,rt;D=((at=t.annotations.Capabilities)===null||at===void 0?void 0:(rt=at.FilterRestrictions)===null||rt===void 0?void 0:rt.RequiredProperties)??[]}}let V=[];if((z=D)!==null&&z!==void 0&&z.length){D.forEach(function(t){V.push(t.value)})}V=V.concat(m);l.requiredProperties=V;if((B=l.requiredProperties)!==null&&B!==void 0&&B.length){if(!l.inParameters||!l.inParameters.length){if(!l.selectionVariantAnnotation){l.showOverlayInitially=true}else{var vt,dt,st,ut;let t=((vt=S)===null||vt===void 0?void 0:(dt=vt.SelectOptions)===null||dt===void 0?void 0:dt.map(t=>{var e;return(e=t.PropertyName)===null||e===void 0?void 0:e.value}))||[];const e=((st=S)===null||st===void 0?void 0:(ut=st.Parameters)===null||ut===void 0?void 0:ut.map(t=>{var e;return(e=t.PropertyName)===null||e===void 0?void 0:e.value}))||[];t=t.concat(e);V=V.sort();t=t.sort();l.showOverlayInitially=V.some(function(e){return t.indexOf(e)===-1})}}else{l.showOverlayInitially=false}}else{l.showOverlayInitially=false}const T=(J=P)===null||J===void 0?void 0:(K=J.$target)===null||K===void 0?void 0:(X=K.Dimensions[0])===null||X===void 0?void 0:(Y=X.$target)===null||Y===void 0?void 0:Y.type;if(!(T==="Edm.DateTimeOffset"||T==="Edm.Date"||T==="Edm.TimeOfDay")&&P.$target.ChartType==="UI.ChartType/Line"){l.renderLineChart=false}else{l.renderLineChart=true}}}else{e.getDiagnostics().addIssue(p.Annotation,f.High,c.MALFORMED_VISUALFILTERS.CHART);return}}else{e.getDiagnostics().addIssue(p.Annotation,f.High,c.MALFORMED_VISUALFILTERS.PRESENTATIONVARIANT)}}else{e.getDiagnostics().addIssue(p.Annotation,f.High,c.MALFORMED_VISUALFILTERS.VALUELIST)}}else{e.getDiagnostics().addIssue(p.Manifest,f.High,c.MALFORMED_VISUALFILTERS.VALUELIST)}return l}a.getVisualFilters=h;return a},false);