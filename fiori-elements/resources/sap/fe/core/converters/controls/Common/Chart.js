/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/converters/annotations/DataField","sap/fe/core/converters/controls/Common/Action","sap/fe/core/converters/helpers/ConfigurableObject","sap/fe/core/converters/helpers/Key","sap/fe/core/helpers/BindingToolkit","sap/fe/core/templating/DataModelPathHelper","sap/ui/core/Core","../../helpers/Aggregation","../../helpers/ID","../../ManifestSettings"],function(t,e,n,a,o,i,r,l,s,g,c){"use strict";var p={};var u=c.VisualizationType;var d=c.VariantManagementType;var v=c.TemplateType;var f=c.ActionType;var m=g.getFilterBarID;var y=g.getChartID;var h=s.AggregationHelper;var b=r.getTargetObjectPath;var P=i.not;var A=i.getExpressionFromAnnotation;var T=i.equal;var S=i.compileExpression;var C=o.KeyHelper;var M=a.OverrideType;var O=a.insertCustomElements;var D=n.getActionsFromManifest;var F=e.isDataFieldForActionAbstract;function I(t,e,n){const a=[];if(t){const e=t.Actions||[];e.forEach(t=>{var e;let o;if(F(t)&&!t.Inline&&!t.Determining){const a=C.generateKeyFromDataField(t);switch(t.$Type){case"com.sap.vocabularies.UI.v1.DataFieldForAction":if(!((e=t.ActionTarget)!==null&&e!==void 0&&e.isBound)){o={type:f.DataFieldForAction,annotationPath:n.getEntitySetBasedAnnotationPath(t.fullyQualifiedName),key:a,visible:$(t,n)}}break;case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":o={type:f.DataFieldForIntentBasedNavigation,annotationPath:n.getEntitySetBasedAnnotationPath(t.fullyQualifiedName),key:a,visible:$(t,n),isNavigable:true};break}}if(o){a.push(o)}})}return a}function E(t,e,n){const a=I(t,e,n);const o=D(n.getManifestControlConfiguration(e).actions,n,a);const i={enabled:M.overwrite,enableOnSelect:M.overwrite,visible:M.overwrite,command:M.overwrite};const r=O(a,o.actions,i);return{actions:r,commandActions:o.commandActions}}p.getChartActions=E;function N(t,e){var n;const a=e.getManifestWrapper();const o=e.getManifestControlConfiguration(t);const i=a.getVariantManagement();const r=[];const l=o===null||o===void 0?void 0:(n=o.chartSettings)===null||n===void 0?void 0:n.personalization;const s=i===d.Control?true:false;if(l!==undefined&&!l||l=="false"){return undefined}switch(true){case typeof l==="object":if(l.type){r.push("Type")}if(l.item){r.push("Item")}if(l.sort){r.push("Sort")}if(l.filter){r.push("Filter")}return r.join(",");case s:case!!l:return"Sort,Type,Item,Filter";default:return"Sort,Type,Item"}}p.getP13nMode=N;function V(t){var e;return(t===null||t===void 0?void 0:(e=t.annotationPath)===null||e===void 0?void 0:e.indexOf(`@${"com.sap.vocabularies.UI.v1.SelectionPresentationVariant"}`))!==-1?t===null||t===void 0?void 0:t.annotationPath:undefined}function w(e,n,a,o,i){var r;const s=new h(a.getEntityType(),a);if(!o&&!s.isAnalyticsSupported()){throw new Error("ApplySupported is not added to the annotations")}const g=s.getTransAggregations();const c=s.getCustomAggregateDefinitions();const p=a.getManifestWrapper();const d=p.getVariantManagement();const f=N(n,a);if(f===undefined&&d==="Control"){t.warning("Variant Management cannot be enabled when personalization is disabled")}const P={};const A=V(i);if(c){const t=s.getEntityType();for(const e of c){var T,S,C,M,O;const n=e===null||e===void 0?void 0:(T=e.annotations)===null||T===void 0?void 0:(S=T.Aggregation)===null||S===void 0?void 0:S.ContextDefiningProperties;const a=e===null||e===void 0?void 0:e.qualifier;const o=a&&t.entityProperties.find(t=>t.name===a);const i=o&&(o===null||o===void 0?void 0:(C=o.annotations)===null||C===void 0?void 0:(M=C.Common)===null||M===void 0?void 0:(O=M.Label)===null||O===void 0?void 0:O.toString());P[a]={name:a,label:i||`Custom Aggregate (${a})`,sortable:true,sortOrder:"both",contextDefiningProperty:n?n.map(t=>t.value):[]}}}const D={};const F=l.getLibraryResourceBundle("sap.fe.core");if(g){for(let t=0;t<g.length;t++){var I,w,$,z,L,x;D[g[t].Name]={name:g[t].Name,propertyPath:g[t].AggregatableProperty.valueOf().value,aggregationMethod:g[t].AggregationMethod,label:(I=g[t])!==null&&I!==void 0&&(w=I.annotations)!==null&&w!==void 0&&($=w.Common)!==null&&$!==void 0&&$.Label?(z=g[t])===null||z===void 0?void 0:(L=z.annotations)===null||L===void 0?void 0:(x=L.Common)===null||x===void 0?void 0:x.Label.toString():`${F.getText("AGGREGATABLE_PROPERTY")} (${g[t].Name})`,sortable:true,sortOrder:"both",custom:false}}}const G=s.getAggregatableProperties();const j=s.getGroupableProperties();const k={};k.$Type="Org.OData.Aggregation.V1.ApplySupportedType";k.AggregatableProperties=[];k.GroupableProperties=[];for(let t=0;G&&t<G.length;t++){var R,H,Q;const e={$Type:(R=G[t])===null||R===void 0?void 0:R.$Type,Property:{$PropertyPath:(H=G[t])===null||H===void 0?void 0:(Q=H.Property)===null||Q===void 0?void 0:Q.value}};k.AggregatableProperties.push(e)}for(let t=0;j&&t<j.length;t++){var U;const e={$PropertyPath:(U=j[t])===null||U===void 0?void 0:U.value};k.GroupableProperties.push(e)}const W=E(e,n,a);let[K]=n.split("@");if(K.lastIndexOf("/")===K.length-1){K=K.substr(0,K.length-1)}const q=((r=e.Title)===null||r===void 0?void 0:r.toString())||"";const J=a.getDataModelObjectPath();const Y=K.length===0;const _=J.targetEntitySet?J.targetEntitySet.name:J.startingEntitySet.name;const X=Y?m(a.getContextPath()):undefined;const Z={legendGroup:{layout:{position:"bottom"}}};let tt;if(a.getTemplateType()===v.ObjectPage){tt=true}else if(a.getTemplateType()===v.ListReport||a.getTemplateType()===v.AnalyticalListPage){tt=false}const et=a.getManifestWrapper().hasMultipleVisualizations()||a.getTemplateType()===v.AnalyticalListPage;const nt=et?".handlers.onSegmentedButtonPressed":"";const at=et?"{= ${pageInternal>alpContentView} !== 'Table'}":"true";const ot=s.getAllowedTransformations();k.enableSearch=ot?ot.indexOf("search")>=0:true;let it="";if(e.fullyQualifiedName.split("#").length>1){it=e.fullyQualifiedName.split("#")[1]}return{type:u.Chart,id:it?y(Y?_:K,it,u.Chart):y(Y?_:K,u.Chart),collection:b(a.getDataModelObjectPath()),entityName:_,personalization:N(n,a),navigationPath:K,annotationPath:a.getAbsoluteAnnotationPath(n),filterId:X,vizProperties:JSON.stringify(Z),actions:W.actions,commandActions:W.commandActions,title:q,autoBindOnInit:tt,onSegmentedButtonPressed:nt,visible:at,customAgg:P,transAgg:D,applySupported:k,selectionPresentationVariantPath:A,variantManagement:B(f,d)}}p.createChartVisualization=w;function B(t,e){return e==="Control"&&!t?d.None:e}function $(t,e){var n,a;return S(P(T(A((n=t.annotations)===null||n===void 0?void 0:(a=n.UI)===null||a===void 0?void 0:a.Hidden,[],undefined,e.getRelativeModelPathFunction()),true)))}function z(t){const e=t.getManifestWrapper().hasMultipleVisualizations()||t.getTemplateType()===v.AnalyticalListPage;const n=t.getDataModelObjectPath();const a=n.targetEntitySet?n.targetEntitySet.name:n.startingEntitySet.name;const o={type:u.Chart,id:y(a,u.Chart),entityName:a,title:"",collection:"",personalization:undefined,navigationPath:"",annotationPath:"",vizProperties:JSON.stringify({legendGroup:{layout:{position:"bottom"}}}),actions:[],commandActions:{},autoBindOnInit:false,onSegmentedButtonPressed:"",visible:e?"{= ${pageInternal>alpContentView} !== 'Table'}":"true",customAgg:{},transAgg:{},applySupported:{$Type:"Org.OData.Aggregation.V1.ApplySupportedType",AggregatableProperties:[],GroupableProperties:[],enableSearch:false},multiViews:false,variantManagement:d.None};return o}p.createBlankChartVisualization=z;return p},false);