/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepEqual","sap/fe/core/CommonUtils","sap/fe/core/converters/controls/ListReport/FilterBar","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/MetaModelFunction","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/DisplayModeFormatter","sap/fe/core/templating/PropertyHelper","sap/fe/core/type/EDM","sap/fe/core/type/TypeUtil","sap/fe/macros/DelegateUtil","sap/ui/core/Core","sap/ui/mdc/odata/v4/TableDelegate","sap/ui/mdc/odata/v4/util/DelegateUtil","sap/ui/mdc/util/FilterUtil","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter"],function(e,t,n,o,r,i,a,s,l,c,p,f,d,u,g,h,y,v,m,b,C){"use strict";var P=f.isTypeFilterable;var I=p.getLabel;var M=p.getAssociatedUnitPropertyPath;var T=p.getAssociatedTimezonePropertyPath;var O=p.getAssociatedTextPropertyPath;var D=p.getAssociatedCurrencyPropertyPath;var x=c.getDisplayMode;var $=l.getTargetObjectPath;var F=l.enhanceDataModelPath;var B=s.isProperty;var j=i.isMultiValueFilterExpression;var E=i.getSortRestrictionsInfo;var U=i.getFilterRestrictionsInfo;var w=r.getInvolvedDataModelObjects;var S=o.fetchTypeConfig;const _=Object.assign({},h);_.fetchProperties=function(e){const t=this._getModel(e);let n;if(!t){n=new Promise(t=>{e.attachModelContextChange({resolver:t},A,this)}).then(t=>this._createPropertyInfos(e,t))}else{n=this._createPropertyInfos(e,t)}return n.then(function(t){u.setCachedProperties(e,t);e.getBindingContext("internal").setProperty("tablePropertiesAvailable",true);return t})};_.createInternalBindingContext=function(e){let t=e;while(t&&!t.isA("sap.ui.mdc.valuehelp.Dialog")){t=t.getParent()}const n=e.getModel("internal");if(t&&n){const o=t.getBindingContext("internal").getPath()+`::VHDialog::${t.getId()}::table`;const r=n.bindContext(o).getBoundContext();e.setBindingContext(r,"internal")}};function A(e,t){const n=e.getSource();_.createInternalBindingContext(n);const o=this._getModel(n);if(o){n.detachModelContextChange(A);t.resolver(o)}}function R(e){const t=L(e);const n={};if(t!==null&&t!==void 0&&t.targetObject){var o,r,i,a,s;const l=t.targetObject;const c=$(t,true);const p=e.targetObject;const f=$(e,true);const d=(o=p.annotations)===null||o===void 0?void 0:(r=o.Common)===null||r===void 0?void 0:r.Text,u=d===null||d===void 0?void 0:(i=d.annotations)===null||i===void 0?void 0:(a=i.UI)===null||a===void 0?void 0:(s=a.TextArrangement)===null||s===void 0?void 0:s.toString(),g=d&&u&&x(p);if(g==="Description"){n[c]=l}else if(g&&g!=="Value"||!d){n[f]=p;n[c]=l}}return n}_._createPropertyInfos=function(e,t){const n=e.getDelegate().payload;const o=[];const r=`/${n.collectionName}`;const i=t.getMetaModel();return i.requestObject(`${r}@`).then(function(t){const n=E(t);const i=t["@Org.OData.Capabilities.V1.FilterRestrictions"];const a=U(i);const s=u.getCustomData(e,"columns");const l={};const c=w(e.getModel().getMetaModel().getContext(r));s.customData.forEach(function(t){const r={name:t.path,label:t.label,sortable:N(n,t),filterable:V(i,t),maxConditions:k(a,t),typeConfig:P(t.$Type)?e.getTypeUtil().getTypeConfig(t.$Type):undefined};const s=F(c,t.path);const p=s.targetObject;if(p){const n=$(s,true);let o;if(P(p.type)){const n=S(p);o=d.getTypeConfig(n.type,n.formatOptions,n.constraints)??e.getTypeUtil().getTypeConfig(t.$Type)}const i=R(s);const a=Object.keys(i);if(a.length){r.propertyInfos=a;r.sortable=false;r.filterable=false;a.forEach(e=>{l[e]=i[e]});if(!a.find(e=>i[e]===p)){l[n]=p}}else{r.path=t.path}r.typeConfig=r.typeConfig?o:undefined}else{r.path=t.path}o.push(r)});const p=H(l,o,n,a);return o.concat(p)})};_.updateBindingInfo=function(e,t){h.updateBindingInfo.apply(this,[e,t]);if(!e){return}const o=e.getDelegate().payload;if(o&&t){t.path=t.path||o.collectionPath||`/${o.collectionName}`;t.model=t.model||o.model}if(!t){t={}}const r=g.byId(e.getFilter()),i=e.isFilteringEnabled();let s;let l,c;const p=[];const f=u.getCachedProperties(e);if(i){s=e.getConditions();l=v.getFilterInfo(e,s,f,[]);if(l.filters){p.push(l.filters)}}if(r){s=r.getConditions();if(s){const n=y.getParameterNames(r);_._updatePropertyInfo(f,e,s,o);c=v.getFilterInfo(r,s,f,n);if(c.filters){p.push(c.filters)}const i=y.getParametersInfo(r,s);if(i){t.path=i}}t.parameters.$search=n.normalizeSearchTerm(r.getSearch())||undefined}this._applyDefaultSorting(t,e.getDelegate().payload);t.parameters.$select=f===null||f===void 0?void 0:f.reduce(function(e,t){if(t.path&&t.path.indexOf("/")===-1){e=e?`${e},${t.path}`:t.path}return e},"");t.parameters.$count=true;if(a.isDraftSupported(e.getModel().getMetaModel(),t.path)){p.push(new m("IsActiveEntity",b.EQ,true))}t.filters=new m(p,true)};_.getTypeUtil=function(){return d};_._getModel=function(e){const t=e.getDelegate().payload;return e.getModel(t.model)};_._applyDefaultSorting=function(e,t){if(e.parameters&&e.parameters.$search==undefined&&e.sorter&&e.sorter.length==0){const n=t?t.defaultSortPropertyName:undefined;if(n){e.sorter.push(new C(n,false))}}};_._updatePropertyInfo=function(e,t,n,o){const r=Object.keys(n),i=t.getModel().getMetaModel();r.forEach(function(n){if(e.findIndex(function(e){return e.path===n})===-1){const r={path:n,typeConfig:t.getTypeUtil().getTypeConfig(i.getObject(`/${o.collectionName}/${n}`).$Type)};e.push(r)}})};_.updateBinding=function(n,o,r){let i=false;const a=n.getBindingContext("internal");const s="pendingManualBindingUpdate";const l=a===null||a===void 0?void 0:a.getProperty(s);let c=n.getRowBinding();h.updateBinding.apply(_,[n,o,r]);if(!c){c=n.getRowBinding()}if(c){const e=c.getFilters("Application");i=t(o.filters,e[0])&&c.getQueryOptionsFromParameters().$search===o.parameters.$search&&!l}if(i&&n.getFilter()){a===null||a===void 0?void 0:a.setProperty(s,true);c.requestRefresh(c.getGroupId()).finally(function(){a===null||a===void 0?void 0:a.setProperty(s,false)}).catch(function(t){e.error("Error while refreshing a filterBar VH table",t)})}n.fireEvent("bindingUpdated")};function H(e,t,n,o){const r={},i=[];Object.keys(e).forEach(a=>{const s=e[a],l=t.find(e=>e.path===a);if(!l){const e=`Property::${a}`;r[a]=e;const t={name:e,label:I(s),path:a,sortable:N(n,s),filterable:V(o,s)};t.maxConditions=k(o,t);if(P(s.type)){const e=S(s);t.typeConfig=d.getTypeConfig(e.type,e.formatOptions,e.constraints)}i.push(t)}});t.forEach(e=>{if(e.propertyInfos){var t;e.propertyInfos=(t=e.propertyInfos)===null||t===void 0?void 0:t.map(e=>r[e]??e)}});return i}function N(e,t){const n=q(t);return n&&e.propertyInfo[n]?e.propertyInfo[n].sortable:t.sortable??true}function V(e,t){const n=q(t);return n&&e!==null&&e!==void 0&&e.propertyInfo.hasOwnProperty(n)?e.propertyInfo[n].filterable:t.filterable??true}function k(e,t){var n;const o=q(t);return(n=e.propertyInfo)!==null&&n!==void 0&&n.hasOwnProperty(o)&&o&&j(e.propertyInfo[o])?-1:1}function q(e){return B(e)?e.name:e.path}function L(e){const t=e.targetObject;const n=O(t)||D(t)||M(t)||T(t);if(!n){return undefined}const o=F(e,n);const r=o.targetObject;if(!r){return undefined}return o}return _},false);