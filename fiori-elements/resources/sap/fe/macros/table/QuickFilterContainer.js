/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/helpers/ClassSupport","sap/fe/core/helpers/StableIdHelper","sap/fe/macros/chart/ChartUtils","sap/fe/macros/DelegateUtil","sap/fe/macros/table/Utils","sap/m/SegmentedButton","sap/m/SegmentedButtonItem","sap/m/Select","sap/ui/core/Control","sap/ui/core/Core","sap/ui/core/Item","sap/ui/model/json/JSONModel"],function(t,e,i,n,o,r,a,s,l,c,u,h,f,d){"use strict";var g,p,b,C,y,_,m,v,w,S,T,E,I;var P=n.generate;var F=i.property;var O=i.defineUI5Class;var D=i.aggregation;function A(t,e,i,n){if(!i)return;Object.defineProperty(t,e,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function j(t){if(t===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return t}function x(t,e){t.prototype=Object.create(e.prototype);t.prototype.constructor=t;z(t,e)}function z(t,e){z=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,i){e.__proto__=i;return e};return z(t,e)}function M(t,e,i,n,o){var r={};Object.keys(n).forEach(function(t){r[t]=n[t]});r.enumerable=!!r.enumerable;r.configurable=!!r.configurable;if("value"in r||r.initializer){r.writable=true}r=i.slice().reverse().reduce(function(i,n){return n(t,e,i)||i},r);if(o&&r.initializer!==void 0){r.value=r.initializer?r.initializer.call(o):void 0;r.initializer=undefined}if(r.initializer===void 0){Object.defineProperty(t,e,r);r=null}return r}function V(t,e){throw new Error("Decorating class property failed. Please ensure that "+"proposal-class-properties is enabled and runs after the decorators transform.")}const $="quickFilterKey";const K="filters";let R=(g=O("sap.fe.macros.table.QuickFilterContainer",{interfaces:["sap.m.IOverflowToolbarContent"]}),p=F({type:"boolean"}),b=F({type:"string"}),C=F({type:"string"}),y=F({type:"string",defaultValue:"$auto"}),_=D({type:"sap.ui.core.Control",multiple:false,isDefault:true}),g(m=(v=function(i){x(n,i);function n(){var t;for(var e=arguments.length,n=new Array(e),o=0;o<e;o++){n[o]=arguments[o]}t=i.call(this,...n)||this;A(t,"showCounts",w,j(t));A(t,"entitySet",S,j(t));A(t,"parentEntityType",T,j(t));A(t,"batchGroupId",E,j(t));A(t,"selector",I,j(t));t._attachedToView=false;return t}n.render=function t(e,i){const n=h.getLibraryResourceBundle("sap.fe.macros");e.renderControl(i.selector);e.attr("aria-label",n.getText("M_TABLE_QUICKFILTER_ARIA"))};var u=n.prototype;u.init=function t(){i.prototype.init.call(this);this._attachedToView=false;this.attachEvent("modelContextChange",this._initControl);const e={onBeforeRendering:()=>{this._createControlSideEffects();this._attachedToView=true;this.removeEventDelegate(e)}};this.addEventDelegate(e,this)};u._initControl=function t(e){if(this.getModel()){this.detachEvent(e.getId(),this._initControl);this._manageTable();this._createContent()}};u._manageTable=function t(){var e,i;let n=this.getParent();const o=this._getFilterModel(),a=o.getObject("/paths"),s=Array.isArray(a)&&a.length>0?a[0].annotationPath:undefined;while(n&&!n.isA("sap.ui.mdc.Table")){n=n.getParent()}this._oTable=n;const l=h.byId(this._oTable.getFilter());if(l&&l.isA("sap.ui.mdc.FilterBar")){l.attachFiltersChanged(this._onFiltersChanged.bind(this))}(e=this._oTable)===null||e===void 0?void 0:(i=e.getParent())===null||i===void 0?void 0:i.attachEvent("internalDataRequested",this._onTableDataRequested.bind(this));r.setCustomData(n,$,s)};u._onFiltersChanged=function t(e){if(e.getParameter("conditionsBased")){this.selector.setProperty("enabled",false)}};u._onTableDataRequested=function t(){this.selector.setProperty("enabled",true);if(this.showCounts){this._updateCounts()}};u.setSelectorKey=function t(e){const i=this.selector;if(i&&i.getSelectedKey()!==e){i.setSelectedKey(e);r.setCustomData(this._oTable,$,e);const t=this._oTable.getFilter&&this._oTable.getFilter();const n=t&&h.byId(t);const o=n&&n.getSuspendSelection&&n.getSuspendSelection();if(!o){this._oTable.rebind()}}};u.getSelectorKey=function t(){const e=this.selector;return e?e.getSelectedKey():null};u.getDomRef=function t(e){const i=this.selector;return i?i.getDomRef(e):null};u._getFilterModel=function t(){let e=this.getModel(K);if(!e){const t=r.getCustomData(this,K);e=new d(t);this.setModel(e,K)}return e};u._createContent=function t(){const e=this._getFilterModel(),i=e.getObject("/paths"),n=i.length>3,o={id:P([this._oTable.getId(),"QuickFilter"]),enabled:e.getObject("/enabled"),items:{path:`${K}>/paths`,factory:(t,e)=>{const i={key:e.getObject().annotationPath,text:this._getSelectorItemText(e)};return n?new f(i):new l(i)}}};if(n){o.autoAdjustWidth=true}o[n?"change":"selectionChange"]=this._onSelectionChange.bind(this);this.selector=n?new c(o):new s(o)};u.getOverflowToolbarConfig=function t(){return{canOverflow:true}};u._createControlSideEffects=function t(){const i=this.selector,n=i.getItems(),o=r.getCustomData(this._oTable,"navigationPath");if(o){var a;const t=[];for(const i in n){const r=n[i].getKey(),a=e.getFiltersInfoForSV(this._oTable,r);a.properties.forEach(function(e){const i=`${o}/${e}`;if(!t.includes(i)){t.push(i)}})}(a=this._getSideEffectController())===null||a===void 0?void 0:a.addControlSideEffects(this.parentEntityType,{sourceProperties:t,targetEntities:[{$NavigationPropertyPath:o}],sourceControlId:this.getId()})}};u._getSelectorItemText=function t(e){const i=e.getObject().annotationPath,n=e.getPath(),o=this.getModel().getMetaModel(),r=o.getObject(`${this.entitySet}/${i}`);return r.Text+(this.showCounts?` ({${K}>${n}/count})`:"")};u._getSideEffectController=function t(){const e=this._getViewController();return e?e._sideEffects:undefined};u._getViewController=function t(){const i=e.getTargetView(this);return i&&i.getController()};u._updateCounts=function i(){const n=this._oTable,s=this._getViewController(),l=this.selector,c=l.getItems(),u=this._getFilterModel(),h=[],f=[];let d=[];let g=[];const p=r.getCustomData(n,$);if(s&&s.getChartControl){const t=s.getChartControl();if(t){const i=o.getAllFilterInfo(t);if(i&&i.filters.length){g=e.getChartPropertiesWithoutPrefixes(i.filters)}}d=o.getChartSelectionsExist(t,n)?d.concat(a.getHiddenFilters(n)).concat(g):d.concat(a.getHiddenFilters(n))}for(const t in c){const i=c[t].getKey(),o=e.getFiltersInfoForSV(n,i);f.push(o.text);u.setProperty(`/paths/${t}/count`,"...");h.push(a.getListBindingForCount(n,n.getBindingContext(),{batchGroupId:i===p?this.batchGroupId:"$auto",additionalFilters:d.concat(o.filters)}))}Promise.all(h).then(function(t){for(const e in t){u.setProperty(`/paths/${e}/count`,a.getCountFormatted(t[e]))}}).catch(function(e){t.error("Error while retrieving the binding promises",e)})};u._onSelectionChange=function t(e){const i=e.getSource();r.setCustomData(this._oTable,$,i.getSelectedKey());this._oTable.rebind();const n=this._getViewController();if(n&&n.getExtensionAPI&&n.getExtensionAPI().updateAppState){n.getExtensionAPI().updateAppState()}};u.destroy=function t(e){if(this._attachedToView){const t=this._getSideEffectController();if(t){t.removeControlSideEffects(this)}}delete this._oTable;i.prototype.destroy.call(this,e)};return n}(u),w=M(v.prototype,"showCounts",[p],{configurable:true,enumerable:true,writable:true,initializer:null}),S=M(v.prototype,"entitySet",[b],{configurable:true,enumerable:true,writable:true,initializer:null}),T=M(v.prototype,"parentEntityType",[C],{configurable:true,enumerable:true,writable:true,initializer:null}),E=M(v.prototype,"batchGroupId",[y],{configurable:true,enumerable:true,writable:true,initializer:null}),I=M(v.prototype,"selector",[_],{configurable:true,enumerable:true,writable:true,initializer:null}),v))||m);return R},false);