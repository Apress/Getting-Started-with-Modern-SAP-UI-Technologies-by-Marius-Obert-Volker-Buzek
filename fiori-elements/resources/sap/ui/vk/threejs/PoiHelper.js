/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../NodeContentType","../TransformationMatrix","../thirdparty/three","sap/base/util/uid"],function(e,t,r,n){"use strict";var a=function(){this._currentSceneId=null};a.prototype.createPOI=function(a,o,i,s,c,d){i=i._implementation||i;c=c||{x:1,y:1};d=d||{};d.sid=d.sid||n();if(!d.transform){var u=i.getDomRef().getBoundingClientRect();var m=s.x-u.left;var f=s.y-u.top;var v=i.hitTest(m,f,{ignoreOverlay:true});if(!v){return Promise.reject()}var l=(new r.Matrix4).compose(v.point,i._getNativeCamera().quaternion,new r.Vector3(Number(c.x),Number(c.y),1));d.transform=t.convertTo4x3(l.elements);var p={picked:v.object?[v.object]:[]};i.fireNodesPicked(p);if(p.picked&&p.picked.length>0){var g=p.picked[0];if(g&&g.userData){d.referenceNode=p.picked[0].userData.nodeId}}else{d.referenceNode=v.object.userData.nodeId}}else if(d.transform.length===16){d.transform=t.convertTo4x3(d.transform)}d.transformType=d.transformType||"BILLBOARD_VIEW";if(this._currentSceneId){a.getSceneBuilder()._resetCurrentScene(this._currentSceneId)}var y=i._cdsLoader;if(y){var x=y.getSkipLowLODRendering();y.setSkipLowLODRendering(true);var w=a.getDefaultNodeHierarchy();var S=w.createNode(null,"Sample POI",null,e.Symbol,d);var h=i.getCurrentView()||a.getViews()[0];h.updateNodeInfos([{target:S,visible:true}]);return y.loadTransientScene(o,S).then(function(e){y.setSkipLowLODRendering(x);i.setShouldRenderFrame();var r=e.nodeRef;r.traverse(function(e){e.userData.skipIt=true});this._currentSceneId=r.userData.currentSceneId;Object.assign(r.userData.treeNode,d);var n={transform:t.convertTo4x4(d.transform),veid:d.sid,entityId:r.userData.entityId,name:d.name||"Sample POI",transformType:"view",contentType:"symbol",referenceNode:d.referenceNode};return n}.bind(this))}return Promise.reject()};a.prototype.removePOI=function(e,t){var r=e.getDefaultNodeHierarchy();var n=e.getViewStateManager();n.setVisibilityState(t,false,true);r.removeNode(t)};a.prototype.getPOIList=function(e){var t=e.getViewStateManager();return t?t.getSymbolNodes():[]};var o={spherical:"360Image",planar:"2DImage"};a.prototype.getBackgroundImageType=function(e){return o[e.getBackgroundProjection()]};a.prototype.getPoiRect=function(e,t){var n=e._getNativeCamera();var a=new r.Box3;a.setFromObject(t);var o=[new r.Vector3(a.min.x,a.min.y,a.min.z),new r.Vector3(a.max.x,a.max.y,a.max.z),new r.Vector3(a.min.x,a.min.y,a.max.z),new r.Vector3(a.min.x,a.max.y,a.max.z),new r.Vector3(a.max.x,a.min.y,a.max.z),new r.Vector3(a.max.x,a.max.y,a.min.z),new r.Vector3(a.min.x,a.max.y,a.min.z),new r.Vector3(a.max.x,a.min.y,a.min.z)];var i=new r.Frustum;i.setFromProjectionMatrix((new r.Matrix4).multiplyMatrices(n.projectionMatrix,n.matrixWorldInverse));if(!i.intersectsBox(a)){return false}var s=new r.Vector3(1,1,1);var c=new r.Vector3(-1,-1,-1);var d=new r.Vector3;for(var u=0;u<o.length;++u){if(!i.containsPoint(o[u])){return false}var m=d.copy(o[u]);var f=m.project(n);s.min(f);c.max(f)}var v=new r.Box2(s,c);var l=e.getDomRef().getBoundingClientRect();var p=new r.Vector2(l.width/2,l.height/2);var g=v.min.clone().multiply(p);var y=v.max.clone().multiply(p);var x=y.x-g.x;var w=y.y-g.y;return{width:x,height:w}};a.prototype.adjustPoi=function(e,n){if(e.getBackgroundProjection()!=="planar"){var a=n.getWorldPosition(new r.Vector3).project(e._getNativeCamera());var o=e.hitTest((a.x*.5+.5)*e._width,(a.y*-.5+.5)*e._height,{ignoreOverlay:true});if(o){n.position.copy(o.point)}n.quaternion.copy(e._getNativeCamera().quaternion);n.updateMatrix();n.updateMatrixWorld();n.userData.direction=(new r.Vector3).setFromMatrixColumn(n.matrixWorld,2).normalize()}n.userData.transform=t.convertTo4x3(n.matrixWorld.elements)};a.prototype.updateNodeId=function(e,t,r){var n=e.getViewStateManager();var a=n?n.getSymbolNodes(t)[0]:null;if(a){a.userData.nodeId=r;a.userData.treeNode.sid=r;e.setNodePersistentId(a,r)}return a};a.prototype.updatePOI=function(e,r,n,a,o){var i=e.getScene();var s=e._viewStateManager.getSymbolNodes(r)[0];o=o||{};var c=e._cdsLoader;if(s&&c){s.name=o.name||s.name;if(a){s.baseScale.set(a.x,a.y)}var d=c.getSkipLowLODRendering();c.setSkipLowLODRendering(true);if(o.transform){if(o.transform.length===16){o.transform=t.convertTo4x3(o.transform)}s.position.set(o.transform[9],o.transform[10],o.transform[11])}if(n){var u=e._viewStateManager.getNodeHierarchy();s.children.forEach(function(e){u.removeNode(e)});return c.loadTransientScene(n,s).then(function(t){c.setSkipLowLODRendering(d);var r=t.nodeRef;r.traverse(function(e){e.userData.skipIt=true});i.getSceneBuilder()._resetCurrentScene(r.userData.currentSceneId);r.userData.treeNode.sid=s.userData.treeNode.sid;s.userData._symbolCenterFixed=false;e.setShouldRenderFrame();return{target:r,entityId:r.userData.entityId}})}else{e.setShouldRenderFrame();var m=s.children[0];return Promise.resolve({target:m,entityId:s.userData.treeNode.entityId||m.userData.entityId})}}};return a});