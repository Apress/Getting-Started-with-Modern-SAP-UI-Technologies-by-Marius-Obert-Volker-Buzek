/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["sap/base/Log","sap/ui/base/ManagedObject","../totara/TotaraLoader","../threejs/SceneBuilder","./Material","../thirdparty/three","../getResourceBundle","../ObjectType"],function(e,t,r,a,n,i,o,s){"use strict";var d=t.extend("sap.ui.vk.threejs.ContentDeliveryService",{metadata:{library:"sap.ui.vk",properties:{authorizationHandler:"any",maxActiveRequests:{type:"int",defaultValue:4},maxUrlLength:{type:"int",defaultValue:2048},meshesBatchSize:{type:"int",defaultValue:128},materialsBatchSize:{type:"int",defaultValue:128},geometriesBatchSize:{type:"int",defaultValue:128},geometriesMaxBatchDataSize:{type:"int",defaultValue:1048576},geomMeshesBatchSize:{type:"int",defaultValue:128},geomMeshesMaxBatchDataSize:{type:"int",defaultValue:1048576},annotationsBatchSize:{type:"int",defaultValue:128},tracksBatchSize:{type:"int",defaultValue:128},sequencesBatchSize:{type:"int",defaultValue:128},voxelThreshold:{type:"number",defaultValue:0},skipLowLODRendering:{type:"boolean",defaultValue:true}},events:{cameraChanged:{parameters:{sceneId:{type:"string"},camera:{type:"any"}},enableEventBubbling:true},sceneUpdated:{parameters:{},enableEventBubbling:true},viewGroupUpdated:{parameters:{currentViewGroupId:"string"},enableEventBubbling:true},sceneCompleted:{parameters:{sceneId:{type:"string"}},enableEventBubbling:true},loadingFinished:{parameters:{currentViewId:"string",currentViewGroupId:"string"},enableEventBubbling:true},contentChangesProgress:{parameters:{percent:"float"}},errorReported:{parameters:{error:{type:"any"}}},initialViewCompleted:{parameters:{sceneId:{type:"string"}},enableEventBubbling:true}}},constructor:function(e,n){this._loader=new r;this._loader.setSceneBuilder(new a);t.apply(this,arguments);this._loader.setSkipLowLODRendering(this.getSkipLowLODRendering());this._transientSceneMap=new Map;this._currentNodeHierarchy=null}});d.prototype.getMaxActiveRequests=function(){return this._loader.getMaxActiveRequests()};d.prototype.setMaxActiveRequests=function(e){this._loader.setMaxActiveRequests(e);return this};d.prototype.getMaxUrlLength=function(){return this._loader.getMaxUrlLength()};d.prototype.setMaxUrlLength=function(e){this._loader.setMaxUrlLength(e);return this};d.prototype.getMeshesBatchSize=function(){return this._loader.getMeshesBatchSize()};d.prototype.setMeshesBatchSize=function(e){this._loader.setMeshesBatchSize(e);return this};d.prototype.getMaterialsBatchSize=function(){return this._loader.getMaterialsBatchSize()};d.prototype.setMaterialsBatchSize=function(e){this._loader.setMaterialsBatchSize(e);return this};d.prototype.getGeometriesBatchSize=function(){return this._loader.getGeometriesBatchSize()};d.prototype.setGeometriesBatchSize=function(e){this._loader.setGeometriesBatchSize(e);return this};d.prototype.getGeometriesMaxBatchDataSize=function(){return this._loader.getGeometriesMaxBatchDataSize()};d.prototype.setGeometriesMaxBatchDataSize=function(e){this._loader.setGeometriesMaxBatchDataSize(e);return this};d.prototype.getGeomMeshesBatchSize=function(){return this._loader.getGeomMeshesBatchSize()};d.prototype.setGeomMeshesBatchSize=function(e){this._loader.setGeomMeshesBatchSize(e);return this};d.prototype.getGeomMeshesMaxBatchDataSize=function(){return this._loader.getGeomMeshesMaxBatchDataSize()};d.prototype.setGeomMeshesMaxBatchDataSize=function(e){this._loader.setGeomMeshesMaxBatchDataSize(e);return this};d.prototype.getAnnotationsBatchSize=function(){return this._loader.getAnnotationsBatchSize()};d.prototype.setAnnotationsBatchSize=function(e){this._loader.setAnnotationsBatchSize(e);return this};d.prototype.getTracksBatchSize=function(){return this._loader.getTracksBatchSize()};d.prototype.setTracksBatchSize=function(e){this._loader.setTracksBatchSize(e);return this};d.prototype.getSequencesBatchSize=function(){return this._loader.getSequencesBatchSize()};d.prototype.setSequencesBatchSize=function(e){this._loader.setSequencesBatchSize(e);return this};d.prototype.getVoxelThreshold=function(){return this._loader.getVoxelThreshold()};d.prototype.setVoxelThreshold=function(e){this._loader.setVoxelThreshold(e);return this};d.prototype.setSkipLowLODRendering=function(e){this.setProperty("skipLowLODRendering",e,true);this._loader.setSkipLowLODRendering(e);return this};d.prototype.initUrl=function(e,t,a){if(!e.endsWith("/")){e+="/"}var n=this;function o(){n.fireSceneUpdated({})}function s(){var e;if(n._loader&&n._loader.currentSceneInfo){var t=n._loader.getContext(n._loader.currentSceneInfo.id);if(t){e=t.currentViewGroupId}}n.fireViewGroupUpdated({currentViewGroupId:e})}if(!this._loader.running()||this._loader.getUrl()!==e){if(this._loader.running()){var d=this._loader.sceneBuilder;this._loader.dispose();this._loader=new r;this._loader.setSceneBuilder(d)}this._loader.onErrorCallbacks.attach(this._reportError.bind(n));this._loader.onMaterialFinishedCallbacks.attach(o);this._loader.onImageFinishedCallbacks.attach(o);this._loader.onSetGeometryCallbacks.attach(o);this._loader.onViewGroupUpdatedCallbacks.attach(s);this._loader.setUrl(e);this._loader.setCorrelationId(a?a:i.MathUtils.generateUUID().toLowerCase());return this._loader.run()}else if(!t){this._loader.cleanup()}return Promise.resolve("Loader is ready")};d.prototype._reportError=function(e){this.fireErrorReported(e)};d.prototype._createLoadParam=function(t,r,a,n){var i=this;var o;var s=false;var d;if(this._currentNodeHierarchy){d=this._currentNodeHierarchy.getScene()}var c={root:a,vkScene:d,activateView:n.getActivateView(),enableLogger:n.getEnableLogger(),includeAnimation:n.getIncludeAnimation(),includeBackground:n.getIncludeBackground(),includeHidden:n.getIncludeHidden(),includeParametric:n.getIncludeParametric(),includeUsageId:n.getIncludeUsageId(),metadataFilter:n.getMetadataFilter(),pushPMI:n.getPushPMI(),pushViewGroups:n.getPushViewGroups(),useSecureConnection:n.getUseSecureConnection(),onActiveCamera:function(e){var t=false;var r=i._loader.getContext(n.getVeid());if(r&&r.phase<2){o=e;t=true}if(!t){i.fireCameraChanged({sceneId:n.getVeid(),camera:e})}},onInitialSceneFinished:function(e){s=true;t({node:a,camera:o,contentResource:n,initialView:e,annotations:i.getSceneBuilder()._annotations,loader:i})},onSceneCompleted:function(){i.fireSceneCompleted({sceneId:n.getVeid()})},onLoadingFinished:function(){var e,t;if(i._loader&&i._loader.currentSceneInfo){var r=i._loader.getContext(i._loader.currentSceneInfo.id);if(r){e=r.currentViewId;t=r.currentViewGroupId}}i.fireLoadingFinished({currentViewId:e,currentViewGroupId:t})},onContentChangesProgress:function(e){i.fireContentChangesProgress({source:e.source,phase:e.phase,percentage:e.percentage})},onInitialViewCompleted:function(){i.fireInitialViewCompleted({sceneId:n.getVeid()})}};var u=function(t){e.warning("Content loading error reported:",JSON.stringify(t.getParameters()));var a;if(t.getParameter("errorText")){a=t.getParameter("errorText")}else if(t.getParameter("error")){a=t.getParameter("error")}else if(t.getParameter("reason")){a=t.getParameter("reason")}else{a="failed to load: unknown reason"}if(s){var n=t.getParameter("error");if(n&&n===4){i.initUrl(this._loader.getUrl(),true)}}else{i.detachErrorReported(u);if(t.getParameter("events")){a=a+"\n"+JSON.stringify(t.getParameter("events"))}r(a)}};i.attachErrorReported(u);return c};d.prototype.load=function(e,t,r){var a=this;var n=t.getNodeProxy();if(n){this._currentNodeHierarchy=n.getNodeHierarchy()}return new Promise(function(n,i){if(!t.getSource()||!t.getVeid()){i(o().getText("CONTENTDELIVERYSERVICE_MSG_NOURLORVEID"));return}a.initUrl(t.getSource(),true);var s=a._createLoadParam(n,i,e,t);if(a._loader){a._loader.request(t.getVeid(),s,r)}})};d.prototype.getSceneBuilder=function(){if(this._loader){return this._loader.getSceneBuilder()}return null};d.prototype.decrementResourceCountersForDeletedTreeNode=function(e){var t=this._loader.getContext(this._loader.currentSceneInfo.id);this._loader.decrementResourceCountersForDeletedTreeNode(t,e)};d.prototype.loadTransientScene=function(e,t,r){var a=this;return new Promise(function(n,s){if(!e||!t){s(o().getText("CONTENTDELIVERYSERVICE_MSG_INVALIDARGUMENTS"));return}if(a._transientSceneMap.has(e)){var d=a._transientSceneMap.get(e).clone();t.add(d);n({nodeRef:d});return}if(!a._loader){s(o().getText("CONTENTDELIVERYSERVICE_MSG_CONTENTDELIVERYSERVICENOTINITIALISED"));return}var c=function(){a.detachLoadingFinished(c);if(a._transientSceneMap.get(e)){var r=a._transientSceneMap.get(e).clone();t.add(r);n({nodeRef:r})}};if(a._loader.contextMap.has(e)){a.attachLoadingFinished(c);return}var u=new i.Object3D;u.name="transient";u.userData.currentSceneId=a.getSceneBuilder()._currentSceneId;var l=function(){var r=a._loader.getContext(e);r.onSceneCompletedCallbacks.detach(l);u.userData.entityId=r.defaultRootEntityId;a._transientSceneMap.set(e,u);var i=u.clone();t.add(i);n({nodeRef:i})};var h={root:u,onSceneCompleted:l,useSecureConnection:r};a._loader.request(e,h)})};d.prototype.update=function(e,t,r){var a=this;return new Promise(function(n,i){if(!a._loader){i(o().getText("CONTENTDELIVERYSERVICE_MSG_CONTENTDELIVERYSERVICENOTINITIALISED"));return}a._loader.update(e,t,r).then(function(e){if(a._currentNodeHierarchy){for(var t=0;t<e.replacedNodeRefs.length;t++){a._currentNodeHierarchy.fireNodeReplaced({ReplacedNodeRef:e.replacedNodeRefs[t],ReplacementNodeRef:e.replacementNodeRefs[t],ReplacedNodeId:e.replacedNodeRefs[t],ReplacementNodeId:e.replacementNodeRefs[t]})}}n({sceneVeId:e.sceneVeId,sids:e.sidArray})}).catch(function(e){return i(e)})})};d.prototype.exit=function(){if(this._loader){this._loader.dispose();this._loader=null}this._transientSceneMap=null};d.prototype.loadView=function(t,r,a,n){if(typeof a==="undefined"){a="static"}var i=this;return this._loader.requestView(t,a,r,null,n).then(function(e){if(i._currentNodeHierarchy&&e.updatedNodes){for(var t=0;t<e.updatedNodes.length;t++){i._currentNodeHierarchy.fireNodeUpdated({nodeRef:e.updatedNodes[t]})}}i.fireSceneUpdated({});return e}).catch(function(t){e.error(t);return null})};d.prototype.updatePlaybacks=function(t,r,a){var n=this;return this._loader.requestView(t,"static",r,a,true).then(function(e){if(n._currentNodeHierarchy&&e.updatedNodes){for(var t=0;t<e.updatedNodes.length;t++){n._currentNodeHierarchy.fireNodeUpdated({nodeRef:e.updatedNodes[t]})}}n.fireSceneUpdated({});return e}).catch(function(t){e.error(t);return null})};d.prototype.loadViewGroup=function(t,r,a){var n=this;return this._loader.requestViewGroup(t,r,a).then(function(e){n.fireSceneUpdated({});return e}).catch(function(t){e.error(t);return null})};d.prototype.assignMaterialToNodes=function(t,r,a,i){var o=this;return this._loader.requestMaterial(t,r).then(function(e){function r(e,t,a){if(!t){return}if(t.userData.markedForNotAssigningMaterial){delete t.userData.markedForNotAssigningMaterial;return}if(o._currentNodeHierarchy){var i=o._currentNodeHierarchy.createNodeProxy(t);var d=new n;d.setMaterialRef(e);i.assignMaterial(d);o._currentNodeHierarchy.destroyNodeProxy(i)}if(a){t.children.forEach(function(t){if(!t||t.userData.objectType===s.PMI||t.userData.objectType===s.Hotspot){return}r(e,t,a)})}}if(!i){for(var d=0;d<a.length;d++){r(e,a[d],true)}}else{for(var c=0;c<a.length;c++){a[c].userData.markedForNotAssigningMaterial=true}var u=o._loader.getContext(t);var l=u.root;r(e,l,true)}o.fireSceneUpdated({});return true}).catch(function(t){e.error(t);return false})};d.prototype.replaceMaterialOnNodes=function(t,r,a,n){var i=this;return Promise.all([this._loader.requestMaterial(t,r),this._loader.requestMaterial(t,a)]).then(function(e){var r=e[0];var a=e[1];function o(e,t,r){if(!e){return}if(i._currentNodeHierarchy){var a=i._currentNodeHierarchy.createNodeProxy(e);a.replaceMaterial(t,r);i._currentNodeHierarchy.destroyNodeProxy(a)}e.children.forEach(function(e){o(e,t,r)})}if(!n){var s=i._loader.getContext(t);o(s.root,r,a)}else if(Array.isArray(n)){n.forEach(function(e){o(e,r,a)})}else{o([n],r,a)}i.fireSceneUpdated({});return true}).catch(function(t){e.error(t);return false})};d.prototype.printLogTokens=function(){if(this._loader){this._loader.printLogTokens();return true}else{return false}};return d});