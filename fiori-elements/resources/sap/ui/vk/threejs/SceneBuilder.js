/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","sap/base/Log","./UsageCounter","../totara/TotaraUtils","./OrthographicCamera","./PerspectiveCamera","./DetailView","./AnimationHelper","./Thrustline","./Billboard","./Callout","../BillboardCoordinateSpace","../BillboardTextEncoding","../BillboardStyle","../BillboardBorderLineStyle","../BillboardHorizontalAlignment","../LeaderLineMarkStyle","../DetailViewType","../DetailViewShape","../AnimationPlayback","../AnimationRotateType","../RenderMode","./Material","./MaterialType","./SphericalMapMaterial","../ObjectType","./ParametricGenerators","../NodeContentType","../NavigationMode","sap/base/util/uid","./ThreeUtils","sap/base/assert","../colorToCSSColor"],function(e,t,r,a,i,n,s,o,d,u,l,c,h,p,f,m,v,g,y,_,w,I,D,b,S,T,M,x,C,A,k,N,R){"use strict";var V=function(e,t,r,a){this._rootNode=e;this._contentResource=t;this._resolve=r;this._reject=a;this._callouts=new Map;this._cameras=new Map;this._images=new Map;this._imageIdsAndTileWidths=new Map;this._imageTextures=new Map;this._geometries=new Map;this._meshNodes=new Map;this._meshSubmeshes=new Map;this._geometryMeshes=new Map;this._materialMeshes=new Map;this._geometryMaterials=new Map;this._materialClones=new Map;this._joints=[];this._imageAddedToMaterialHandlers=[];this._isSmallScene=null;if(e){this._nodes=new Map;this._tracks=new Map;this._trackIdSequenceNodeMap=new Map;this._viewGroups=new Map;this._views=new Map}else{this._nodes=null;this._tracks=null;this._trackIdSequenceNodeMap=null;this._viewGroups=null;this._views=null}this._currentSceneId=null;this._sceneIdTreeNodesMap=new Map;this._sceneIdRootNodeMap=new Map;this._animationHelper=new o(this);if(t){var i=t.getNodeProxy();var n=i.getNodeHierarchy();this._vkScene=n.getScene();var s=t.getSource();if(s&&s.name){this._sceneIdTreeNodesMap.set(s.name,this._nodes);this._sceneIdRootNodeMap.set(s.name,e);this._currentSceneId=s.name}}this._viewThumbnails=new Map;this._thrustlines=new Map;this._animations=new Map;this._animationTracks=new Map;this._jointNodesMap=new Map;this._jointParentsMap=new Map;this._upAxis=2;this._voxelThreshold=0};V.prototype.getVoxelThreshold=function(){return this._voxelThreshold};V.prototype.setVoxelThreshold=function(e){this._voxelThreshold=e;return this};var O=[I.Default,I.Default,I.Default,I.LineIllustration,I.SolidOutline,I.ShadedIllustration];V.prototype.setScene=function(e){this._vkScene.setSceneBuilder(this);var t=this._cameras.get(e.cameraId);this._upAxis=e.upAxis;this._resolve({node:this._rootNode,camera:t,backgroundTopColor:e.backgroundTopColor,backgroundBottomColor:e.backgroundBottomColor,upAxis:e.upAxis,contentResource:this._contentResource,builder:this})};V.prototype.setRootNode=function(e,t,r,a){this._rootNode=e;this._nodes=new Map;this._nodes.set(t,e);this._tracks=new Map;this._trackIdSequenceNodeMap=new Map;this._sequenceIdToPlaybacks=new Map;this._viewGroups=new Map;this._views=new Map;if(r){this._sceneIdTreeNodesMap.set(r,this._nodes);this._sceneIdRootNodeMap.set(r,e);this._currentSceneId=r}if(a){this._vkScene=a}return this};V.prototype._resetCurrentScene=function(e){if(e&&e!==this._currentSceneId){var t=this._sceneIdTreeNodesMap.get(e);if(t){this._nodes=t}else{this._nodes=null}var r=this._sceneIdRootNodeMap.get(e);if(r){this._rootNode=r}else{this._rootNode=null}this._currentSceneId=e}};V.prototype.getNode=function(e,t){if(t){this._resetCurrentScene(t);if(this._nodes){return this._nodes.get(e)}}else{var r=this._sceneIdTreeNodesMap.values();var a=r.next();while(!a.done){var i=a.value.get(e);if(i){return i}a=r.next()}}return null};V.prototype.hasMesh=function(e){return this._meshSubmeshes.has(e)};V.prototype.hasImage=function(e){return this._images.has(e)};V.prototype.hasAnnotation=function(e){return this._vkScene._hasAnnotation(e)};V.prototype.setNodePersistentId=function(e,t,r){if(!e.userData.treeNode){e.userData.treeNode={}}var a=null;if(e.userData.treeNode.sid){a=e.userData.treeNode.sid;delete e.userData.treeNode.sid}this._resetCurrentScene(r);e.userData.treeNode.sid=t;if(this._nodes){if(a){this._nodes.delete(a)}this._nodes.set(t,e);return true}return false};var P=function(t){var r=new e.Matrix4;if(t.length===3){r.setPosition((new e.Vector3).fromArray(t))}else if(t.length===12){r.set(t[0],t[3],t[6],t[9],t[1],t[4],t[7],t[10],t[2],t[5],t[8],t[11],0,0,0,1)}else if(t.length===16){r.set(t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15])}else{throw"Invalid matrix format"}return r};var E={r:.0235,g:.0235,b:.0235};var B={r:.0602,g:.0602,b:.0602};V.prototype._createTemporaryMaterial=function(t,r){var a=new D(r||b.MeshPhongMaterial);var i=a.getMaterialRef();i.userData.defaultHighlightingEmissive=E;i.userData.defaultHighlightingSpecular=B;i.userData.materialUsed=0;i.userData.materialId=t;i.userData.toBeUpdated=true;if(this._vkScene.getDoubleSided()){i.side=e.DoubleSide;i.userData.originalMaterialSide=e.FrontSide}this._vkScene.setMaterial(t,a);var n=this._materialMeshes.get(t);if(n){n.forEach(function(e){this._updateMeshSubmeshesMaterial(e,t,i)},this)}var s=this._vkScene.getSceneRef().userData;if(!s.instanceDataTexture){var o=2048;var d=2048;s.instanceDataTexture=new e.DataTexture(new Float32Array(o*d*4),o,d,e.RGBAFormat,e.FloatType);s.instanceDataTexture.version=1;s.instanceDataTexture.image.needsUpdate=true;s.textureUpdateResults=null}i.specularMap=s.instanceDataTexture;return i};V.prototype._getMaterialRef=function(e){var t=this._vkScene.getMaterial(e);return t?t.getMaterialRef():null};V.prototype.checkMaterialExists=function(e,t){if(this._getMaterialRef(e)===null){if(t){this._createTemporaryMaterial(e)}return false}return true};V.prototype.materialNeeded=function(e){return true};V.prototype.attachImageAddedToMaterial=function(e,t){this._imageAddedToMaterialHandlers.push({func:e,listener:t});return this};V.prototype.detachImageAddedToMaterial=function(e,t){for(var r=0;r<this._imageAddedToMaterialHandlers.length;r++){var a=this._imageAddedToMaterialHandlers[r];if(a.func===e&&a.listener===t){this._imageAddedToMaterialHandlers.splice(r,1);return this}}return this};V.prototype.fireImageAddedToMaterial=function(e){var t=this._imageAddedToMaterialHandlers.slice();t.forEach(function(t){t.func.call(t.listener,e)});return this};V.prototype._attachMaterialClone=function(e,t){a.pushElementIntoMapArray(this._materialClones,e,t)};V.prototype._addDynamicObject=function(e,t,r){var a=this._rootNode.userData;if(!a._vkDynamicObjects){a._vkDynamicObjects=[]}if(a._vkDynamicObjects.indexOf(e)<0){a._vkDynamicObjects.push(e)}e._vkUpdate=t;if(r){e.userData.is2D=true}};V.prototype.createNode=function(t,r){this._resetCurrentScene(r);var a=new e.Group;this._nodes.set(t.sid,a);var i;var n=this._jointNodesMap.get(t.sid);if(n&&n.length){for(i=0;i<n.length;i++){n[i].node=a}}var s=this._jointParentsMap.get(t.sid);if(s&&s.length){for(i=0;i<s.length;i++){s[i].parent=a}}var o=this._nodes.get(t.parentId);(o||this._rootNode).add(a);var d=a.userData;d.treeNode=t;if(t.closed){d.closed=true}if(t.selectable===false){d.selectable=false}if(t.visualisable===false&&t.contentType!=="SYMBOL"){d.skipIt=true}if(t.metadata){d.metadata=t.metadata}if(t.veids){d.veids=t.veids}if(t.usageIds){d.usageIds=t.usageIds}if(t.sid){d.nodeId=t.sid}if(t.name){a.name=t.name}if(t.visible!==undefined){a.visible=!!t.visible}if(o){var l;if(d.skipIt||o.name&&a.name===o.name+" offset geometry"){d.skipIt=true}else{l=o;while(l){if(l.userData.closed){d.skipIt=true;d.skipItClosed=true}l=l.parent}}if(o.userData.symbolContent){d.skipIt=true;if(d.skipItClosed===true){d.skipItClosed=false}d.symbolContent=true}if(a.visible&&!d.skipIt&&this._contentResource){l=o;while(l){l.visible=true;l=l.parent}}}if(t.renderOrder){a.renderOrder=t.renderOrder}if(t.renderMethod){d.renderMethod=t.renderMethod}if(t.renderStage){if(typeof t.renderStage==="string"){t.renderStage={UNDERLAY_2D:-1,OVERLAY_2D:1}[t.renderStage]||0}d.renderStage=t.renderStage}d.opacity=t.opacity;if(t.transform){a.applyMatrix4(P(t.transform));if(!isFinite(a.quaternion.x)||!isFinite(a.quaternion.y)||!isFinite(a.quaternion.z)||!isFinite(a.quaternion.w)){a.quaternion.set(0,0,0,1)}}a.updateMatrixWorld(true);if(t.transformType){d.transformType=t.transformType;switch(t.transformType){case"ORTHO2D":d.originalTransform={p:a.position.clone(),q:a.quaternion.clone(),s:a.scale.clone()};this._addDynamicObject(a,u.prototype._ortho2DUpdate,true);break;case"BILLBOARD_VIEW":this._addDynamicObject(a,u.prototype._billboardViewUpdate,false);break;case"LOCK_TOVIEWPORT":this._addDynamicObject(a,u.prototype._lockToViewportUpdate,true);break;default:break}}if(t.materialId){d.materialId=t.materialId}if(t.geometryType){d.geometryType=t.geometryType}if(t.meshId){this.setMeshNode(t.sid,t.meshId)}if(t.parametricId){this.setParametricNode(t.sid,t.parametricId,t.visible)}if(a.parent.userData.objectType===T.Hotspot){d.objectType=T.Hotspot}else if(a.parent.userData.objectType===T.PMI){d.objectType=T.PMI}else if(t.contentType==="HOTSPOT"){d.objectType=T.Hotspot}else if(t.contentType==="PMI"){d.objectType=T.PMI}if(t.contentType==="REFERENCE"){a._vkSetNodeContentType(x.Reference)}else if(t.contentType==="ANNOTATION"){a._vkSetNodeContentType(x.Annotation)}else if(t.contentType==="BACKGROUND"){a._vkSetNodeContentType(x.Background)}else if(t.contentType==="SYMBOL"){a._vkSetNodeContentType(x.Symbol);d.symbolContent=true}return a};V.prototype.removeNode=function(e){this._nodes.delete(e._vkPersistentId());this._vkScene._removeAnnotationsForNode(e);var t=false;if(!this._forbiddenTextureUpdate){this._forbiddenTextureUpdate=true;t=true;var r=this._vkScene.getSceneRef().userData;if(r.instanceDataTexture){var a=r.geometryClusters;var i=k.prepareTextureUpdateResults(a?a.length:0,r.textureUpdateResults);k.removeNodeFromClusterRenderingRecursive(e,r.instanceDataTexture.image.data,i);r.textureUpdateResults=i}}e.children.forEach(this.removeNode,this);if(t){delete this._forbiddenTextureUpdate}};V.prototype.hasNode=function(e){return this._nodes.has(e._vkPersistentId())};function L(t){if(t&&t.type===b.LineBasicMaterial){return t}var r=new e.LineBasicMaterial({color:16711680,linewidth:1});if(t){r.color.copy(t.color);r.specularMap=t.specularMap;r.userData.materialId=t.userData.materialId}return r}V.prototype.getChildNodeIds=function(e,t,r){this._resetCurrentScene(t);var a=this._nodes.get(e);var i=[];if(!a){return i}if(a&&a.children){for(var n=0;n<a.children.length;n++){var s=a.children[n];if(s.userData.treeNode&&s.userData.treeNode.sid){i.push(s.userData.treeNode.sid)}else if(r&&s.userData.submeshInfo&&s.userData.submeshInfo.id){i.push(s.userData.submeshInfo.id)}}}return i};function G(e){for(var t=0;t<e.length;t++){if(e[t].type==="box"&&e[t].data){return e[t]}}return null}function U(e){if(Array.isArray(e)){for(var t=0;t<e.length;t++){if(e[t].type===undefined||e[t].type==="mesh"||e[t].type==="line"){return e[t]}}}return null}V.prototype._addGeometryToCluster=function(t,r,a,i,n,s,o){var d=this._vkScene.getSceneRef().userData;var u=65536;var l=3*u;var c=t.length/3;var h=i.length;var p=!n&&(a&&a.length===c*2);var f=":"+(n?"l":"t")+(p?"u":"n");var m=s+f+o;if(!d.currentClusters){d.currentClusters=new Map}var v=d.currentClusters.get(m);if(!v||v.freeVertices<c||v.freeIndices<h){v=new e.BufferGeometry;if(o>1){v.userData.renderInstanceCount=o}d.currentClusters.set(m,v);v.freeVertices=u;v.freeIndices=l;v.instanceIndices=[];v.userData.geometryUsed=0;v.setIndex(new e.BufferAttribute(new Uint16Array(l),1));v.setAttribute("position",new e.BufferAttribute(new Float32Array(u*3),3));v.setAttribute("clusterInstance",new e.BufferAttribute(new Float32Array(u),1));if(n){v.userData.isPolyline=true}else{v.setAttribute("normal",new e.BufferAttribute(new Float32Array(u*3),3))}if(p){v.setAttribute("uv",new e.BufferAttribute(new Float32Array(u*2),2))}var g=this._getMaterialRef(s);var y=n?new e.LineSegments(v,L(g)):new e.Mesh(v,g);if(d.geometryClusters){d.geometryClusters.push(y)}else{d.geometryClusters=[y];d.currentInstanceIndex=0}y.userData.isGeometryCluster=true;v.userData.clusterIndex=d.geometryClusters.length-1}var _=u-v.freeVertices;k.updateClusterAttrib(v,"position",_*3,t);var w=v.getAttribute("clusterInstance");w.array.fill(d.currentInstanceIndex,_,_+c);if(w.updateRange.count<0){w.updateRange.offset=_;w.updateRange.count=c}else{w.updateRange.count+=c}w.needsUpdate=true;if(!n){if(!r||r.length!==t.length){r=z(t,i)}k.updateClusterAttrib(v,"normal",_*3,r)}if(p){k.updateClusterAttrib(v,"uv",_*2,a)}var I=l-v.freeIndices;k.updateClusterIndices(v,i,_,I,h);v.freeVertices-=c;v.freeIndices-=h;v.drawRange.count=I+h;v.instanceIndices.push(d.currentInstanceIndex);v.computeBoundingBox(_,_+c);v.computeBoundingSphere(_,_+c,true);var D={geometry:v,vertexStart:_,vertexCount:c,indexStart:I,indexCount:h,boundingBox:v.boundingBox,boundingSphere:v.boundingSphere};v.boundingBox=null;v.boundingSphere=null;return D};function q(e,t){var r=e.boundingBox.min;var a=e.boundingBox.max;var i=e.boundingSphere;return{firstVertex:e.vertexStart,lastVertex:e.vertexStart+e.vertexCount,start:e.indexStart,count:e.indexCount,instanceIndex:t,clusterIndex:e.geometry.userData.clusterIndex,boundingBox:[r.x,r.y,r.z,a.x,a.y,a.z],boundingSphere:[i.center.x,i.center.y,i.center.z,i.radius]}}V.prototype._cloneSubmesh=function(t,r){var a=t instanceof e.Mesh?t._vkClone():t.clone();if(r.userData.transformType==="ORTHO2D"){a.position.setScalar(0);a.scale.setScalar(1)}a.userData.skipIt=true;a.renderOrder=r.renderOrder;if(r.userData.materialId){k.disposeMaterial(a.material);a.material=this._getMaterialRef(r.userData.materialId)||t.material;a.userData.materialId=r.userData.materialId}return a};V.prototype.insertSubmesh=function(t,r){var i=this._getMaterialRef(t.materialId)||this._createTemporaryMaterial(t.materialId);if(!t.lods){return false}var n=U(t.lods);if(!n){return false}var s=n.pointCount;var o=n.elementCount;var d=n.flags;var u=n.boundingBox;var l=!u||d==null;var c=this._meshNodes.get(t.meshId);var h=null;var p;if(l){var f=new e.BufferGeometry;var m=new e.BufferAttribute(new Uint16Array(0),1);var v=new e.BufferAttribute(new Float32Array(0),3);f.setIndex(m);f.setAttribute("position",v);p=new e.Mesh(f,i)}else{var g=(d&1)>0;var y=c?c.length:0;var _=G(t.lods);var w=_?a.base64ToUint8Array(_.data):null;if(this._isSmallScene==null){this._isSmallScene=this._meshNodes.size<2e3&&this._nodes.size<5e3}var I=g||!w;var D=g||y<1||s<24||o<12;var b=1;if(D){b=-1}else if(this._isSmallScene||I){b=0}var S=k.buildTemporaryMesh(u,d,s,o,w,I,b);if(D||S.points.length>s*3||S.indices.length>o*3){var T=new e.BufferGeometry;var M=new e.BufferAttribute(S.indices,1);var x=new e.BufferAttribute(S.points,3);var C=new e.BufferAttribute(S.normals,3);T.setIndex(M);T.setAttribute("position",x);T.setAttribute("normal",C);p=new e.Mesh(T,i)}else{h=this._addGeometryToCluster(S.points,S.normals,S.uvs,S.indices,false,t.materialId,y);a.pushElementIntoMapArray(this._geometries,n.id,h);p=new e.Mesh(h.geometry,i)}}p.userData.geometryId=n.id;p.userData.lodInfo=n;if(t.transform){p.applyMatrix4(P(t.transform))}p.updateMatrixWorld(true);p.userData.submeshId=t.id;p.userData.initialMaterialId=t.materialId;p.userData.meshId=t.meshId;p.userData.materialId=t.materialId;p.userData.submeshInfo=t;a.pushElementIntoMapArray(this._materialMeshes,t.materialId,t.meshId);a.pushElementIntoMapArray(this._geometryMaterials,n.id,t.materialId);a.pushElementIntoMapArray(this._geometryMeshes,n.id,t.meshId);a.pushElementIntoMapArray(this._meshSubmeshes,t.meshId,p);if(c){c.forEach(function(r){var a=this._cloneSubmesh(p,r);if(a.material&&r.userData&&r.userData.geometryType&&(r.userData.geometryType==="PLANE"||r.userData.geometryType==="SURFACE")){a.material.side=e.DoubleSide;if(this._vkScene.getDoubleSided()){if(!a.material.userData){a.material.userData={}}a.material.userData.originalMaterialSide=e.DoubleSide}}if(h){var i=this._vkScene.getSceneRef().userData;a.userData.renderGroup=q(h,i.currentInstanceIndex);i.currentInstanceIndex++}r.add(a);a.updateMatrixWorld(true);F(r,t.materialId,this._materialClones)},this)}return true};function H(t,a,i,n){var s=0;var o=i.geometry;for(var d=0;d<t.length;d++){var u=t[d];if(a&&u.userData.geometryId===a&&u.geometry!==o){var l=q(i,n+s);s++;if(u.type==="Mesh"&&!o.userData.isPolyline){if(u.geometry){k.disposeGeometry(u)}u.geometry=o;u.userData.renderGroup=l;u.updateMatrixWorld(true);r.increaseGeometryUsed(o)}else{var c=new e.LineSegments(o,u.material);r.increaseGeometryUsed(o);c.position.copy(u.position);c.quaternion.copy(u.quaternion);c.scale.copy(u.scale);c.matrix.copy(u.matrix);c.updateMatrixWorld(true);c.userData=u.userData;c.userData.renderGroup=l;c.renderOrder=u.renderOrder;c.parent=u.parent;t[d]=c;u.parent=null}}}return s}V.prototype._setSubmeshMaterial=function(e,t,i){r.increaseMaterialUsed(t);e.material=t;e.userData.materialId=i;delete e.userData.originalMaterial;e._vkUpdateMaterialOpacity();if(e.material!==t){a.pushElementIntoMapArray(this._materialClones,i,e.material)}};V.prototype._updateMaterial=function(e,t,r){e.children.forEach(function(e){if(e.material&&e.userData.materialId===t){this._setSubmeshMaterial(e,r,t)}},this)};V.prototype._updateMeshSubmeshesMaterial=function(e,t,r){var a=this._meshSubmeshes.get(e);if(a){a.forEach(function(e){if(e.material&&e.material.userData.materialId===t){e.material=r}})}};function F(e,t,r){e.children.forEach(function(e){if(e.material&&(!t||t===e.material.userData.materialId)){var i=e.material;e._vkUpdateMaterialOpacity();if(e.material!==i){a.pushElementIntoMapArray(r,e.material.userData.materialId,e.material)}}})}function z(t,r){var a=new Float32Array(t.length);var i=new e.Vector3;var n=new e.Vector3;var s=new e.Vector3;var o=new e.Vector3;var d,u;for(d=0,u=r.length;d<u;d+=3){var l=[r[d]*3,r[d+1]*3,r[d+2]*3];i.fromArray(t,l[0]);n.fromArray(t,l[1]).sub(i);s.fromArray(t,l[2]).sub(i);o.crossVectors(n,s).normalize();for(var c=0;c<3;c++){var h=l[c];a[h]+=o.x;a[h+1]+=o.y;a[h+2]+=o.z}}for(d=0,u=a.length;d<u;d+=3){o.fromArray(a,d).normalize().toArray(a,d)}return a}V.prototype.setGeometry=function(e){var r=e.id;var i=e.data;var n=this._geometries.get(r);if(n){n.forEach(function(e){if(!k.updateClusterGeometry(e,i.points,i.normals,i.uvs,i.indices)){t.error("Invalid geometry in setGeometry")}})}var s=0;var o=n?null:this._geometryMeshes.get(r);if(o){o.forEach(function(e){var t=this._meshNodes.get(e);if(t){s+=t.length}},this)}if(s<1){s=1}var d=n?null:this._geometryMaterials.get(r);if(d){d.forEach(function(t){var n=this._addGeometryToCluster(i.points,i.normals,i.uvs,i.indices,e.isPolyline,t,s);a.pushElementIntoMapArray(this._geometries,r,n);if(o){var d=this._vkScene.getSceneRef().userData;for(var u=0;u<o.length;u++){var l=o[u];var c=this._meshNodes.get(l);if(c){for(var h=0;h<c.length;h++){d.currentInstanceIndex+=H(c[h].children,r,n,d.currentInstanceIndex)}}var p=this._meshSubmeshes.get(l);if(p){H(p,r,n,d.currentInstanceIndex)}}}},this)}if(this._fireSceneUpdated){this._fireSceneUpdated()}return this};V.prototype.setMeshNode=function(e,t){var r=this._nodes.get(e);if(r){a.pushElementIntoMapArray(this._meshNodes,t,r);var i=this._meshSubmeshes.get(t);if(i){i.forEach(function(e){var t=this._cloneSubmesh(e,r);var a=this._geometries.get(e.userData.geometryId);if(a){t.userData.renderGroup=q(a[0],null)}r.add(t)},this);F(r,null,this._materialClones)}}};V.prototype.setParametricNode=function(e,t,r){var a=this._nodes.get(e);if(a){a.userData.parametricVisible=r!==undefined?r:true}};V.prototype.progress=function(e){t.log("reading progress:",e)};V.prototype.loadingFinished=function(e){if(this._fireLoadingFinished){this._fireLoadingFinished(e)}};V.prototype.getGeometry=function(e){var t=this._geometries.get(e);return t?t[0].geometry:null};var W={rect:p.RectangularShape,circle:p.CircularShape,none:p.None,textGlow:p.TextGlow};var j={none:f.None,solid:f.Solid,dash:f.Dash,dot:f.Dot,dashdot:f.DashDot,dashdotdot:f.DashDotDot};var K={left:m.Left,center:m.Center,right:m.Right};var Y={none:v.None,point:v.Point,arrow:v.Arrow};var J=new e.Color;function Z(t){var r=new e.Matrix4;var a=new e.Matrix4;var i=t;while(i&&i.userData.originalTransform){N(i.userData.transformType==="ORTHO2D");var n=i.userData.originalTransform;r.compose(n.p,n.q,n.s);a.premultiply(r);i=i.parent}a.decompose(t.position,t.quaternion,t.scale)}V.prototype.createAnnotation=function(r,a){this._resetCurrentScene(a);var i=this._nodes.get(r.nodeId);if(!i){t.warning("Annotation node not found",r);return}if(i.userData.originalTransform){Z(i)}var n=r.type;if(n===undefined){this.createLegacyAnnotation(r,i);return}i.userData.annotationType=n;if(n==="html"){r.id=r.id||A();var s=[];if(r.leaderLines){r.leaderLines.forEach(function(e){if(e.start&&e.start.sid){s.push(this._nodes.get(e.start.sid))}},this)}this._vkScene._addAnnotation(r.id,{annotation:r,node:i,attachment:r.attachment&&r.attachment.sid?this._nodes.get(r.attachment.sid):null,targetNodes:s});return}var o=r.label||{};var d=r.text||{};var c=o.colour||[1,1,1,1];var m=o.borderColour||[0,0,0,1];var v={node:i,renderOrder:i.renderOrder||0,style:W[o.shape]||p.RectangularShape,width:o.width||64,height:o.height||64,backgroundColor:J.fromArray(c).getStyle(),backgroundOpacity:c[3],borderColor:J.fromArray(m).getStyle(),borderOpacity:m[3],borderWidth:o.borderColour?o.borderWidth||0:0,borderLineStyle:j[o.borderLineStyle]||f.Solid,horizontalAlignment:K[d.align]};if(d.html){v.encoding=h.HtmlText;v.text=d.html}else{v.encoding=h.PlainText;v.text=d.text;v.font=d.fontFace||"Arial";v.fontSize=Math.abs(d.fontSize)||16;v.fontWeight=Math.min(d.fontWeight,900);v.fontItalic=d.fontItalic;v.textColor=J.fromArray(d.colour||[0,0,0]).getStyle()}if(n==="text"){var g=i.position;v.position=new e.Vector3(g.x*2,g.y*2,g.z);var y=new u(v);y.setText(v.text);this._addDynamicObject(i,y._update.bind(y),true)}else if(n==="note"){var _=r.attachment||{};v.position=(new e.Vector3).fromArray(_.position||[0,0,0]);v.anchorNode=this._nodes.get(_.sid)||this._rootNode;v.depthTest=false;var w=new l(v);w.setText(v.text);this._callouts.set(r.id,w);this._addDynamicObject(i,w._update.bind(w),false)}else{t.warning("Unsupported annotation type",r)}};var Q=[p.RectangularShape,p.CircularShape,p.None,p.TextGlow];var X=[c.Viewport,c.Screen,c.World];var $=[f.None,f.Solid,f.Dash,f.Dot,f.DashDot,f.DashDotDot];var ee=[v.None,v.Point,v.Arrow];var te=[m.Left,m.Center,m.Right];function re(e){var t=e.toString(16);if(e.length>=3){t=(e[0]*255<<16|e[1]*255<<8|e[2]*255).toString(16)}return"#"+"000000".substring(t.length)+t}function ae(e){if(!e){return false}for(var t=0,r=e.length;t<r;t++){if(!isFinite(e[t])){return false}}return true}V.prototype.createLegacyAnnotation=function(r,a){var i=r.position;if(!ae(i)){t.warning("Incorrect annotation position",r);return}r.coordinateSpace|=0;var n=r.backgroundOpacity;if(!n){n=r.backgroundColour?r.backgroundColour[3]:0}var s=r.borderOpacity;if(!s){s=r.borderColour?r.borderColour[3]:0}var o={node:a,coordinateSpace:X[r.coordinateSpace],style:Q[r.shape||0],width:r.width,height:r.height,backgroundColor:r.backgroundColour?re(r.backgroundColour):"#fff",backgroundOpacity:n,borderColor:r.borderColour?re(r.borderColour):"#000",borderOpacity:s,borderWidth:r.borderWidth,borderLineStyle:$[r.borderLineStyle]};if(r.encoding!==undefined){o.encoding=r.encoding?h.HtmlText:h.PlainText;o.font=r.font;o.fontSize=r.fontSize;o.fontWeight=Math.min(r.fontWeight,900);o.fontItalic=r.fontItalic;o.textColor=re(r.textColour);o.link=r.link;o.horizontalAlignment=te[r.textHorizontalAlignment];o.position=(new e.Vector3).fromArray(i)}else if(r.fontFace){o.encoding=h.PlainText;o.font=r.fontFace;o.fontSize=Math.abs(r.fontSize);o.fontWeight=Math.min(r.fontWeight,900);o.textColor=re(r.textColour)}else{o.encoding=h.HtmlText}if(r.coordinateSpace<2){if(!o.positions){o.position=new e.Vector3(i[0]*2-1,i[1]*-2+1,i[2])}o.renderOrder=(r.order|0)+1e3;var d=new u(o);d.setText(r.text);this._addDynamicObject(a,d._update.bind(d),true)}else{o.anchorNode=this._nodes.get(r.sid)||this._rootNode;if(!o.position){o.position=(new e.Vector3).fromArray(i)}o.depthTest=false;o.renderOrder=r.order|0;if(r.alwaysOnTop){o.renderOrder=1}var c=new l(o);c.setText(r.text);this._callouts.set(r.id,c);this._addDynamicObject(a,c._update.bind(c),false)}};function ie(e){while(e){if(e.userData.transformType){return e.userData.transformType}e=e.parent}}V.prototype.createImageNote=function(r,a){this._resetCurrentScene(a);var i=this._nodes.get(r.nodeId);if(!i){t.warning("Image annotation node not found",r);return}if(i.userData.originalTransform){Z(i)}if(r.type==="image"){var n=r.label||{};var s=n.materialId;var o=this._getMaterialRef(s);if(!o){t.warning("Image annotation material not found",r);return}if(n.projection==="spherical"){i.position.setScalar(0);i.scale.setScalar(1);n.width=-1;n.height=-1;i.userData.transformType="LOCK_TOVIEWPORT";i.userData.renderStage=-1;var d=o;o=new S({upAxis:this._upAxis,map:d.map,color:d.color});o.userData=d.userData;this._vkScene.getMaterial(s)._nativeMaterial=o}o.depthTest=false;o.depthWrite=false;o.blending=e.CustomBlending;o.side=e.DoubleSide;if(i.userData.renderStage===undefined){if(r.order){i.userData.renderStage=Math.sign(r.order)}else if(r.order===undefined&&ie(i)!==undefined){i.userData.renderStage=1}}switch(i.userData.transformType){case"ORTHO2D":case"LOCK_TOVIEWPORT":var l=new u({node:i,renderOrder:i.renderOrder||0,coordinateSpace:c.Screen,position:new e.Vector3(i.position.x,i.position.y,0),width:(n.width||200)*i.scale.x*.5,height:(n.height||200)*i.scale.y*.5});l.setMaterial(o);i.position.setScalar(0);i.scale.setScalar(1);this._addDynamicObject(i,l._update.bind(l),true);break;case"BILLBOARD_VIEW":default:var h=new e.Mesh(u.prototype._planeGeometry,o);h.scale.set(n.width,n.height,1);h.updateMatrix();i.add(h);break}}else{this.createLegacyImageNote(r,i)}};V.prototype.createLegacyImageNote=function(t,r){var a=(new e.Vector3).fromArray(t.position);var i=t.width;var n=t.height;if(!t.properlyAligned){a.x+=t.width*.5;a.y+=t.height*.5;a.applyMatrix4(r.matrix);i=t.width*.5*r.matrix.elements[0];n=t.height*.5*r.matrix.elements[5]}var s=this._getMaterialRef(t.labelMaterialId);s.depthTest=false;s.depthWrite=false;s.blending=e.CustomBlending;if(ie(r)==="LOCK_TOVIEWPORT"){var o=new u({node:r,coordinateSpace:c.Screen,renderOrder:(t.order|0)+1e3,position:a,width:i,height:n});o.setMaterial(s);this._addDynamicObject(r,o._update.bind(o),true)}else{var d=new e.Mesh(u.prototype._planeGeometry,s);d.renderOrder=(t.order|0)+1e3;d.position.copy(a);d.scale.set(i*2,n*2,1);d.updateMatrix();r.add(d);r.scale.setScalar(1);r.updateMatrix()}};V.prototype.insertLeaderLine=function(r,a){this._resetCurrentScene(a);var i=this._callouts.get(r.annotationId);if(i){var n=this._getMaterialRef(r.materialId);if(!n){t.warning("Leader line material not found",r);return}var s=[];var o=r.points;for(var d=0,u=o.length;d<u;d++){s.push((new e.Vector3).fromArray(o[d]))}var l;if(r.start){var c=r.start||{};var h=r.end||{};var p=r.extension||{};l=this._nodes.get(r.start.sid)||this._rootNode;i.addLeaderLine(s,l,n,Y[c.style]||v.None,Y[h.style]||v.None,c.size,p.length||0)}else{l=this._nodes.get(r.startPointSid)||this._rootNode;i.addLeaderLine(s,l,n,ee[r.startPointHeadStyle],ee[r.endPointHeadStyle],r.pointHeadConstant,r.extensionLength)}}};V.prototype._findDetailViewNodes=function(e){var r=[];if(e){e.forEach(function(e){var a=this._nodes.get(e);if(a){r.push(a)}else{t.warning("Unknown detailView node reference",e)}},this)}return r};V.prototype.createDetailView=function(r,a){this._resetCurrentScene(a);var i=this._nodes.get(r.nodeId);if(!i){t.warning("Detail view node not found",r);return}var n=r.label;if(!n){this.createLegacyDetailView(r,i);return}var o=r.attachment;var d={name:r.name,camera:n.camera?this.createCamera(n.camera):null,type:r.cutaway?g.Cutaway:g.DetailView,borderWidth:n.borderWidth||0,backgroundColor:J.fromArray(n.colour||[1,1,1]).getStyle(),borderColor:J.fromArray(n.borderColour||[1,1,1]).getStyle(),origin:new e.Vector2(i.position.x*2-1+i.scale.x,i.position.y*-2+1-i.scale.x),size:new e.Vector2(i.scale.x,i.scale.y),attachmentPoint:(new e.Vector3).fromArray(o.position||[0,0,0]),veId:r.veid,visibleNodes:this._findDetailViewNodes(r.visibleNodes),targetNodes:this._findDetailViewNodes(r.targetNodes)};if(n.shape==="rect"){d.shape=!n.leaderStyle||n.leaderStyle==="none"?y.Box:y.BoxLine}else{d.shape={none:y.Circle,line:y.CircleLine,pointer:y.CirclePointer,arrow:y.CircleArrow,bubbles:y.CircleBubbles}[n.leaderStyle]||y.Circle}var u=new s(d);if(!this._rootNode.userData._vkDetailViews){this._rootNode.userData._vkDetailViews=[]}this._rootNode.userData._vkDetailViews.push({detailView:u,node:i,renderOrder:r.renderOrder||i.renderOrder||0})};V.prototype.createLegacyDetailView=function(t,r){if(!t.properlyAligned){if(!t.shape){t.shape=t.leaderStyle?y.BoxLine:y.Box}else{t.shape=[y.Circle,y.CircleLine,y.CirclePointer,y.CircleArrow,y.CircleBubbles][t.leaderStyle||0]}t.type=t.cutaway?g.Cutaway:g.DetailView;t.camera=t.camera?this.createCamera(t.camera):null;t.origin=new e.Vector2(r.position.x*2-1+r.scale.x,r.position.y*-2+1-r.scale.x);t.size=new e.Vector2(r.scale.x,r.scale.y);t.renderOrder=r.renderOrder}else{t.type=[g.DetailView,g.Cutaway][t.type];t.shape=[y.Box,y.Circle,y.CircleLine,y.CirclePointer,y.CircleArrow,y.CircleBubbles,y.BoxLine,y.BoxNoOutline,y.SolidPointer,y.SolidArrow][t.shape];t.camera=this._cameras.get(t.cameraId);t.origin=(new e.Vector2).fromArray(t.origin);t.size=(new e.Vector2).fromArray(t.size)}var a=new s({name:t.name,camera:t.camera,type:t.type,shape:t.shape,borderWidth:t.borderWidth||0,backgroundColor:t.backgroundColour?re(t.backgroundColour):"#fff",borderColor:t.borderColour?re(t.borderColour):"#000",origin:t.origin,size:t.size,attachmentPoint:(new e.Vector3).fromArray(t.attachment),metadata:t.metadata,veId:t.veid,visibleNodes:this._findDetailViewNodes(t.visibleNodes),targetNodes:this._findDetailViewNodes(t.targetNodes)});if(!this._rootNode.userData._vkDetailViews){this._rootNode.userData._vkDetailViews=[]}this._rootNode.userData._vkDetailViews.push({detailView:a,node:r,renderOrder:t.renderOrder||0})};V.prototype.insertThrustline=function(t){var r=this._nodes.get(t.thrustlineId);if(r&&!this._thrustlines.get(t.thrustlineId)){var a=new d({node:r,principleAxis:(new e.Vector3).fromArray(t.principleAxis),material:this._getMaterialRef(t.materialId)});var i=[];var n=0;var s=0;var o=0;for(var u=0;u<t.itemCount;u++){var l={};l.target=this._nodes.get(t.targets[u]);l.majorAxisIndex=t.itemMajorAxisesIndices[u];var c;l.basisAxises=[];o=n+t.itemBasisAxisesCounts[u];for(c=n;c<o;c++){var h={};h.x=t.itemBasisAxisesCoordinates[c*3];h.y=t.itemBasisAxisesCoordinates[c*3+1];h.z=t.itemBasisAxisesCoordinates[c*3+2];l.basisAxises.push(h)}n=o;l.dimension={};l.dimension.x=t.itemDimensionsCoordinates[u*3];l.dimension.y=t.itemDimensionsCoordinates[u*3+1];l.dimension.z=t.itemDimensionsCoordinates[u*3+2];l.center={};l.center.x=t.itemCentersCoordinates[u*3];l.center.y=t.itemCentersCoordinates[u*3+1];l.center.z=t.itemCentersCoordinates[u*3+2];l.boundPoints=[];o=s+t.itemBoundPointsCounts[u];for(c=s;c<o;c++){var p={};p.x=t.itemBoundPointsCoordinates[c*3];p.y=t.itemBoundPointsCoordinates[c*3+1];p.z=t.itemBoundPointsCoordinates[c*3+2];l.boundPoints.push(p)}s=o;i.push(l)}a.setItems(i);var f=0;var m=[];for(var v=0;v<t.segmentCount;v++){var g={};g.startItemIndex=t.segmentsStartItemIndices[v];g.endItemIndex=t.segmentsEndItemIndices[v];g.startBoundIndex=t.segmentsStartBoundIndices[v];g.endBoundIndex=t.segmentsEndBoundIndices[v];g.ratios=[];o=f+t.segmentRatioCounts[v];for(var y=0;y<o;y++){var _={};_.x=t.segmentRatiosCoordinates[y*2];_.y=t.segmentRatiosCoordinates[y*2+1];g.ratios.push(_)}f=o;m.push(g)}a.setSegments(m);this._thrustlines.set(t.thrustlineId,a);this._addDynamicObject(r,a._update.bind(a),false)}};V.prototype.updateViewsForReplacedNodes=function(e){var t=new Map;e.forEach(function(e){var r=this._nodes.get(e.sid);if(r){t.set(e.sid,r)}},this);function r(e,t){var r=e.getNodeInfos();r.forEach(function(e){var r=e.target;if(r&&r.userData&&r.userData.treeNode&&r.userData.treeNode.sid){var a=t.get(r.userData.treeNode.sid);if(a){e.target=a;a.updateMatrixWorld()}}})}function a(t,r){var a;var i=t.getPlaybacks();for(var n=0;n<i.length;n++){var s=i[n];var o=s.getSequence();if(o){var d=false;var u=o.getNodeAnimation();for(var l=0;l<u.length;l++){var c=u[l];var h=c.nodeRef;if(h&&h.userData&&h.userData.treeNode&&h.userData.treeNode.sid){a=r.get(h.userData.treeNode.sid);if(a){o.removeNodeAnimation(h,null,true);for(var p in c){if(p==="nodeRef"){continue}o.setNodeAnimation(a,p,c[p],true)}d=true}}}var f=o.getJoint();for(var m=0;f&&m<f.length;m++){var v=f[m];if(v.parentSid){a=r.get(v.parentSid);if(a){v.parent=a;d=true}}if(v.nodeSid){a=r.get(v.nodeSid);if(a){v.node=a;d=true}}}if(d){o._fireSequenceChanged()}}}e.forEach(function(e){var t=e.target;if(t&&t.userData&&t.userData.treeNode&&t.userData.treeNode.sid){var a=r.get(t.userData.treeNode.sid);if(a){e.target=a;a.updateMatrixWorld()}}})}this._views.forEach(function(e,i){r(e,t);a(e,t)})};V.prototype._decrementResourceCounters=function(e){e.traverse(function(e){if(e.isMesh){r.decreaseMaterialUsed(e.material);r.decreaseGeometryUsed(e.geometry)}})};V.prototype.decrementResourceCountersForDeletedTreeNode=function(e,t){this._resetCurrentScene(t);var r=this;e=[].concat(e);e.forEach(function(e){var t=r._nodes.get(e);if(t){r._decrementResourceCounters(t);r._nodes.delete(e)}});return this};V.prototype.remove=function(e,t){this._resetCurrentScene(t);var r=this;e=[].concat(e);e.forEach(function(e){var a=r._nodes.get(e);if(a){r._decrementResourceCounters(a);if(a.parent){a.parent.remove(a)}r._nodes.delete(e);var i=false;if(!r._forbiddenTextureUpdate){r._forbiddenTextureUpdate=true;i=true;var n=r._vkScene.getSceneRef().userData;if(n.instanceDataTexture){var s=n.geometryClusters;var o=k.prepareTextureUpdateResults(s?s.length:0,n.textureUpdateResults);k.removeNodeFromClusterRenderingRecursive(a,n.instanceDataTexture.image.data,o);n.textureUpdateResults=o}}for(var d=0;d<a.children.length;d++){var u=a.children[d];if(u.userData&&u.userData.treeNode&&u.userData.treeNode.sid){r.remove(u.userData.treeNode.sid,t)}}if(i){delete r._forbiddenTextureUpdate}}});return this};V.prototype.resourcesCleanUp=function(){var e=this._geometries;e.forEach(function(e){e.forEach(function(e){var t=e.geometry.userData.geometryUsed;if(t<=0){e.dispose()}})});return this};V.prototype.createCamera=function(t,r){this._resetCurrentScene(r);var a=t.near||1;var s=t.far||2e5;if(t.origin.length===3&&t.origin[0]===0&&t.origin[1]===0&&t.origin[2]===0){t.ortho=false;t.rotate=true}var o;if(t.ortho){o=new e.OrthographicCamera(-1,1,1,-1,a,s);o.zoom=t.zoom||-1}else{o=new e.PerspectiveCamera(e.MathUtils.radToDeg(t.fov),1,a,s)}if(t.origin){o.position.fromArray(t.origin)}if(t.up){o.up.fromArray(t.up);if(t.notUseDirectionVector){o.up.sub(o.position)}o.up.normalize()}if(t.rotate){o.userData.rotate=t.rotate;o.up.set(0,1,0)}if(t.target){var d=(new e.Vector3).fromArray(t.target);if(!t.notUseDirectionVector){d.add(o.position)}o.lookAt(d)}this._rootNode.userData.camera=o;var u=null;if(o.isOrthographicCamera){u=new i}else if(o.isPerspectiveCamera){u=new n}u.setCameraRef(o);u.setUsingDefaultClipPlanes(true);var l=t.id;if(l){this._cameras.set(l,u)}this._rootNode.userData.camera=u;return u};V.prototype.insertCamera=function(e,t,r){this._resetCurrentScene(r);var a=this._nodes.get(e);var i=this._cameras.get(t);var n=i&&i.getCameraRef();if(a&&n){(a||this._rootNode).add(n.parent?n.clone():n)}return this};V.prototype.getCamera=function(e){return this._cameras.get(e)};V.prototype.updateMaterialForGeometryWithoutNormal=function(t){var r=this._getMaterialRef(t);if(r&&r.emissive){r.emissive.copy(r.color);r.side=e.DoubleSide;if(this._vkScene.getDoubleSided()){if(!r.userData){r.userData={}}r.userData.originalMaterialSide=e.DoubleSide}}return this};V.prototype.createMaterial=function(t){var r=[];var i=t.id;var n=this._getMaterialRef(i);var s;if(t.lineWidth>0){if(!n||!n.isLineBasicMaterial){s=new D(b.LineBasicMaterial);n=s.getMaterialRef();this._vkScene.setMaterial(i,s)}n.color=new e.Color(t.lineColour[0],t.lineColour[1],t.lineColour[2]);n.linewidth=t.lineWidth;n.userData.lineStyle={width:t.lineWidth,haloWidth:t.lineHaloWidth||0,endCapStyle:t.lineEndRound?1:0,dashPattern:t.lineDashPattern||[],dashPatternScale:t.lineDashPatternScale,widthCoordinateSpace:t.lineWidthCoordinateSpace};n.userData.materialInfo=t;n.userData.materialId=i;return r}var o=null;if(t.textureEmissive){if(!n||!n.isMeshBasicMaterial){o=n;n=this._createTemporaryMaterial(i,b.MeshBasicMaterial)}}if(!n){n=this._createTemporaryMaterial(i)}delete n.userData.toBeUpdated;n.userData.materialInfo=t;if(t.diffuseColour){n.color.fromArray(t.diffuseColour)}if(t.specularColour&&n.specular){n.specular.fromArray(t.specularColour);if(t.specularLevel){n.specular.multiplyScalar(t.specularLevel)}}var d=true;if(t.emissiveColour){if(n.emissive){n.emissive.fromArray(t.emissiveColour);if(n.emissive.r!==0||n.emissive.g!==0||n.emissive.b!==0){d=false;n.depthFunc=e.LessDepth}}else{n.color.fromArray(t.emissiveColour)}}if(d&&t.ambientColour&&n.emissive){n.emissive.fromArray(t.ambientColour);n.emissive.multiplyScalar(.2)}if(t.opacity!==undefined){n.opacity=t.opacity;n.transparent=t.opacity<1;n.side=e.DoubleSide}var u=t.glossiness?t.glossiness:0;var l=Math.pow(2,u*10)*2;if(l<0){l=0}if(l>128){l=128}n.shininess=l;n.userData.defaultHighlightingEmissive=E;n.userData.defaultHighlightingSpecular=B;n.userData.imageIdsToAddAsTexture=new Set;var c,h;if(t.textureDiffuse){h=t.textureDiffuse;c=h[0]||h;n.userData.imageIdsToAddAsTexture.add(c.imageId)}else if(t.textureDecal){h=t.textureDecal;c=h[0]||h;n.userData.imageIdsToAddAsTexture.add(c.imageId)}if(t.textureBump){h=t.textureBump;c=h[0]||h;n.userData.imageIdsToAddAsTexture.add(c.imageId)}if(t.textureEmissive){h=t.textureEmissive;c=h[0]||h;n.userData.imageIdsToAddAsTexture.add(c.imageId)}if(t.textureAmbientOcclusion){h=t.textureAmbientOcclusion;c=h[0]||h;n.userData.imageIdsToAddAsTexture.add(c.imageId)}if(t.textureReflection){h=t.textureReflection;c=h[0]||h;n.userData.imageIdsToAddAsTexture.add(c.imageId)}if(n.userData.imageIdsToAddAsTexture.size===0){delete n.userData.imageIdsToAddAsTexture}r=this.updateTextureMaps(i);if(r.length>0){n.userData.imageIdsToLoad=new Set;for(var p=0;p<r.length;p++){var f=r[p];a.pushElementIntoMapArray(this._imageTextures,f.imageId,{textureType:f.textureType,materialId:i});n.userData.imageIdsToLoad.add(f.imageId)}}var m=this._materialMeshes.get(i);if(m){for(var v=0;v<m.length;v++){var g=m[v];var y=this._meshNodes.get(g);if(y){for(var _=0;_<y.length;_++){this._updateMaterial(y[_],i,n)}}if(o){this._updateMeshSubmeshesMaterial(g,i,n)}}}if(o){k.disposeMaterial(o)}return r};V.prototype.getMaterial=function(e){return this._getMaterialRef(e)};var ne=function(e){var t="";try{var r=32768;var a=0;var i=e.length;var n;while(a<i){n=e.slice(a,Math.min(a+r,i));t+=String.fromCharCode.apply(null,n);a+=r}}catch(e){t=""}return t};V.prototype.createImage=function(e){if(e.binaryData.length<32){t.warning("SceneBuilder.createImage()","Can't create image from empty data");return this}var r=new DataView(e.binaryData.buffer);var a=true;if(r.getUint8(0,true)===parseInt("0xFF",16)&&r.getUint8(1,true)===parseInt("0xD8",16)){a=false}var i=ne(e.binaryData);var n="data:image/"+(a?"png":"jpeg")+";base64,"+btoa(i);this._images.set(e.id,n);var s=this._imageTextures.get(e.id);if(s){this._imageTextures.delete(e.id);for(var o=0;o<s.length;o++){var d=s[o];this.updateTextureMap(d.materialId,d.textureType)}}return this};var se=new e.TextureLoader;var oe={Diffuse:0,Bump:1,Opacity:2,Reflection:3,Refraction:4,Specular:5,Ambient:6,Emissive:7,SpecularLevel:8,Glossiness:9,AmbientOcclusion:10,Decal:11};V.prototype.updateTextureMaps=function(e){var t=[];var r=this._getMaterialRef(e);if(!r){return t}var a=r.userData.materialInfo;if(!a){return t}if(a.textureDiffuse){var i=this.updateTextureMap(e,oe.Diffuse);if(i.imageId){t.push(i)}}else if(a.textureDecal){var n=this.updateTextureMap(e,oe.Decal);if(n.imageId){t.push(n)}}if(a.textureBump){var s=this.updateTextureMap(e,oe.Bump);if(s.imageId){t.push(s)}}if(a.textureEmissive){var o=this.updateTextureMap(e,oe.Emissive);if(o.imageId){r[r.emissive?"emissive":"color"].setRGB(1,1,1);t.push(o)}}if(a.textureAmbientOcclusion){var d=this.updateTextureMap(e,oe.AmbientOcclusion);if(d.imageId){t.push(d)}}if(a.textureReflection){var u=this.updateTextureMap(e,oe.Reflection);if(u.imageId){t.push(u)}}return t};V.prototype.updateTextureMap=function(t,r){var a={textureType:r,imageId:null};var i=this._getMaterialRef(t);if(!i){return a}var n=i.userData.materialInfo;if(!n){return a}var s=null;switch(r){case oe.Diffuse:s=n.textureDiffuse;break;case oe.Decal:s=n.textureDecal;break;case oe.Bump:s=n.textureBump;break;case oe.Reflection:s=n.textureReflection;break;case oe.Emissive:s=n.textureEmissive;break;case oe.AmbientOcclusion:s=n.textureAmbientOcclusion;break;default:break}if(!s){return a}var o=s[0]||s;var d=this._images.get(o.imageId);if(!d){a.imageId=o.imageId;return a}if(i.userData.imageIdsToLoad){i.userData.imageIdsToLoad.delete(o.imageId);if(i.userData.imageIdsToLoad.size===0){delete i.userData.imageIdsToLoad}}if(i.userData.parametricType==="sphere"){o.uvHorizontalScale=-1}var u=o.influence!==undefined?o.influence:0;function l(t,a){switch(r){case oe.Diffuse:case oe.Decal:t.map=a;if(d.startsWith("data:image/png")){t.transparent=true}break;case oe.Bump:t.bumpMap=a;t.bumpScale=u;break;case oe.Opacity:t.alphaMap=a;break;case oe.Reflection:a.mapping=e.EquirectangularReflectionMapping;t.envMap=a;t.combine=e.AddOperation;t.reflectivity=u;break;case oe.Emissive:t[t.emissiveMap!==undefined?"emissiveMap":"map"]=a;if(t.isSphericalMapMaterial){a.minFilter=e.LinearFilter}break;case oe.AmbientOcclusion:t.aoMap=a;break;default:}t.needsUpdate=true}se.load(d,function(r){r.wrapS=o.uvHorizontalTilingEnabled?e.RepeatWrapping:e.ClampToEdgeWrapping;r.wrapT=o.uvVerticalTilingEnabled?e.RepeatWrapping:e.ClampToEdgeWrapping;r.magFilter=o.filterMode===1?e.NearestFilter:e.LinearFilter;r.minFilter=o.filterMode===1?e.NearestFilter:e.LinearMipMapLinearFilter;r.anisotropy=4;var a=o.uvHorizontalOffset||0;var n=o.uvVerticalOffset||0;r.repeat.set(o.uvHorizontalScale||1,o.uvVerticalScale||1);r.center.set(-a,-n);r.offset.set(a,n);r.rotation=-o.uvRotationAngle;if(i.isMeshBasicMaterial){r.generateMipmaps=false;r.minFilter=o.filterMode===1?e.NearestFilter:e.LinearFilter}l(i,r);if(i.userData.imageIdsToAddAsTexture&&o.imageId){i.userData.imageIdsToAddAsTexture.delete(o.imageId);if(i.userData.imageIdsToAddAsTexture.size===0){delete i.userData.imageIdsToAddAsTexture}}var s=this._materialClones.get(t);if(s){s.forEach(function(e){l(e,r)})}this.fireImageAddedToMaterial({materialId:t});if(this._fireSceneUpdated){this._fireSceneUpdated()}}.bind(this));return a};V.prototype.insertPlayback=function(e,t,r){this._resetCurrentScene(r);var i=this._vkScene.findSequence(e.sequenceId);var n=new _(e.id,{sequence:i,timeScale:e.speed?1/e.speed:1,preDelay:e.preDelay?e.preDelay:0,postDelay:e.postDelay?e.postDelay:0,repeats:e.repeat?Math.abs(e.repeat):0,reversed:e.reversed?true:false,startTime:e.start?e.start:0});var s=this._views.get(t);if(s){s.addPlayback(n)}if(!i){a.pushElementIntoMapArray(this._sequenceIdToPlaybacks,e.sequenceId,n)}return this};V.prototype.insertSequence=function(e,t){var r=this._vkScene.findSequence(e.id);if(r){this._vkScene.removeSequence(r)}var i;if(e.endTime){if(e.startTime){i=e.endTime-e.startTime}else{i=e.endTime}}else{i=1}r=this._vkScene.createSequence(e.id,{name:e.name,duration:i});if(Array.isArray(e.joints)){e.joints.forEach(function(e){var t=this._joints[e];if(t){r.setJoint(t,true)}},this)}if(e.nodes&&e.nodes.length>0){for(var n=0;n<e.nodes.length;n++){var s=e.nodes[n];if(s.empty){s.type=s.binding;var o=this._nodes.get(s.sid);this._animationHelper.insertEmptyTrack(s,r,o,this._vkScene);continue}a.pushElementIntoMapArray(this._trackIdSequenceNodeMap,s.trackId,{sequenceId:e.id,targetId:s.sid,type:s.binding,pivot:s.pivot,isAbsoluteValue:s.isAbsoluteValue})}}var d=this._sequenceIdToPlaybacks.get(e.id);if(d){d.forEach(function(e){e.setSequence(r)})}return this};V.prototype.insertTracks=function(e){this._animationHelper.insertTracks(e,this._trackIdSequenceNodeMap,this._nodes,this._vkScene);return this};V.prototype.insertJoints=function(e,t){this._resetCurrentScene(t);this._joints=[];e.forEach(function(e){var t=this._nodes.get(e.childSid);var r=this._nodes.get(e.parentSid);var a={id:e.id,node:t,parent:r,translation:new Float32Array(e.t?e.t:[0,0,0]),quaternion:new Float32Array(e.q?e.q:[0,0,0,1]),scale:new Float32Array(e.s?e.s:[1,1,1])};if(!t){var i=this._jointNodesMap.get(e.childSid);if(!i){i=[]}i.push(a);this._jointNodesMap.set(e.childSid,i)}if(!r){var n=this._jointParentsMap.get(e.parentSid);if(!n){n=[]}n.push(a);this._jointParentsMap.set(e.parentSid,n)}this._joints.push(a)},this);return this};V.prototype.finalizeAnimation=function(){var e=this._rootNode;if(e){while(e.parent){e=e.parent}e.userData.tracks=this._tracks}return this};V.prototype.finalizePlaybacks=function(){var e=this._rootNode;if(e){while(e.parent){e=e.parent}}else{return this}if(!e.userData.animationNodeOriginalData){e.userData.animationNodeOriginalData=new Map}var t;var r=this._viewGroups.entries();var a=r.next();while(!a.done){t=a.value[1];a=r.next();var i=[];for(var n=0;n<t.getViews().length;n++){if(t.getViews()[n].id){var s=this._views.get(t.getViews()[n].id);if(s){i.push(s)}}}}return this};V.prototype.finalizeViewGroups=function(e){this._resetCurrentScene(e);var t=this._viewGroups.entries();var r=t.next();while(!r.done){var a=r.value[1];var i=r.value[0];if(!a||!a.views||!a.views.length){r=t.next();continue}a.removeViews();for(var n=0;n<a.views.length;n++){var s=a.views[n].id;var o=this._views.get(s);if(o&&o.userData.viewInfo.thumbnailId&&!o.thumbnailData){var d=this._images.get(o.userData.viewInfo.thumbnailId);if(d){o.thumbnailData=d}}if(o){o.viewGroupId=i;a.addView(o)}}r=t.next()}return this};V.prototype.insertViewGroup=function(e,t){this._resetCurrentScene(t);var r=this._viewGroups.get(e.id);if(!r){r=this._vkScene.createViewGroup({viewGroupId:e.id,name:e.name,description:e.description});this._viewGroups.set(e.id,r)}else{r.setViewGroupId(e.id);r.setName(e.name);r.setDescription(e.description)}r.type=e.type;r.metadata=e.metadata;r.veids=e.veids;r.views=e.views;r.sceneId=e.sceneId;return this};V.prototype.getViewGroup=function(e,t){this._resetCurrentScene(t);var r=this._viewGroups.get(e);var a=[];if(r&&r.views){for(var i=0;i<r.views.length;i++){var n=r.views[i].id;var s=this._views.get(n);if(s){a.push(s)}}}return a};var de={turntable:C.Turntable,orbit:C.Orbit,pan:C.Pan,zoom:C.Zoom};V.prototype.insertView=function(e,t){this._resetCurrentScene(t);var r=e.description;if(r){var a=new RegExp("^<[^>]*?>");if(a.test(r)){var i=new RegExp("(^(<[^>]*?>s*)+)|((<[^>]*?>s*)+$)","g");var n=r.replace(i,"");if(!n){r=n}}r='<pre class="sapVizKitViewGalleryStepDescriptionPre">'+r+"</pre>"}var s=this._views.get(e.viewId);if(s==null){s=this._vkScene.createView({viewId:e.viewId,name:e.name,description:r,aspectRatio:e.safeAreaAspectRatio,autoPlayAnimation:e.autoPlayAnimation,navigationMode:de[e.navigationMode]||C.NoChange,dimension:e.dimension||3});this._views.set(e.viewId,s)}else{s.removePlaybacks(true);s.setName(e.name);s.setDescription(r);s.setAspectRatio(e.safeAreaAspectRatio);s.setAutoPlayAnimation(e.autoPlayAnimation);s.setNavigationMode(de[e.navigationMode]||C.NoChange);s.setDimension(e.dimension||3)}s.userData={};s.userData.viewInfo=e;if(e.thumbnailId){var o=this._images.get(e.thumbnailId);if(o){s.thumbnailData=o}else{this._viewThumbnails.set(e.thumbnailId,s)}}if(e.animatedThumbnailId){var d=this._images.get(e.animatedThumbnailId);if(d){s.animatedThumbnailData=d;s.tileWidth=this._imageIdsAndTileWidths.get(e.animatedThumbnailId)}}if(e.cameraId){s.setCamera(this._cameras.get(e.cameraId))}s.type=e.type;s.flyToTime=e.flyToTime;s.preDelay=e.preDelay;s.postDelay=e.postDelay;s.navigationMode=e.navigationMode;var u=this._getSavedColor(e.topColour,localStorage.getItem("color.backgroundTop"));if(u!=null){s.setTopColor(u)}var l=this._getSavedColor(e.bottomColour,localStorage.getItem("color.backgroundBottom"));if(l!=null){s.setBottomColor(l)}s.renderMode=O[e.renderMethod];s.dimension=e.dimension;s.query=e.query;s.metadata=e.metadata;s.veids=e.veids;s.viewGroupId=e.viewGroupId;s.id=e.viewId;if(s.viewGroupId){var c=this._viewGroups.get(s.viewGroupId);if(c){var h=c.indexOfView(s);if(h<0){c.addView(s)}}}return this};V.prototype.setModelViewVisibilitySet=function(e){var r=this._views.get(e.viewId);var a=new Set;var i=[];e.visibleNodes.forEach(function(e){var r=this._nodes.get(e);if(r){a.add(r);i.push({target:r,visible:true})}else{t.warning("Unknown modelView visible node reference",e)}},this);Array.from(a).forEach(function(e){e=e.parent;while(e&&!a.has(e)){a.add(e);i.push({target:e,visible:true});e=e.parent}});if(r){r.updateNodeInfos(i)}};V.prototype.recordHighlightedNodeInView=function(e,t,r,a){this._resetCurrentScene(a);var i=this._views.get(r);if(!i){return this}var n=this._nodes.get(t);if(!n){return this}i.addHighlightedNodes(e,n);return this};V.prototype.insertHighlightStyle=function(e){var t=this._vkScene.getHighlight(e.id);if(t){return this}if(e.duration>0){if(e.colours&&e.colours.length===1&&(!e.opacities||e.opacities.length===1)){var r=e.colours[0];e.colours.push([r[0],r[1],r[2],0])}else if(!e.colours&&e.opacities&&e.opacities.length===1){e.opacities.push(0)}}this._vkScene.createHighlight(e.id,e);return this};V.prototype.insertModelViewHighlight=function(t){var r=this._views.get(t.viewId);if(r){var a=[];t.highlightNodes.forEach(function(e){var t=this._nodes.get(e);if(t){a.push(t)}else{}},this);var i={duration:t.duration,cycles:t.cycles};if(!t.id){t.id=e.MathUtils.generateUUID().toLowerCase()}var n=new e.Color(t.color1).toArray();var s=new e.Color(t.color2).toArray();n[3]=(t.color1>>>24&255)/255;s[3]=(t.color2>>>24&255)/255;i.colours=[n,s];i.opacities=[t.opacity1,t.opacity2];this._vkScene.createHighlight(t.id,i);r.addHighlightedNodes(t.id,a)}};V.prototype.createThumbnail=function(e){var t=this._viewThumbnails.get(e.imageId);if(t){t.thumbnailData="data:image/"+"jpeg"+";base64,"+window.btoa(String.fromCharCode.apply(null,e.data));if(this._fireThumbnailLoaded){this._fireThumbnailLoaded({modelView:t})}}};V.prototype.highlightStyleExists=function(e){var t=this._vkScene.getHighlight(e);return t!==undefined};V.prototype.getView=function(e,t){this._resetCurrentScene(t);return this._views.get(e)};V.prototype.getSequence=function(e){return this._vkScene.findSequence(e)};V.prototype.setViewCamera=function(e,t,r){this._resetCurrentScene(r);var a=this._cameras.get(e);var i=this._views.get(t);if(a&&i){i.setCamera(a)}return this};V.prototype.setViewNodeInfos=function(e,t,r){this._resetCurrentScene(r);var a=this._views.get(t);a.setNodeInfos(e);return this};V.prototype.setViewThumbnail=function(e,t,r,a){this._resetCurrentScene(r);var i=this._views.get(t);var n=this._images.get(e);if(a){this._imageIdsAndTileWidths.set(e,a)}if(i&&n){if(i.userData!==undefined){if(i.userData.viewInfo.thumbnailId===e){i.thumbnailData=n}else if(i.userData.viewInfo.animatedThumbnailId===e){i.animatedThumbnailData=n;i.tileWidth=a}}}return this};V.prototype.cleanup=function(){this._rootNode=null;this._currentSceneId=null;this._contentResource=null;this._resolve=null;this._reject=null;if(this._vkScene){this._vkScene.clearMaterials()}this._callouts.forEach(function(e){e.destroy()});this._callouts.clear();this._cameras.forEach(function(t){if(!t instanceof e.Camera){t.destroy()}});this._cameras.clear();this._images.clear();this._imageIdsAndTileWidths.clear();this._imageTextures.clear();this._geometries.clear();this._meshNodes.clear();this._meshSubmeshes.clear();this._geometryMeshes.clear();this._materialMeshes.clear();this._geometryMaterials.clear();this._materialClones.clear();this._joints=[];this._imageAddedToMaterialHandlers=[];this._isSmallScene=null;if(this._nodes){this._nodes.clear()}if(this._tracks){this._tracks.clear()}if(this._trackIdSequenceNodeMap){this._trackIdSequenceNodeMap.clear()}if(this._viewGroups){this._viewGroups.clear()}if(this._views){this._views.clear()}this._sceneIdTreeNodesMap.clear();this._sceneIdRootNodeMap.clear();this._viewThumbnails.clear();this._thrustlines.clear();this._animations.clear();this._animationTracks.clear();this._jointNodesMap.clear();this._jointParentsMap.clear()};V.prototype.insertAnimationGroup=function(e){var t=this._vkScene.findSequence(e.animationGroupRef.toString());if(!t){var r;if(e.endTime){r=e.endTime-e.startTime;if(!e.startTime){e.startTime=0}}t=this._vkScene.createSequence(e.animationGroupRef.toString(),{name:e.name,duration:r});if(!t.userData){t.userData={}}t.userData.animations=[]}if(e.modelViewRef){var a=this._views.get(e.modelViewRef);if(a){var i=this._vkScene.findSequence(e.animationGroupRef.toString());var n=new _({sequence:i,timeScale:e.playbackSpeed?1/e.playbackSpeed:1,preDelay:e.playbackPreDelay?e.playbackPreDelay:0,postDelay:e.playbackPostDelay?e.playbackPostDelay:0,repeat:e.playbackRepeat?Math.abs(e.playbackRepeat):0,reversed:e.playbackReversed?true:false,startTime:0});a.addPlayback(n)}}};V.prototype.insertAnimation=function(e){var t=this._animations.get(e.animationRef);if(!t){t={};t.type=e.animationType;t.targetRefs=[];t.targetPivots=[];t.sequenceId=e.animationGroupRef.toString();t.trackIds=new Set;t.tracks=[];this._animations.set(e.animationRef,t)}if(e.animationGroupRef){var r=this._vkScene.findSequence(e.animationGroupRef.toString());if(!r.userData.animations.includes(e.animationRef)){r.userData.animations.push(e.animationRef)}}};V.prototype.insertAnimationTarget=function(e){var t=this._animations.get(e.animationRef);if(t){if(!t.targetRefs.includes(e.targetRef)){t.targetRefs.push(e.targetRef);t.targetPivots.push({x:e.targetPivotX,y:e.targetPivotY,z:e.targetPivotZ})}}};V.prototype.insertAnimationTrack=function(e){var t=this._animationTracks.get(e.animationTrackRef);var r=e.animationRef;if(!t){delete e.animationRef;t=e;this._animationTracks.set(e.animationTrackRef,t)}if(!r){return}var i=this._animations.get(r);if(!i||!i.sequenceId){return}if(i.trackIds.has(t.animationTrackRef)){return}i.trackIds.add(t.animationTrackRef);for(var n=0;i.targetRefs&&n<i.targetRefs.length;n++){var s=i.targetRefs[n];var o=i.targetPivots[n];var d=this._nodes.get(s);if(!d){continue}var u;if(o.x!==0||o.y!==0||o.z!==0){u=[o.x,o.y,o.z]}var l=["OPACITY","COLOUR","TRANSLATE","SCALE","ROTATE"][t.type]||"";a.pushElementIntoMapArray(this._trackIdSequenceNodeMap,e.animationTrackRef,{sequenceId:i.sequenceId,targetId:s,type:l,pivot:u,isAbsoluteValue:true});var c={};c.times=Array.prototype.slice.call(t.times);c.values=Array.prototype.slice.call(t.values);c.id=e.animationTrackRef;c.cyclicInfo={};c.cyclicInfo.cyclicStart=t.cyclicStart;c.cyclicInfo.cyclicEnd=t.cyclicEnd;var h;if(i.type===0){if(t.dataType===0){if(t.values.length!==t.keyCount||t.times.length!==t.keyCount){continue}if(t.type===3){c.values=[];for(h=0;h<t.keyCount;h++){c.values.push(t.values[h]);c.values.push(t.values[h]);c.values.push(t.values[h])}}}else if(t.dataType===1||t.dataType===3){if(t.values.length!==3*t.keyCount||t.times.length!==t.keyCount){continue}}else if(t.dataType===4||t.dataType===5||t.dataType===6){if(t.values.length!==4*t.keyCount||t.times.length!==t.keyCount){continue}if(t.dataType===4){c.rotateType=w.AngleAxis}else if(t.dataType===6){c.rotateType=w.Euler}else{c.rotateType=w.Quaternion;for(var p=3;p<c.values.length;p=p+4){c.values[p]=-c.values[p]}}}}i.tracks.push(c)}};V.prototype.setAnimationTracks=function(e){var t=this._animations.get(e);if(t){this._animationHelper.insertTracks(t.tracks,this._trackIdSequenceNodeMap,this._nodes,this._vkScene)}};V.prototype.setAnimationPlaybacks=function(e){var t=this._viewGroups.get(e.viewGroupId);this._animationHelper.setInitialNodePositionsFromSubsequentViews(t.getViews(),this._vkScene);this._animationHelper.setInitialNodePositionsFromPreviousViews(t.getViews(),this._vkScene);this._animationHelper.setInitialNodePositionsFromCurrenetViews(t.getViews(),this._vkScene);this._animationHelper.setPlaybackStartTimes(t.getViews(),this._vkScene);this._animationHelper.buildViewsInitialState(t.getViews(),this._vkScene)};V.prototype.getSphere=function(e,t,r){var a=M.generateSphere(t,r);if(e.userData&&e.userData.nodeContentType){a.userData.nodeContentType=e.userData.nodeContentType}a.userData.skipIt=true;a.renderOrder=e.renderOrder;e.add(a)};V.prototype.getPlane=function(e,t,r){var a=M.generatePlane(t,r);if(e.userData&&e.userData.nodeContentType){a.userData.nodeContentType=e.userData.nodeContentType}a.userData.skipIt=true;a.renderOrder=e.renderOrder;e.add(a)};V.prototype.preferMeshes=function(){return true};V.prototype.setParametricContent=function(e,r,a){this._resetCurrentScene(a);var i={sphere:this.getSphere.bind(this),plane:this.getPlane.bind(this)};if(r.type in i===false){t.warning("Attempt to load unknown parametric type: "+r.type);return}var n=r.type;var s=this.getNode(e,this.sceneId);var o=r.materialID;var d=null;if(o){d=this._getMaterialRef(o)||this._createTemporaryMaterial(o);if(s.userData.parametricVisible){d.userData.parametricType=n}}i[n](s,r,d)};V.prototype.insertFillStyle=function(e){};V.prototype.insertLineStyle=function(e){};V.prototype.insertTextStyle=function(e){};V.prototype._getSavedColor=function(e,t){if(e&&e.length>2){return R({red:Math.floor(e[0]*255),green:Math.floor(e[1]*255),blue:Math.floor(e[2]*255),alpha:e.length>3?e[3]:1})}else if(t){return t}return undefined};return V});