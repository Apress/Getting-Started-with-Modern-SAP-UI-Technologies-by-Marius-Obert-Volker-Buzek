/*!
 * SAPUI5
 * (c) Copyright 2009-2023 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/comp/library","sap/ui/core/date/UI5Date","sap/ui/comp/util/DateTimeUtil","sap/ui/comp/odata/ODataType","sap/ui/comp/util/FormatUtil","sap/ui/core/format/DateFormat","sap/ui/core/format/TimezoneUtil","sap/base/Log"],function(e,a,t,i,n,l,r,s){"use strict";var o=e.smartfilterbar.FilterType;var g=e.valuehelpdialog.ValueHelpRangeOperation;var u=e.ANALYTICAL_PARAMETER_PREFIX;var d=function(){};d.prototype.convert=function(e,a,t,i,n,l,r){var s,o,g,u,f=null,h,p;var c={SelectionVariantID:e};if(l){c.ParameterContextUrl=l}if(r){c.FilterContextUrl=r}this._sAPILevel=n;if(t&&a){g=JSON.parse(t);if(g){s=this._getFields(a);if(s&&s.length>0){for(o=0;o<s.length;o++){this._convertField(c,s[o],g,i)}}if(g._CUSTOM){if(typeof g._CUSTOM==="string"){u=JSON.parse(g._CUSTOM)}else{u=g._CUSTOM}for(f in u){if(f){if(Array.isArray(u[f])&&u[f].length>1){this._addArrayOfSingleValues(c,f,u[f])}else{this._addSingleValue(c,f,d._getValue(u[f],true))}}}}if(i&&i.getBasicSearchName){h=i.getBasicSearchName();if(h){p=i.getBasicSearchValue();this._addSingleValue(c,h,d._getValue(p,true))}}}}return JSON.stringify(c)};d.prototype._getParameterMetaData=function(e,a){var t,i,n;var l=a.getFilterBarViewMetadata();if(l){for(t=0;t<l.length;t++){n=l[t];for(i=0;i<n.fields.length;i++){if(e===n.fields[i].fieldName){return n.fields[i]}}}}if(a.getAnalyticalParameters){var r=a.getAnalyticalParameters();if(r){for(i=0;i<r.length;i++){if(e===r[i].fieldName){return r[i]}}}}return null};d.prototype._convertField=function(e,a,t,l){var r,s,g=null,u,f,h,p;if(t&&a&&e){r=t[a];if(r){f=this._getParameterMetaData(a,l);if(f){if(f.isCustomFilterField){return}var c=l.getUseDateRangeType()&&(f.type==="Edm.DateTime"&&f.displayFormat==="Date"||f.type==="Edm.String"&&f.isCalendarDate)||t[a]&&t[a].conditionTypeInfo&&t[a].conditionTypeInfo.name&&t[a].conditionTypeInfo.name==="sap.ui.comp.config.condition.DateRangeType";if(f.filterRestriction===o.single&&(!c||f.isParameter)){s=r.value===undefined?r:r.value;s=d._getValueWithMetadata(l,f,s,true);this._addSingleValue(e,a,s);if(c&&f.isParameter){if(t&&a&&e&&t[a]&&t[a].conditionTypeInfo){var r=t[a];if(r.ranges&&r.ranges.length>0){u=d.addRangeEntry(e,a);d.addRanges(u,r.ranges,l,f)}}}}else if(f.filterRestriction===o.interval){if(r.conditionTypeInfo){this._convertFieldByValue(e,a,t,l,f)}else{u=d.addRangeEntry(e,a);if(f.type==="Edm.DateTime"&&!r.high){r.high=r.low}else if(f.type==="Edm.String"&&!r.high){g="EQ"}if(f.type==="Edm.Time"){this._addRangeMultipleRangeValues(l,f,u,r.ranges,true)}else if(f.type==="Edm.DateTimeOffset"&&!r.high){g="BT";h=n.parseDateTimeOffsetInterval(r.low);if(h&&h.length===2&&h[0]){h[0]=f.ui5Type.parseValue(h[0],"string");if(h.length===2){h[1]=f.ui5Type.parseValue(h[1],"string")}p={low:h[0],high:h[1]};this._addRangeLowHigh(l,f,u,p,"BT")}else{this._addRangeLowHigh(l,f,u,r,"EQ")}}else if(i.isNumeric(f.type)&&!r.high){h=n.parseFilterNumericIntervalData(r.low);if(h&&h.length===2&&h[0]){this._addRangeLowHigh(l,f,u,{low:h[0],high:h[1]},"BT")}else{this._addRangeLowHigh(l,f,u,r,"EQ")}}else{this._addRangeLowHigh(l,f,u,r,g)}}}else if(f.filterRestriction===o.multiple){u=d.addRangeEntry(e,a);if(r.items&&r.items.length>0){this._addRangeMultipleSingleValues(l,f,u,r.items)}else if(r.ranges&&r.ranges.length>0){this._addRangeMultipleRangeValues(l,f,u,r.ranges,r.conditionTypeInfo?true:false)}else{this._addRangeSingleValue(u,r.value)}}else{this._convertFieldByValue(e,a,t,l,f)}}else{this._convertFieldByValue(e,a,t,l,f)}}}};d.prototype._convertFieldByValue=function(e,a,t,i,n){var l;var r;if(t&&a&&e){l=t[a];if(l){if(l.conditionTypeInfo){if(l.ranges&&l.ranges.length>0){r=d.addRangeEntry(e,a);d.addRanges(r,l.ranges,i,n)}}else if(l.ranges!==undefined&&l.items!==undefined&&l.value!==undefined){r=d.addRangeEntry(e,a);if(l.ranges&&l.ranges.length>0){d.addRanges(r,l.ranges,i,n)}if(l.items&&l.items.length>0){this._addRangeMultipleSingleValues(i,n,r,l.items)}if(l.value){this._addRangeSingleValue(r,d._getValueWithMetadata(i,n,l.value))}}else if(l.items!==undefined&&l.items&&l.items.length>0){r=d.addRangeEntry(e,a);this._addRangeMultipleSingleValues(i,n,r,l.items)}else if(l.low!==undefined&&l.low&&l.high!==undefined&&l.high){r=d.addRangeEntry(e,a);this._addRangeLowHigh(i,n,r,l)}else if(l.value!==undefined&&l.value){this._addSingleValue(e,a,l.value)}else if(l){this._addSingleValue(e,a,l)}}}};d.addRangeEntry=function(e,a){var t={PropertyName:a,Ranges:[]};if(!e.SelectOptions){e.SelectOptions=[]}e.SelectOptions.push(t);return t.Ranges};d.addRanges=function(e,a,t,i){var n,l,r,o;for(var u=0;u<a.length;u++){n=a[u].exclude?"E":"I";r=d._getValueWithMetadata(t,i,a[u].value1,true);o=null;if(a[u].operation===g.BT){o=d._getValueWithMetadata(t,i,a[u].value2)}switch(a[u].operation){case g.Contains:l="CP";if(r){r="*"+r+"*"}break;case g.StartsWith:l="CP";if(r){r=r+"*"}break;case g.EndsWith:l="CP";if(r){r="*"+r}break;case g.Empty:l="EQ";r="";break;case g.EQ:case g.BT:case g.LE:case g.GE:case g.GT:case g.LT:l=a[u].operation;break;default:s.error("ValueHelpRangeOperation is not supported '"+a[u].operation+"'");return}e.push({Sign:n,Option:l,Low:r,High:o})}};d.prototype._addRangeMultipleSingleValues=function(e,a,t,i){for(var n=0;n<i.length;n++){t.push({Sign:"I",Option:"EQ",Low:d._getValueWithMetadata(e,a,i[n].key,true),High:null})}};d.prototype._addRangeMultipleRangeValues=function(e,a,t,i,n){for(var l=0;l<i.length;l++){t.push({Sign:i[l].exclude?"E":"I",Option:n?"BT":"EQ",Low:d._getValueWithMetadata(e,a,i[l].value1,true),High:n?d._getValueWithMetadata(e,a,i[l].value2):null})}};d.prototype._addRangeSingleValue=function(e,a){e.push({Sign:"I",Option:"EQ",Low:d._getValue(a,true),High:null})};d.prototype._addRangeLowHigh=function(e,a,t,i,n){var l=n||"BT";t.push({Sign:"I",Option:l,Low:d._getValueWithMetadata(e,a,i.low,true),High:d._getValueWithMetadata(e,a,i.high)})};d.prototype._addParamaterSingleValue=function(e,a,t){if(!e.Parameters){e.Parameters=[]}e.Parameters.push({PropertyName:a,PropertyValue:t})};d.prototype._createRangeSingleValue=function(e,a,t){var i=d.addRangeEntry(e,a);this._addRangeSingleValue(i,t)};d.prototype._addSingleValue=function(e,a,t){var i;if(this._sAPILevel){i=a.split(u);if(i.length>1){this._addParamaterSingleValue(e,i[i.length-1],t)}else{this._createRangeSingleValue(e,a,t)}}else{this._addParamaterSingleValue(e,a,t)}};d.prototype._addArrayOfSingleValues=function(e,a,t){var i=d.addRangeEntry(e,a);t.forEach(function(e){i.push({Sign:"I",Option:"EQ",Low:d._getValue(e,true),High:null})})};d.prototype._getFields=function(e){var a=[];if(e){for(var t=0;t<e.length;t++){a.push(e[t].name)}}return a};d._getValue=function(e,a){if(e===null||e===undefined||e===""){return a?"":null}return""+e};d._getValueWithMetadata=function(e,i,n,l){if(n===null||n===undefined||n===""){return l?"":null}else if(e&&i){if(i.type==="Edm.DateTime"||i.type==="Edm.Time"){if(i.isParameter&&n.oData){n=n.oData}if(i.isParameter&&!n.oData&&n.ranges&&n.ranges[0]&&n.ranges[0].value1){n=n.ranges[0].value1}if(e&&e.isInUTCMode&&e.isInUTCMode()){n=t.localToUtc(a.getInstance(n)).toJSON()}if(n.indexOf("Z")===n.length-1){n=n.substr(0,n.length-1)}}else if(i.type==="Edm.DateTimeOffset"){var r=e&&e._oFilterProvider&&e._oFilterProvider._getFilterTimeZone(i.name);if(r){n=t.toTimezone(n,r).toJSON()}else{n=a.getInstance(n).toJSON()}}}return""+n};return d},true);