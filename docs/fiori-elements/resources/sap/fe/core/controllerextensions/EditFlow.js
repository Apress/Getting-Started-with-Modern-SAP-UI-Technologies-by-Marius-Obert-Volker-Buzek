/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/controllerextensions/collaboration/ActivitySync","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/controllerextensions/editFlow/draft","sap/fe/core/controllerextensions/editFlow/sticky","sap/fe/core/controllerextensions/editFlow/TransactionHelper","sap/fe/core/controllerextensions/Feedback","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/ClassSupport","sap/fe/core/helpers/EditState","sap/fe/core/helpers/MetaModelFunction","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/ResourceModelHelper","sap/fe/core/helpers/SemanticKeyHelper","sap/fe/core/library","sap/m/Button","sap/m/Dialog","sap/m/MessageToast","sap/m/Text","sap/ui/core/Core","sap/ui/core/library","sap/ui/core/message/Message","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","sap/ui/model/odata/v4/ODataListBinding","../ActionRuntime"],function(t,e,i,n,o,r,s,a,c,l,d,g,u,h,f,p,y,v,m,w,C,M,P,b,S,D,E,x){"use strict";var A,k,_,I,O,R,T,F,B,V,H,N,j,L,$,G,U,q,K,W,z,J,X,Q,Y,Z,tt,et,it,nt,ot;var rt=f.getResourceModel;var st=u.getNonComputedVisibleFields;var at=d.publicExtension;var ct=d.finalExtension;var lt=d.extensible;var dt=d.defineUI5Class;var gt=l.getInvolvedDataModelObjects;var ut=l.convertTypes;var ht=c.TriggerType;var ft=c.triggerConfiguredSurvey;var pt=c.StandardActions;var yt=o.shareObject;var vt=o.Activity;function mt(t,e){t.prototype=Object.create(e.prototype);t.prototype.constructor=t;wt(t,e)}function wt(t,e){wt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,i){e.__proto__=i;return e};return wt(t,e)}function Ct(t,e,i,n,o){var r={};Object.keys(n).forEach(function(t){r[t]=n[t]});r.enumerable=!!r.enumerable;r.configurable=!!r.configurable;if("value"in r||r.initializer){r.writable=true}r=i.slice().reverse().reduce(function(i,n){return n(t,e,i)||i},r);if(o&&r.initializer!==void 0){r.value=r.initializer?r.initializer.call(o):void 0;r.initializer=undefined}if(r.initializer===void 0){Object.defineProperty(t,e,r);r=null}return r}const Mt=y.CreationMode,Pt=y.ProgrammingModel,bt=y.Constants,St=y.DraftStatus,Dt=y.EditMode,Et=y.StartupMode,xt=P.MessageType;let At=(A=dt("sap.fe.core.controllerextensions.EditFlow"),k=at(),_=ct(),I=at(),O=ct(),R=at(),T=ct(),F=at(),B=lt(D.After),V=at(),H=lt(D.After),N=at(),j=lt(D.After),L=at(),$=lt(D.After),G=at(),U=lt(D.After),q=at(),K=ct(),W=at(),z=ct(),J=at(),X=ct(),Q=at(),Y=ct(),Z=at(),tt=ct(),et=at(),it=ct(),A(nt=(ot=function(o){mt(c,o);function c(){var t;for(var e=arguments.length,i=new Array(e),n=0;n<e;n++){i[n]=arguments[n]}t=o.call(this,...i)||this;t.syncTasks=Promise.resolve();return t}var l=c.prototype;l.getAppComponent=function t(){return this.base.getAppComponent()};l.editDocument=async function e(i){const n=true;const o=this.getTransactionHelper();const r=this._getRootViewController();const s=i.getModel();let a,c;const l=this.getView().getViewData();const d=this.getProgrammingModel(i);let g=i;const u=this.getView();try{if((l===null||l===void 0?void 0:l.viewLevel)>1){if(d===Pt.Draft){const t=h.getDraftRootPath(i);g=u.getModel().bindContext(t).getBoundContext();await g.requestObject(t)}else if(d===Pt.Sticky){const t=h.getStickyRootPath(i);g=u.getModel().bindContext(t).getBoundContext();await g.requestObject(t)}}await this.base.editFlow.onBeforeEdit({context:g});const t=await o.editDocument(g,this.getView(),this.getAppComponent(),this.getMessageHandler());this._setStickySessionInternalProperties(d,s);if(t){this.setEditMode(Dt.Editable,false);this.setDocumentModified(false);this.getMessageHandler().showMessageDialog();if(t!==g){let e=t;if(this._isFclEnabled()){a=r.getRightmostContext();c=await this._computeSiblingInformation(g,a,d,true);c=c??this._createSiblingInfo(i,t);this._updatePathsInHistory(c.pathMapping);if(c.targetContext.getPath()!=t.getPath()){e=c.targetContext}}else if((l===null||l===void 0?void 0:l.viewLevel)>1){c=await this._computeSiblingInformation(g,i,d,true);e=this._getNavigationTargetForEdit(i,t,c)}await this._handleNewContext(e,true,false,n,true);if(d===Pt.Sticky){let e;if(this._isFclEnabled()){e=t.getModel().getKeepAliveContext(t.getPath())}else{e=t}this.handleStickyOn(e)}else if(h.isCollaborationDraftSupported(s.getMetaModel())){await yt(t)}}}}catch(e){t.error("Error while editing the document",e)}};l.deleteMultipleDocuments=async function o(r,s){if(s){s.beforeDeleteCallBack=this.base.editFlow.onBeforeDelete}else{s={beforeDeleteCallBack:this.base.editFlow.onBeforeDelete}}const a=this.getGlobalUIModel();const c=this.getView().byId(s.controlId);if(!c){throw new Error("parameter controlId missing or incorrect")}else{s.parentControl=c}const l=c.getBinding("items")||c.getRowBinding();s.bFindActiveContexts=true;i.lock(a);try{await this.deleteDocumentTransaction(r,s);let t;if(c.isA("sap.ui.mdc.Table")){c.clearSelection()}const i=this.getView().getBindingContext();if(l.isRoot()){t=new Promise(t=>{l.attachEventOnce("dataReceived",function(){t()})});l.refresh()}else if(i){if(!e.hasTransientContext(l)){this.getAppComponent().getSideEffectsService().requestSideEffectsForNavigationProperty(l.getPath(),i)}}if(!this.getAppComponent()._isFclEnabled()){g.setEditStateDirty()}n.send(this.getView(),vt.Delete,r.map(t=>t.getPath()));return t}catch(e){t.error("Error while deleting the document(s)",e)}finally{i.unlock(a)}};l.updateDocument=function e(i,n){const o=this.getView().getBindingContext();const r=this.getProgrammingModel(i)===Pt.Draft;this.getMessageHandler().removeTransitionMessages();return this.syncTask(async()=>{if(o){this.setDocumentModified(true);if(!this._isFclEnabled()){g.setEditStateDirty()}if(r){this.setDraftStatus(St.Saving)}}try{await n;const t=this.getView().getBindingContext();if(!r||!t||t!==o){return}const e=t.getModel().getMetaModel();const i=e.getMetaContext(t.getPath()).getObject("@sapui.name");const s=p.getSemanticKeys(e,i);if(s!==null&&s!==void 0&&s.length){const e=this._getSemanticMapping();const i=e===null||e===void 0?void 0:e.semanticPath,n=p.getSemanticPath(t,true);if(i&&i!==n){await this._handleNewContext(t,true,false,true)}}this.setDraftStatus(St.Saved)}catch(e){t.error("Error while updating the document",e);if(r&&o){this.setDraftStatus(St.Clear)}}finally{await this.getMessageHandler().showMessages()}})};l.createDocument=async function o(r,s){var a;const c=this.getTransactionHelper(),l=this.getGlobalUIModel();let d;let u=s;let f;const p=!u||u.creationMode!==Mt.Inline&&u.creationMode!==Mt.CreationRow&&u.creationMode!==Mt.External;let y=Promise.resolve([]);const v=this.getAppComponent();v.getRouterProxy().removeIAppStateKey();if(u.creationMode===Mt.External){await this.syncTask();const t=this.getView().getController();const e=h.getAbsoluteMetaPathForListBinding(this.getView(),r);t.handlers.onChevronPressNavigateOutBound(t,u.outbound,undefined,e);return}if(u.creationMode===Mt.CreationRow&&u.creationRow){const t=u.creationRow.getBindingContext().getObject();delete t["@$ui5.context.isTransient"];d=u.creationRow.getParent();y=this.validateDocument(d.getBindingContext(),{data:t,customValidationFunction:d.getCreationRow().data("customValidationFunction")});if(d.getCreationRow().data("disableAddRowButtonForEmptyData")==="true"){const t=d.getBindingContext("internal");t.setProperty("creationRowFieldValidity",{})}}if(u.creationMode===Mt.Inline&&u.tableId){d=this.getView().byId(u.tableId)}if(d&&d.isA("sap.ui.mdc.Table")){const t=u.creationMode===Mt.Inline?d.focusRow.bind(d):d.scrollToIndex.bind(d);d.getRowBinding().attachEventOnce("change",async function(){await f;t(u.createAtEnd?d.getRowBinding().getLength():0,true)})}const m=async(i,n)=>{try{const t=await n;await t.created();const o=this.getView().getBindingContext();if(!e.hasTransientContext(i)){const t=this.getAppComponent();t.getSideEffectsService().requestSideEffectsForNavigationProperty(i.getPath(),o)}}catch(e){t.error("Error while creating the document",e)}};const w=t=>{var e;const i=d&&d.getCreationRow().data("customValidationFunction");const n=d&&((e=d.getBindingContext("internal"))===null||e===void 0?void 0:e.getProperty("creationRowCustomValidity"));const o=M.getMessageManager();const r=[];let s;let a;o.getMessageModel().getData().forEach(function(t){if(t.code===i){o.removeMessages(t)}});t.forEach(t=>{if(t.messageTarget){var e;s=M.getControl(n[t.messageTarget].fieldId);a=`${(e=s.getBindingContext())===null||e===void 0?void 0:e.getPath()}/${s.getBindingPath("value")}`;if(o.getMessageModel().getData().filter(function(t){return t.target===a}).length===0){o.addMessages(new b({message:t.messageText,processor:this.getView().getModel(),type:xt.Error,code:i,technical:false,persistent:false,target:a}))}const r=o.getMessageModel().getData().filter(function(t){return t.target===a});r[0].addControlId(n[t.messageTarget].fieldId)}else{r.push({code:i,text:t.messageText,persistent:true,type:xt.Error})}});if(r.length>0){this.getMessageHandler().showMessageDialog({customMessages:r})}};const C=(t,e,i,n)=>{if(t&&t!==Mt.NewPage){return t}else{if(!i.isRelative()){const t=i.getPath(),o=e===Pt.Draft?n.getObject(`${t}@com.sap.vocabularies.Common.v1.DraftRoot/NewAction`):n.getObject(`${t}@com.sap.vocabularies.Session.v1.StickySessionSupported/NewAction`);if(o){const t=n.getObject(`/${o}/@$ui5.overload/0/$Parameter`)||[];if(t.length>1){return Mt.Deferred}}}const t=n.getMetaPath(i===null||i===void 0?void 0:i.getHeaderContext().getPath());const o=st(n,t,this.getAppComponent());if(o.length>0){return Mt.Deferred}return Mt.Async}};if(p){i.lock(l)}try{const e=await this.syncTask(y);if(e.length>0){w(e);t.error("Custom Validation failed");return}let o;u=u||{};if(r&&typeof r==="object"){o=r}else if(typeof r==="string"){o=new E(this.getView().getModel(),r);u.creationMode=Mt.Sync;delete u.createAtEnd}else{throw new Error("Binding object or path expected")}const s=o.getModel();const l=this.getProgrammingModel(o);const p=C(u.creationMode,l,o,s.getMetaModel());let b;const k=u.creationRow;let _;let I;let O;const R=s.getMetaModel();const T=this.getInternalRouting();if(p!==Mt.Deferred){if(p===Mt.CreationRow){_=k.getBindingContext();O=R.getMetaPath(_.getPath());I=_.getObject();u.data={};Object.keys(I).forEach(function(t){const e=R.getObject(`${O}/${t}`);if(e&&e.$kind==="NavigationProperty"){return}u.data[t]=I[t]});await this._checkForValidationErrors()}if(p===Mt.CreationRow||p===Mt.Inline){var P,S,D;u.keepTransientContextOnFailed=false;u.busyMode="Local";u.busyId=(P=d)===null||P===void 0?void 0:(S=P.getParent())===null||S===void 0?void 0:(D=S.getTableDefinition())===null||D===void 0?void 0:D.annotation.id;this.handleCreateEvents(o)}if(!u.parentControl){u.parentControl=this.getView()}u.beforeCreateCallBack=this.onBeforeCreate;u.skipParameterDialog=v.getStartupMode()===Et.AutoCreate;f=c.createDocument(o,u,this.getAppComponent(),this.getMessageHandler(),false);if(!u.bSkipSideEffects){m(o,f)}}let F;switch(p){case Mt.Deferred:F=T.navigateForwardToContext(o,{bDeferredContext:true,editable:true,bForceFocus:true});break;case Mt.Async:F=T.navigateForwardToContext(o,{asyncContext:f,editable:true,bForceFocus:true});break;case Mt.Sync:b={editable:true,bForceFocus:true};if(l==Pt.Sticky||u.createAction){b.transient=true}F=(a=f)===null||a===void 0?void 0:a.then(function(t){if(!t){const t=M.getLibraryResourceBundle("sap.fe.core");return T.navigateToMessagePage(t.getText("C_COMMON_SAPFE_DATA_RECEIVED_ERROR"),{title:t.getText("C_COMMON_SAPFE_ERROR"),description:t.getText("C_EDITFLOW_SAPFE_CREATION_FAILED_DESCRIPTION")})}else{return u.bFromDeferred?T.navigateToContext(t,b):T.navigateForwardToContext(t,b)}});break;case Mt.Inline:this.syncTask(f);break;case Mt.CreationRow:try{const e=_.getBinding();const i=e.create();k.setBindingContext(i);i.created().catch(function(){t.trace("transient fast creation context deleted")});F=_.delete("$direct")}catch(e){if(i.isLocked(this.getView().getModel("ui"))){i.unlock(this.getView().getModel("ui"))}t.error("CreationRow navigation error: ",e)}break;default:F=Promise.reject(`Unhandled creationMode ${p}`);break}if(f){try{const t=await Promise.all([f,F]);this._setStickySessionInternalProperties(l,s);this.setEditMode(Dt.Editable);if(!o.isRelative()&&l===Pt.Sticky){var x,A;const t=o.getModel().getMetaModel();const e=t.bindContext(t.getMetaPath(o.getPath()));const i=gt(e).startingEntitySet;const n=i===null||i===void 0?void 0:(x=i.annotations.Session)===null||x===void 0?void 0:(A=x.StickySessionSupported)===null||A===void 0?void 0:A.NewAction;this.getInternalModel().setProperty("/lastInvokedAction",n)}const e=t[0];if(e){this.setDocumentModifiedOnCreate(o);if(!this._isFclEnabled()){g.setEditStateDirty()}this._sendActivity(vt.Create,e);if(h.isCollaborationDraftSupported(s.getMetaModel())&&!n.isConnected(this.getView())){await yt(e)}}}catch(t){if(t===bt.CancelActionDialog||t===bt.ActionExecutionFailed||t===bt.CreationFailed){if(p===Mt.Sync||p===Mt.Deferred||p===Mt.Async){T.navigateBackFromTransientState()}}throw t}}}finally{if(p){i.unlock(l)}}};l.validateDocument=function t(e,i){return this.getTransactionHelper().validateDocument(e,i,this.getView())};l.createMultipleDocuments=async function n(o,r,s,a,c){let l=arguments.length>5&&arguments[5]!==undefined?arguments[5]:false;const d=this.getTransactionHelper();const g=this.getGlobalUIModel();const u=o;i.lock(g);try{await this.syncTask();if(c){await c({contextPath:u.getPath()})}const t=u.getModel().getMetaModel();let i;if(u.getContext()){i=t.getMetaPath(`${u.getContext().getPath()}/${u.getPath()}`)}else{i=t.getMetaPath(u.getPath())}this.handleCreateEvents(u);const n=r.map(e=>{const n={data:{}};n.keepTransientContextOnFailed=false;n.busyMode="None";n.creationMode=Mt.CreationRow;n.parentControl=this.getView();n.createAtEnd=s;n.inactive=l;for(const o in e){const r=t.getObject(`${i}/${o}`);if(r&&r.$kind!=="NavigationProperty"&&o.indexOf("/")<0&&e[o]){n.data[o]=e[o]}}return d.createDocument(u,n,this.getAppComponent(),this.getMessageHandler(),a)});const o=await Promise.all(n);if(!l){this.setDocumentModifiedOnCreate(u)}await Promise.all(o.map(t=>{if(!t.bInactive){return t.created()}}));const g=this.getView().getBindingContext();if(!e.hasTransientContext(u)){this.getAppComponent().getSideEffectsService().requestSideEffectsForNavigationProperty(u.getPath(),g)}return o}catch(e){t.error("Error while creating multiple documents.");throw e}finally{i.unlock(g)}};l.onBeforeSave=function t(e){return Promise.resolve()};l.onBeforeCreate=function t(e){return Promise.resolve()};l.onBeforeEdit=function t(e){return Promise.resolve()};l.onBeforeDiscard=function t(e){return Promise.resolve()};l.onBeforeDelete=function t(e){return Promise.resolve()};l.saveDocument=async function e(i,o){o=o||{};const r=o.bExecuteSideEffectsOnError||undefined;const s=true;const a=this.getTransactionHelper();const c=o.bindings;try{await this.syncTask();await this._submitOpenChanges(i);await this._checkForValidationErrors();await this.base.editFlow.onBeforeSave({context:i});const t=this.getProgrammingModel(i);const e=this._getRootViewController();let o;if((t===Pt.Sticky||i.getProperty("HasActiveEntity"))&&e.isFclEnabled()){o=await this._computeSiblingInformation(i,e.getRightmostContext(),t,true)}const l=await a.saveDocument(i,this.getAppComponent(),this._getResourceModel(),r,c,this.getMessageHandler(),this.getCreationMode());this._removeStickySessionInternalProperties(t);this._sendActivity(vt.Activate,l);n.disconnect(this.getView());this._triggerConfiguredSurvey(pt.save,ht.standardAction);this.setDocumentModified(false);this.setEditMode(Dt.Display,false);this.getMessageHandler().showMessageDialog();if(l!==i){let t=l;if(e.isFclEnabled()){o=o??this._createSiblingInfo(i,l);this._updatePathsInHistory(o.pathMapping);if(o.targetContext.getPath()!==l.getPath()){t=o.targetContext}}await this._handleNewContext(t,false,false,s,true)}}catch(e){if(!(e&&e.canceled)){t.error("Error while saving the document",e)}throw e}};l.toggleDraftActive=async function t(e){const i=e.getObject();let n;const o=e&&this.getProgrammingModel(e)===Pt.Draft;if(!o||!(!i.IsActiveEntity&&i.HasActiveEntity||i.IsActiveEntity&&i.HasDraftEntity)){return}if(!i.IsActiveEntity&&i.HasActiveEntity){n=false}else{n=true}try{const t=this._getRootViewController();const i=t.isFclEnabled()?t.getRightmostContext():e;let o=await this._computeSiblingInformation(e,i,Pt.Draft,false);if(!o&&e!==i){o=await this._computeSiblingInformation(e,e,Pt.Draft,false)}if(o){this.setEditMode(n?Dt.Editable:Dt.Display,false);if(t.isFclEnabled()){const t=this._getSemanticMapping();if((t===null||t===void 0?void 0:t.technicalPath)===e.getPath()){const e=o.pathMapping[o.pathMapping.length-1].newPath;o.pathMapping.push({oldPath:t.semanticPath,newPath:e})}this._updatePathsInHistory(o.pathMapping)}await this._handleNewContext(o.targetContext,n,true,true,true)}else{throw new Error("Error in EditFlow.toggleDraftActive - Cannot find sibling")}}catch(t){throw new Error(`Error in EditFlow.toggleDraftActive:${t}`)}};l.cancelDocument=async function e(i,o){const r=this.getTransactionHelper();const s=o;let a;let c=false;s.cancelButton=o.control||s.cancelButton;s.beforeCancelCallBack=this.base.editFlow.onBeforeDiscard;try{await this.syncTask();const t=this.getProgrammingModel(i);if((t===Pt.Sticky||i.getProperty("HasActiveEntity"))&&this._isFclEnabled()){const e=this._getRootViewController();a=await this._computeSiblingInformation(i,e.getRightmostContext(),t,true)}const e=await r.cancelDocument(i,s,this.getAppComponent(),this._getResourceModel(),this.getMessageHandler(),this.getCreationMode(),this.isDocumentModified());const o=true;this._removeStickySessionInternalProperties(t);this.setEditMode(Dt.Display,false);this.setDocumentModified(false);this.setDraftStatus(St.Clear);g.setEditStateDirty();if(!e){this._sendActivity(vt.Discard,undefined);n.disconnect(this.getView());if(!s.skipBackNavigation){await this.getInternalRouting().navigateBackFromContext(i);c=true}}else{const r=e;this._sendActivity(vt.Discard,r);n.disconnect(this.getView());let c=r;if(this._isFclEnabled()){a=a??this._createSiblingInfo(i,r);this._updatePathsInHistory(a.pathMapping);if(a.targetContext.getPath()!==r.getPath()){c=a.targetContext}}if(t===Pt.Draft){await this._fetchSemanticKeyValues(r);if(!s.skipBindingToView){await this._handleNewContext(c,false,true,o,true)}else{return r}}else{await this._handleNewContext(c,false,false,o,true)}}this.showDocumentDiscardMessage(c)}catch(e){t.error("Error while discarding the document",e)}};l.showDocumentDiscardMessage=function t(e){const i=this._getResourceModel();const n=i.getText("C_TRANSACTION_HELPER_DISCARD_DRAFT_TOAST");if(e==true){const t=this.getAppComponent();t.getRoutingService().attachAfterRouteMatched(this.showMessageWhenNoContext,this)}else{w.show(n)}};l.showMessageWhenNoContext=function t(){const e=this._getResourceModel();const i=e.getText("C_TRANSACTION_HELPER_DISCARD_DRAFT_TOAST");const n=this.getAppComponent();w.show(i);n.getRoutingService().detachAfterRouteMatched(this.showMessageWhenNoContext,this)};l.isDraftRoot=function t(e){const i=e.getModel().getMetaModel();const n=i.getMetaContext(e.getPath());return h.isDraftRoot(gt(n).targetEntitySet)};l.deleteDocument=async function e(i,n){const o=this.getAppComponent();let r=n;if(!r){r={bFindActiveContexts:false}}else{r.bFindActiveContexts=false}r.beforeDeleteCallBack=this.base.editFlow.onBeforeDelete;try{if(this._isFclEnabled()&&this.isDraftRoot(i)&&i.getIndex()===undefined&&i.getProperty("IsActiveEntity")===true&&i.getProperty("HasDraftEntity")===true){r.beforeDeleteCallBack=async e=>{await this.base.editFlow.onBeforeDelete(e);try{const t=i.getModel();const e=t.bindContext(`${i.getPath()}/SiblingEntity`).getBoundContext();const n=await e.requestCanonicalPath();const o=t.getKeepAliveContext(n);o.replaceWith(i)}catch(e){t.error("Error while replacing the draft instance in the LR ODLB",e)}}}await this.deleteDocumentTransaction(i,r);if(!this._isFclEnabled()){g.setEditStateDirty()}this._sendActivity(vt.Delete,i);if(o){o.getShellServices().setBackNavigation()}if((o===null||o===void 0?void 0:o.getStartupMode())===Et.Deeplink&&!this._isFclEnabled()){o.getRouterProxy().exitFromApp()}else{this.getInternalRouting().navigateBackFromContext(i)}}catch(e){t.error("Error while deleting the document",e)}};l.applyDocument=async function t(e){const n=this.getGlobalUIModel();i.lock(n);try{await this.syncTask();await this._submitOpenChanges(e);await this._checkForValidationErrors();await this.getMessageHandler().showMessageDialog();await this.getInternalRouting().navigateBackFromContext(e)}finally{if(i.isLocked(n)){i.unlock(n)}}};l.invokeAction=async function e(i,o,r){var s;let a;const c=this.getTransactionHelper();let l;let d;let u;const h=this.getView();let f=o||{};if(f.isA&&f.isA("sap.ui.model.odata.v4.Context")||Array.isArray(f)||r!==undefined){const t=f;f=r||{};if(t){f.contexts=t}else{f.model=this.getView().getModel()}}f.isNavigable=f.requiresNavigation||f.isNavigable;const p=ut((s=this.getView().getModel())===null||s===void 0?void 0:s.getMetaModel());if(i.indexOf(""+p.entityContainer.name)>-1){f.isBound=false}else{f.isBound=true}if(!f.parentControl){f.parentControl=this.getView()}if(f.controlId){a=this.getView().byId(f.controlId);if(a){f.internalModelContext=a.getBindingContext("internal")}}else{f.internalModelContext=h.getBindingContext("internal")}if(i&&i.indexOf("(")>-1){l=i.split("(");i=l[0];d=l[l.length-1].replaceAll(")","")}if(f.bStaticAction){if(a.isTableBound()){f.contexts=a.getRowBinding().getHeaderContext()}else{const t=a.data("rowsBindingInfo").path,e=new E(this.getView().getModel(),t);f.contexts=e.getHeaderContext()}if(d&&a.getBindingContext()){f.contexts=this._getActionOverloadContextFromMetadataPath(a.getBindingContext(),a.getRowBinding(),d)}if(f.enableAutoScroll){u=this.createActionPromise(i,a.sId)}}f.bGetBoundContext=this._getBoundContext(h,f);f.bObjectPage=h.getViewData().converterType==="ObjectPage";try{await this.syncTask();const e=await c.callAction(i,f,this.getView(),this.getAppComponent(),this.getMessageHandler());let o;if(f.contexts&&f.isBound===true){o=await this._refreshListIfRequired(this.getActionResponseDataAndKeys(i,e),f.contexts[0])}if(n.isConnected(this.getView())){let t=[];if(e){t=Array.isArray(e)?Object.keys(e[0].value.getObject()):Object.keys(e.getObject())}this._sendActivity(vt.Action,f.contexts,i,o,t)}this._triggerConfiguredSurvey(i,ht.action);if(u){u.fResolver(e)}if(f.contexts){if(!this._isFclEnabled()){g.setEditStateDirty()}this.getInternalModel().setProperty("/lastInvokedAction",i)}if(f.isNavigable){let i=e;if(Array.isArray(i)&&i.length===1){i=i[0].value}if(i&&!Array.isArray(i)){const e=h.getModel().getMetaModel();const n=e.getMetaPath(i.getPath());const o=(t,e)=>t.filter(t=>{if(e){return e.indexOf(t)>-1}return true});const r=Array.isArray(f.contexts)?o(f.contexts,f.applicableContexts)[0]:f.contexts;const s=r&&e.getMetaPath(r.getPath());if(n!=undefined&&n===s){if(r.getPath()!==i.getPath()){this.getInternalRouting().navigateForwardToContext(i,{checkNoHashChange:true,noHistoryEntry:false})}else{t.info("Navigation to the same context is not allowed")}}}}return e}catch(t){if(u){u.fRejector()}if(t===bt.CancelActionDialog){throw new Error("Dialog cancelled")}else if(!(t&&(t.canceled||t.rejectedItems&&t.rejectedItems[0].canceled))){throw new Error(`Error in EditFlow.invokeAction:${t}`)}}};l.securedExecution=function t(e,n){var o,r;const s=(n===null||n===void 0?void 0:(o=n.busy)===null||o===void 0?void 0:o.set)??true,a=(n===null||n===void 0?void 0:(r=n.busy)===null||r===void 0?void 0:r.check)??true,c=(n===null||n===void 0?void 0:n.updatesDocument)??false,l=this.getGlobalUIModel(),d=this.getView().getBindingContext(),u=d&&this.getProgrammingModel(d)===Pt.Draft;if(a&&i.isLocked(l)){return Promise.reject("Application already busy therefore execution rejected")}if(s){i.lock(l)}if(c&&u){this.setDraftStatus(St.Saving)}this.getMessageHandler().removeTransitionMessages();return this.syncTask(e).then(()=>{if(c){this.setDocumentModified(true);if(!this._isFclEnabled()){g.setEditStateDirty()}if(u){this.setDraftStatus(St.Saved)}}}).catch(t=>{if(c&&u){this.setDraftStatus(St.Clear)}return Promise.reject(t)}).finally(()=>{if(s){i.unlock(l)}this.getMessageHandler().showMessageDialog()})};l.handlePatchSent=function t(e){var i,o;const r=n.isConnected(this.getView());if(r){e.getSource().getModel().setIgnoreETag(true)}if(!((i=this.getView())!==null&&i!==void 0&&(o=i.getBindingContext("internal"))!==null&&o!==void 0&&o.getProperty("skipPatchHandlers"))){const t=e.getSource();const i=new Promise((i,n)=>{e.getSource().attachEventOnce("patchCompleted",o=>{if(r){e.getSource().getModel().setIgnoreETag(false)}if(e.getSource().isA("sap.ui.model.odata.v4.ODataListBinding")){var s;x.setActionEnablementAfterPatch(this.getView(),t,(s=this.getView())===null||s===void 0?void 0:s.getBindingContext("internal"))}const a=o.getParameter("success");if(a){i()}else{n()}})});this.updateDocument(t,i)}};l.handleCreateActivate=async function e(i){const n=i.getSource();const o=this.getTransactionHelper();const r=true;const s=true;const a={creationMode:Mt.Inline,createAtEnd:r,inactive:s,keepTransientContextOnFailed:false,busyMode:"None"};try{var c;const e=i.getParameter("context");(c=e.created())===null||c===void 0?void 0:c.then(()=>{this._sendActivity(vt.Create,e)}).catch(()=>{t.warning(`Failed to activate context ${e.getPath()}`)});const r=await o.createDocument(n,a,this.getAppComponent(),this.getMessageHandler(),false);if(r){if(!this._isFclEnabled()){g.setEditStateDirty()}}}catch(e){t.error("Failed to activate new row -",e)}};l.syncTask=function t(e){if(e){if(typeof e==="function"){this.syncTasks=this.syncTasks.then(e).catch(function(){return Promise.resolve()})}else{this.syncTasks=this.syncTasks.then(()=>e).catch(function(){return Promise.resolve()})}}return this.syncTasks};l.computeEditMode=async function e(i){const n=this.getProgrammingModel(i);if(n===Pt.Draft){try{this.setDraftStatus(St.Clear);const t=this.getGlobalUIModel();t.setProperty("/isEditablePending",true,undefined,true);const e=await i.requestObject("IsActiveEntity");if(e===false){this.setEditMode(Dt.Editable);const t=await i.requestObject("HasActiveEntity");this.setEditMode(undefined,!t)}else{this.setEditMode(Dt.Display,false)}t.setProperty("/isEditablePending",false,undefined,true)}catch(e){t.error("Error while determining the editMode for draft",e);throw e}}else if(n===Pt.Sticky){const t=this.getInternalModel().getProperty("/lastInvokedAction");if(t&&this.isNewActionForSticky(t,i)){this.setEditMode(Dt.Editable,true);if(!this.getAppComponent()._isFclEnabled()){g.setEditStateDirty()}this.handleStickyOn(i);this.getInternalModel().setProperty("/lastInvokedAction",undefined)}}};l.deleteDocumentTransaction=async function t(e,i){var n;const o=rt(this);const r=this.getTransactionHelper();i.internalModelContext=i.controlId?(n=sap.ui.getCore().byId(i.controlId))===null||n===void 0?void 0:n.getBindingContext("internal"):null;await this.syncTask();await r.deleteDocument(e,i,this.getAppComponent(),o,this.getMessageHandler())};l._getResourceModel=function t(){return rt(this.getView())};l.getTransactionHelper=function t(){return a};l.getMessageHandler=function t(){if(this.base.messageHandler){return this.base.messageHandler}else{throw new Error("Edit Flow works only with a given message handler")}};l.getInternalModel=function t(){return this.getView().getModel("internal")};l.getGlobalUIModel=function t(){return this.getView().getModel("ui")};l.setCreationMode=function t(e){const i=this.getView().getBindingContext("ui");this.getGlobalUIModel().setProperty("createMode",e,i,true)};l.getCreationMode=function t(){const e=this.getView().getBindingContext("ui");return!!this.getGlobalUIModel().getProperty("createMode",e)};l.isDocumentModified=function t(){return!!this.getGlobalUIModel().getProperty("/isDocumentModified")};l.setDocumentModified=function t(e){this.getGlobalUIModel().setProperty("/isDocumentModified",e)};l.setDocumentModifiedOnCreate=function t(e){if(e.isRelative()){this.setDocumentModified(true)}};l.handleCreateEvents=function t(e){this.setDraftStatus(St.Clear);const i=this.getProgrammingModel(e);e.attachEvent("createSent",()=>{if(i===Pt.Draft){this.setDraftStatus(St.Saving)}});e.attachEvent("createCompleted",t=>{const e=t.getParameter("success");if(i===Pt.Draft){this.setDraftStatus(e?St.Saved:St.Clear)}this.getMessageHandler().showMessageDialog()})};l.setDraftStatus=function t(e){this.getView().getModel("ui").setProperty("/draftStatus",e,undefined,true)};l.getProgrammingModel=function t(e){return this.getTransactionHelper().getProgrammingModel(e)};l.setEditMode=function t(e,i){const n=this.getGlobalUIModel();if(e){n.setProperty("/isEditable",e==="Editable",undefined,true)}if(i!==undefined){this.setCreationMode(i)}};l.isNewActionForSticky=function e(i,n){try{var o;const t=n.getModel().getMetaModel();const e=t.getMetaContext(n.getPath());const r=gt(e).startingEntitySet;const s=(o=r.annotations.Session)===null||o===void 0?void 0:o.StickySessionSupported;if((s===null||s===void 0?void 0:s.NewAction)===i){return true}if(s!==null&&s!==void 0&&s.AdditionalNewActions&&(s===null||s===void 0?void 0:s.AdditionalNewActions.indexOf(i))!==-1){return true}return false}catch(e){t.info(e);return false}};l.handleStickyOn=function e(i){const n=this.getAppComponent();try{if(n===undefined){throw new Error("undefined AppComponent for function handleStickyOn")}if(!n.getRouterProxy().hasNavigationGuard()){const t=n.getRouterProxy().getHash();const e=this.getInternalModel();setTimeout(function(){n.getRouterProxy().setNavigationGuard(i.getPath().substring(1))},0);n.getShellServices().setBackNavigation(this.onBackNavigationInSession.bind(this));this.dirtyStateProviderFunction=this.getDirtyStateProvider(n,e,t);n.getShellServices().registerDirtyStateProvider(this.dirtyStateProviderFunction);const o=this.getView().getModel("sap.fe.i18n");this.sessionTimeoutFunction=this.getSessionTimeoutFunction(i,o);this.getView().getModel().attachSessionTimeout(this.sessionTimeoutFunction);this.stickyDiscardAfterNavigationFunction=this.getRouteMatchedFunction(i,n);n.getRoutingService().attachRouteMatched(this.stickyDiscardAfterNavigationFunction)}}catch(e){t.info(e);return false}return true};l.handleStickyOff=function e(){const i=this.getAppComponent();try{if(i===undefined){throw new Error("undefined AppComponent for function handleStickyOff")}if(i.getRouterProxy){i.getRouterProxy().discardNavigationGuard()}if(this.dirtyStateProviderFunction){i.getShellServices().deregisterDirtyStateProvider(this.dirtyStateProviderFunction);this.dirtyStateProviderFunction=undefined}const t=this.getView().getModel();if(t&&this.sessionTimeoutFunction){t.detachSessionTimeout(this.sessionTimeoutFunction)}i.getRoutingService().detachRouteMatched(this.stickyDiscardAfterNavigationFunction);this.stickyDiscardAfterNavigationFunction=undefined;this.setEditMode(Dt.Display,false);if(i.getShellServices){i.getShellServices().setBackNavigation()}}catch(e){t.info(e);return false}return true};l._setStickySessionInternalProperties=function t(e,i){if(e===Pt.Sticky){const t=this.getInternalModel();t.setProperty("/sessionOn",true);t.setProperty("/stickySessionToken",i.getHttpHeaders(true)["SAP-ContextId"])}};l.getDirtyStateProvider=function e(i,n,o){return e=>{try{if(e===undefined){throw new Error("Invalid input parameters for DirtyStateProvider function")}const t=e.innerAppRoute;const r=i.getRouterProxy();let s="";let a;const c=n.getProperty("/sessionOn");if(!c){return undefined}if(!r.isNavigationFinalized()){a=false;s=t}else if(o===t){a=true}else if(r.checkHashWithGuard(t)||r.isGuardCrossAllowedByUser()){s=t;a=false}else{a=true}if(a){setTimeout(function(){i.getShellServices().setDirtyFlag(false)},0)}else{o=s}return a}catch(e){t.info(e);return undefined}}};l.getSessionTimeoutFunction=function e(i,n){return()=>{try{if(i===undefined){throw new Error("Context missing for SessionTimeout function")}this.getMessageHandler().removeTransitionMessages();const t=new m({title:"{sap.fe.i18n>C_EDITFLOW_OBJECT_PAGE_SESSION_EXPIRED_DIALOG_TITLE}",state:"Warning",content:new C({text:"{sap.fe.i18n>C_EDITFLOW_OBJECT_PAGE_SESSION_EXPIRED_DIALOG_MESSAGE}"}),beginButton:new v({text:"{sap.fe.i18n>C_COMMON_DIALOG_OK}",type:"Emphasized",press:()=>{this.handleStickyOff();this.getInternalRouting().navigateBackFromContext(i)}}),afterClose:function(){t.destroy()}});t.addStyleClass("sapUiContentPadding");t.setModel(n,"sap.fe.i18n");this.getView().addDependent(t);t.open()}catch(e){t.info(e);return undefined}return true}};l.getRouteMatchedFunction=function t(e,i){return()=>{const t=i.getRouterProxy().getHash();if(!t||!i.getRouterProxy().checkHashWithGuard(t)){this.discardStickySession(e);setTimeout(()=>{e.getModel().clearSessionContext()},0)}}};l.discardStickySession=async function t(e){const i=await s.discardDocument(e);if(i!==null&&i!==void 0&&i.hasPendingChanges()){i.getBinding().resetChanges()}i===null||i===void 0?void 0:i.refresh();this.handleStickyOff()};l.getInternalRouting=function t(){if(this.base._routing){return this.base._routing}else{throw new Error("Edit Flow works only with a given routing listener")}};l._getRootViewController=function t(){return this.getAppComponent().getRootViewController()};l._getSemanticMapping=function t(){return this.getAppComponent().getRoutingService().getLastSemanticMapping()};l.createActionPromise=function t(e,i){let n,o;this.actionPromise=new Promise((t,e)=>{n=t;o=e}).then(t=>Object.assign({controlId:i},this.getActionResponseDataAndKeys(e,t)));return{fResolver:n,fRejector:o}};l.getActionResponseDataAndKeys=function t(e,i){if(Array.isArray(i)){if(i.length===1){i=i[0].value}else{return null}}if(!i){return null}const n=this.getView();const o=n.getModel().getMetaModel().getData();const r=o&&o[e]&&o[e][0]&&o[e][0].$ReturnType?o[e][0].$ReturnType.$Type:null;const s=r&&o[r]?o[r].$Key:null;return{oData:i.getObject(),keys:s}};l.getCurrentActionPromise=function t(){return this.actionPromise};l.deleteCurrentActionPromise=function t(){this.actionPromise=undefined};l._scrollAndFocusOnInactiveRow=function t(e){const i=e.getRowBinding();const n=i.getCount()||0;if(e.data("tableType")!=="ResponsiveTable"){if(n>0){e.scrollToIndex(n-1)}e.focusRow(n,true)}else{const t=i.getContexts();if(!(t!==null&&t!==void 0&&t.length)){e.focusRow(n,true);return}let o=n,r=0;for(const e of t){if(e.isInactive()&&r<o){o=r}r++}if(o>0){e.scrollToIndex(o)}e.focusRow(o,true)}};l.createEmptyRowsAndFocus=async function t(e){var i,n,o;const r=e.getParent();if(r!==null&&r!==void 0&&(i=r.tableDefinition)!==null&&i!==void 0&&(n=i.control)!==null&&n!==void 0&&n.inlineCreationRowsHiddenInEditMode&&!((o=e.getBindingContext("ui"))!==null&&o!==void 0&&o.getProperty("createMode"))){await r.setUpEmptyRows(e,true)}this._scrollAndFocusOnInactiveRow(e)};l._sendActivity=function t(e,i,o,r,s){const a=Array.isArray(i)?i.map(t=>t.getPath()):i===null||i===void 0?void 0:i.getPath();n.send(this.getView(),e,a,o,r,s)};l._triggerConfiguredSurvey=function t(e,i){ft(this.getView(),e,i)};l._submitOpenChanges=async function t(e){const n=e.getModel(),o=this.getGlobalUIModel();try{await n.submitBatch("$auto");await n.oRequestor.waitForRunningChangeRequests("$auto");if(n.hasPendingChanges("$auto")){throw new Error("submit of open changes failed")}}finally{if(i.isLocked(o)){i.unlock(o)}}};l._removeStickySessionInternalProperties=function t(e){if(e===Pt.Sticky){const t=this.getInternalModel();t.setProperty("/sessionOn",false);t.setProperty("/stickySessionToken",undefined);this.handleStickyOff()}};l.onBackNavigationInSession=function t(){const e=this.getView();const i=this.getAppComponent().getRouterProxy();if(i.checkIfBackIsOutOfGuard()){const t=e.getBindingContext();const i=this.getProgrammingModel(t);s.processDataLossConfirmation(async()=>{await this.discardStickySession(t);this._removeStickySessionInternalProperties(i);history.back()},e,i);return}history.back()};l._handleNewContext=async function t(e,i,n,o){let r=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;if(!this._isFclEnabled()){g.setEditStateDirty()}await this.getInternalRouting().navigateToContext(e,{checkNoHashChange:true,editable:i,bPersistOPScroll:true,bRecreateContext:n,bDraftNavigation:o,showPlaceholder:false,bForceFocus:r,keepCurrentLayout:true})};l._getBoundContext=function t(e,i){const n=e.getViewData().viewLevel;const o=n>1||n===1&&i.controlId;return!i.isNavigable||!!o};l._checkForValidationErrors=function t(){return this.syncTask().then(()=>{const t=this.getView().getId();const e=sap.ui.getCore().getMessageManager().getMessageModel().getData();let i;let n;if(!e.length){return Promise.resolve("No validation errors found")}for(let o=0;o<e.length;o++){n=e[o];if(n.validation){i=M.byId(n.getControlId());while(i){if(i.getId()===t){return Promise.reject("validation errors exist")}i=i.getParent()}}}})};l._refreshListIfRequired=function e(i,n){if(!n||!i||!i.oData){return Promise.resolve(undefined)}const o=n.getBinding();if(o&&o.isA("sap.ui.model.odata.v4.ODataListBinding")){const e=i.oData;const r=i.keys;const s=n.getObject();let a=true;if(Object.keys(e).length){a=r.every(function(t){return s[t]===e[t]});if(!a){return new Promise(e=>{if(o.isRoot()){o.attachEventOnce("dataReceived",function(){e(!a)});o.refresh()}else{const i=this.getAppComponent();i.getSideEffectsService().requestSideEffects([{$NavigationPropertyPath:o.getPath()}],o.getContext()).then(function(){e(!a)},function(){t.error("Error while refreshing the table");e(!a)}).catch(function(e){t.error("Error while refreshing the table",e)})}})}}}return Promise.resolve(undefined)};l._fetchSemanticKeyValues=function t(e){const i=e.getModel().getMetaModel(),n=i.getMetaContext(e.getPath()).getObject("@sapui.name"),o=p.getSemanticKeys(i,n);if(o&&o.length){const t=o.map(function(t){return e.requestObject(t.$PropertyPath)});return Promise.all(t)}else{return Promise.resolve()}};l._getActionOverloadContextFromMetadataPath=function t(e,i,n){const o=e.getModel();const r=o.getMetaModel();let s=i.getPath().split("/");let a=e;s.pop();if(s.length===0){s=[""]}if(s[0]!==""){s.unshift("")}const c=s.map(t=>{if(t!==""){a=o.bindContext(t,a).getBoundContext()}else{a=e}return a}).reverse();const l=c.find(t=>r.getMetaContext(t.getPath()).getObject("$Type")===n);return l||i.getHeaderContext()};l._createSiblingInfo=function t(e,i){return{targetContext:i,pathMapping:[{oldPath:e.getPath(),newPath:i.getPath()}]}};l._updatePathsInHistory=function t(e){const i=this.getAppComponent();i.getRouterProxy().setPathMapping(e);const n=this._getSemanticMapping();if(e.length&&(n===null||n===void 0?void 0:n.technicalPath)===e[e.length-1].oldPath){n.technicalPath=e[e.length-1].newPath}};l._getNavigationTargetForEdit=function t(e,i,n){let o;n=n??this._createSiblingInfo(e,i);this._updatePathsInHistory(n.pathMapping);if(n.targetContext.getPath()!=i.getPath()){o=n.targetContext}return o};l._computeSiblingInformation=async function e(i,n,o,s){n=n??i;if(!n.getPath().startsWith(i.getPath())){t.error("Cannot compute rightmost sibling context");throw new Error("Cannot compute rightmost sibling context")}if(s&&n.getPath()===i.getPath()){return Promise.resolve(undefined)}const a=i.getModel();if(o===Pt.Draft){return r.computeSiblingInformation(i,n)}else{return{targetContext:a.bindContext(n.getPath()).getBoundContext(),pathMapping:[]}}};l._isFclEnabled=function t(){return this.getAppComponent()._isFclEnabled()};return c}(S),Ct(ot.prototype,"editDocument",[k,_],Object.getOwnPropertyDescriptor(ot.prototype,"editDocument"),ot.prototype),Ct(ot.prototype,"updateDocument",[I,O],Object.getOwnPropertyDescriptor(ot.prototype,"updateDocument"),ot.prototype),Ct(ot.prototype,"createDocument",[R,T],Object.getOwnPropertyDescriptor(ot.prototype,"createDocument"),ot.prototype),Ct(ot.prototype,"onBeforeSave",[F,B],Object.getOwnPropertyDescriptor(ot.prototype,"onBeforeSave"),ot.prototype),Ct(ot.prototype,"onBeforeCreate",[V,H],Object.getOwnPropertyDescriptor(ot.prototype,"onBeforeCreate"),ot.prototype),Ct(ot.prototype,"onBeforeEdit",[N,j],Object.getOwnPropertyDescriptor(ot.prototype,"onBeforeEdit"),ot.prototype),Ct(ot.prototype,"onBeforeDiscard",[L,$],Object.getOwnPropertyDescriptor(ot.prototype,"onBeforeDiscard"),ot.prototype),Ct(ot.prototype,"onBeforeDelete",[G,U],Object.getOwnPropertyDescriptor(ot.prototype,"onBeforeDelete"),ot.prototype),Ct(ot.prototype,"saveDocument",[q,K],Object.getOwnPropertyDescriptor(ot.prototype,"saveDocument"),ot.prototype),Ct(ot.prototype,"cancelDocument",[W,z],Object.getOwnPropertyDescriptor(ot.prototype,"cancelDocument"),ot.prototype),Ct(ot.prototype,"deleteDocument",[J,X],Object.getOwnPropertyDescriptor(ot.prototype,"deleteDocument"),ot.prototype),Ct(ot.prototype,"applyDocument",[Q,Y],Object.getOwnPropertyDescriptor(ot.prototype,"applyDocument"),ot.prototype),Ct(ot.prototype,"invokeAction",[Z,tt],Object.getOwnPropertyDescriptor(ot.prototype,"invokeAction"),ot.prototype),Ct(ot.prototype,"securedExecution",[et,it],Object.getOwnPropertyDescriptor(ot.prototype,"securedExecution"),ot.prototype),ot))||nt);return At},false);