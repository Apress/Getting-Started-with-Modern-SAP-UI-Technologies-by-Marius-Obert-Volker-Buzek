// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/base/ManagedObject","sap/ui/base/Object","sap/ui/core/Core","sap/ui/thirdparty/jquery","sap/ushell/utils","sap/ushell/services/_Personalization/utils","sap/ushell/services/_Personalization/constants","sap/ushell/services/_Personalization/ContextContainer","sap/ushell/services/_Personalization/WindowAdapter","sap/ushell/services/_Personalization/TransientPersonalizer","sap/ushell/services/_Personalization/PersonalizationContainer","sap/ushell/services/_Personalization/Personalizer","sap/ushell/services/personalization/VariantSetAdapter","sap/ushell/services/_Personalization/Variant","sap/ushell/services/_Personalization/VariantSet","sap/ushell/services/_Personalization/WindowAdapterContainer"],function(e,t,n,r,a,i,o,s,p,d,u,c,l,f,h,_,v){"use strict";function A(e,t,n,r){this._oConfig=r&&r.config||{};this._oAppVariantAdapterWithBackendAdapter=this._configureAppVariantStorage(this._oConfig.appVariantStorage);this._oAdapterWithBackendAdapter={lazy:false,instance:new d(this,e)};this._oAdapterWindowOnly={lazy:false,instance:new d(this,undefined)};this._oContainerMap=new i.Map;this._oPendingOperationsMap=new i.Map}A.prototype.SAVE_DEFERRED_DROPPED="Deferred save dropped (OK) - Data superseded by subsequent save";A.prototype.constants=s;A.prototype._configureAppVariantStorage=function(e){var t=this;var n="sap.ushell.adapters.AppVariantPersonalizationAdapter";if(!e){e={adapter:{module:n}}}if(Object.keys(e).length===0||e.enabled===false){return}var r=e.adapter&&e.adapter.module||n;var i=r.split(".").join("/");var o=function(){t._oAppVariantAdapterLoadPromise=t._oAppVariantAdapterLoadPromise||function(){var e=new a.Deferred;try{sap.ui.require([i],n)}catch(t){e.reject(t)}function n(n){try{var r=new n;var a=new d(t,r);e.resolve(a)}catch(t){e.reject(t)}}return e.promise()}();return t._oAppVariantAdapterLoadPromise};return{lazy:true,create:o}};A.prototype.getGeneratedKey=function(){return i.generateRandomKey()};A.prototype.getPersonalizer=function(e,t,n){n=n||this._getApplicationComponent();return new l(this,this._oAdapterWithBackendAdapter.instance,e,t,n)};A.prototype._getApplicationComponent=function(){var e=t._sOwnerId;if(e){var a=r.getComponent(e);if(n.isA(a,"sap.ui.core.UIComponent")){return a}}return undefined};A.prototype.getTransientPersonalizer=function(){return new u};A.prototype.getContainer=function(e,t,n){n=n||this._getApplicationComponent();return this._createContainer(e,t,false,n)};A.prototype.createEmptyContainer=function(e,t,n){n=n||this._getApplicationComponent();return this._createContainer(e,t,true,n)};A.prototype._createContainer=function(e,t,n,r){var s=this;var d=new a.Deferred;if(typeof e!=="string"){throw new i.Error("sContainerKey is not a string: sap.ushell.services.Personalization"," ")}var u=!!(o.isAppVariant(r)&&(!t||!t.shared)&&this._oAppVariantAdapterWithBackendAdapter);var c=o.adjustScope(t);var l=o.addContainerPrefix(e);if(u){var f=r.getManifestObject();c.component=r;c.appVarId=f.getEntry("/sap.ui5/appVariantId");c.appVersion=f.getEntry("/sap.app/applicationVersion/version");l+="#"+f.getEntry("/sap.ui5/appVariantId")}var h=u?this._oAppVariantAdapterWithBackendAdapter:this._oAdapterWithBackendAdapter;var _=s._oAdapterWindowOnly;var v=o.pickAdapter(t,_,h);o.loadAdapter(v).then(function(e){var t;var i=new p(s,e,l,c,r);var o=e&&e.supportsGetWithoutSubsequentLoad===true;if(n&&o){t=new a.Deferred;t.resolve(i)}else{t=i.load()}t.fail(function(){d.reject()}).done(function(){if(n||i._isExpired()){i.clear()}d.resolve(i)})},function(e){d.reject(e)});return d.promise()};A.prototype.delContainer=function(e,t){var n={};var r="";var i=this;t=i._adjustScope(t);r=o.addContainerPrefix(e);n=new a.Deferred;var s=i._pendingContainerOperations_cancelAddNext(e,null);s.always(function(){i.getContainer(e,t).fail(function(){i._pendingContainerOperations_cancelAddNext(e,n);n.reject()}).done(function(){var a;i._pendingContainerOperations_cancelAddNext(e,n);a=t.validity===0?i._oAdapterWindowOnly:i._oAdapterWithBackendAdapter;o.loadAdapter(a).then(function(e){e.delAdapterContainer(r,t).fail(function(){n.reject()}).done(function(){n.resolve()})},function(){n.reject()})})});return n.promise()};A.prototype._pendingContainerOperations_flushAddNext=function(e,t){var n=this._oPendingOperationsMap.get(e);if(!n){n=new a.Deferred;n.resolve()}if(t!==null){this._oPendingOperationsMap.put(e,t)}if(!n||n.state()!=="pending"){return n}clearTimeout(n._sapTimeoutId);n._sapTimeoutId=undefined;if(typeof n._sapFnSave==="function"){var r=n._sapFnSave;n._sapFnSave=undefined;r()}return n};A.prototype._pendingContainerOperations_cancelAddNext=function(e,t){var n;n=this._oPendingOperationsMap.get(e);if(!n){n=new a.Deferred;n.resolve()}if(t!==null){this._oPendingOperationsMap.put(e,t)}if(!n||n.state()!=="pending"){return n}if(n._sapTimeoutId){clearTimeout(n._sapTimeoutId);n._sapTimeoutId=undefined;n.resolve(A.prototype.SAVE_DEFERRED_DROPPED)}return n};A.prototype.getPersonalizationContainer=function(e){var t="";var n={};var r={};if(typeof e!=="string"){throw new i.Error("sContainerKey is not a string: sap.ushell.services.Personalization"," ")}t=o.addContainerPrefix(e);if(this._oContainerMap.containsKey(t)){return this._oContainerMap.get(t).promise()}r=new a.Deferred;n=new c(this._oAdapterWithBackendAdapter.instance,t);n.done(function(e){r.resolve(e)}).fail(function(e){r.reject(e)});this._oContainerMap.put(t,r);return r.promise()};A.prototype.delPersonalizationContainer=function(e){var t={};var n="";var r=this;n=o.addContainerPrefix(e);t=new a.Deferred;this.getPersonalizationContainer(e).fail(function(){t.reject()}).done(function(){r._oAdapterWithBackendAdapter.instance.delAdapterContainer(n).fail(function(){t.reject()}).done(function(){r._oContainerMap.remove(n);t.resolve()})});return t.promise()};A.prototype._getBackendAdapter=function(){return this._oAdapterWithBackendAdapter.instance._oBackendAdapter};A.prototype.resetEntirePersonalization=function(){var e=this._getBackendAdapter();return this.isResetEntirePersonalizationSupported().then(function(t){if(t){return e.resetEntirePersonalization()}return Promise.reject()})};A.prototype.isResetEntirePersonalizationSupported=function(){var t=this._getBackendAdapter();if(typeof t.resetEntirePersonalization!=="function"){return Promise.resolve(false)}if(typeof t.isResetEntirePersonalizationSupported==="function"){return t.isResetEntirePersonalizationSupported().then(function(e){return e}).catch(function(t){e.error("isResetEntirePersonalizationSupported failed with error: "+t.toString());return Promise.reject(t)})}return Promise.resolve(true)};A.prototype._adjustScope=o.adjustScope;A.hasNoAdapter=false;A.ContextContainer=p;A.Variant=h;A.VariantSet=_;A.VariantSetAdapter=f;A.WindowAdapter=d;A.WindowAdapterContainer=v;return A},true);