// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/isPlainObject","sap/base/util/ObjectPath","sap/base/util/extend","sap/ui/thirdparty/jquery","sap/ushell/ApplicationType","sap/ushell/Config","sap/ushell/navigationMode","sap/ushell/services/_ClientSideTargetResolution/Formatter","sap/ushell/services/_ClientSideTargetResolution/InboundIndex","sap/ushell/services/_ClientSideTargetResolution/InboundProvider","sap/ushell/services/_ClientSideTargetResolution/ParameterMapping","sap/ushell/services/_ClientSideTargetResolution/PrelaunchOperations","sap/ushell/services/_ClientSideTargetResolution/Search","sap/ushell/services/_ClientSideTargetResolution/StagedLogger","sap/ushell/services/_ClientSideTargetResolution/SystemContext","sap/ushell/services/_ClientSideTargetResolution/Utils","sap/ushell/services/_ClientSideTargetResolution/VirtualInbounds","sap/ushell/services/_ClientSideTargetResolution/XAppStateProcessing","sap/ushell/services/AppConfiguration","sap/ushell/TechnicalParameters","sap/ushell/utils","sap/ushell/utils/UrlParsing"],function(e,t,n,r,i,s,a,o,l,u,c,d,f,p,g,h,m,v,b,y,S,R,I){"use strict";function j(e,t,n,r){this._init.apply(this,arguments)}j.prototype._init=function(t,n,r,i){this._iLogId=0;if(!this._implementsServiceInterface(t)){e.error("Cannot get Inbounds","ClientSideTargetResolutionAdapter should implement getInbounds method","sap.ushell.services.ClientSideTargetResolution");return}this._oInboundProvider=new c(t.getInbounds.bind(t));this._oHaveEasyAccessSystemsDeferreds={userMenu:null,sapMenu:null};this._oServiceConfiguration=i;this._oAdapter=t};j.prototype._implementsServiceInterface=function(e){if(typeof e.getInbounds==="function"){return true}return false};j.prototype._extractInboundFilter=function(e){if(!this._oAdapter.hasSegmentedAccess){return undefined}if(typeof e!=="string"){return undefined}var t=e.indexOf("#")===0?e:"#"+e;var n=I.parseShellHash(t);if(!n||!n.semanticObject||!n.action){return undefined}return[{semanticObject:n.semanticObject,action:n.action}]};j.prototype.resolveHashFragment=function(e){var t=this,n=new i.Deferred,r=this._oAdapter.resolveHashFragmentFallback&&this._oAdapter.resolveHashFragmentFallback.bind(this._oAdapter),s=this._extractInboundFilter(e);this._oInboundProvider.getInbounds(s).then(function(i){t._resolveHashFragment(e,r,i).done(function(e){return n.resolve(e)}).fail(n.reject.bind(n))},function(){n.reject.apply(n,arguments)});return n.promise()};j.prototype.resolveTileIntent=function(e){var t=this,n=new i.Deferred,r=this._extractInboundFilter(e);this._oInboundProvider.getInbounds(r).then(function(r){t._resolveTileIntent(e,undefined,r).done(n.resolve.bind(n)).fail(n.reject.bind(n))},function(){n.reject.apply(n,arguments)});return n.promise()};j.prototype.resolveTileIntentInContext=function(e,t){var n,r=new i.Deferred;n=u.createIndex(e.concat(v.getInbounds()));this._resolveTileIntent(t,undefined,n).done(r.resolve.bind(r)).fail(r.reject.bind(r));return r.promise()};j.prototype._resolveHashFragment=function(t,n,r){var s=this,a=new i.Deferred,o=t.indexOf("#")===0?t:"#"+t,l=I.parseShellHash(o);if(l===undefined){e.error("Could not parse shell hash '"+t+"'","please specify a valid shell hash","sap.ushell.services.ClientSideTargetResolution");return a.reject().promise()}l.formFactor=R.getFormFactor();this._getMatchingInbounds(l,r,{bExcludeTileInbounds:true}).fail(function(n){e.error("Could not resolve "+t,"_getMatchingInbounds promise rejected with: "+n,"sap.ushell.services.ClientSideTargetResolution");a.reject(n)}).done(function(r){var i;if(r.length===0){e.warning("Could not resolve "+t,"rejecting promise","sap.ushell.services.ClientSideTargetResolution");a.reject("Could not resolve navigation target");return}r=s._applySapNavigationScopeFilter(r,l);i=r[0];if(e.getLevel()>=e.Level.DEBUG){var u=function(e,t){return this[e]===undefined?"<undefined>":t};var c=function(e,t){return e==="_original"?undefined:u.call(this,e,t)};var d=JSON.stringify(i,c,"   ");e.debug("The following target will now be resolved",d,"sap.ushell.services.ClientSideTargetResolution")}s._resolveSingleMatchingTarget(i,n,o).done(function(e){a.resolve(e)}).fail(a.reject.bind(a))});return a.promise()};j.prototype._applySapNavigationScopeFilter=function(e,t){var r=t&&t.params&&t.params["sap-navigation-scope-filter"];if(!r){return e}var i=e.filter(function(e){var t=n.get("inbound.signature.parameters",e);var i=t&&t["sap-navigation-scope"];if(i){return r[0]===i.defaultValue.value}return undefined});return i.length>0?i:e};j.prototype._resolveSingleMatchingTarget=function(t,r,l){var u=this,c=new i.Deferred,p=I.parseShellHash(l),g=[p.semanticObject,p.action].join("-"),h=(t.inbound.resolutionResult||{}).applicationType;var m;if(this._oAdapter.resolveSystemAlias){m=this._oAdapter.resolveSystemAlias.bind(this._oAdapter)}var v=!!t.inbound.templateContext;var S=s.getEasyAccessMenuResolver(g,h);if(S&&!v){S(p,t,m,s.WDA.enableWdaCompatibilityMode).then(function(e){var r=o.compute(n.get("inbound.resolutionResult.applicationType",t),(t.intentParamsPlusAllDefaults["sap-ushell-next-navmode"]||[])[0],(t.intentParamsPlusAllDefaults["sap-ushell-navmode"]||[])[0],(y.getCurrentApplication()||{}).applicationType,a.last("/core/navigation/enableInPlaceForClassicUIs"));R.shallowMergeObject(e,r);e.inboundPermanentKey=t.inbound.permanentKey||t.inbound.id;c.resolve(e)},function(e){c.reject(e)});return c.promise()}var j=this._getReservedParameters(t);d.mapParameterNamesAndRemoveObjects(t);sap.ushell.Container.getServiceAsync("AppState").then(function(i){b.mixAppStateIntoResolutionResultAndRename(t,i).done(function(t){var i=function(){return u._constructFallbackResolutionResult.call(u,t,r,l)};if(s[h]){i=s[h].generateResolutionResult}delete t.intentParamsPlusAllDefaults["sap-tag"];delete t.mappedIntentParamsPlusSimpleDefaults["sap-tag"];t.mappedDefaultedParamNames=t.mappedDefaultedParamNames.filter(function(e){return e!=="sap-tag"});var a=n.get("inbound.resolutionResult.url",t);f.executePrelaunchOperations(t,j["sap-prelaunch-operations"]).then(function(){return i(t,a,m)}).then(function(e){e.reservedParameters=j;e.inboundPermanentKey=t.inbound.permanentKey||t.inbound.id;return e}).then(function(n){e.debug("Intent was resolved to the following target",JSON.stringify(t.resolutionResult,null,3),"sap.ushell.services.ClientSideTargetResolution");R.shallowMergeObject(t.resolutionResult,n);c.resolve(t.resolutionResult)},function(e){if(typeof e==="string"&&e.indexOf("fallback:")>=0){u._constructFallbackResolutionResult.call(this,t,r,l).then(function(e){R.shallowMergeObject(t.resolutionResult,e);c.resolve(t.resolutionResult)},c.reject.bind(c))}else{c.reject(e)}})})});return c.promise()};j.prototype._getReservedParameters=function(e){var t=S.getParameters({injectFrom:"startupParameter"}).map(function(e){return e.name});var n=m.extractParameters(t,e.intentParamsPlusAllDefaults);S.getParameters({injectFrom:"inboundParameter"}).forEach(function(t){var r=t.name;var i=e.inbound&&e.inbound.signature&&e.inbound.signature.parameters;if(i&&Object.keys(i).length>0){var s=i[r];var a=s&&s.defaultValue&&s.defaultValue.hasOwnProperty("value");var o=s&&s.filter&&s.filter.hasOwnProperty("value");if(s&&(o||a)){if(a){n[r]=s.defaultValue.value}else{n[r]=s.filter.value}}else{delete n[r]}delete e.intentParamsPlusAllDefaults[r];var l=e.defaultedParamNames.indexOf(r);if(l>=0){e.defaultedParamNames.splice(l,1)}}});return n};j.prototype._resolveTileIntent=function(t,n,r){var s=this,a=new i.Deferred,o=t.indexOf("#")===0?t:"#"+t,l=I.parseShellHash(o);if(l===undefined){e.error("Could not parse shell hash '"+t+"'","please specify a valid shell hash","sap.ushell.services.ClientSideTargetResolution");return a.reject("Cannot parse shell hash").promise()}l.formFactor=R.getFormFactor();this._getMatchingInbounds(l,r,{bExcludeTileInbounds:false}).fail(function(n){e.error("Could not resolve "+t,"_getMatchingInbounds promise rejected with: "+n,"sap.ushell.services.ClientSideTargetResolution");a.reject(n)}).done(function(r){var i;if(r.length===0){e.warning("Could not resolve "+t,"no matching targets were found","sap.ushell.services.ClientSideTargetResolution");a.reject("No matching targets found");return}i=r[0];s._resolveSingleMatchingTileIntent(i,n,o).done(a.resolve.bind(a)).fail(a.reject.bind(a))});return a.promise()};j.prototype._resolveSingleMatchingTileIntent=function(t,a,l){var u=new i.Deferred,c=(t.inbound.resolutionResult||{}).applicationType,f=this;var p;if(this._oAdapter.resolveSystemAlias){p=this._oAdapter.resolveSystemAlias.bind(this._oAdapter)}d.mapParameterNamesAndRemoveObjects(t);sap.ushell.Container.getServiceAsync("AppState").then(function(i){b.mixAppStateIntoResolutionResultAndRename(t,i).done(function(t){var i=function(){return f._constructFallbackResolutionResult.call(f,t,a,l)};if(s[c]){i=s[c].generateResolutionResult}delete t.intentParamsPlusAllDefaults["sap-tag"];delete t.mappedIntentParamsPlusSimpleDefaults["sap-tag"];t.mappedDefaultedParamNames=t.mappedDefaultedParamNames.filter(function(e){return e!=="sap-tag"});var d=n.get("inbound.resolutionResult.url",t);i(t,d,p).then(function(n){R.shallowMergeObject(t.resolutionResult,n);var i=r({},t.inbound.tileResolutionResult);i.startupParameters=t.effectiveParameters;i.navigationMode=t.resolutionResult.navigationMode;if(!i.navigationMode){i.navigationMode=o.getNavigationMode(t.resolutionResult)}u.resolve(i);e.debug("Tile Intent was resolved to the following target",JSON.stringify(i,null,3),"sap.ushell.services.ClientSideTargetResolution")},function(e){u.reject(e)})})});return u.promise()};j.prototype._constructFallbackResolutionResult=function(t,n,i){var s={},a;Object.keys(t.intentParamsPlusAllDefaults).forEach(function(e){if(Array.isArray(t.intentParamsPlusAllDefaults[e])){s[e]=t.intentParamsPlusAllDefaults[e]}});a=t.mappedDefaultedParamNames||t.defaultedParamNames;if(a.length>0){s["sap-ushell-defaultedParameterNames"]=[JSON.stringify(a)]}if(typeof n!=="function"){e.error("Cannot resolve hash fragment",i+" has matched an inbound that cannot be resolved client side and no resolveHashFragmentFallback method was implemented in ClientSideTargetResolutionAdapter","sap.ushell.services.ClientSideTargetResolution");return Promise.reject("Cannot resolve hash fragment: no fallback provided.")}e.warning("Cannot resolve hash fragment client side",i+" has matched an inbound that cannot be resolved client side. Using fallback logic","sap.ushell.services.ClientSideTargetResolution");return new Promise(function(e,a){n(i,r({},t.inbound),s).done(function(t){var n={};["applicationType","additionalInformation","url","applicationDependencies","text"].forEach(function(e){if(t.hasOwnProperty(e)){n[e]=t[e]}});e(n)}).fail(a.bind(null))})};j.prototype.getDistinctSemanticObjects=function(){var e=new i.Deferred;this._oInboundProvider.getInbounds().then(function(t){var n={};t.getAllInbounds().forEach(function(e){if(typeof e.semanticObject==="string"&&e.semanticObject!=="*"&&!e.hideIntentLink&&e.semanticObject.length>0){n[e.semanticObject]=true}});e.resolve(Object.keys(n).sort())},function(){e.reject.apply(e,arguments)});return e.promise()};j.prototype.getLinks=function(n){var s,a=this,o,l,u,c=new i.Deferred,d;if(arguments.length===1&&t(arguments[0])){s=arguments[0];d=r({},s);["action","semanticObject"].forEach(function(e){if(s.hasOwnProperty(e)){d[e]=s[e]}});if(d.appStateKey){d.params=d.params||{};d.params["sap-xapp-state"]=[d.appStateKey];delete d.appStateKey}}else if(arguments.length<=3){e.warning("Passing positional arguments to getLinks is deprecated","Please use nominal arguments instead","sap.ushell.services.ClientSideTargetResolution");o=arguments[0];l=arguments[1];u=arguments[2];d={semanticObject:o,params:l,ignoreFormFactor:u}}else{return c.reject("invalid arguments for getLinks").promise()}this._oInboundProvider.getInbounds().then(function(e){a._getLinks(d,e).done(c.resolve.bind(c)).fail(c.reject.bind(c))},function(){c.reject.apply(c,arguments)});return c.promise()};j.prototype._validateGetSemanticObjectLinksArgs=function(t){var n=t.semanticObject,r=t.action,i=!t.hasOwnProperty("action");if(typeof n!=="undefined"||i){if(typeof n!=="string"){e.error("invalid input for _getLinks","the semantic object must be a string, got "+Object.prototype.toString.call(n)+" instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object"}if(i&&n.match(/^\s+$/)){e.error("invalid input for _getLinks","the semantic object must be a non-empty string, got '"+n+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object"}if(!i&&n.length===0){e.error("invalid input for _getLinks","the semantic object must not be an empty string, got '"+n+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object"}}if(typeof r!=="undefined"){if(typeof r!=="string"){e.error("invalid input for _getLinks","the action must be a string, got "+Object.prototype.toString.call(r)+" instead","sap.ushell.services.ClientSideTargetResolution");return"invalid action"}if(r.length===0){e.error("invalid input for _getLinks","the action must not be an empty string, got '"+r+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid action"}}return undefined};j.prototype._getLinks=function(t,r){var s=t.semanticObject,a=t.action,o=t.params,l=!!t.withAtLeastOneUsedParam,u=!!t.treatTechHintAsFilter,c=t.ignoreFormFactor,d=t.hasOwnProperty("sortResultsBy")?t.sortResultsBy:"intent";if(t.hasOwnProperty("sortResultOnTexts")){e.warning("the parameter 'sortResultOnTexts' was experimental and is no longer supported","getLinks results will be sorted by '"+d+"'","sap.ushell.services.ClientSideTargetResolution")}var f={bExcludeTileInbounds:true};var p=this._validateGetSemanticObjectLinksArgs(t);if(t.tags){f.tags=t.tags}if(p){return(new i.Deferred).reject(p).promise()}if(s==="*"){return i.when([])}function g(e){var t=I.paramsToString(e);return t?"?"+t:""}var h=new i.Deferred,v=R.getFormFactor(),b=I.parseParameters(g(o)),y={semanticObject:s===""?undefined:s,action:a,formFactor:c?undefined:v,params:b};if(u){y.treatTechHintAsFilter=true}this._getMatchingInbounds(y,r,f).done(function(r){var i={},a=r.map(function(e){var r=s||e.inbound.semanticObject,a="#"+r+"-"+e.inbound.action,o;if(r==="*"){return undefined}if(e.inbound.action==="*"){return undefined}if(e.inbound&&e.inbound.hasOwnProperty("hideIntentLink")&&e.inbound.hideIntentLink===true){return undefined}if(!i.hasOwnProperty(a)){i[a]={matchingInbound:e.inbound,count:1};if(e.inbound.signature.additionalParameters==="ignored"){o=m.filterObjectKeys(b,function(t){return t.indexOf("sap-")===0||e.inbound.signature.parameters.hasOwnProperty(t)},false)}else{o=b}if(l){var u=Object.keys(o).some(function(e){return e.indexOf("sap-")!==0});if(!u){i[a].hideReason="getLinks called with 'withAtLeastOneUsedParam = true', but the inbound had no business parameters defined.";return undefined}}var c=m.inboundSignatureMeetsParameterOptions(e.inbound.signature.parameters,t.paramsOptions||[]);if(!c){i[a].hideReason="inbound signature does not meet the requested parameter filter options";return undefined}var d={intent:a+g(o),text:e.inbound.title};if(e.inbound.icon){d.icon=e.inbound.icon}if(e.inbound.subTitle){d.subTitle=e.inbound.subTitle}if(e.inbound.shortTitle){d.shortTitle=e.inbound.shortTitle}var f=n.get("inbound.signature.parameters.sap-tag.defaultValue.value",e);if(f){d.tags=[f]}return d}i[a].count++;return undefined}).filter(function(e){return typeof e==="object"});if(d!=="priority"){a.sort(function(e,t){return e[d]<t[d]?-1:1})}if(a.length===0){e.debug("_getLinks returned no results")}else if(e.getLevel()>=e.Level.DEBUG){if(e.getLevel()>=e.Level.TRACE){var o=[];var u=[];a.forEach(function(e){var t=e.intent.split("?")[0];if(i[t].hideReason){u.push(["-",t+"("+i[t].hideReason+")\n"," text:",e.text+"\n"," full intent:",e.intent].join(" "))}else{o.push(["-",t,i[t].count>1?"("+(i[t].count-1)+" others matched)\n":"\n","text:",e.text+"\n","full intent:",e.intent].join(" "))}});e.debug("_getLinks filtered to the following unique intents:","\n"+o.join("\n"),"sap.ushell.services.ClientSideTargetResolution");e.debug("_getLinks would have also returned the following unique intents, but something prevented this:",u.join("\n"),"sap.ushell.services.ClientSideTargetResolution")}else{e.debug("_getLinks filtered to unique intents.","Reporting histogram: \n - "+Object.keys(i).join("\n - "),"sap.ushell.services.ClientSideTargetResolution")}}h.resolve(a)}).fail(h.reject.bind(h));return h.promise()};j.prototype._getMatchingInbounds=function(t,n,r){var s=this,a,o,u,c,d,f,h,m=new i.Deferred;if(r){a=r.tags;f=r.bExcludeTileInbounds}if(e.getLevel()>=e.Level.DEBUG){u=++s._iLogId}g.begin(function(){function e(e){var t=e.action||(typeof e.action==="undefined"?"<any>":"<invalid-value>");var n=e.semanticObject||(typeof e.semanticObject==="undefined"?"<any>":"<invalid-value>");return I.constructShellHash({semanticObject:n,action:t,params:e.params})}var n=e(t);return{logId:u,title:"Matching Intent '"+n+"' to inbounds (form factor: "+(t.formFactor||"<any>")+")",moduleName:"sap.ushell.services.ClientSideTargetResolution",stages:["STAGE1: Find matching inbounds","STAGE2: Resolve references","STAGE3: Rematch with references","STAGE4: Sort matched targets"]}});d=t.semanticObject;o=t.action;this._oShellHash=t;c=a?n.getSegmentByTags(a):n.getSegment(d,o);if(f){h=c.filter(function(e){return!e.tileResolutionResult||!e.tileResolutionResult.isCustomTile})}else{h=c}var v=null;if(this._oAdapter.getContentProviderDataOriginsLookup){v=this._oAdapter.getContentProviderDataOriginsLookup.bind(this._oAdapter)}p.match(t,h,{},v,e.getLevel()>=e.Level.DEBUG).then(function(e){g.log(function(){return{logId:u,stage:1,prefix:"✘",lines:Object.keys(e.noMatchReasons||{}).map(function(t){return t+" "+e.noMatchReasons[t]})}});g.log(function(){var t=e.matchResults.map(function(e){return l.formatInbound(e.inbound)});return{logId:u,stage:1,prefix:t.length>0?"✅":"✘",lines:t.length>0?t:["No inbound was matched"]}});var t={};var n=false;var r=Object.keys(e.missingReferences);r.forEach(function(r){var i=Object.keys(e.missingReferences[r]);n=n||i.length>0;t[r]=i});r=r.filter(function(e){if(t[e].length>0){return true}delete t[e];return false});if(!n){g.log(function(){return{logId:u,stage:2,prefix:"✅",line:"No need to resolve references"}});return(new i.Deferred).resolve({matchResults:e.matchResults,referencesToInclude:null}).promise()}r.forEach(function(e){g.log(function(){return{logId:u,stage:2,line:'@ Must resolve the following references with contentProviderId = "'+e+'":',prefix:"•",lines:t[e]}})});var s=new i.Deferred;sap.ushell.Container.getServiceAsync("ReferenceResolver").then(function(e){var n=r.map(function(e){return this.getSystemContext(e)}.bind(this));return Promise.all(n).then(function(n){var i=r.map(function(r,i){return new Promise(function(s,a){e.resolveReferences(t[r],n[i]).done(s).fail(a)})});return Promise.all(i)})}.bind(this)).then(function(t){var n={matchResults:e.matchResults,referencesToInclude:{}};r.forEach(function(e,r){var i=t[r];n.referencesToInclude[e]=i;if(Object.keys(i).length>0){g.log(function(){return{logId:u,stage:2,line:'✅ resolved references with contentProviderId = "'+e+'" to the following values:',prefix:"•",lines:Object.keys(i).map(function(e){return e+": '"+i[e]+"'"})}})}});s.resolve(n)}).catch(function(e){g.log(function(){return{logId:u,stage:2,prefix:"❌",line:"Failed to resolve references: "+e}});m.resolve([])});return s.promise()}.bind(this)).then(function(e){var n,r,s=e.referencesToInclude;if(!s){g.log(function(){return{logId:u,stage:3,line:"rematch was skipped (no references to resolve)",prefix:"✅"}});return(new i.Deferred).resolve(e).promise()}r=e.matchResults;n=r.map(function(e){return e.inbound});return p.match(t,n,s,v,0).then(function(e){g.log(function(){var t=e.matchResults||[];if(t.length>=1){return{logId:u,stage:3,line:"The following inbounds re-matched:",lines:t.map(function(e){return l.formatInbound(e.inbound)}),prefix:"✅"}}return{logId:u,stage:3,line:"No inbounds re-matched",prefix:"-"}});return e})}).then(function(e){var t=e.matchResults||[];if(t.length<=1){g.log(function(){return{logId:u,stage:4,line:"Nothing to sort"}});m.resolve(t);return}var n=p.sortMatchingResultsDeterministic(e.matchResults||[]);g.log(function(){var e=n.map(function(e){return l.formatInbound(e.inbound||{})+(e.matchesVirtualInbound?" (virtual)":"")+"\n[ Sort Criteria ] "+"\n * 1 * sap-priority: '"+e["sap-priority"]+"'"+"\n * 2 * Sort string: '"+e.priorityString+"\n * 3 * Deterministic blob: '"+p.serializeMatchingResult(e)+"'"});return{logId:u,stage:4,line:"Sorted inbounds as follows:",lines:e,prefix:".",number:true}});m.resolve(n)});return m.promise().then(function(e){g.end(function(){return{logId:u}});return e})};j.prototype._isIntentSupportedOne=function(e,t){var n=new i.Deferred,r=I.parseShellHash(e);if(e==="#"){n.resolve(true);return n.promise()}if(r===undefined){return n.reject("Could not parse shell hash '"+e+"'").promise()}r.formFactor=R.getFormFactor();this._getMatchingInbounds(r,t,{bExcludeTileInbounds:true}).done(function(e){n.resolve(e.length>0)}).fail(function(){n.reject()});return n.promise()};j.prototype.isIntentSupported=function(e){var t=this,n=new i.Deferred;this._oInboundProvider.getInbounds().then(function(r){t._isIntentSupported(e,r).done(n.resolve.bind(n)).fail(n.reject.bind(n))},function(){n.reject.apply(n,arguments)});return n.promise()};j.prototype._isIntentSupported=function(e,t){var n=this,r=new i.Deferred,s={};r.resolve();function a(e,t){s[e]={supported:t}}var o=[];e.forEach(function(e){var s=n._isIntentSupportedOne(e,t);s.fail(function(e){o.push(e)});s.done(function(t){a(e,t)});r=i.when(r,s)});var l=new i.Deferred;r.done(function(){l.resolve(s)}).fail(function(){l.reject("One or more input intents contain errors: "+o.join(", "))});return l.promise()};j.prototype.getUserDefaultParameterNames=function(e){var t=this,n=new i.Deferred;this._oInboundProvider.getInbounds().then(function(r){t._getUserDefaultParameterNames(r.getAllInbounds(),e).then(function(e){n.resolve(e)},function(e){n.reject("Cannot get user default parameters from inbounds: "+e)})},function(){n.reject.apply(n,arguments)});return n.promise()};j.prototype._getUserDefaultParameterNames=function(e,t){var n={simple:{},extended:{}};e=e.filter(function(e){if(e.contentProviderId===undefined&&t.id===""){return true}return e.contentProviderId===t.id});return sap.ushell.Container.getServiceAsync("ReferenceResolver").then(function(t){e.forEach(function(e){var r=e.signature&&e.signature.parameters||[];Object.keys(r).forEach(function(e){var i=r[e],s,a,o;if(i){if(i.filter&&i.filter.format==="reference"){o=i.filter.value}else if(i.defaultValue&&i.defaultValue.format==="reference"){o=i.defaultValue.value}if(typeof o==="string"){s=t.extractUserDefaultReferenceName(o);if(typeof s==="string"){n.simple[s]={}}a=t.extractExtendedUserDefaultReferenceName(o);if(typeof a==="string"){n.extended[a]={}}}}})});return n})};j.prototype.getEasyAccessSystems=function(r){var a={},o,u,c;r=r||"sapMenu";if(this._oHaveEasyAccessSystemsDeferreds[r]){return this._oHaveEasyAccessSystemsDeferreds[r].promise()}this._oHaveEasyAccessSystemsDeferreds[r]=new i.Deferred;c=this._oHaveEasyAccessSystemsDeferreds[r];function d(e,t,n){if(!e){return false}var i=[e.semanticObject,e.action].join("-");return n[r][i]&&e.deviceTypes&&t!==undefined&&e.deviceTypes[t]}o=s.getEasyAccessMenuDefinitions().reduce(function(e,t){var n=t.easyAccessMenu.intent.split("-")[1];e[n]={appType:t.type,priority:t.easyAccessMenu.systemSelectionPriority};return e},{});u={userMenu:s.getEasyAccessMenuDefinitions().reduce(function(e,t){var n=t.easyAccessMenu.intent;e[n]=t.easyAccessMenu.showSystemSelectionInUserMenu;return e},{}),sapMenu:s.getEasyAccessMenuDefinitions().reduce(function(e,t){var n=t.easyAccessMenu.intent;e[n]=t.easyAccessMenu.showSystemSelectionInSapMenu;return e},{})};this._oInboundProvider.getInbounds().then(function(r){var i={};r.getAllInbounds().filter(function(e){return d(e,R.getFormFactor(),u)}).forEach(function(r){var s;if(t(r.signature.parameters["sap-system"])&&r.signature.parameters["sap-system"].hasOwnProperty("filter")){s=n.get("signature.parameters.sap-system.filter.value",r)}if(typeof s==="string"){var u=o[r.action].priority;var c=o[r.action].appType;if(!a[s]){i[s]=-1;a[s]={appType:{}}}if(i[s]<u){a[s].text=r.title;i[s]=u}a[s].appType[c]=true}else{e.warning("Cannot extract sap-system from easy access menu inbound: "+l.formatInbound(r),"This parameter is supposed to be a string. Got '"+s+"' instead.","sap.ushell.services.ClientSideTargetResolution")}});c.resolve(a)},function(){c.reject.apply(c,arguments)});return c.promise()};j.prototype.getSystemContext=function(e){var t=e===undefined?"":e;return new Promise(function(e,n){var r;this._oAdapter.resolveSystemAlias(t).done(function(t){r=h.createSystemContextFromSystemAlias(t);e(r)}).fail(function(e){n(e)})}.bind(this))};j.hasNoAdapter=false;return j},true);