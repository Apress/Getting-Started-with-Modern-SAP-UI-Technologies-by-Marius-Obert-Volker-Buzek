// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/base/Object","sap/ui/thirdparty/jquery","sap/ushell/services/_AppState/AppState","sap/ushell/services/_AppState/AppStatePersistencyMethod","sap/ushell/services/_AppState/Sequentializer","sap/ushell/services/_AppState/SequentializingAdapter","sap/ushell/services/_AppState/WindowAdapter","sap/ushell/utils"],function(e,t,n,i,s,a,r,o){"use strict";function p(e){return o.isDefined(e)&&o.isDefined(e.transient)?!!e.transient:true}function d(e,t,n,i){this._oConfig=i&&i.config;this._sSessionKey="";this._oAdapter=new a(e);this._oAdapter=new r(this,this._oAdapter,i)}d.prototype._getSessionKey=function(){if(!this._sSessionKey){this._sSessionKey=this._getGeneratedKey()}return this._sSessionKey};d.prototype.getAppState=function(e){var i=new t.Deferred;var s=this;var a;this._loadAppState(e).done(function(e,t,r,o){a=new n(s,e,false,t,undefined,undefined,undefined,r,o);i.resolve(a)}).fail(function(){a=new n(s,e);i.resolve(a)});return i.promise()};d.prototype._getGeneratedKey=function(e){var t=o.generateRandomKey();if(e){t=("TAS"+t).substring(0,41)}else{t=("AS"+t).substring(0,40)}return t};d.prototype.createEmptyAppState=function(t,s,a,r){var o;var d="";var f="";var u=s||p(this._oConfig);var c=this._getGeneratedKey(u);if(a!==undefined&&!this.isPersistencyMethodSupported(a)){a=undefined;r=undefined}if(t){if(!e.isA(t,"sap.ui.core.UIComponent")){throw new Error("oComponent passed must be a UI5 Component")}if(t.getMetadata&&t.getMetadata()&&typeof t.getMetadata().getName==="function"){d=t.getMetadata().getName()||""}if(!d&&t.getMetadata&&t.getMetadata().getComponentName){d=t.getMetadata().getComponentName()}if(t.getMetadata&&t.getMetadata()&&typeof t.getMetadata().getManifest==="function"&&typeof t.getMetadata().getManifest()==="object"&&typeof t.getMetadata().getManifest()["sap.app"]==="object"){f=t.getMetadata().getManifest()["sap.app"].ach||""}}if(u===true){a=r=undefined}else if(a===undefined&&this.isPersistencyMethodSupported(i.PersonalState)){a=i.PersonalState;r=undefined}o=new n(this,c,true,undefined,d,f,u,a,r);return o};d.prototype.createEmptyUnmodifiableAppState=function(){var e=this._getGeneratedKey();var t=new n(this,e,false);return t};d.prototype._saveAppState=function(e,t,n,s,a,r,d){var f=this._getSessionKey();var u=o.isDefined(a)?a:p(this._oConfig);if(u){r=undefined;d=undefined}else if(r!==undefined){if(!this.isPersistencyMethodSupported(r)){if(this.isPersistencyMethodSupported(i.PersonalState)){r=i.PersonalState}else{r=undefined}d=undefined}}return this._oAdapter.saveAppState(e,f,t,n,s,u,r,d)};d.prototype._loadAppState=function(e){return this._oAdapter.loadAppState(e)};d.prototype.deleteAppState=function(e){return this._oAdapter.deleteAppState(e)};d._getSequentializer=function(){return new s};d.prototype.getSupportedPersistencyMethods=function(){if(this._oAdapter.getSupportedPersistencyMethods){return this._oAdapter.getSupportedPersistencyMethods()}return[]};d.prototype.isPersistencyMethodSupported=function(e){var t=this.getSupportedPersistencyMethods();if(t.length>0&&e!==undefined){return t.indexOf(e)>=0}return false};d.prototype.setAppStateToPublic=function(e){var n=f(e,"sap-xapp-state");var s=f(e,"sap-iapp-state");var a=(new t.Deferred).resolve();var r=(new t.Deferred).resolve();var o=new t.Deferred;var p;var d;if(n!==undefined){a=this.makeStatePersistent(n,i.PublicState).done(function(t){if(n!==t){e=e.replace(n,t);p=t}}).fail(o.reject)}if(s!==undefined){r=this.makeStatePersistent(s,i.PublicState).done(function(t){if(s!==t){e=e.replace(s,t);d=t}}).fail(o.reject)}t.when(a,r).done(function(){o.resolve(e,n,s,p,d)});return o.promise()};function f(e,t){var n=new RegExp("(?:"+t+"=)([^&/]+)");var i=n.exec(e);var s;if(i&&i.length===2){s=i[1]}return s}d.prototype.makeStatePersistent=function(e,n,i){var s=new t.Deferred;if(this.getSupportedPersistencyMethods().length===0){return s.resolve(e)}if(this.isPersistencyMethodSupported(n)){this.getAppState(e).done(function(t){if(t._iPersistencyMethod!==n){t.bTransient=false;t._iPersistencyMethod=n;t._oPersistencySettings=i;if(e.startsWith("TAS")){e=e.substring(1,e.length)}this._saveAppState(e,t._sData,t._sAppName,t._sACHComponent,false,n,i).done(function(){s.resolve(e)}).fail(s.reject)}else{s.resolve(e)}}.bind(this)).fail(s.reject)}else{s.reject("AppState.makeStatePersistent - adapter does not support persistence method: "+n)}return s.promise()};d.WindowAdapter=r;d.hasNoAdapter=false;return d},true);