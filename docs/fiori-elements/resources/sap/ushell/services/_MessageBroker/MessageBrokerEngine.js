// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend"],function(e,s){"use strict";var n={},r={},t={},i={};n[window.location.origin]=true;var a=function(){this.processPostMessage=function(s){var n=s.oMessageData,r=n.body,t=s.oMessage,i=t.origin,a=t.source;r.requestId=n.request_id;if(!a){var c="Missing iframe object in PostMessage request";e.error(c,null,"sap.ushell.services.MessageBroker");return Promise.reject(c)}return this._handlePostMessageRequest(r,a,i)};this.connect=function(s){var n;if(typeof s!=="string"||!s.length){n="Missing required parameter client id"}else if(t[s]){n="Client is already connected"}else{var r=Object.values(i);t[s]=true;return Promise.resolve(r)}e.error(n,null,"sap.ushell.services.MessageBroker");return Promise.reject(n)};this.disconnect=function(s){var n;if(typeof s!=="string"||!s.length){n="Missing required parameter client id"}else if(!t[s]){n="Client is already disconnected"}else{for(var a in r){var c=r[a];for(var l in c){var o=c[l];if(o.clientId===s){c.splice(l,1);break}}}if(i[s]&&i[s].channels.length){this._emitEvent("clientUnsubscribed",s,i[s].channels);delete i[s]}delete t[s];return Promise.resolve()}e.error(n,null,"sap.ushell.services.MessageBroker");return Promise.reject(n)};this.subscribe=function(s,n,a,c,l,o){var u,d="clientSubscribed",h=[],f=false;if(typeof s!=="string"||!s.length||!n.length||typeof l!=="object"&&(typeof a!=="function"||typeof c!=="function")){u="Missing required parameter(s)"}else if(!t[s]){u="Client is not connected"}else{for(var v in n){var g=n[v];var p={clientId:s,subscribedChannels:n,messageCallback:a,clientConnectionCallback:c,iframe:l||{},origin:o||"",isUI5:!l};if(!r[g.channelId]){r[g.channelId]=[]}var b=r[g.channelId].find(function(e){return e.clientId===s});if(!b){r[g.channelId].push(p)}if(i[s]){var I=i[s].channels.find(function(e){return e.channelId===g.channelId});if(!I){i[s].channels.push(g)}}}if(!i[s]){f=true;var m={clientId:s,channels:n};i[s]=m;h=Object.values(i).filter(function(e){return e.clientId!==s});if(!l&&h.length){h.forEach(function(e){c(d,e.clientId,e.channels)})}}if(Object.keys(i).length>1){this._emitEvent(d,s,n)}return Promise.resolve(l&&f?h:"")}e.error(u,null,"sap.ushell.services.MessageBroker");return Promise.reject(u)};this.unsubscribe=function(s,n){var a;if(typeof s!=="string"||!s.length||!Array.isArray(n)||!n.length){a="Missing required parameter(s)";e.error(a,null,"sap.ushell.services.MessageBroker");return Promise.reject(a)}if(!t[s]){a="Client is not connected";e.error(a,null,"sap.ushell.services.MessageBroker");return Promise.reject(a)}for(var c in n){var l=n[c];if(r[l.channelId]){var o=r[l.channelId];for(var u in o){var d=o[u];if(d.clientId===s){var h=i[s].channels;i[s].channels=h.filter(function(e){return e.channelId!==l.channelId});o.splice(u,1);break}}}else{var f="Unknown channel Id: "+l.channelId;e.warning(f,null,"sap.ushell.services.MessageBroker")}}this._emitEvent("clientUnsubscribed",s,n);return Promise.resolve()};this.publish=function(s,n,i,a,c,l){var o,u=[];if(!t[n]){o="Client is not connected";e.error(o,null,"sap.ushell.services.MessageBroker");return Promise.reject(o)}if(!r[s]){o="Unknown channel Id: "+s;e.error(o,null,"sap.ushell.services.MessageBroker");return Promise.reject(o)}var d=r[s].find(function(e){return e.clientId===n});if(!d){o="Client is not subscribed to the provided channel";e.error(o,null,"sap.ushell.services.MessageBroker");return Promise.reject(o)}for(var h in c){var f=c[h];if(f==="*"){u=r[s].concat();break}else{var v=r[s].find(function(e){return e.clientId===f});if(v){u.push(this._deepCopy(v))}}}if(u.length){this._sendMessage(u,s,i,a,n,l);return Promise.resolve()}else{o="Target client(s) not found in the provided channel";e.error(o,null,"sap.ushell.services.MessageBroker");return Promise.reject(o)}};this.addAcceptedOrigin=function(s){if(typeof s==="string"&&s.length>0){n[s]=true}else{e.warning("Missing required parameter sOrigin",null,"sap.ushell.services.MessageBroker")}};this.removeAcceptedOrigin=function(e){delete n[e]};this.getAcceptedOrigins=function(){return Object.keys(n)};this.getSubscribedClients=function(){return this._deepCopy(r)};this._emitEvent=function(e,s,n){var t={};for(var i in r){var a=r[i];for(var c in a){var l=a[c];if(l.clientId!==s&&!t[l.clientId]){var o={clientId:s,channels:n};if(l.isUI5!==false){l.clientConnectionCallback(e,s,n)}else{o.channelId="sap.ushell.MessageBroker";o.messageName=e;var u=this._buildPostMessageObject("event",o);this._sendPostMessageToClient(u,l.iframe,l.origin,false)}t[l.clientId]=true}}}};this._sendMessage=function(e,s,n,r,t,i){for(var a in e){var c=e[a];if(c.clientId!==t){if(c.isUI5!==false){c.messageCallback(t,s,r,i)}else{var l={clientId:t,channelId:s,messageName:r,data:i};var o=this._buildPostMessageObject("request",l);this._sendPostMessageToClient(o,c.iframe,c.origin,false)}}}};this._callApi=function(e,s){return this[e].apply(this,s)};this._handlePostMessageRequest=function(e,s,n){return new Promise(function(r,t){var i,a=false,c=e.clientId,l=e.channelId,o=e.requestId,u=e.messageName,d=e.subscribedChannels,h=e.targetClientIds,f=e.data;var v={connect:[c],disconnect:[c],subscribe:[c,d,null,null,s,n],unsubscribe:[c,d],publish:[l,c,o,u,h,f]};var g={channelId:l,clientId:c,messageName:u,requestId:o};switch(u){case"connect":case"disconnect":case"subscribe":case"unsubscribe":i=u;a=true;break;default:i="publish";break}var p=this._buildPostMessageObject("response",g);this._callApi(i,v[i]).then(function(e){if(Array.isArray(e)){p.body.activeClients=e.concat()}return r({_noresponse_:true})}).catch(function(e){a=false;return t(e)}).finally(function(){if(a){p.body.status="accepted";this._sendPostMessageToClient(p,s,n,false)}}.bind(this))}.bind(this))};this._sendPostMessageToClient=function(e,s,n,r){return new Promise(function(t,i){sap.ui.require(["sap/ushell/components/applicationIntegration/application/Application"],function(a){a.postMessageToIframeObject(e,s,n,r).then(t,i)})})};this._buildPostMessageObject=function(e,s){function n(e,s){var n=Date.now().toString();return{type:"request",request_id:n,service:e,body:s}}function r(e,s,n,r){return{type:"response",request_id:s,service:e,status:r?"success":"error",body:n}}var t="sap.ushell.services.MessageBroker",i={request:{channelId:s.channelId,clientId:s.clientId,messageName:s.messageName},response:{channelId:s.channelId,clientId:s.clientId,correlationMessageId:s.requestId,messageName:s.messageName},event:{channelId:s.channelId,clientId:s.clientId,messageName:s.messageName}};switch(e){case"event":i.event.channels=s.channels;break;case"request":if(s.data){i[e].data=s.data}if(s.activeClients){i[e].activeClients=s.activeClients}break}var a={request:[t,i.request],response:[t,s.requestId,i.response,true],event:[t,i.event]};var c=e==="response"?r:n;return c.apply(this,a[e])};this._buildFunctionName=function(e,s){s=s.charAt(0).toUpperCase()+s.substring(1);return e+s};this._deepCopy=function(e){return s(e)}};return new a},false);