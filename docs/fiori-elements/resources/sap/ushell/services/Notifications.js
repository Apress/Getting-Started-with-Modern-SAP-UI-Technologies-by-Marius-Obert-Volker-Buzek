// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/core/Core","sap/ui/core/Configuration","sap/ui/core/ws/SapPcpWebSocket","sap/ui/model/json/JSONModel","sap/ui/thirdparty/datajs","sap/ui/thirdparty/hasher","sap/ui/thirdparty/jquery","sap/ushell/utils"],function(e,t,i,s,n,o,r,a,c){"use strict";var u="/sap/bc/apc/iwngw/notification_push_apc";var f=60;function d(d,l,g){var h=new n,p=new Date,N=g&&g.config,v={getNotifications:{},getNotificationsByType:{},getNotificationsInGroup:{},getBadgeNumber:{},resetBadgeNumber:{},getNotificationTypesSettings:{},getNotificationsGroupHeaders:{},getMobileSupportSettings:{},getEmailSupportSettings:{},getWebSocketValidity:{},getNotificationCount:{}},_,S,T,I,C=[],m=[],b=[],y=false,D=[],E=false,A=false,P=true,O,B,R=5e3,k=6e3,U=false,F={NOTIFICATIONS:0,NOTIFICATIONS_BY_TYPE:1,GET_BADGE_NUMBER:2,RESET_BADGE_NUMBER:3,GET_SETTINGS:4,GET_MOBILE_SUPPORT_SETTINGS:5,NOTIFICATIONS_GROUP_HEADERS:6,NOTIFICATIONS_IN_GROUP:7,GET_NOTIFICATIONS_COUNT:8,VALIDATE_WEBSOCKET_CHANNEL:9,GET_EMAIL_SUPPORT_SETTINGS:10,NOTIFICATIONS_BY_DATE_DESCENDING:"notificationsByDateDescending",NOTIFICATIONS_BY_DATE_ASCENDING:"notificationsByDateAscending",NOTIFICATIONS_BY_PRIORITY_DESCENDING:"notificationsByPriorityDescending",NOTIFICATIONS_BY_TYPE_DESCENDING:"notificationsByTypeDescending"},G={PACKAGED_APP:0,FIORI_CLIENT:1,WEB_SOCKET:2,POLLING:3},q,w=false,L=true,M=false,H=new a.Deferred,j=new a.Deferred,W,X,x=H.promise(),$=false,z={},J=10,Y=false,V=false,K=[];this.isEnabled=function(){if(!N.enabled||!N.serviceUrl){P=false;if(N.enabled&&!N.serviceUrl){e.warning("No serviceUrl was found in the service configuration")}}else{P=true}return P};this.init=function(){if(!E&&this.isEnabled()){t.getEventBus().subscribe("launchpad","sessionTimeout",this.destroy,this);this.lastNotificationDate=new Date;this._setWorkingMode();E=true;this.bUpdateDependencyInitiatorExists=false;this._userSettingInitialization()}t.getEventBus().subscribe("launchpad","setConnectionToServer",this._onSetConnectionToServer,this)};this._onSetConnectionToServer=function(e,t,i){if(i.active){this._resumeConnection()}else{this._closeConnection()}};this.getUnseenNotificationsCount=function(){var e=new a.Deferred;e.resolve(h.getProperty("/UnseenCount"));return e.promise()};this.getNotificationsCount=function(){return h.getProperty("/NotificationsCount")?h.getProperty("/NotificationsCount"):"0"};this.getNotificationsByTypeWithGroupHeaders=function(){var t={"Accept-Language":i.getLanguageTag()},s,n=new a.Deferred,r=this._getRequestURI(F.NOTIFICATIONS_BY_TYPE);s={requestUri:r};if(!this._getHeaderXcsrfToken()){t["X-CSRF-Token"]="fetch"}s.headers=t;o.request(s,function(e){n.resolve(e)},function(t){if(t.response&&t.response.statusCode===200&&t.response.body){n.resolve(t.response.body)}else{n.reject(t);e.error("Notification service - oData executeAction failed: ",t,"sap.ushell.services.Notifications")}});return n.promise()};this.getNotificationsGroupHeaders=function(){var t={"Accept-Language":i.getLanguageTag()},s,n=new a.Deferred,r=this._getRequestURI(F.NOTIFICATIONS_GROUP_HEADERS);s={requestUri:r};if(!this._getHeaderXcsrfToken()){t["X-CSRF-Token"]="fetch"}s.headers=t;o.request(s,function(e){n.resolve(e)},function(t){if(t.response&&t.response.statusCode===200&&t.response.body){n.resolve(t.response.body)}else{n.reject();e.error("Notification service - oData executeAction failed: ",t,"sap.ushell.services.Notifications")}});return n.promise()};this.getNotificationsBufferInGroup=function(t,s,n){var r=this,c={"Accept-Language":i.getLanguageTag()},u,f=new a.Deferred,d={group:t,skip:s,top:n},l,g,h=this._getRequestURI(F.NOTIFICATIONS_IN_GROUP,d);if($===true){l=z[F.NOTIFICATIONS_IN_GROUP].slice(s,s+n);g=JSON.stringify({"@odata.context":"$metadata#Notifications",value:l});setTimeout(function(){f.resolve(g)},1e3)}else{u={requestUri:h};if(!this._getHeaderXcsrfToken()){c["X-CSRF-Token"]="fetch"}u.headers=c;o.request(u,function(e){r._updateCSRF(e.response);f.resolve(e.value)},function(t){if(t.response&&t.response.statusCode===200&&t.response.body){r._updateCSRF(t.response);f.resolve(JSON.parse(t.response.body).value)}else{f.reject();e.error("Notification service - oData executeAction failed: ",t,"sap.ushell.services.Notifications")}})}return f.promise()};this.getNotificationsBufferBySortingType=function(t,s,n){var r=this,c={"Accept-Language":i.getLanguageTag()},u,f=new a.Deferred,d={skip:s,top:n},l,g,h=this._getRequestURI(t,d);if($===true){l=z[t].slice(s,s+n);g=JSON.stringify({"@odata.context":"$metadata#Notifications",value:l});setTimeout(function(){f.resolve(g)},1e3)}else{u={requestUri:h};if(!this._getHeaderXcsrfToken()){c["X-CSRF-Token"]="fetch"}u.headers=c;o.request(u,function(e){r._updateCSRF(e.response);f.resolve(e.value)},function(t){if(t.response&&t.response.statusCode===200&&t.response.body){r._updateCSRF(t.response);f.resolve(JSON.parse(t.response.body).value)}else{f.reject();e.error("Notification service - oData executeAction failed: ",t,"sap.ushell.services.Notifications")}})}return f.promise()};this.getNotifications=function(){var e,t=new a.Deferred;if(q===G.FIORI_CLIENT||q===G.PACKAGED_APP){e=this._readNotificationsData(false);e.done(function(){t.resolve(h.getProperty("/Notifications"))}).fail(function(){t.reject()})}else{t.resolve(h.getProperty("/Notifications"))}return t.promise()};this.executeBulkAction=function(e,t){var i=new a.Deferred,s=[],n=[],o={succededNotifications:s,failedNotifications:n},r=this;r.sendBulkAction(e,t).done(function(e){e.forEach(function(e,t){var i=e.NotificationId,o=e.Success;if(o){s.push(i)}else{n.push(i)}});if(n.length){i.reject(o)}else{i.resolve(o)}}).fail(function(){i.reject(o)});return i.promise()};this.dismissBulkNotifications=function(e){var t=new a.Deferred,i=this;i.sendBulkDismiss(e).done(function(){t.resolve()}).fail(function(){t.reject()});return t.promise()};this.executeAction=function(t,i){var s=this,n=N.serviceUrl+"/ExecuteAction",r={NotificationId:t,ActionId:i},c={requestUri:n,method:"POST",data:r,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:B,"X-CSRF-Token":O}},u=new a.Deferred;o.request(c,function(e){var t,i={isSucessfull:true,message:""};if(e&&e.response&&e.response.statusCode===200&&e.response.body){t=JSON.parse(e.response.body);i.isSucessfull=t.Success;i.message=t.MessageText}u.resolve(i)},function(n){var o,r={isSucessfull:false,message:""};if(n.response&&n.response.statusCode===200&&n.response.body){o=JSON.parse(n.response.body);r.isSucessfull=o.Success;r.message=o.MessageText;u.resolve(r)}else if(s._csrfTokenInvalid(n)&&Y===false){s._invalidCsrfTokenRecovery(u,s.executeAction,[t,i])}else{u.reject(n);e.error("Notification service - oData executeAction failed: ",n,"sap.ushell.services.Notifications")}});return u.promise()};this.sendBulkAction=function(t,i){var s=this,n=N.serviceUrl+"/BulkActionByHeader",r={ParentId:t,ActionId:i},c={requestUri:n,method:"POST",data:r,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:B,"X-CSRF-Token":O}},u=new a.Deferred;o.request(c,function(e){var t,i;if(e&&e.response&&e.response.statusCode===200&&e.response.body){t=JSON.parse(e.response.body);i=t.value}u.resolve(i)},function(n){var o,r;if(n.response&&n.response.statusCode===200&&n.response.body){o=JSON.parse(n.response.body);r=o.value;u.resolve(r)}else if(s._csrfTokenInvalid(n)&&Y===false){s._invalidCsrfTokenRecovery(u,s.sendBulkAction,[t,i])}else{u.reject();e.error("Notification service - oData executeBulkAction failed: ",n.message,"sap.ushell.services.Notifications")}});return u.promise()};this.sendBulkDismiss=function(t){var i=this,s=N.serviceUrl+"/DismissAll",n={ParentId:t},r={requestUri:s,method:"POST",data:n,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:B,"X-CSRF-Token":O}},c=new a.Deferred;o.request(r,function(){c.resolve()},function(s){if(s.response&&s.response.statusCode===200){c.resolve()}else if(i._csrfTokenInvalid(s)&&Y===false){i._invalidCsrfTokenRecovery(c,i.sendBulkDismiss,[t])}else{c.reject();var n=s?s.message:"";e.error("Notification service - oData executeBulkAction failed: ",n,"sap.ushell.services.Notifications")}});return c.promise()};this.markRead=function(t){var i=this,s=N.serviceUrl+"/MarkRead",n={NotificationId:t},r={requestUri:s,method:"POST",data:n,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:B,"X-CSRF-Token":O}},c=new a.Deferred;o.request(r,function(){c.resolve()},function(s){if(i._csrfTokenInvalid(s)&&Y===false){i._invalidCsrfTokenRecovery(c,i.markRead,[t])}else{e.error("Notification service - oData reset badge number failed: ",s,"sap.ushell.services.Notifications");c.reject(s)}});return c.promise()};this.dismissNotification=function(t){var i=N.serviceUrl+"/Dismiss",s=this,n={NotificationId:t},r={requestUri:i,method:"POST",data:n,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:B,"X-CSRF-Token":O}},c=new a.Deferred;o.request(r,function(){s._addDismissNotifications(t);c.resolve()},function(i){if(s._csrfTokenInvalid(i)&&Y===false){s._invalidCsrfTokenRecovery(c,s.dismissNotification,[t])}else{c.reject(i);e.error("Notification service - oData dismiss notification failed: ",i,"sap.ushell.services.Notifications")}});return c.promise()};this.registerNotificationsUpdateCallback=function(e){C.push(e)};this.registerDependencyNotificationsUpdateCallback=function(e,t){if(t===false){this.bUpdateDependencyInitiatorExists=true}m.push({callback:e,dependent:t})};this.registerNotificationCountUpdateCallback=function(e){b.push(e)};this.notificationsSeen=function(){this._setNotificationsAsSeen()};this.isFirstDataLoaded=function(){return w};this.readSettings=function(){var e;e=this._readSettingsFromServer();return e};this.saveSettingsEntry=function(e){var t=this._writeSettingsEntryToServer(e);return t};this.getUserSettingsFlags=function(){var e=new a.Deferred;if(M===true){e.resolve({highPriorityBannerEnabled:L})}else{x.done(function(){e.resolve({highPriorityBannerEnabled:L})})}return e.promise()};this.setUserSettingsFlags=function(e){L=e.highPriorityBannerEnabled;this._writeUserSettingsFlagsToPersonalization(e)};this._getNotificationSettingsMobileSupport=function(){return W};this._getDismissNotifications=function(){return K};this.filterDismisssedItems=function(e,t){return e.filter(function(e){return!t.some(function(t){return t===e.originalItemId})})};this._addDismissNotifications=function(e){if(K.indexOf(e)===-1){K.push(e)}};this._initializeDismissNotifications=function(){K=[]};this._getNotificationSettingsEmailSupport=function(){return X};this.destroy=function(){A=true;if(S){clearTimeout(S)}else if(T){clearTimeout(T)}else if(I){clearTimeout(I)}if(q===G.WEB_SOCKET&&_){_.close()}t.getEventBus().unsubscribe("launchpad","sessionTimeout",this.destroy,this);t.getEventBus().unsubscribe("launchpad","setConnectionToServer",this._onSetConnectionToServer,this)};this._readUnseenNotificationsCount=function(t){var s=this,n=new a.Deferred,r=this._getRequestURI(F.GET_BADGE_NUMBER),c={requestUri:r,headers:{"Accept-Language":i.getLanguageTag()}};o.read(c,function(e,t){h.setProperty("/UnseenCount",t.data.GetBadgeNumber.Number);s._setNativeIconBadge(t.data.GetBadgeNumber.Number);n.resolve(t.data.GetBadgeNumber.Number)},function(t){if(t.response&&t.response.statusCode===200&&t.response.body){var i=JSON.parse(t.response.body);h.setProperty("/UnseenCount",i.value);s._setNativeIconBadge(i.value);n.resolve(i.value)}else{e.error("Notification service - oData read unseen notifications count failed: ",t.message,"sap.ushell.services.Notifications");n.reject(t)}});return n.promise()};this.readNotificationsCount=function(){var t=new a.Deferred,s=this._getRequestURI(F.GET_NOTIFICATIONS_COUNT),n={requestUri:s,headers:{"Accept-Language":i.getLanguageTag()}};o.read(n,function(e,i){t.resolve(i.data)},function(i){if(i.response&&i.response.statusCode===200&&i.response.body){var s=JSON.parse(i.response.body);t.resolve(s.value)}else{e.error("Notification service - oData read notifications count failed: ",i.message,"sap.ushell.services.Notifications");t.reject(i)}});return t.promise()};this._getNotificationSettingsAvailability=function(){return j.promise()};this._setNotificationsAsSeen=function(){var t=this,i=new a.Deferred,s=this._getRequestURI(F.RESET_BADGE_NUMBER),n={requestUri:s,method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:B,"X-CSRF-Token":O}};if(this._isFioriClientMode()===true||this._isPackagedMode()===true){this._setNativeIconBadge(0)}o.request(n,function(){i.resolve()},function(s){if(t._csrfTokenInvalid(s)&&Y===false){t._invalidCsrfTokenRecovery(i,t._setNotificationsAsSeen)}else{e.error("Notification service - oData reset badge number failed: ",s,"sap.ushell.services.Notifications");i.reject(s)}});return i.promise()};this._readNotificationsData=function(e){var t=this,i,s,n,o=new a.Deferred,r=[];i=this._readUnseenNotificationsCount(e);r.push(i);n=this.readNotificationsCount();n.done(function(e){h.setProperty("/NotificationsCount",e)});s=this.getNotificationsBufferBySortingType(F.NOTIFICATIONS_BY_DATE_DESCENDING,0,J);r.push(s);a.when.apply(a,r).then(function(){r[0].done(function(){if(e===true){t._updateNotificationsCountConsumers()}});r[1].done(function(i){h.setProperty("/Notifications",i);t._notificationAlert(i);if(e===true){t._updateNotificationsConsumers();t._updateDependentNotificationsConsumers()}o.resolve()})});return o.promise()};this._getHeaderXcsrfToken=function(){return O};this._getDataServiceVersion=function(){return B};this._getRequestURI=function(e,t){var i,s=encodeURI(this._getConsumedIntents(e));switch(e){case F.NOTIFICATIONS:if(v.getNotifications.basic===undefined){v.getNotifications.basic=N.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$filter=IsGroupHeader%20eq%20false"}if(this._isIntentBasedConsumption()){if(v.getNotifications.byIntents===undefined){v.getNotifications.byIntents=v.getNotifications.basic.concat("&intents%20eq%20"+s)}return v.getNotifications.byIntents}return v.getNotifications.basic;case F.NOTIFICATIONS_BY_TYPE:if(v.getNotificationsByType.basic===undefined){v.getNotificationsByType.basic=N.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams"}if(this._isIntentBasedConsumption()){if(v.getNotificationsByType.byIntents===undefined){v.getNotificationsByType.byIntents=v.getNotificationsByType.basic.concat("&$filter=intents%20eq%20"+s)}return v.getNotificationsByType.byIntents}return v.getNotificationsByType.basic;case F.NOTIFICATIONS_GROUP_HEADERS:if(v.getNotificationsGroupHeaders.basic===undefined){v.getNotificationsGroupHeaders.basic=N.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$filter=IsGroupHeader%20eq%20true"}if(this._isIntentBasedConsumption()){if(v.getNotificationsGroupHeaders.byIntents===undefined){v.getNotificationsGroupHeaders.byIntents=v.getNotificationsGroupHeaders.basic.concat("&intents%20eq%20"+s)}return v.getNotificationsGroupHeaders.byIntents}return v.getNotificationsGroupHeaders.basic;case F.NOTIFICATIONS_IN_GROUP:i=N.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt desc&$filter=IsGroupHeader eq false and ParentId eq "+t.group+"&$skip="+t.skip+"&$top="+t.top;if(this._isIntentBasedConsumption()===true){i=i.concat("&intents%20eq%20"+s)}break;case F.GET_BADGE_NUMBER:if(v.getBadgeNumber.basic===undefined){v.getBadgeNumber.basic=N.serviceUrl+"/GetBadgeNumber()"}if(this._isIntentBasedConsumption()){if(v.getBadgeNumber.byIntents===undefined){v.getBadgeNumber.byIntents=N.serviceUrl+"/GetBadgeCountByIntent("+s+")"}return v.getBadgeNumber.byIntents}return v.getBadgeNumber.basic;case F.GET_NOTIFICATIONS_COUNT:if(v.getNotificationCount.basic===undefined){v.getNotificationCount.basic=N.serviceUrl+"/Notifications/$count"}return v.getNotificationCount.basic;case F.RESET_BADGE_NUMBER:if(v.resetBadgeNumber.basic===undefined){v.resetBadgeNumber.basic=N.serviceUrl+"/ResetBadgeNumber"}return v.resetBadgeNumber.basic;case F.GET_SETTINGS:if(v.getNotificationTypesSettings.basic===undefined){v.getNotificationTypesSettings.basic=N.serviceUrl+"/NotificationTypePersonalizationSet"}return v.getNotificationTypesSettings.basic;case F.GET_MOBILE_SUPPORT_SETTINGS:if(v.getMobileSupportSettings.basic===undefined){v.getMobileSupportSettings.basic=N.serviceUrl+"/Channels(ChannelId='SAP_SMP')"}return v.getMobileSupportSettings.basic;case F.GET_EMAIL_SUPPORT_SETTINGS:if(v.getEmailSupportSettings.basic===undefined){v.getEmailSupportSettings.basic=N.serviceUrl+"/Channels(ChannelId='SAP_EMAIL')"}return v.getEmailSupportSettings.basic;case F.VALIDATE_WEBSOCKET_CHANNEL:if(v.getWebSocketValidity.basic===undefined){v.getWebSocketValidity.basic=N.serviceUrl+"/Channels('SAP_WEBSOCKET')"}return v.getWebSocketValidity.basic;case F.NOTIFICATIONS_BY_DATE_DESCENDING:i=N.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt%20desc&$filter=IsGroupHeader%20eq%20false&$skip="+t.skip+"&$top="+t.top;if(this._isIntentBasedConsumption()===true){i=i.concat("&intents%20eq%20"+s)}break;case F.NOTIFICATIONS_BY_DATE_ASCENDING:i=N.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt%20asc&$filter=IsGroupHeader%20eq%20false&$skip="+t.skip+"&$top="+t.top;if(this._isIntentBasedConsumption()===true){i=i.concat("&intents%20eq%20"+s)}break;case F.NOTIFICATIONS_BY_PRIORITY_DESCENDING:i=N.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=Priority%20desc&$filter=IsGroupHeader%20eq%20false&$skip="+t.skip+"&$top="+t.top;if(this._isIntentBasedConsumption()===true){i=i.concat("&intents%20eq%20"+s)}break;default:i=""}return i};this._readSettingsFromServer=function(){var t=this._getRequestURI(F.GET_SETTINGS),s={requestUri:t,headers:{"Accept-Language":i.getLanguageTag()}},n=new a.Deferred;o.request(s,function(e){n.resolve(e.results)},function(t){if(t.response&&t.response.statusCode===200&&t.response.body){n.resolve(t.response.body)}else{n.reject(t);e.error("Notification service - oData get settings failed: ",t,"sap.ushell.services.Notifications")}});return n.promise()};this._readMobileSettingsFromServer=function(){return this._readChannelSettingsFromServer(F.GET_MOBILE_SUPPORT_SETTINGS)};this._readEmailSettingsFromServer=function(){return this._readChannelSettingsFromServer(F.GET_EMAIL_SUPPORT_SETTINGS)};this._readChannelSettingsFromServer=function(t){var s=this._getRequestURI(t),n={requestUri:s,headers:{"Accept-Language":i.getLanguageTag()}},r=new a.Deferred,c,u;o.request(n,function(e){if(typeof e.results==="string"){c=JSON.parse(e.results);c.successStatus=true;u=JSON.stringify(c);r.resolve(u)}else{e.results.successStatus=true;r.resolve(e.results)}},function(t){if(t.response&&t.response.statusCode===200&&t.response.body){c=JSON.parse(t.response.body);c.successStatus=true;u=JSON.stringify(c);r.resolve(u)}else{r.resolve(JSON.stringify({successStatus:false}));e.error("Notification service - oData get settings failed: ",t,"sap.ushell.services.Notifications")}});return r.promise()};this._checkWebSocketActivity=function(){var t=this._getRequestURI(F.VALIDATE_WEBSOCKET_CHANNEL),s={requestUri:t,headers:{"Accept-Language":i.getLanguageTag()}},n=new a.Deferred,r;o.request(s,function(e){if(typeof e.results==="string"){r=JSON.parse(e.results);n.resolve(r.IsActive)}else{n.resolve(false)}},function(t){if(t.response&&t.response.statusCode===200&&t.response.body){r=JSON.parse(t.response.body);n.resolve(r.IsActive)}else{n.resolve(false);e.error("Notification service - oData get settings failed: ",t,"sap.ushell.services.Notifications")}});return n.promise()};this._writeSettingsEntryToServer=function(t){var i=this,s,n=this._getRequestURI(F.GET_SETTINGS)+"(NotificationTypeId="+t.NotificationTypeId+")",r={requestUri:n,method:"PUT",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:B,"X-CSRF-Token":O}};r.data=JSON.parse(JSON.stringify(t));r.data["@odata.context"]="$metadata#NotificationTypePersonalizationSet/$entity";s=new a.Deferred;o.request(r,function(e){s.resolve(e)},function(n){if(n.response&&n.response.statusCode===200&&n.response.body){s.resolve(n.response.body)}else if(i._csrfTokenInvalid(n)&&Y===false){i._invalidCsrfTokenRecovery(s,i._writeSettingsEntryToServer,[t])}else{s.reject(n);e.error("Notification service - oData set settings entry failed: ",n,"sap.ushell.services.Notifications")}});return s.promise()};this._updateNotificationsConsumers=function(){C.forEach(function(e){e()})};this._updateDependentNotificationsConsumers=function(){var e=this,t=new a.Deferred;m.forEach(function(i){if(e.bUpdateDependencyInitiatorExists===false){i.callback()}else if(i.dependent===true){i.callback(t.promise())}else{i.callback(t)}})};this._updateNotificationsCountConsumers=function(){b.forEach(function(e){e()})};this._updateAllConsumers=function(){this._updateNotificationsConsumers();this._updateNotificationsCountConsumers();this._updateDependentNotificationsConsumers()};this._getModel=function(){return h};this._getMode=function(){return q};this._setWorkingMode=function(){var e;if(N.intentBasedConsumption===true){D=this._getIntentsFromConfiguration(N.consumedIntents);if(D.length>0){y=true}}if(this._isPackagedMode()){q=G.PACKAGED_APP;e=this._getIntentsFromConfiguration(window.fiori_client_appConfig.applications);if(e.length>0){D=e}if(D.length>0){y=true}this._registerForPush();this._readNotificationsData(true);this._setNativeIconBadgeWithDelay();return}this._performFirstRead()};this._performFirstRead=function(){var t=this,i,s=this._readNotificationsData(true);s.done(function(){i=t._getFioriClientRemainingDelay();if(i<=0){t._fioriClientStep()}else{S=setTimeout(function(){t._fioriClientStep()},i)}w=true}).fail(function(t){e.error("Notifications oData read failed. Error: "+t);return})};this._fioriClientStep=function(){if(this._isFioriClientMode()){q=G.FIORI_CLIENT;this._addPushNotificationHandler();this.getUnseenNotificationsCount().done(function(e){this._setNativeIconBadge(e,function(){})}.bind(this)).fail(function(){})}else{this._webSocketStep()}};this._webSocketStep=function(){q=G.WEB_SOCKET;this._establishWebSocketConnection()};this._webSocketRecoveryStep=function(){if(U===false){U=true;T=setTimeout(function(){this._webSocketStep()}.bind(this),R)}else{this._activatePollingAfterInterval()}};this._activatePollingAfterInterval=function(){var e=N.pollingIntervalInSeconds||f;clearTimeout(I);I=setTimeout(this._activatePolling.bind(this),c.sanitizeTimeoutDelay(e*1e3))};this._activatePolling=function(){var e=N.pollingIntervalInSeconds||f;q=G.POLLING;this._readNotificationsData(true);clearTimeout(I);I=setTimeout(this._activatePolling.bind(this,e,false),c.sanitizeTimeoutDelay(e*1e3))};this._formatAsDate=function(e){return new Date(e)};this._notificationAlert=function(e){if(L===false){return}var i,s=[],n=0;for(i in e){if(this.lastNotificationDate&&this._formatAsDate(e[i].CreatedAt)>this.lastNotificationDate){if(e[i].Priority==="HIGH"){s.push(e[i])}}if(n<this._formatAsDate(e[i].CreatedAt)){n=this._formatAsDate(e[i].CreatedAt)}}if(this.lastNotificationDate&&s&&s.length>0){t.getEventBus().publish("sap.ushell.services.Notifications","onNewNotifications",s)}this.lastNotificationDate=n};this._getFioriClientRemainingDelay=function(){return k-(new Date-p)};this._establishWebSocketConnection=function(){var t=this,i=false,n;try{_=this._getWebSocketObjectObject(N.webSocketUrl||u,[s.SUPPORTED_PROTOCOLS.v10]);_.attachMessage(this,function(e){n=e.getParameter("pcpFields");if(n&&n.Command&&n.Command==="Notification"){t._readNotificationsData(true)}});_.attachOpen(this,function(){t._checkWebSocketActivity().done(function(e){if(!e){i=true;_.close();t._activatePollingAfterInterval()}});e.info("Notifications UShell service WebSocket: webSocket connection opened")});_.attachClose(this,function(s){e.warning("Notifications UShell service WebSocket: attachClose called with code: "+s.mParameters.code+" and reason: "+s.mParameters.reason);if(!A&&!i){t._webSocketRecoveryStep()}});_.attachError(this,function(){e.warning("Notifications UShell service WebSocket: attachError called!")})}catch(t){e.error("Exception occurred while creating new sap.ui.core.ws.SapPcpWebSocket. Message: "+t.message)}};this._isFioriClientMode=function(){return!(sap.FioriClient===undefined)};this._isPackagedMode=function(){return window.fiori_client_appConfig&&window.fiori_client_appConfig.prepackaged===true};this._setNativeIconBadge=function(e){if(sap.Push!==undefined&&sap.Push.setBadgeNumber!==undefined){sap.Push.setBadgeNumber(e,function(){})}};this._setNativeIconBadgeWithDelay=function(){setTimeout(function(){this.getUnseenNotificationsCount().done(function(e){this._setNativeIconBadge(e)}.bind(this)).fail(function(){})}.bind(this),4e3)};this._getIntentsFromConfiguration=function(e){var t=[];if(e&&e.length>0){var i;for(var s=0;s<e.length;s++){i=e[s].intent;t.push(i)}}return t};this._handlePushedNotification=function(e){var i,s,n,o,a=[],u;if(e!==undefined){if(e.additionalData===undefined||e.additionalData.foreground===true){this._readNotificationsData(true)}else{if(e.additionalData&&e.additionalData.NavigationTargetObject){s=e.additionalData.NavigationTargetObject}else{s=e.NavigationTargetObject}if(e.additionalData&&e.additionalData.NavigationTargetAction){n=e.additionalData.NavigationTargetAction}else{n=e.NavigationTargetAction}if(e.additionalData&&e.additionalData.NavigationTargetParam){o=e.additionalData.NavigationTargetParam}else{o=e.NavigationTargetParam}if(o){if(typeof o==="string"||o instanceof String){a[0]=o}else if(Array.isArray(o)===true){a=o}}i=e.NotificationId;if(s&&n){if(typeof r!=="undefined"&&r.getHash()===s+"-"+n){u=t.byId("viewPortContainer");if(u){u.switchState("Center")}}c.toExternalWithParameters(s,n,a)}this.markRead(i);this._readNotificationsData(true)}}};this._registerForPush=function(){sap.Push.initPush(this._handlePushedNotification.bind(this))};this._addPushNotificationHandler=function(){document.addEventListener("deviceready",this._registerForPush.bind(this),false)};this._isIntentBasedConsumption=function(){return y};this._getConsumedIntents=function(e){var t="",i;if(!this._isIntentBasedConsumption()){return t}if(D.length>0){if(e!==F.GET_BADGE_NUMBER){t="&"}for(i=0;i<D.length;i++){if(e===F.GET_BADGE_NUMBER){if(i===0){t=D[i]}else{t=t+","+D[i]}}else{t=t+"NavigationIntent%20eq%20%27"+D[i]+"%27"}}}return t};this._revalidateCsrfToken=function(){var e;O=undefined;V=false;e=this.getNotificationsBufferBySortingType(F.NOTIFICATIONS_BY_DATE_DESCENDING,0,1);return e.promise()};this._csrfTokenInvalid=function(e){var t=e.response;var i=t&&t.statusCode===403;var s=t?t.headers["x-csrf-token"]:"";var n=s.toLowerCase()==="required";return i&&n};this._invalidCsrfTokenRecovery=function(t,i,s){var n=this,o=this._revalidateCsrfToken(),r;Y=true;o.done(function(){r=i.apply(n,s);r.done(function(e){Y=false;t.resolve(e)});r.fail(function(e){Y=false;if(e.response&&e.response.statusCode===200&&e.response.body){t.resolve(e.response.body)}else{t.reject(e)}})});o.fail(function(i){Y=false;t.reject(i);e.error("Notification service - oData markRead failed: ",i.message,"sap.ushell.services.Notifications")})};this._notificationsAscendingSortBy=function(e,t){e.sort(function(e,i){var s=e[t],n=i[t];if(s===n){s=e.id;n=i.id}return n>s?-1:1});return e};this._getWebSocketObjectObject=function(e,t){return new s(e,t)};this.getOperationEnum=function(){return F};this._readUserSettingsFlagsFromPersonalization=function(){this._getUserSettingsPersonalizer().then(function(t){t.getPersData().done(function(e){if(e===undefined){this._writeUserSettingsFlagsToPersonalization({highPriorityBannerEnabled:L})}else{L=e.highPriorityBannerEnabled}M=true;H.resolve()}.bind(this)).fail(function(){e.error("Reading User Settings flags from Personalization service failed")})}.bind(this)).catch(function(t){e.error("Personalization service does not work:");e.error(t.name+": "+t.message);e.error("Reading User Settings flags from Personalization service failed")})};this._writeUserSettingsFlagsToPersonalization=function(t){var i=new a.Deferred;this._getUserSettingsPersonalizer().then(function(e){e.setPersData(t).done(i.resolve).fail(i.reject)}).catch(function(t){e.error("Personalization service does not work:");e.error(t.name+": "+t.message);i.reject(t)});return i.promise()};this._getUserSettingsPersonalizer=function(){if(!this.oUserSettingsPersonalizerPromise){this.oUserSettingsPersonalizerPromise=sap.ushell.Container.getServiceAsync("Personalization").then(function(e){var t={keyCategory:e.constants.keyCategory.FIXED_KEY,writeFrequency:e.constants.writeFrequency.LOW,clientStorageAllowed:true};var i={container:"sap.ushell.services.Notifications",item:"userSettingsData"};return e.getPersonalizer(i,t)})}return this.oUserSettingsPersonalizerPromise};this._updateCSRF=function(e){if(V===true||e.headers===undefined){return}if(!this._getHeaderXcsrfToken()){O=e.headers["x-csrf-token"]||e.headers["X-CSRF-Token"]||e.headers["X-Csrf-Token"]}if(!this._getDataServiceVersion()){B=e.headers.DataServiceVersion||e.headers["odata-version"]}V=true};this._userSettingInitialization=function(){var e,t,i,s={settingsAvailable:false,mobileAvailable:false,emailAvailable:false},n,o,r,c;this._readUserSettingsFlagsFromPersonalization();e=this._readSettingsFromServer();t=this._readMobileSettingsFromServer();i=this._readEmailSettingsFromServer();n=[e,t,i];e.done(function(){s.settingsAvailable=true});t.done(function(e){o=JSON.parse(e);r=o.successStatus;if(r){W=e?o.IsActive:false;s.mobileAvailable=W}else{W=false;s.mobileAvailable=false}});i.done(function(e){o=JSON.parse(e);c=o.successStatus;if(c){X=e?o.IsActive:false;s.emailAvailable=X}else{X=false;s.emailAvailable=false}});a.when.apply(a,n).then(function(){j.resolve(s)})};this._closeConnection=function(){if(!A){if(q===G.WEB_SOCKET&&_){_.close();A=true}if(q===G.POLLING&&I){clearTimeout(I);A=true}}};this._resumeConnection=function(){if(A){A=false;this._webSocketStep()}}}d.hasNoAdapter=true;return d},true);