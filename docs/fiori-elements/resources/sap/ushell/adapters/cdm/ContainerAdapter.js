// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/extend","sap/base/util/ObjectPath","sap/ui/thirdparty/URI","sap/ui/thirdparty/jquery","sap/ushell/System","sap/ushell/User","sap/ushell/utils"],function(e,t,r,i,o,s,n,a){"use strict";var u=e.getLogger("sap/ushell/adapters/cdm/ContainerAdapter",e.Level.INFO);var l=function(l,f,c){var d="/sap/public/bc/icf/logoff",m=v(c.config,d),p=r.get("systemProperties.logoutMethod",c.config)||"GET",g=r.get("systemProperties.csrfTokenUrl",c.config),h=b(c.config),y=T(l,c.config),P=A(c.config);function v(e,t){if(e.systemProperties&&e.systemProperties.logoutUrl){return e.systemProperties.logoutUrl}return t}function b(e){var t,r=e.userProfile;if(r){t=R(r.defaults,e.userProfilePersonalization,r.metadata)}return new n(t||w())}function T(e,t){var r=t.systemProperties,i=e.getAlias(),o=e.getPlatform(),n=e.getBaseUrl(),a,u,l,f,c,d,m;if(r){i=r.alias||i;o=r.platform||o;a=r.SID;u=r.client;l=r.productName;f=r.productVersion;c=r.systemName;d=r.systemRole;m=r.tenantRole}return new s({alias:i,platform:o,baseUrl:n,system:a,client:u,productName:l,productVersion:f,systemName:c,systemRole:d,tenantRole:m})}function R(e,r,i){var o=t(w(),e,r);o.bootTheme=o.bootTheme||{theme:o.theme,root:""};delete o.theme;if(i){if(i.editablePropterties){o.setThemePermitted=i.editablePropterties.indexOf("theme")>-1;o.setAccessibilityPermitted=i.editablePropterties.indexOf("accessibility")>-1;o.setContentDensityPermitted=i.editablePropterties.indexOf("contentDensity")>-1}if(i.ranges){o.ranges=i.ranges}}return o}function w(){return{setThemePermitted:false,setAccessibilityPermitted:false,setContentDensityPermitted:false}}function A(e){var t=e&&e.systemProperties&&e.systemProperties.sessionKeepAlive;if(!t){return null}if(!t.url){u.error("Mandatory parameter 'url' missing in 'sessionKeepAlive' configuration.");return null}if(t.method!=="HEAD"&&t.method!=="GET"){t.method="HEAD"}return t}this._getLogoutUrl=function(){return m};this._setDocumentLocation=function(e){document.location=e};this._setWindowLocation=function(e){window.location.href=e};this.getSystem=function(){return y};this.getUser=function(){return h};this.load=function(){return o.when()};this.getCurrentUrl=function(){return window.location.href};this.logout=function(e){var t;if(!e){throw new Error("Not implemented")}if(a.hasNativeLogoutCapability()){t=new i(this._getLogoutUrl()).absoluteTo(this.getCurrentUrl()).search("").toString();a.getPrivateEpcm().doLogOff(t)}else{return this.logoutRedirect()}return o.when()};this.logoutRedirect=function(){var t=y.adjustUrl(this._getLogoutUrl()),r=new o.Deferred,i=this;if(p==="POST"){e.info("performing logout from system via POST",undefined,"sap.ushell.adapters.cdm.ContainerAdapter::logoutRedirect");o.ajax({type:"HEAD",url:g,headers:{"X-CSRF-Token":"Fetch"},success:function(s,n,a){o.ajax({type:"POST",url:t,headers:{"X-CSRF-Token":a.getResponseHeader("X-CSRF-Token")},success:function(e){i._setWindowLocation(e);r.resolve()},error:function(){e.error("Logging out via POST failed",undefined,"sap.ushell.adapters.cdm.ContainerAdapter::logoutRedirect");r.resolve()}})},error:function(){e.error("fetching X-CSRF-Token for logout via POST failed for system: "+y.getAlias(),undefined,"sap.ushell.adapters.cdm.ContainerAdapter::logoutRedirect");r.resolve()}})}else{e.info("performing logout from system via GET (redirect)",undefined,"sap.ushell.adapters.cdm.ContainerAdapter::logoutRedirect");this._setDocumentLocation(t);r.resolve()}return r.promise()};this.sessionKeepAlive=function(){if(!P){return}var e=new XMLHttpRequest;e.open(P.method,P.url,true);e.onreadystatechange=function(){if(this.readyState===4){u.debug("Server session was extended")}};e.send()};this._getSessionKeepAliveConfig=function(){return P}};return l},false);