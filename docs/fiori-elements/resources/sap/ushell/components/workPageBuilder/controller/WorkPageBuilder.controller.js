//Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/resources","sap/base/Log","sap/ui/core/Core","sap/ui/core/Component","sap/ui/core/mvc/Controller","sap/ushell/utils","sap/ui/integration/widgets/Card","sap/ui/core/Fragment","sap/ui/integration/Host","sap/base/util/ObjectPath","sap/ui/model/json/JSONModel","sap/f/GridContainerItemLayoutData","sap/ushell/EventHub","sap/ushell/Config","sap/ui/core/theming/Parameters","sap/m/library","sap/ushell/services/_VisualizationInstantiation/VizInstanceCdm","sap/ushell/adapters/cdm/v3/utilsCdm","sap/ushell/adapters/cdm/v3/_LaunchPage/readUtils","sap/ushell/adapters/cdm/v3/_LaunchPage/readVisualizations","sap/ushell/services/VisualizationInstantiation","sap/ui/core/InvisibleMessage","sap/ui/core/library"],function(e,t,i,r,n,o,a,s,d,l,g,u,c,h,p,v,f,m,C,P,w,_,y){"use strict";var D=4;var W=24;var z=2;var S=6;var M=v.LoadState;var V=y.InvisibleMessageMode;return n.extend("sap.ushell.components.workPageBuilder.controller.WorkPageBuilder",{onInit:function(){this._fnDeleteRowHandler=this.deleteRow.bind(this);this.oModel=new g({editMode:false,loaded:false,navigationDisabled:false,showFooter:false,data:{WorkPage:null,Visualizations:[],UsedVisualizations:[]}});this.oModel.setSizeLimit(Infinity);this._saveHost();this._oViewSettingsModel=new g({gridContainerGap:{},gridContainerRowSize:{}});this.getView().setModel(this._oViewSettingsModel,"viewSettings");var e=this._setGridContainerSizes.bind(this);h.on("/core/home/sizeBehavior").do(e);c.on("themeChanged").do(e);this._setGridContainerSizes();this.byId("sapCepWorkPage").bindElement({path:"/data/WorkPage"});return this.getOwnerComponent().getVizInstantiationPromise().then(function(e){this._oVizInstantiationService=e;this.getView().setModel(this.oModel)}.bind(this))},onAddColumn:function(e){var t=this.getView().getModel();var i=e.getSource();var r=i.getParent();var n=r.indexOfAggregation("columns",i);var o=r.getBindingContext().getPath();var a=o+"/Columns/";var s=i.getBindingContext().getPath()+"/Descriptor/columnWidth";var d=t.getProperty(a);var l=d.length;var g=e.getParameter("left");if(l>=S){return}var u=i.getProperty("columnWidth");var c=Math.floor(u/2)>=D?Math.floor(u/2):D;var h=c%2;t.setProperty(s,c+h);var p=r.indexOfAggregation("columns",i)+(g===true?0:1);var v=this._createEmptyColumn(c-h);var f=[d.slice(0,p),v,d.slice(p)].flat();var m=f.reduce(function(e,t){return e+this._getColumnWidth(t)}.bind(this),0);if(m>W){this._calculateColWidths(f,n,m)}t.setProperty(a,f);this.getOwnerComponent().fireEvent("workPageEdited")},setEditMode:function(e){this.oModel.setProperty("/editMode",!!e)},getEditMode:function(){return this.oModel.getProperty("/editMode")},setShowFooter:function(e){this.oModel.setProperty("/showFooter",!!e)},setPageData:function(e){var t={};var i=l.get("WorkPage.UsedVisualizations.nodes",e);var r=l.get("WorkPage.Contents",e);if(i&&i.length>0){t=i.reduce(function(e,t){e[t.Id]=t;return e},{})}this.oModel.setProperty("/data/UsedVisualizations",t);this.oModel.setProperty("/data/WorkPage",r);this.oModel.setProperty("/loaded",true)},getPageData:function(){var e=this.oModel.getProperty("/data/UsedVisualizations")||{};return{WorkPage:{Contents:this.oModel.getProperty("/data/WorkPage"),UsedVisualizations:{nodes:Object.values(e)}}}},setVisualizationData:function(e){return this.oContentFinderPromise.then(function(t){this.oModel.setProperty("/data/Visualizations",e);t.setVisualizationData(this.oModel.getProperty("/data/Visualizations"))}.bind(this))},onGridColumnsChange:function(e){var t=e.getParameter("columns");var i=e.getSource();i.getWidgets().filter(function(e){return e.isA("sap.ui.integration.widgets.Card")}).forEach(function(e){e.setLayoutData(new u({columns:t,minRows:1}))})},onDeleteColumn:function(e){var t=this.getView().getModel();var i=e.getSource();var r=i.getColumnWidth();var n=i.getParent();var o=n.indexOfAggregation("columns",i);var a=n.getBindingContext().getPath();var s=a+"/Columns/";var d=t.getProperty(s);var l=d.filter(function(e,t){return t!==o});var g=r/2;var u=o-1<0?o:o-1;while(g>0){var c=l[u];this._setColumnWidth(c,this._getColumnWidth(c)+z);u=++u>=l.length?0:u++;g--}t.setProperty(s,l);this.getOwnerComponent().fireEvent("workPageEdited")},onAddFirstRow:function(){var e="/data/WorkPage/Rows/";this.getView().getModel().setProperty(e,[this._createEmptyRow()]);this.getOwnerComponent().fireEvent("workPageEdited")},onAddRow:function(e){var t=this.getView().getModel();var i=e.getSource();var r=this.byId("sapCepWorkPage");var n="/data/WorkPage/Rows/";var o=t.getProperty(n);var a=this._createEmptyRow();var s=r.indexOfAggregation("rows",i)+(e.getParameter("bottom")===true?1:0);var d=[o.slice(0,s),a,o.slice(s)].flat();t.setProperty(n,d);this.getOwnerComponent().fireEvent("workPageEdited")},onResize:function(e){var t=e.getParameter("posXDiff");var i=e.getSource();var r=i.getParent();var n=r.getSingleColumnWidth();var o,a,s,d,l,g,u,c;if(n===0){return}o=t/n;if(o>-1&&o<1){return}a=o<0?Math.floor(t/n):Math.ceil(t/n);s=a>=0?"right":"left";d=r.indexOfAggregation("columns",i);l=d-1;g=this._getCurrentColumnWidth(r,l);u=this._getCurrentColumnWidth(r,d);c=this._doColumnResizeStep(r,l,d,g,u,s);if(c){this._updateModelWithColumnWidths(r,l,d,c.newLeftColumnWidth,c.newRightColumnWidth)}},onResizeCompleted:function(){this.getOwnerComponent().fireEvent("workPageEdited")},_deleteCell:function(e){var t=this.getView().getModel();var i=e.getParent();var r=i.indexOfAggregation("cells",e);var n=i.getBindingContext().getPath()+"/Cells";var o=t.getProperty(n);var a=o.filter(function(e,t){return t!==r});t.setProperty(n,a);this.getOwnerComponent().fireEvent("workPageEdited")},onDeleteCell:function(e){this._deleteCell(e.getSource())},_deleteVisualization:function(e){var t=e.getParent().getParent();var i=e.getBindingContext();var r=i.getPath();var n=this.getView().getModel();var o=r.substring(0,r.lastIndexOf("/"));var a=t.indexOfAggregation("widgets",e);var s=n.getProperty(o);var d=s.filter(function(e,t){return t!==a});n.setProperty(o,d);this.getOwnerComponent().fireEvent("workPageEdited")},onEditTitle:function(){this.getOwnerComponent().fireEvent("workPageEdited")},onWidgetAdded:function(){this.getOwnerComponent().fireEvent("workPageEdited")},_getWidgetGroups:function(){var t=[{id:"applicationWidgets",title:e.i18n.getText("ContentFinder.Categories.Applications.Title"),widgets:[{id:"widgets-tiles",title:e.i18n.getText("ContentFinder.Widgets.Tiles.Title"),description:e.i18n.getText("ContentFinder.Widgets.Tiles.Description"),icon:"sap-icon://header",target:"appSearch_tiles"},{id:"widgets-cards",title:e.i18n.getText("ContentFinder.Widgets.Cards.Title"),description:e.i18n.getText("ContentFinder.Widgets.Cards.Description"),icon:"sap-icon://card",target:"appSearch_cards"}]}];return t},createContentFinderComponent:function(){this.oContentFinderPromise=r.create({name:"sap.ushell.components.contentFinder"}).then(function(e){return e});return this.oContentFinderPromise},openWidgetGallery:function(e){var t=e.getSource();if(!this.oContentFinderPromise){this.oContentFinderPromise=this.createContentFinderComponent()}this.getOwnerComponent().fireEvent("visualizationFilterApplied");return this.oContentFinderPromise.then(function(e){e.setWidgetGroups(this._getWidgetGroups());e.attachVisualizationsAdded(t,this._onAddVisualization,this);e.show("widgetGallery")}.bind(this))},openTilesAppSearch:function(e){var t=e.getSource();var i=["sap.ushell.StaticAppLauncher","sap.ushell.DynamicAppLauncher"];if(!this.oContentFinderPromise){this.oContentFinderPromise=this.createContentFinderComponent()}this.getOwnerComponent().fireEvent("visualizationFilterApplied",{filters:[{filterKey:"Type",filterValue:i}]});return this.oContentFinderPromise.then(function(e){e.setContextData({restrictedVisualizations:this._getRestrictedVisualizationIds(t)});e.setRestrictedMode(true);e.attachVisualizationsAdded(t,this._onAddVisualization,this);e.show("appSearch_tiles")}.bind(this))},_getRestrictedVisualizationIds:function(e){var t=[];t=e.getWidgets().map(function(e){if(e.isA("sap.ushell.ui.launchpad.VizInstanceCdm")){return e.getProperty("vizRefId")}});return t},_onAddVisualization:function(e,t){var i=e.getParameter("visualizations");if(i.length>0){i.forEach(function(e){var t="/data/UsedVisualizations/"+e.id;if(!this.oModel.getProperty(t)){this.oModel.setProperty(t,e.vizData)}}.bind(this));var r=this._instantiateWidgetData(i);if(t.isA("sap.ushell.components.workPageBuilder.controls.WorkPageCell")){this._setCellData(t,r)}if(t.isA("sap.ushell.components.workPageBuilder.controls.WorkPageColumn")){this._setColumnData(t,r)}}},_instantiateWidgetData:function(e){var t=[];var i=[];var r;t=e.map(function(e){r=this._generateUniqueId(i);i=i.concat([r]);return{Id:r,DescriptorSchemaVersion:"3.2.0",Descriptor:{},Visualization:{Id:e.vizData.Id,Type:e.type}}}.bind(this));return t},_setCellData:function(e,t){var i=e.getBindingContext().getPath();var r=Object.assign({},this.oModel.getProperty(i));r.Widgets=r.Widgets.concat(t);this.oModel.setProperty(i,r);this.onWidgetAdded()},_setColumnData:function(e,t){var i=e.getBindingContext().getPath();var r=Object.assign({},this.oModel.getProperty(i));if(!r.Cells){r.Cells=[]}r.Cells=r.Cells.concat([{Id:this._generateUniqueId(),DescriptorSchemaVersion:"3.2.0",Descriptor:{},Widgets:t.concat([])}]);this.oModel.setProperty(i,r);this.onWidgetAdded()},onDeleteRow:function(e){var t=this.getOwnerComponent().getRootControl();var i=e.getSource().getBindingContext();if(!this.oLoadDeleteDialog){this.oLoadDeleteDialog=s.load({id:t.createId("rowDeleteDialog"),name:"sap.ushell.components.workPageBuilder.view.WorkPageRowDeleteDialog",controller:this}).then(function(e){e.setModel(this.getView().getModel("i18n"),"i18n");return e}.bind(this))}return this.oLoadDeleteDialog.then(function(e){e.getBeginButton().detachEvent("press",this._fnDeleteRowHandler);e.getBeginButton().attachEvent("press",{rowContext:i},this._fnDeleteRowHandler);e.open()}.bind(this))},deleteRow:function(e,t){var i=this.getView().getModel();var r=t.rowContext;var n=i.getProperty("/data/WorkPage/Rows");var o=r.getObject();var a=n.filter(function(e){return e.Id!==o.Id});i.setProperty("/data/WorkPage/Rows",a);this.getOwnerComponent().fireEvent("workPageEdited");return this.oLoadDeleteDialog.then(function(e){e.close()})},onRowDeleteCancel:function(){return this.oLoadDeleteDialog.then(function(e){e.close()})},_createErrorTile:function(){return new f({state:M.Failed}).attachPress(this.onVisualizationPress,this).bindEditable("/editMode").setLayoutData(new u({columns:2,rows:2}))},widgetFactory:function(e,i){var r=i.getProperty("Visualization/Id");if(!r){t.error("No vizId found in widget context.");return this._createErrorTile()}var n=this.getView().getModel().getProperty("/data/UsedVisualizations/"+r);if(!n||!n.Type){t.error("No viz or vizType found for vizId "+r);return this._createErrorTile()}switch(n.Type){case"sap.card":return this._createCard(n);case"sap.ushell.StaticAppLauncher":case"sap.ushell.DynamicAppLauncher":return this._createVizInstance(n);default:t.error("Unknown type for widget "+n.Type);return this._createErrorTile()}},_createVizInstance:function(e){var i=l.get(["Descriptor","sap.flp","indicatorDataSource"],e);var r=l.get(["Descriptor","sap.flp","target","appId"],e);var n=this.getOwnerComponent().getSiteApplication(r);var o=l.get(["sap.app","dataSources"],n);var a=this.getOwnerComponent().getSiteVizType(e.Type);var s={};s[r]=n;var d={id:e.Id,title:l.get(["Descriptor","sap.app","title"],e),subtitle:l.get(["Descriptor","sap.app","subTitle"],e),info:l.get(["Descriptor","sap.app","info"],e),icon:l.get(["Descriptor","sap.ui","icons","icon"],e),keywords:l.get(["Descriptor","sap.app","tags","keywords"],e)||[],_instantiationData:{platform:"CDM",vizType:a},indicatorDataSource:i,vizType:l.get("Type",e),dataSource:this._getDataSource(o,i),contentProviderId:l.get(["sap.app","contentProviderId"],n),vizConfig:l.get(["Descriptor"],e),supportedDisplayFormats:l.get(["Descriptor","sap.flp","vizOptions","displayFormats","supported"],e),displayFormatHint:l.get(["Descriptor","sap.flp","vizOptions","displayFormats","default"],e),numberUnit:l.get(["Descriptor","sap.flp","numberUnit"],e),vizId:e.Id,preview:false};if(!this.oModel.getProperty("/navigationDisabled")){d.target=C.harmonizeTarget(P.getTarget(d)||{});d.targetURL=m.toHashFromVizData(d,s)}var g=this._oVizInstantiationService.instantiateVisualization(d);if(!g){t.error("No VizInstance was created.");return this._createErrorTile()}return g.setActive(true).attachPress(this.onVisualizationPress,this).bindEditable("/editMode").bindClickable({path:"/navigationDisabled",formatter:function(e){return!e}}).setLayoutData(new u(g.getLayout()))},_getDataSource:function(e,t){if(!t||!e){return}return e[t.dataSource]},onVisualizationPress:function(e){var t=e.getParameter("scope");var i=e.getParameter("action");if(t==="Actions"&&i==="Remove"){this._deleteVisualization(e.getSource())}},_createCard:function(e){var i={};var r=e.Descriptor&&e.Descriptor["sap.card"];var n=e.DescriptorResources&&(e.DescriptorResources.BaseUrl||e.DescriptorResources.DescriptorPath);if(!r&&!n){t.error("No Descriptor or DescriptorResources for Card");return(new a).setLayoutData(new u({columns:2,rows:2}))}if(r){i.manifest=e.Descriptor;if(n){i.baseUrl=e.DescriptorResources.BaseUrl+e.DescriptorResources.DescriptorPath}}else if(n){i.manifest=e.DescriptorResources.BaseUrl+e.DescriptorResources.DescriptorPath+"/manifest.json"}if(i.baseUrl&&i.baseUrl.substr(-1)!=="/"){i.baseUrl+="/"}return new a(i).addStyleClass("sapCepWidget").setHost(this.oHost).setLayoutData(new u({columns:16,minRows:1}))},executeNavigation:function(e){var t=e.getParameter("parameters");if(e.getParameter("type")!=="Navigation"||this.oModel.getProperty("/navigationDisabled")){return Promise.resolve()}return this.getOwnerComponent().getUshellContainer().getServiceAsync("CrossApplicationNavigation").then(function(e){return e.toExternal({target:{semanticObject:t.ibnTarget.semanticObject,action:t.ibnTarget.action},params:t.ibnParams})})},saveEditChanges:function(){this.getOwnerComponent().fireEvent("closeEditMode",{saveChanges:true})},cancelEditChanges:function(){this.getOwnerComponent().fireEvent("closeEditMode",{saveChanges:false})},onCellDrop:function(e){var t=e.getParameter("draggedControl");var i=t.getParent().getParent();var r=e.getParameter("droppedControl");var n=i.indexOfAggregation("widgets",t);var o=r.getBindingContext().getProperty("Widgets").length;this._moveVisualization(i,r,n,o)},onCellDragEnter:function(e){var t=e.getParameter("target");if(!this.tileEditMode(true,t.getBindingContext().getProperty("Widgets"))){e.preventDefault()}},onGridDrop:function(e){var t=e.getSource();var i=e.getParameter("draggedControl");var r=e.getParameter("droppedControl");var n=e.getParameter("dropPosition");var o=i.getParent().getParent();var a=o.indexOfAggregation("widgets",i);var s=t.indexOfAggregation("widgets",r);var d=t.getId()===o.getId();if(n==="After"){s++}if(d){if(a<s){s--}if(a===s){return}}this._moveVisualization(o,t,a,s)},_moveVisualization:function(e,t,i,r){var n=this.getView().getModel();var o=e.getBindingContext().getPath()+"/Widgets";var a=t.getBindingContext().getPath()+"/Widgets";var s=o===a;var d=n.getProperty(o);var l=n.getProperty(a);var g=d[i];var u=d.filter(function(e,t){return t!==i});if(s){l=u}var c=[l.slice(0,r),g,l.slice(r)].flat();n.setProperty(o,u);n.setProperty(a,c);_.getInstance().announce(this.getView().getModel("i18n").getResourceBundle().getText("WorkPage.Message.WidgetMoved"),V.Assertive);this.getOwnerComponent().fireEvent("workPageEdited")},tileEditMode:function(e,t){var i=this.getView().getModel();var r;return e&&!!t&&!t.some(function(e){r=i.getProperty("/data/UsedVisualizations/"+l.get("Visualization.Id",e));return l.get("Type",r)==="sap.card"})},_updateModelWithColumnWidths:function(e,t,i,r,n){var o=this.getView().getModel();var a=e.getBindingContext();var s=a.getPath();var d=s+"/Columns/"+t+"/Descriptor/columnWidth";var l=s+"/Columns/"+i+"/Descriptor/columnWidth";o.setProperty(d,r);o.setProperty(l,n)},_updateColumnWidthClass:function(e,t,i){e.$().find(".sapCepWorkPageColumn").eq(t).removeClass(function(e,t){return(t.match(/sapCepColumnWidth.*/g)||[]).join(" ")}).addClass("sapCepColumnWidth"+i)},_doColumnResizeStep:function(e,r,n,o,a,s){var d=i.getConfiguration().getRTL();var l;if(!d){l=s==="right"?z:-z}else{l=s==="right"?-z:z}var g=o+l;var u=a-l;if(g<D||u<D){t.debug("new column value too small",g,u);return null}this._updateColumnWidthClass(e,r,g);this._updateColumnWidthClass(e,n,u);return{newLeftColumnWidth:g,newRightColumnWidth:u}},_getCurrentColumnWidth:function(e,t){var i=e.getBindingContext().getPath();var r=i+"/Columns/"+t+"/Descriptor/columnWidth";return this.getView().getModel().getProperty(r)},_getColumnWidth:function(e){return l.get("Descriptor.columnWidth",e)||W},_setColumnWidth:function(e,t){l.set("Descriptor.columnWidth",t,e)},_calculateColWidths:function(e,t,i){var r=e[t];if(this._getColumnWidth(r)-z>=D){this._setColumnWidth(r,this._getColumnWidth(r)-z);i=i-z}if(i>W){var n=t-1>=0?t-1:e.length-1;this._calculateColWidths(e,n,i)}return e},_createEmptyColumn:function(e){return{Id:this._generateUniqueId(),DescriptorSchemaVersion:"3.2.0",Descriptor:{columnWidth:e},Configurations:[],Cells:[]}},_createEmptyRow:function(){return{Id:this._generateUniqueId(),DescriptorSchemaVersion:"3.2.0",Descriptor:{title:"",description:"this is not yet rendered",fillRowHeight:false,fullWidth:false},Columns:[this._createEmptyColumn(W)]}},_saveHost:function(){this.oHost=i.byId("sap.shell.host.environment");if(!this.oHost){this.oHost=new d("sap.shell.host.environment",{resolveDestination:function(e){if(!e){return Promise.reject()}return Promise.resolve("/dynamic_dest/"+e)}}).attachAction(this.executeNavigation.bind(this))}},getNavigationDisabled:function(){return this.oModel.getProperty("/navigationDisabled")},setNavigationDisabled:function(e){this.oModel.setProperty("/navigationDisabled",e)},_setGridContainerSizes:function(){var e=h.last("/core/home/sizeBehavior");var t=this.getView().getModel("viewSettings");var i=e==="Small"?"_sap_ushell_Tile_SpacingXS":"_sap_ushell_Tile_Spacing";var r=e==="Small"?"_sap_ushell_Tile_SpacingXS":"_sap_ushell_Tile_SpacingS";t.setProperty("/gridContainerGap/gridContainerGap",this._getNumericThemeParam(i));t.setProperty("/gridContainerGap/gridContainerGapXS",this._getNumericThemeParam("_sap_ushell_Tile_SpacingXS"));t.setProperty("/gridContainerGap/gridContainerGapS",this._getNumericThemeParam(r));t.setProperty("/gridContainerGap/gridContainerGapM",this._getNumericThemeParam(i));t.setProperty("/gridContainerGap/gridContainerGapL",this._getNumericThemeParam(i));t.setProperty("/gridContainerGap/gridContainerGapXL",this._getNumericThemeParam(i));var n=e==="Small"?"_sap_ushell_Tile_WidthXS":"_sap_ushell_Tile_Width";var o=e==="Small"?"_sap_ushell_Tile_WidthXS":"_sap_ushell_Tile_WidthS";t.setProperty("/gridContainerRowSize/gridContainerRowSize",this._getNumericThemeParam(n));t.setProperty("/gridContainerRowSize/gridContainerRowSizeXS",this._getNumericThemeParam("_sap_ushell_Tile_WidthXS"));t.setProperty("/gridContainerRowSize/gridContainerRowSizeS",this._getNumericThemeParam(o));t.setProperty("/gridContainerRowSize/gridContainerRowSizeM",this._getNumericThemeParam(n));t.setProperty("/gridContainerRowSize/gridContainerRowSizeL",this._getNumericThemeParam(n));t.setProperty("/gridContainerRowSize/gridContainerRowSizeXL",this._getNumericThemeParam(n))},_getNumericThemeParam:function(e){var t=p.get(e);if(t&&t.indexOf(".")===0){t="0"+t}return t},_generateUniqueId:function(e){var t=(e||[]).concat([]);var i=this.oModel.getProperty("/data/WorkPage");t.push(i.Id);(i.Rows||[]).forEach(function(e){t.push(e.Id);(e.Columns||[]).forEach(function(e){t.push(e.Id);(e.Cells||[]).forEach(function(e){t.push(e.Id);(e.Widgets||[]).forEach(function(e){t.push(e.Id)})})})});return o.generateUniqueId(t)}})});