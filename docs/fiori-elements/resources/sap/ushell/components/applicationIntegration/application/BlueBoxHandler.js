// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/applicationIntegration/application/BlueBoxesCache","sap/ushell/components/applicationIntegration/application/Application","sap/ushell/components/container/ApplicationContainer","sap/ui/thirdparty/jquery","sap/base/util/deepExtend","sap/ui/core/Core","sap/ui/thirdparty/hasher"],function(e,t,i,s,a,p,n){"use strict";function r(){var r=this,u,l={isStateful:{handler:function(e,t){if(e&&(e.enabled===true||e===true)){return true}return false}},isGUI:{handler:function(e,t){if(e&&e.protocol==="GUI"){return true}return false}},isGUIStateful:{handler:function(e,t){return r.isCapUT(t,"isGUI")&&r.isCapUT(t,"isStateful")}},isFLP:{handler:function(e,t){return!r.isCapUT(t,"isGUI")&&r.isCapUT(t,"isStateful")}}},o={},f={},c={setup:function(e,t){},create:function(e,a,r,u,l){var f=new s.Deferred,c,h;function d(){if(c){c["sap-flp-url"]=sap.ushell.Container.getFLPUrl(true);c["system-alias"]=e.getSystemAlias();h["sap-flp-params"]=c}p.getEventBus().publish("launchpad","appOpening",u);t.postMessageToIframeApp(e,"sap.ushell.services.appLifeCycle","create",h,true).then(function(){o[e].currentAppTarget=u;sap.ushell.Container.getServiceAsync("AppLifeCycle").then(function(t){if(l===true){t.prepareCurrentAppObject("URL",undefined,false,e)}p.getEventBus().publish("sap.ushell","appOpened",u);f.resolve()})})}a=i.prototype._checkNwbcUrlAdjustment(e,u.applicationType,a);h={sCacheId:r,sUrl:a,sHash:n.getHash()};if(a.indexOf("sap-iframe-hint=GUI")>0||a.indexOf("sap-iframe-hint=WDA")>0||a.indexOf("sap-iframe-hint=WCF")>0){var C=[];var y=i.prototype._getParamKeys(a,C);if(y.length>0){sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(e){e.getAppStateData(y).then(function(e){c={};C.forEach(function(t,i){if(e[i][0]){c[t]=e[i][0]}});d()},function(){d()})})}else{c={};d()}}else{d()}return f.promise()},destroy:function(e,i){var s;sap.ushell.Container.setAsyncDirtyStateProvider(undefined);s=t.postMessageToIframeApp(e,"sap.ushell.services.appLifeCycle","destroy",{sCacheId:i},true);s.then(function(){p.getEventBus().publish("sap.ushell","appClosed",o[e].currentAppTarget);o[e].currentAppTarget=undefined});return s},store:function(e,i){var s;sap.ushell.Container.setAsyncDirtyStateProvider(undefined);s=t.postMessageToIframeApp(e,"sap.ushell.services.appLifeCycle","store",{sCacheId:i},true);s.then(function(){p.getEventBus().publish("sap.ushell","appClosed",o[e].currentAppTarget);o[e].currentAppTarget=undefined});return s},restore:function(e,i,s,a){return new Promise(function(r){p.getEventBus().publish("launchpad","appOpening",s);t.postMessageToIframeApp(e,"sap.ushell.services.appLifeCycle","restore",{sCacheId:i,sUrl:s.url,sHash:n.getHash()},true).then(function(){o[e].currentAppTarget=s;sap.ushell.Container.getServiceAsync("AppLifeCycle").then(function(t){if(a===true){t.prepareCurrentAppObject("URL",undefined,false,e)}p.getEventBus().publish("sap.ushell","appOpened",s);r()})})})}},h=[{service:"sap.ushell.services.appLifeCycle",action:"create"},{service:"sap.ushell.services.appLifeCycle",action:"destroy"}];this.init=function(i,s,p){e.init();t.init(this);u=p;if(s){a(f,s.supportedTypes)}};this.isStatefulContainerSupported=function(e){var t=this.isCapabilitySupported(e,"sap.ushell.services.appLifeCycle","create")&&this.isCapabilitySupported(e,"sap.ushell.services.appLifeCycle","destroy");return t};this.isKeepAliveSupported=function(e){var t=this.isCapabilitySupported(e,"sap.ushell.services.appLifeCycle","store")&&this.isCapabilitySupported(e,"sap.ushell.services.appLifeCycle","restore");return t};this.isIframeIsValidSupported=function(e){return this.isCapabilitySupported(e,"sap.ushell.appRuntime","iframeIsValid")};this.isIframeBusySupported=function(e){return this.isCapabilitySupported(e,"sap.ushell.appRuntime","iframeIsBusy")};this.mapCapabilities=function(e,t){this.setCapabilities(e,t)};this.getCapabilities=function(e){return o[e].oCapMap};this.isCapabilitySupported=function(e,t,i){if(o[e]&&o[e].oCapMap&&o[e].oCapMap[t]){return!!o[e].oCapMap[t][i]}return false};this.setCapabilities=function(e,t){var i;if(!o[e]){this.initBlueBoxBD(e)}if(!o[e].oCapMap){o[e].oCapMap={}}i=o[e].oCapMap;Object.keys(t).forEach(function(e){var s=t[e],a;if(!i[s.service]){i[s.service]={}}a=i[s.service];a[s.action]=true});if(!e.getIsStateful()&&this.isStatefulContainerSupported(e)){e.setIsStateful(true)}};this.removeCapabilities=function(e){if(o[e]){o[e].oCapMap={};e.setIsStateful(false)}};this.hasIFrame=function(e){if(e&&e._getIFrame){return true}return false};this.initBlueBoxBD=function(e){o[e]={BlueBox:e}};this.setAppCapabilities=function(e,t){if(!o[e]){this.initBlueBoxBD(e)}o[e].currentAppTarget=t;o[e].appCapabilities=t.appCapabilities;if(t.appCapabilities&&t.appCapabilities.statefulContainer===true){this.setCapabilities(e,h)}};this.forEach=function(e){var t;for(t in o){if(o.hasOwnProperty(t)){e(o[t].BlueBox)}}};this.isCapByTarget=function(e,t){if(e.appCapabilities===undefined){return false}if(l[t]&&e&&e.appCapabilities){return l[t].handler(e.appCapabilities)}return e.appCapabilities[t]||false};this.isCapUT=function(e,t){var i=o[e];if(i===undefined||i.appCapabilities===undefined){return false}if(l[t]&&i){return l[t].handler(i.appCapabilities,e)}return i.appCapabilities[t]||false};this.setStorageKey=function(e,t){if(!o[e]){this.initBlueBoxBD(e)}o[e].sStorageKey=t};this.getStorageKey=function(e){if(!o[e]){return undefined}return o[e].sStorageKey};this.getHandler=function(){return c};this._getBlueBoxCacheKey=function(t){return e.getBlueBoxCacheKey(t)};this.deleteStateFul=function(e){return this.delete(e)};this.getStateFul=function(t){return e.get(t)};this.destroyApp=function(e){u.postMessageToIframeApp("sap.ushell.services.appLifeCycle","destroy",{appId:e})};this.openApp=function(e){u.postMessageToIframeApp("sap.ushell.services.appLifeCycle","create",{appId:e,sHash:n.getHash()})};this.storeApp=function(e){u.postMessageToIframeApp("sap.ushell.services.appLifeCycle","store",{appId:e,sHash:n.getHash()})};this.restoreApp=function(e){u.postMessageToIframeApp("sap.ushell.services.appLifeCycle","restore",{appId:e,sHash:n.getHash()})};this.delete=function(t){e.remove(t)};this.get=function(t){return e.get(t)};this.getById=function(t){return e.getById(t)};this.set=function(t,i){e.add(t,i)}}return new r},true);