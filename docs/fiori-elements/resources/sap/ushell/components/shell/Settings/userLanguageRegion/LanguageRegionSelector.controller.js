// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/UriParameters","sap/ui/core/Configuration","sap/ui/core/Locale","sap/ui/core/LocaleData","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/performance/Measurement"],function(e,t,a,r,n,s,i,o){"use strict";return s.extend("sap.ushell.components.shell.Settings.userLanguageRegion.LanguageRegionSelector",{onInit:function(){this.oUserInfoServicePromise=sap.ushell.Container.getServiceAsync("UserInfo");return this.oUserInfoServicePromise.then(function(e){this.oUser=sap.ushell.Container.getUser();var t=a.getFormatSettings().getFormatLocale();var r=n.getInstance(t);var s,o,g,l;var u=sap.ushell.Container.getRenderer("fiori2").getShellConfig().enableSetLanguage||false;var m=this.oUser.isLanguagePersonalized();var c=e.getUserSettingListEditSupported();var L=[];if(c){var d=a.getFormatSettings();s=d.getLegacyDateFormat();g=d.getLegacyTimeFormat();l=this._getLegacyNumberFormat(d);L.push(this._loadUserSettingList())}else{s=r.getDatePattern("medium");o=r.getTimePattern("medium");g=o.indexOf("H")===-1?"12h":"24h"}var h=new i({languageList:null,DateFormatList:null,TimeFormatList:null,NumberFormatList:null,TimeZoneList:null,selectedLanguage:this.oUser.getLanguage(),selectedLanguageText:this.oUser.getLanguageText(),selectedDatePattern:s,selectedTimeFormat:g,selectedNumberFormat:l,selectedTimeZone:this.oUser.getTimeZone(),isSettingsLoaded:true,isLanguagePersonalized:m,isEnableSetLanguage:u,isEnableUserProfileSetting:c,isTimeZoneIanaAvailable:true});h.setSizeLimit(1e3);var f=sap.ushell.Container.getUser().getTimeZoneIana();if(f===undefined||f!==""&&typeof f==="string"){h.setProperty("/isTimeZoneIanaAvailable",false)}if(u){L.push(this._loadLanguagesList())}if(L.length>0){this.getView().setBusy(true);return Promise.all(L).then(function(e){var t=c?e[0]:null;var a=null;if(u){a=e.length===1?e[0]:e[1]}if(a&&a.length>1){h.setProperty("/languageList",a);var r=a.some(function(e){return e.key==="default"});if(!m&&r){h.setProperty("/selectedLanguage","default")}}if(t&&t.TIME_FORMAT&&t.TIME_FORMAT.length>0){h.setProperty("/TimeFormatList",t.TIME_FORMAT)}if(t&&t.DATE_FORMAT&&t.DATE_FORMAT.length>0){h.setProperty("/DateFormatList",t.DATE_FORMAT)}if(t&&t.TIME_ZONE&&t.TIME_ZONE.length>0){h.setProperty("/TimeZoneList",t.TIME_ZONE)}if(t&&t.NUMBER_FORMAT&&t.NUMBER_FORMAT.length>0){h.setProperty("/NumberFormatList",t.NUMBER_FORMAT)}this.oView.setModel(h);this.getView().setBusy(false)}.bind(this))}this.oView.setModel(h)}.bind(this))},_loadLanguagesList:function(){o.start("FLP:LanguageRegionSelector._getLanguagesList","_getLanguagesList","FLP");return this.oUserInfoServicePromise.then(function(t){return new Promise(function(a){o.start("FLP:LanguageRegionSelector._getLanguagesList","_getLanguagesList","FLP");t.getLanguageList().done(function(e){o.end("FLP:LanguageRegionSelector._getLanguagesList");a(e)}).fail(function(t){o.end("FLP:LanguageRegionSelector._getLanguagesList");e.error("Failed to load language list.",t,"sap.ushell.components.ushell.settings.userLanguageRegion.LanguageRegionSelector.controller");a(null)})})})},_loadUserSettingList:function(){o.start("FLP:LanguageRegionSelector._loadUserSettingList","_loadUserSettingList","FLP");return this.oUserInfoServicePromise.then(function(e){return new Promise(function(t){o.start("FLP:LanguageRegionSelector._loadUserSettingList","_loadUserSettingList","FLP");e.getUserSettingList().then(function(e){o.end("FLP:LanguageRegionSelector._loadUserSettingList");t(e)})})})},onCancel:function(){var e=this.getView().getModel(),t=e.getData(),a=t.languageList,r=t.isEnableSetLanguage;if(r&&a){var n=this.oUser.getLanguage();var s=t.isLanguagePersonalized?n:"default";e.setProperty("/selectedLanguage",s);this._updateTextFields(n)}if(t.isEnableUserProfileSetting){this._restoreUserSettingPreferenceValues()}},onSaveSuccess:function(t,a,r){var n={refresh:true};t.resetChangedProperty("dateFormat");t.resetChangedProperty("timeFormat");t.resetChangedProperty("numberFormat");t.resetChangedProperty("timeZone");if(a){e.debug("[000] onSaveSuccess: oUser.resetChangedPropertyLanguage:","LanguageRegionSelector.controller");t.resetChangedProperty("language");n.obsoleteUrlParams=["sap-language"]}return n},onSave:function(t){var r=this.oUser,n=this.getView().getModel().getData(),s=n.selectedLanguage,i=r.getLanguage(),o=s!==(n.isLanguagePersonalized?i:"default"),g=n.isEnableUserProfileSetting,l=n.isEnableSetLanguage&&n.languageList&&o,u=false,m=["DATE_FORMAT","TIME_FORMAT","NUMBER_FORMAT","TIME_ZONE","LANGUAGE"];e.debug("[000] LanguageRegionSelector:onSave:bUpdateLanguage, bIsEnableSetUserProfileSetting:",l,"LanguageRegionSelector.controller");if(l){e.debug("[000] LanguageRegionSelector:onSave:UserInfo: oUser.setLanguage:",s,"LanguageRegionSelector.controller");r.setLanguage(s)}if(g){var c=a.getFormatSettings();if(c.getLegacyDateFormat()!==n.selectedDatePattern){u=true;r.setChangedProperties({propertyName:"dateFormat",name:"DATE_FORMAT"},c.getLegacyDateFormat(),n.selectedDatePattern)}if(c.getLegacyTimeFormat()!==n.selectedTimeFormat){u=true;r.setChangedProperties({propertyName:"timeFormat",name:"TIME_FORMAT"},c.getLegacyTimeFormat(),n.selectedTimeFormat)}if(this._getLegacyNumberFormat(c)!==n.selectedNumberFormat){u=true;r.setChangedProperties({propertyName:"numberFormat",name:"NUMBER_FORMAT"},this._getLegacyNumberFormat(c),n.selectedNumberFormat)}if(this.oUser.getTimeZone()!==n.selectedTimeZone){u=true;r.setChangedProperties({propertyName:"timeZone",name:"TIME_ZONE"},this.oUser.getTimeZone(),n.selectedTimeZone)}}if(l||u){return t().then(function(){e.debug("[000] onSave:fnUpdateUserPreferences","LanguageRegionSelector.controller");return this.onSaveSuccess(r,l,s)}.bind(this)).catch(function(t){e.debug("[000] onSave:catch:errorMessage",t,"LanguageRegionSelector.controller");var a=m.some(function(e){return t.includes(e)});if(!a){return this.onSaveSuccess(r,l,s)}if(l){r.setLanguage(i);r.resetChangedProperty("language");this._updateTextFields(i)}r.resetChangedProperty("dateFormat");r.resetChangedProperty("timeFormat");r.resetChangedProperty("numberFormat");r.resetChangedProperty("timeZone");if(n.isEnableUserProfileSetting){this._restoreUserSettingPreferenceValues()}e.error("Failed to save Language and Region Settings",t,"sap.ushell.components.ushell.settings.userLanguageRegion.LanguageRegionSelector.controller");throw t}.bind(this))}return Promise.resolve()},_restoreUserSettingPreferenceValues:function(){var e=this.getView().getModel();var t=a.getFormatSettings();e.setProperty("/selectedDatePattern",t.getLegacyDateFormat());e.setProperty("/selectedTimeFormat",t.getLegacyTimeFormat());e.setProperty("/selectedNumberFormat",this._getLegacyNumberFormat(t));e.setProperty("/selectedTimeZone",this.oUser.getTimeZone())},_handleSelectChange:function(e){var t=e.getParameters().selectedItem.getKey();this._updateTextFields(t)},_updateTextFields:function(e){var t;if(e===this.oUser.getLanguage()){t=a.getFormatSettings().getFormatLocale()}else{t=new r(e)}var s=this.getView().getModel(),i=n.getInstance(t),o=i.getDatePattern("medium"),g=i.getTimePattern("medium"),l=g.indexOf("H")===-1?"12h":"24h";if(!s.getData().isEnableUserProfileSetting){s.setProperty("/selectedDatePattern",o);s.setProperty("/selectedTimeFormat",l)}},_getLegacyNumberFormat:function(e){var t=e.getLegacyNumberFormat();if(t){return t.trim()}}})});