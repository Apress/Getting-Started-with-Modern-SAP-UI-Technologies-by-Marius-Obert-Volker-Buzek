//Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/Core","./util/SearchResultManager","sap/ui/integration/Host","sap/m/library","sap/m/Menu","sap/m/MenuItem","./controls/FilterField","sap/ushell/ui/footerbar/AddBookmarkButton"],function(e,t,s,a,r,i,n,o,l){"use strict";var h=r.URLHelper;return e.extend("sap.ushell.components.cepsearchresult.app.Main",{onInit:function(){if(sap.ushell.Container){var e=sap.ushell.Container.getRenderer();e.getRouter().getRoute("wzsearch").attachMatched(this.onRouteMatched.bind(this))}this.initCard();this.initSearchResultManager();this.applyPersonalization();this._sSearchTerm=this.getOwnerComponent().getSearchTerm()},onRouteMatched:function(e){var t=this._sSearchTerm;var s=this._sCategory;var a=e.getParameter("arguments");var r=a["?query"];this._sCategory=r&&r.category;this._sSearchTerm=r&&r.searchTerm;if(t!==this._sSearchTerm&&s===this._sCategory){this.updateSearchResultManager(this._sSearchTerm)}else if(s!==this._sCategory){this.initSearchResultManager()}},getSearchTerm:function(){return this._sSearchTerm||this.getOwnerComponent().getSearchTerm()},applyPersonalization:function(){this.getPersonalization("showFilterPanel",false+"").then(function(e){this._showFilterPanel=e!=="true";this.toggleFilterPanel()}.bind(this))},getPersonalization:function(e,t){var s=localStorage.getItem("sap.ushell.components.cepsearchresult.app-"+e);return Promise.resolve(s!==undefined?s:t)},setPersonalization:function(e,t){localStorage.setItem("sap.ushell.components.cepsearchresult.app-"+e,t+"")},initCard:function(){var e=this.getView().byId("searchResultWidget");if(!this.oHost){this.oHost=new a({id:"searchAppHost",resolveDestination:function(e){return null}});e.setHost(this.oHost);this.oHost.attachAction(this.handleCardAction.bind(this))}},initSearchResultManager:function(){this.oSearchResultManager=new s(this.getOwnerComponent().getSearchConfig());var e=this.oSearchResultManager.getModel();this.oSearchResultManager._loaded.then(function(){if(e.getProperty("/categories/0/name")==="all"&&e.getProperty("/categories").length===2){this.setCategory(e.getProperty("/categories/1/name"));this.byId("searchCategoriesTabs").getItems()[0].setVisible(false);this.byId("searchCategoriesTabs").getItems()[1].setVisible(false)}else{this.setCategory(this.getOwnerComponent().getCategory())}this.addFilterFields();this.setSummaryText();this.getView().setVisible(true);this.byId("searchResultWidget").setManifest(sap.ui.require.toUrl("sap/ushell/components/cepsearchresult/app/cards/searchresultwidget/manifest.json"))}.bind(this));this.getView().setModel(e,"manager")},updateSearchResultManager:function(e){this._sSearchTerm=e;this.oSearchResultManager._loaded.then(function(){var t=this.getView().byId("searchResultWidget");if(t&&t.setSearchTerm){t.setParameter("searchTerm",e)}this.oSearchResultManager.getModel().setProperty("/totalCount",-1);this.oSearchResultManager.getModel().setProperty("/searchTerm",e)}.bind(this))},onExit:function(){if(this.oHost){this.oHost.destroy()}this.oSearchResultManager=null;this.oHost=null},tabSelectionChange:function(e){this.setCategory(e.getParameters().item.getKey())},setCategory:function(e){this.byId("searchCategoriesTabs").setSelectedKey(e);this.updateResultCard()},setSummaryText:function(){var e=this.byId("summaryText");var t=this.byId("filterPanel");var s=t.getItems();var a="";a="Sort By: Relevance";a+=" / ";var r=[];for(var i=1;i<s.length;i++){var n=s[i].getItems()[1];if(n.getValue&&n.getValue()){r.push(s[i].getItems()[0].getText())}else if(n.getSelectedKeys&&n.getSelectedKeys().length>0){r.push(s[i].getItems()[0].getText())}}if(r.length===0){a+="No filters active"}else if(r.length===1){a+="1 filter active"}else{a+=r.length+" filters active";e.setTooltip("Active filters - "+r.join(",\n"))}e.setText(a)},addFilterFields:function(){this.oSearchResultManager._loaded.then(function(){var e=this.oSearchResultManager.getFilters(),t=this.byId("filterPanel"),s=t.getItems()[0];t.removeAllItems();t.addItem(s);if(e){e.forEach(function(e){this.addFilterField(e)}.bind(this))}}.bind(this))},addFilterField:function(e){var t=this.byId("filterPanel");var s=o.create(e,function(){this.setSummaryText()}.bind(this));t.addItem(s)},updateResultCard:function(){var e=this.byId("searchResultWidget");var t=e.getParent();t.removeItem(e);e.setParameters({categories:this.byId("searchCategoriesTabs").getSelectedKey(),searchTerm:this.getSearchTerm(),edition:this.getOwnerComponent().getSearchConfig()});t.addItem(e);this.oSearchResultManager.getModel().setProperty("/searchTerm",this.getSearchTerm())},onAfterRendering:function(){this.adaptScrollArea()},adaptScrollArea:function(){if(this.getView().getDomRef()){var e=this.getView().getDomRef().querySelector(".sapUiCEPSRAppScroll");e.style.height="calc( 100% - "+e.offsetTop+"px )"}},handleCardAction:function(e){if(e.mParameters){if(e.mParameters.type==="Navigation"&&e.mParameters.parameters.category){this.setCategory(e.mParameters.parameters.category)}else if(e.mParameters.type==="Custom"&&e.mParameters.parameters.categoryStateChange){var t=e.mParameters.parameters.categoryStateChange;this.updateCounts(t.name,t.count)}}return true},updateCounts:function(e,t){var s=this.getView().getModel("manager");var a=s.getProperty("/categoriesMap");var r=-1;s.setProperty("/categoriesMap/"+e+"/_state",{count:t,loading:t===-1});for(var i in a){var n=s.getProperty("/categoriesMap/"+i+"/_state/count");if(n>-1){r=r>-1?r+n:n}}s.setProperty("/totalCount",r)},translateTitle:function(e,t,s){var a=s||"";var r=t>-1?"("+t+")":"(...)";return e.replace("{0}",a).replace("{1}",r)},toggleFilterPanel:function(){this._showFilterPanel=!this._showFilterPanel;if(this._showFilterPanel){this.byId("filterPanel").removeStyleClass("sapUiCEPSRFiltersHide");this.byId("filterPanelToggle").setPressed(true);this.byId("summaryText").setVisible(false)}else{this.byId("filterPanel").addStyleClass("sapUiCEPSRFiltersHide");this.byId("filterPanelToggle").setPressed(false);this.byId("summaryText").setVisible(true)}this.setPersonalization("showFilterPanel",this._showFilterPanel+"");t.applyChanges();this.adaptScrollArea()},openTitleMenu:function(e){if(!this._oTitleMenu){var t=this.getView().getModel("appI18n");this._oTitleMenu=new i({items:[new n({text:"{appI18n>SEARCHRESULTAPP.TitleMenu.SaveAsTile}",icon:"sap-icon://header",press:this.triggerBookmark.bind(this)}),new n({text:"{appI18n>SEARCHRESULTAPP.TitleMenu.Email}",icon:"sap-icon://email",press:this.triggerEmail.bind(this)})]});this._oTitleMenu.setModel(t,"appI18n")}this._oTitleMenu.openBy(e.getSource())},triggerBookmark:function(){var e=this.getView().getModel("appI18n").getResourceBundle();var t=new l({title:e.getText("SEARCHRESULTAPP.Bookmark.Title",[this._sSearchTerm]),subtitle:"",tileIcon:"sap-icon://search",keywords:"search,result,"+this._sSearchTerm,showGroupSelection:false,customUrl:document.location.hash});t.firePress()},triggerEmail:function(){var e=this.getView().getModel("appI18n").getResourceBundle();h.triggerEmail("",e.getText("SEARCHRESULTAPP.EMail.Subject",[this._sSearchTerm]),document.location.href)}})});