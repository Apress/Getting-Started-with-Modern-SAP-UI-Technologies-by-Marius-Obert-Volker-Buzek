// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend","sap/ui/base/Object","sap/ui/core/Configuration","sap/ui/Device","sap/ui/thirdparty/jquery","sap/ushell/Layout"],function(e,t,i,o,n,s,a){"use strict";var l=i.extend("sap.ushell.components.homepage.DashboardUIActions",{metadata:{publicMethods:["initializeUIActions"]},constructor:function(){this.aTabBarItemsLocation=[];if(l.fnDashboardUIActionsGetter&&l.fnDashboardUIActionsGetter()){return l.fnDashboardUIActionsGetter()}l.fnDashboardUIActionsGetter=function(e){return function(){return e}}(this.getInterface());this.oTileUIActions=undefined;this.oLinkUIActions=undefined;this.oGroupUIActions=undefined;this.oController=undefined;this.UIActionsInitialized=false;sap.ui.getCore().getEventBus().subscribe("launchpad","actionModeActive",this._enableGroupUIActions,this);sap.ui.getCore().getEventBus().subscribe("launchpad","actionModeInactive",this._disableGroupUIActions,this)},destroy:function(){sap.ui.getCore().getEventBus().unsubscribe("launchpad","actionModeActive",this._enableGroupUIActions,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","actionModeInactive",this._disableGroupUIActions,this);l.fnDashboardUIActionsGetter=undefined;this.oGroupUIActions=null;this.oTileUIActions=null;this.oLinkUIActions=null},initializeUIActions:function(e){this.oController=e;if(e.getView().getModel().getProperty("/homePageGroupDisplay")==="tabs"){this._fillTabBarItemsArray()}var i=s("#sapUshellDashboardPage").width();var n=e.getView().sDashboardGroupsWrapperId,a,l=o.getRTL(),r={containerSelector:"#dashboardGroups",wrapperSelector:n?"#"+n:undefined,rootSelector:"#shell"},d=t({},r,{switchModeDelay:1e3,isTouch:e.getView().isTouch,isCombi:e.getView().isCombi,debug:false}),h={draggableSelector:".sapUshellLinkTile",placeHolderClass:"sapUshellLinkTile-placeholder",cloneClass:"sapUshellLinkTile-clone",endCallback:this._handleLinkDrop.bind(this),dragCallback:this._handleStartDragTile.bind(this),onBeforeCreateClone:this._onBeforeCreateLinkClone.bind(this),dragAndScrollCallback:this._handleTileDragMove.bind(this),endDragAndScrollCallback:this._handleTileDragAndScrollContinuation.bind(this),moveTolerance:e.getView().isTouch||e.getView().isCombi?10:3,isLayoutEngine:true,disabledDraggableSelector:"sapUshellLockedTile",onDragStartUIHandler:this._markDisableGroups.bind(this),onDragEndUIHandler:this._endUIHandler.bind(this),offsetLeft:l?i:-i,defaultMouseMoveHandler:function(){}},c={draggableSelector:".sapUshellTile",draggableSelectorExclude:".sapUshellPlusTile",placeHolderClass:"sapUshellTile-placeholder",cloneClass:"sapUshellTile-clone",deltaTop:-44,scrollContainerSelector:undefined,endCallback:this._handleTileDrop.bind(this),dragCallback:this._handleStartDragTile.bind(this),dragAndScrollCallback:this._handleTileDragMove.bind(this),endDragAndScrollCallback:this._handleTileDragAndScrollContinuation.bind(this),moveTolerance:e.getView().isTouch||e.getView().isCombi?10:3,isLayoutEngine:true,disabledDraggableSelector:"sapUshellLockedTile",onDragStartUIHandler:this._markDisableGroups.bind(this),onDragEndUIHandler:this._endUIHandler.bind(this),offsetLeft:l?i:-i,defaultMouseMoveHandler:function(){}},u={draggableSelector:".sapUshellDashboardGroupsContainerItem:not(.sapUshellDisableDragAndDrop)",draggableSelectorBlocker:".sapUshellTilesContainer-sortable, .sapUshellTileContainerBeforeContent, .sapUshellTileContainerAfterContent",draggableSelectorExclude:".sapUshellHeaderActionButton",placeHolderClass:"sapUshellDashboardGroupsContainerItem-placeholder",cloneClass:"sapUshellDashboardGroupsContainerItem-clone",startCallback:this._handleGroupsUIStart.bind(this),endCallback:this._handleGroupDrop.bind(this),dragCallback:this._handleGroupStartDrag.bind(this),moveTolerance:e.getView().isTouch||e.getView().isCombi?10:.1,isLayoutEngine:false,isVerticalDragOnly:true,draggableElement:".sapUshellTileContainerHeader"};if(e.getView().oDashboardGroupsBox.getGroups().length){if(e.getView().getModel().getProperty("/personalization")){sap.ui.require(["sap/ushell/UIActions"],function(i){sap.ushell.Container.getServiceAsync("LaunchPage").then(function(o){this._disableTileUIActions();this._disableGroupUIActions();this._disableLinkUIActions();this.oTileUIActions=new i(t({},d,c)).enable();this.oGroupUIActions=new i(t({},d,u));if(o.isLinkPersonalizationSupported()){this.oLinkUIActions=new i(t({},d,h)).enable()}a=e.getView().getModel().getProperty("/tileActionModeActive");if(a){this.oGroupUIActions.enable()}}.bind(this))}.bind(this))}}},_enableGroupUIActions:function(){if(this.oGroupUIActions){this.oGroupUIActions.enable()}},disableAllDashboardUiAction:function(){this._disableTileUIActions();this._disableLinkUIActions();this._disableGroupUIActions()},_disableTileUIActions:function(){if(this.oTileUIActions){this.oTileUIActions.disable()}},_disableLinkUIActions:function(){if(this.oLinkUIActions){this.oLinkUIActions.disable()}},_disableGroupUIActions:function(){if(this.oGroupUIActions){this.oGroupUIActions.disable()}},_handleTileDragMove:function(e){if(!e.isScrolling){a.getLayoutEngine().moveDraggable(e.moveX,e.moveY,this.aTabBarItemsLocation)}},_handleTileDragAndScrollContinuation:function(e){var t=s("#anchorNavigationBar").offset(),i=t?t.top:0;if(e<i){a.getLayoutEngine()._cancelLongDropTimmer()}return a.getLayoutEngine()._isTabBarCollision(e)},_fillTabBarItemsArray:function(){var e=document.getElementsByClassName("sapUshellAnchorItem");var t;var i=10;var o=0;var n;var s=[];for(t=0;t<e.length;t++){var a=e[t];var l=a.getBoundingClientRect();s[t]=l.width}for(t=0;t<e.length;t++){var r=s[t];if(r===0){continue}var d=Math.round(r/i);for(n=o;n<o+d;n++){this.aTabBarItemsLocation[n]=t}o=n}},_preventTextSelection:function(){if(window.getSelection){var e=window.getSelection();try{e.removeAllRanges()}catch(e){}}},_handleStartDragTile:function(e,t){this._preventTextSelection();a.getLayoutEngine().layoutStartCallback(t);a.initDragMode();var i=t.querySelectorAll("a");for(var o=0;o<i.length;o++){i[o].removeAttribute("href")}this.oController._handleDrag.call(this.oController,e,t);sap.ui.getCore().getEventBus().publish("launchpad","sortableStart")},_onBeforeCreateLinkClone:function(e,t){a.getLayoutEngine().saveLinkBoundingRects(t)},_handleLinkDrop:function(e,t,i){var o=s.Deferred(),l;if(a.isTabBarActive()){a.tabBarTileDropped()}if(i&&i.clone){s(i.clone).css({opacity:0})}if(n.desktop){document.body.classList.remove("sapUshellDisableUserSelect")}if(a.getLayoutEngine().isLinkIntersected()||a.getLayoutEngine().isOriginalAreaChanged()){l=this.oController._handleDrop.call(this.oController,e,t)}if(l){l.then(function(){var e=document.getElementById("dashboardGroups");var t=e&&e.getElementsByClassName("sapUshellHidePlusTile");for(var i=0;i<t.length;i++){t[i].classList.remove("sapUshellHidePlusTile")}setTimeout(function(){o.resolve()},0)})}else{setTimeout(function(){o.resolve()},0)}return o.promise()},_handleTileDrop:function(e,t,i){if(a.getLayoutEngine().isOriginalAreaChanged()){return this._handleTileToLinkDrop(e,t,i)}return this._handleTileToTileDrop(e,t,i)},_handleTileToLinkDrop:function(e,t,i){return this._handleLinkDrop(e,t,i)},_handleTileToTileDrop:function(e,t,i){var o;var l;var r;var d=function(e,t){a.endDragMode();var i=document.getElementById("dashboardGroups");var o=i&&i.getElementsByClassName("sapUshellHidePlusTile");for(var s=0;s<o.length;s++){o[s].classList.remove("sapUshellHidePlusTile")}this.oController._handleDrop(this.oController,e,t);if(n.desktop){document.body.classList.remove("sapUshellDisableUserSelect")}};l=s(".sapUshellTabBarHoverOn");l.removeClass("sapUshellTabBarHoverOn");r=s(".sapUshellTileDragOpacity");r.removeClass("sapUshellTileDragOpacity");if(a.isTabBarActive()){a.tabBarTileDropped()}var h;if(a.isTabBarActive()&&a.isOnTabBarElement()){if(i&&i.clone){h=s.Deferred();o=s(i.clone);o.css("display","none");setTimeout(function(){h.resolve();d.call(this,e,t)}.bind(this),0);return h.promise()}d.apply(this,arguments)}if(i&&i.clone){h=s.Deferred();o=s(i.clone);setTimeout(function(){h.resolve();d.call(this,e,t)}.bind(this),0);return h.promise()}setTimeout(function(){d.call(this,e,t)}.bind(this),0)},_getTileTopOffset:function(e,t,i){var o=0,n=o+i;n+=e.closest(".sapUshellDashboardGroupsContainerItem").position().top;n+=t.top;return n},_markDisableGroups:function(){if(this.oController.getView().getModel()){this.oController.getView().getModel().setProperty("/isInDrag",true)}},_endUIHandler:function(){a.endDragMode();if(this.oController.getView().getModel()){this.oController.getView().getModel().setProperty("/isInDrag",false)}},_handleGroupStartDrag:function(t,i){this.oTileUIActions.disable();if(this.oLinkUIActions){this.oLinkUIActions.disable()}var a=s(".sapUshellDashboardGroupsContainerItem-clone"),l=a.find(".sapUshellContainerTitle"),r=l.height(),d=l.width(),h,c,u,p,g=o.getRTL();if(!n.system.phone){a.find(".sapUshellTileContainerEditMode").offset({top:this.oGroupUIActions.getMove().y-r,left:g?s("#sapUshellDashboardPage").width()+this.oGroupUIActions.getMove().x+d:this.oGroupUIActions.getMove().x-d/2});s(".sapUshellTileContainerBeforeContent").addClass("sapUshellTileContainerHidden")}else{s(".sapUshellTilesContainer-sortable").addClass("sapUshellTileContainerRemoveContent");s(".sapUshellLineModeContainer").addClass("sapUshellTileContainerRemoveContent");s(".sapUshellTileContainerBeforeContent").addClass("sapUshellTileContainerRemoveContent");s(".sapUshellContainerHeaderActions").addClass("sapUshellTileContainerHidden")}s(".sapUshellTileContainerAfterContent").addClass("sapUshellTileContainerRemoveContent");s(i).find(".sapUshellContainerHeaderActions").addClass("sapUshellTileContainerHidden");this.oController.getView().getModel().setProperty("/isInDrag",true);s(i).attr("startPos",s(i).index());e.info("startPos - "+s(i).index());setTimeout(function(){sap.ui.getCore().getEventBus().publish("launchpad","sortableStart")},0);h=s("#dashboardGroups").offset().top;c=s(".sapUshellDashboardGroupsContainerItem-placeholder").offset().top;u=s(".sapUshellDashboardGroupsContainerItem-clone").offset().top;p=c-h-u;s(".sapUshellDashboardView section").css({scrollTop:p})},_handleGroupsUIStart:function(e,t){s(t).find(".sapUshellTileContainerContent").css("outline-color","transparent")},_handleGroupDrop:function(e,t){var i=sap.ui.getCore().getEventBus(),o=s(t),n=s(o.children()[0]).attr("id"),a=sap.ui.getCore().byId(n),l=sap.ui.getCore().byId("dashboardGroups"),r={group:a,groupChanged:false,focus:false},d=o.index();o.startPos=window.parseInt(o.attr("startPos"),10);l.removeAggregation("groups",a,true);l.insertAggregation("groups",a,d,true);this._handleGroupMoved(e,{item:o});o.removeAttr("startPos");sap.ui.getCore().getEventBus().publish("launchpad","sortableStop");setTimeout(function(){s(".sapUshellContainerHeaderActions").removeClass("sapUshellTileContainerHidden");s(".sapUshellTileContainerBeforeContent").removeClass("sapUshellTileContainerHidden");s(".sapUshellTileContainerBeforeContent").removeClass("sapUshellTileContainerRemoveContent");s(".sapUshellTileContainerAfterContent").removeClass("sapUshellTileContainerRemoveContent");s(".sapUshellTilesContainer-sortable").removeClass("sapUshellTileContainerRemoveContent");s(".sapUshellLineModeContainer").removeClass("sapUshellTileContainerRemoveContent")},0);window.setTimeout(s.proxy(i.publish,i,"launchpad","scrollToGroup",r),1);this.oTileUIActions.enable();if(this.oLinkUIActions){this.oLinkUIActions.enable()}},_handleGroupMoved:function(e,t){var i=t.item.startPos,o=t.item.index(),n=this.oController.getView().getModel();if(o!==-1){this.oController._publishAsync("launchpad","moveGroup",{fromIndex:i,toIndex:o});setTimeout(function(){n.setProperty("/isInDrag",false)},100)}},_setController:function(e){this.oController=e}});return l});