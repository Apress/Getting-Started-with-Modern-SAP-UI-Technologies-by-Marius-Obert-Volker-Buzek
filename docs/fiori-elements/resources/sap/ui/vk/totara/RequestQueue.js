/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./TotaraUtils","./Command"],function(t,e){"use strict";function i(t){this.getBatchSize=t;this.globalList=new Set;this.waitingList=new Map;this.requestedList=new Set}i.prototype.push=function(t,e){if(!this.globalList.has(t)){this.globalList.add(t);this.waitingList.set(t,e);this.requestedList.add(t)}};i.prototype.setBatchSizeInfo=function(t){this.batchSizeInfo=t};i.prototype.fetchBatch=function(){var t=this.getBatchSize?this.getBatchSize:1;if(typeof this.getBatchSize==="function"){t=this.getBatchSize()}var e=0;var i=[];var s=this.requestedList.keys();var a=s.next();for(var n=0;n<t&&!a.done;n++,a=s.next()){var h=a.value;e+=h.toString().length+(n==0||!this.batchSizeInfo?0:this.batchSizeInfo.separatorLength);if(this.batchSizeInfo&&e>this.batchSizeInfo.maxBatchStringLength){break}else{this.requestedList.delete(h)}i.push(h)}return i};i.prototype.pop=function(t){this.requestedList.delete(t);return this.waitingList.delete(t)};i.prototype.isReady=function(t){return this.globalList.has(t)&&!this.waitingList.has(t)};i.prototype.clear=function(t){this.globalList.clear();this.waitingList.clear();this.requestedList.clear()};i.prototype.isEmpty=function(){return this.requestedList.size===0};i.prototype.isWaiting=function(){return this.waitingList.size>0};i.prototype.isInitialViewCompleted=function(){var t=this.waitingList;for(var e=t.values(),i=e.next();!i.done;i=e.next()){var s=i.value;if(s&&s.isInitial){return false}}return true};function s(t,e){i.call(this,t);this.getMaxBatchDataSize=e;this.priorityMap=new Map}s.prototype=Object.create(i.prototype);s.prototype.constructor=s;s.prototype.push=function(t,e,i,s){if(!this.globalList.has(t)){i=i||1;this.globalList.add(t);this.waitingList.set(t,s);this.requestedList.add(t);this.priorityMap.set(t,{p:e,s:i})}};s.prototype.clear=function(){i.prototype.clear.call(this);this.priorityMap.clear()};s.prototype.setBatchSizeInfo=function(t){this.batchSizeInfo=t};s.prototype.fetchBatch=function(){var t=this.priorityMap;var e=this.requestedList;var i=Array.from(e.keys()).sort(function(e,i){return t.get(e).p-t.get(i).p});var s=[];var a=0;var n=this.getBatchSize?this.getBatchSize():1;var h=0;var r=this.getMaxBatchDataSize?this.getMaxBatchDataSize():1024*1024;var o=r>>1;for(var c=0;c<n&&i.length>0;c++){var m=i.pop();h+=m.toString().length+(c==0||!this.batchSizeInfo?0:this.batchSizeInfo.separatorLength);var p=t.get(m).s;if(this.batchSizeInfo&&h>this.batchSizeInfo.maxBatchStringLength||a>o&&a+p>r){break}a+=p;e.delete(m);t.delete(m);s.push(m)}return s};var a=function(e,a){this.context=e;this.sceneId=a;this.token=e.token||t.generateToken();var n=e.loader;this.meshes=new i(n.getMeshesBatchSize.bind(n));this.materials=new i(n.getMaterialsBatchSize.bind(n));this.textures=new i;this.geometries=new s(n.getGeometriesBatchSize.bind(n),n.getGeometriesMaxBatchDataSize.bind(n));this.geomMeshes=new s(n.getGeomMeshesBatchSize.bind(n),n.getGeomMeshesMaxBatchDataSize.bind(n));this.annotations=new i(n.getAnnotationsBatchSize.bind(n));this.parametric=new i(n.getParametricsBatchSize.bind(n));this.views=new i;this.thumbnails=new i;this.tracks=new i(n.getTracksBatchSize.bind(n));this.sequences=new i(n.getSequencesBatchSize.bind(n));this.highlights=new i};a.prototype.isEmpty=function(){return this.meshes.isEmpty()&&this.annotations.isEmpty()&&this.parametric.isEmpty()&&this.materials.isEmpty()&&this.textures.isEmpty()&&this.geometries.isEmpty()&&this.geomMeshes.isEmpty()&&this.views.isEmpty()&&this.thumbnails.isEmpty()&&this.tracks.isEmpty()&&this.sequences.isEmpty()&&this.highlights.isEmpty()};a.prototype.isWaitingForContent=function(){return this.meshes.isWaiting()||this.textures.isWaiting()||this.materials.isWaiting()||this.geometries.isWaiting()||this.geomMeshes.isWaiting()||this.annotations.isWaiting()||this.parametric.isWaiting()||this.views.isWaiting()||this.thumbnails.isWaiting()||this.tracks.isWaiting()||this.sequences.isWaiting()||this.highlights.isWaiting()};a.prototype.clearContent=function(){this.meshes.clear();this.annotations.clear();this.parametric.clear();this.materials.clear();this.textures.clear();this.geometries.clear();this.geomMeshes.clear();this.views.clear();this.thumbnails.clear();this.tracks.clear();this.sequences.clear();this.highlights.clear()};a.prototype.createGetContentCommand=function(e,i,s){var a={sceneId:this.sceneId,ids:i.map(function(t){return parseInt(t,10)}),token:this.token};return t.createRequestCommand(e,s?Object.assign(a,s):a)};function n(t){var e=t.keys().next();if(e.done){return null}var i=e.value;t.delete(i);return i}a.prototype.generateRequestCommand=function(){var i;var s;var a;var h=null;if(!this.meshes.isEmpty()){s=this.meshes.fetchBatch();var r=s.map(function(t){return t.id?t.id:t});h=this.createGetContentCommand(e.getMesh,r);h.sceneId=this.sceneId;h.meshIds=r}else if(!this.geomMeshes.isEmpty()){s=this.geomMeshes.fetchBatch();h=this.createGetContentCommand(e.getGeomMesh,s);h.sceneId=this.sceneId;h.meshIds=s}else if(!this.annotations.isEmpty()){s=this.annotations.fetchBatch();h={method:e.getAnnotation,parameters:{sceneId:this.sceneId,annotationIds:s}}}else if(!this.parametric.isEmpty()){s=this.parametric.fetchBatch();throw new Error("Command "+e.getParametric+" is not implemented")}else if(!this.materials.isEmpty()){s=this.materials.fetchBatch();h={method:e.getMaterial,parameters:{sceneId:this.sceneId,materialIds:s}}}else if(!this.textures.isEmpty()){i=n(this.textures.requestedList);a=this.textures.waitingList.get(i);h=this.createGetContentCommand(e.getImage,[i]);h.sceneId=this.sceneId;h=Object.assign(h,a)}else if(!this.sequences.isEmpty()){s=this.sequences.fetchBatch();throw new Error("Command "+e.getSequence+" is not implemented")}else if(!this.tracks.isEmpty()){s=this.tracks.fetchBatch();throw new Error("Command "+e.getTrack+" is not implemented")}else if(!this.views.isEmpty()){i=n(this.views.requestedList);h={method:e.getView,parameters:{sceneId:this.sceneId,viewId:i,query:t.configureSceneViewQuery(this.context)}}}else if(!this.highlights.isEmpty()){i=n(this.highlights.requestedList);throw new Error("Command "+e.getHighlightStyle+" is not implemented")}else if(!this.thumbnails.isEmpty()){i=n(this.thumbnails.requestedList);a=this.thumbnails.waitingList.get(i);h=this.createGetContentCommand(e.getImage,[i]);h.sceneId=this.sceneId;h=Object.assign(h,a)}return h};return a});