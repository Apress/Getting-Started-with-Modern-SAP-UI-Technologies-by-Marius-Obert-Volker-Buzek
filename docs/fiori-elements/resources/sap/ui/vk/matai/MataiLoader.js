/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","sap/ui/core/Core","sap/ui/base/ManagedObject","../getResourceBundle","../helpers/WorkerScriptLoader","../DownloadManager"],function(e,r,t,a,n,s){"use strict";var o={FinishedTree:a().getText("SCENE_CONTEXT_FINISHED_TREE"),LoadingGeometries:a().getText("SCENE_CONTEXT_LOADING_GEOMETRIES"),LoadingTextures:a().getText("SCENE_CONTEXT_LOADING_TEXTURES"),LoadingModelViews:a().getText("SCENE_CONTEXT_LOADING_MODEL_VIEWS")};var i=t.extend("sap.ui.vk.matai.MataiLoader",{metadata:{library:"sap.ui.vk",events:{contentChangesProgress:{parameters:{source:"any",phase:"string",percent:"float"}},contentLoadingFinished:{parameters:{source:"any",node:"any"}}}}});var u=i.getMetadata().getName();function c(e,r,t){var a=e._progress;a.phase=r;a.count=t;var n=40+60*(a.totalCount?a.count/a.totalCount:1);e._loader.fireContentChangesProgress({source:e._contentResource&&e._contentResource.getSource(),phase:r,percentage:Math.min(n,100)})}var d=1;var g=new Map;var l=function(){var r;return function(){return r||(r=new Promise(function(r,t){var s=n.loadScript("sap/ui/vk/matai/MataiLoaderWorker.js",["sap/ui/vk/ve/matai.js"]);var i=0;var d=-1;var l=-2;var E=-3;var f=-4;var v=-5;var R=-6;var _=-7;var p=-8;function L(e){var r=a();switch(e){case d:return r.getText("LOADER_FILENOTFOUND");case l:return r.getText("LOADER_WRONGFILEFORMAT");case E:return r.getText("LOADER_WRONGPASSWORD");case f:return r.getText("LOADER_ERRORREADINGFILE");case v:return r.getText("LOADER_FILECONTENT");case R:return r.getText("LOADER_NODEFAULTVIEW");case _:return r.getText("LOADER_FILECONTENT");case p:return r.getText("LOADER_ERRORREADINGREFERENCEDFILE");default:return r.getText("LOADER_UNKNOWNERROR")}}function T(r,t,a){var n=L(t);r._reject({status:t,errorText:n});e.error(n,a,u);O(r,t)}function O(r,t){e.info("Matai loading finished");r.loadingFinished({result:t});r._loader.fireContentLoadingFinished({source:r._contentResource,node:r._rootNode});r._loader=null;var a=r._id;s.postMessage({method:"destroyContext",args:{sceneBuilderId:a}});g.delete(a)}s.onmessage=function(t){var n=t.data;if(n.event==="runtimeCreated"){r(this);return}var d=n.sceneBuilderId;var l=g.get(d);var E=l.sceneBuilder;if("event"in n){switch(n.event){case"contextCreated":if(n.result===i){s.postMessage({method:"loadFile",args:{sceneBuilderId:d}})}else{T(E,n.result)}break;case"fileLoaded":if(n.result===i){if(l.waitingCount===0){s.postMessage({method:"buildScene",args:{sceneBuilderId:d}})}}else{T(E,n.result)}break;case"referencedFileLoaded":l.waitingCount-=1;if(n.result!==i){e.error(L(n.result),n.fileName,u)}if(l.waitingCount===0){s.postMessage({method:"buildScene",args:{sceneBuilderId:d}})}break;case"referencedFileRequested":var f=l.dependencyLoader;if(f==null){e.error(a().getText("LOADER_NODEPENDENCYLOADER"),null,u)}else{var v=n.fileName;var R=n.veId;var _=n.veVersion;var p=l.files;var m=p.get(v);if(m==null){m=f.load(v);p.set(v,m)}l.waitingCount+=1;m.then(function(e){var r=e.buffer;e.buffer=null;s.postMessage({method:"loadReferencedFile",args:{sceneBuilderId:d,buffer:r,fileName:v,veId:R,veVersion:_}},r==null?[]:[r])},function(){l.waitingCount-=1;e.error(a().getText("LOADER_ERRORREADINGREFERENCEDFILE"),v,u);if(l.waitingCount===0){s.postMessage({method:"buildScene",args:{sceneBuilderId:d}})}})}break;case"sceneBuilt":O(E,n.result);break;default:break}}else{try{E[n.method].apply(E,n.args)}catch(r){e.error("SceneBuilder."+n.method+"()",r)}switch(n.method){case"setScene":var N=n.args[0];E._progress.totalCount=N.meshCount+N.imageCount+N.modelViewCount;c(E,o.FinishedTree,0);break;case"setGeometry":c(E,o.LoadingGeometries,E._progress.count+1);break;case"createImage":c(E,o.LoadingTextures,E._progress.count+1);break;case"createThumbnail":c(E,o.LoadingModelViews,E._progress.count+1);break;default:break}}};s.onerror=function(e){t(e)};var m=n.absoluteUri("sap/ui/vk/ve/").toString();s.postMessage({method:"createRuntime",args:{scriptDirectory:m}})}))}}();function E(t,n,s,o,i,u,c){var E=i.getDependencyLoader();sap.ui.require([o.isObject3D?"sap/ui/vk/threejs/SceneBuilder":"sap/ui/vk/svg/SceneBuilder"],function(f){l().then(function(l){l.onerror=function(r){e.error("Error in WebWorker",r);c(a().getText("LOADER_ERRORREADINGFILE"))};var v=new f(o,i,u,c);v._loader=t;v._progress={};v._id=d++;g.set(v._id,{sceneBuilder:v,dependencyLoader:E,files:new Map,waitingCount:0});l.postMessage({method:"createContext",args:{sceneBuilderId:v._id,buffer:n,fileName:s,locale:r.getConfiguration().getLanguageTag()}},[n])},function(e){c(e)})})}i.prototype.load=function(e,r,t,n){var o=this;return new Promise(function(i,u){if(typeof r.getSource()==="string"){var c=r.getSource();new s([c],undefined,t,n).attachItemSucceeded(function(t){var a=t.getParameter("source");var n=t.getParameter("response");E(o,n,a,e,r,i,u)},this).attachItemFailed(function(e){var r=e.getParameter("statusText");if(r===""){r=a().getText("VIEWER_SOURCE_FAILED_TO_DOWNLOAD_CAUSE")}u(r)},this).start()}else if(r.getSource()instanceof File){var d=new FileReader;d.onload=function(t){E(o,t.target.result,r.getSource().name,e,r,i,u)};d.onerror=function(e){u(e)};d.readAsArrayBuffer(r.getSource())}})};return i});