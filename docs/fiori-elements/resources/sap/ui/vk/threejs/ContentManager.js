/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.script","sap/base/Log","../thirdparty/three","../ContentManager","./Scene","../TransformationMatrix","./PerspectiveCamera","./OrthographicCamera","../Messages","../getResourceBundle","./ContentDeliveryService","./ThreeUtils","./Viewport","./ViewStateManager"],function(e,r,t,a,o,n,i,s,d,l,u,c){"use strict";var f=function(e){Object.defineProperties(this,{source:{value:e.getSource()},sourceType:{value:e.getSourceType()},sourceId:{value:null,writable:true},name:{value:null,writable:true},localMatrix:{value:null,writable:true},children:{value:[]},nodeProxy:{value:null,writable:true},loader:{value:null,writable:true},builder:{value:null,writable:true}});e._shadowContentResource=this};var h=a.extend("sap.ui.vk.threejs.ContentManager",{metadata:{library:"sap.ui.vk"}});var g=h.getMetadata().getParent().getClass().prototype;h.prototype.init=function(){if(g.init){g.init.call(this)}this._shadowContentResources=[]};h.prototype.exit=function(){if(this.defaultCdsLoader){this.defaultCdsLoader.destroy();this.defaultCdsLoader=null}if(this.defaultMataiLoader){this.defaultMataiLoader.destroy();this.defaultMataiLoader=null}if(g.exit){g.exit.call(this)}this._shadowContentResources=null};h.prototype._handleContentChangesProgress=function(e){this.fireContentChangesProgress({phase:e.getParameter("phase"),source:e.getParameter("source"),percentage:e.getParameter("percentage")})};h.prototype._handleContentLoadingFinished=function(e){this.fireContentLoadingFinished({source:e.getParameter("source"),node:e.getParameter("node")})};function p(e){if(e&&e.isMesh){e.castShadow=true;e.receiveShadow=false}if(e&&e.children){for(var r=0;r<e.children.length;r++){p(e.children[r])}}}function v(e,r){if(e){var a=new t.Group;e.add(a);a.name="DefaultLights";a.private=true;var o=(new t.Box3).setFromObject(e);var n=o.getSize(new t.Vector3);var i=o.getCenter(new t.Vector3);var s=n.length();var d=new t.PointLight;d.color.setRGB(.72,.72,.81);d.visible=true;d.private=true;a.add(d);var l=[new t.Color(.2,.2,.2),new t.Color(.32,.32,.36),new t.Color(.36,.36,.36)];var u=[new t.Vector3(2,-.5,-1.5),new t.Vector3(-2,-2.5,1.1),new t.Vector3(-.04,2,.01)];for(var c=0,f=l.length;c<f;c++){var h=new t.DirectionalLight;h.color.copy(l[c]);h.position.copy(u[c]);h.private=true;h.updateWorldMatrix(false,false);a.add(h)}if(r){p(e);var g=new t.DirectionalLight;g.color.setRGB(.5,.5,.5);g.position.set(0,1,0);g.castShadow=true;g.shadow.mapSize.width=512;g.shadow.mapSize.height=512;var v=2e3;g.shadow.camera.left=-v;g.shadow.camera.right=v;g.shadow.camera.top=v;g.shadow.camera.bottom=-v;g.shadow.camera.far=3500;g.shadow.bias=-1e-4;g.private=true;a.add(g);var C=new t.PlaneGeometry(n.x,n.z);var y=new t.ShadowMaterial;y.opacity=.2;var m=new t.Mesh(C,y);m.rotation.x=-Math.PI/2;m.position.x=i.x;m.position.y=o.min.y-s*.1;m.position.z=i.z;e.add(m);m.receiveShadow=true}}}h.prototype.loadContent=function(e,a){this.fireContentChangesStarted();var n=e||new o(new t.Scene);var i=this;this._loadContentResources(n,a).then(function(t){r.info("Content loading resolved");if(t){for(var a=0;a<t.length;++a){if(!n.getInitialView()&&t[a].initialView){n.setInitialView(t[a].initialView)}n.camera=n.camera||t[a].camera;var o=t[a].contentResource?t[a].contentResource._shadowContentResource:null;if(t[a].loader){if(o){o.loader=t[a].loader}n.loaders=n.loaders||[];n.loaders.push(t[a].loader)}if(t[a].builder){if(o){o.builder=t[a].builder}n.builders=n.builders||[];n.builders.push(t[a].builder)}}if(t.length>0){var s=t[0];n.backgroundTopColor=s.backgroundTopColor;n.backgroundBottomColor=s.backgroundBottomColor;n.renderMode=s.renderMode;n.upAxis=s.upAxis}}n.getSceneRef().updateMatrixWorld();if(!e){v(n.getSceneRef(),false)}if(n.loaders){i._initSceneWithCDSLoaderIfExists(n,n.loaders)}i.fireContentChangesFinished({content:n})},function(e){r.info("Content loading rejected:",e);var t;if(typeof e==="string"){t=e}else if(e.errorText){t=e.errorText}else if(e.message){t=e.message}t=t||l().getText(d.VIT37.summary);r.error(l().getText("CONTENTMANAGER_MSG_CONTENTRESOURCESFAILEDTOLOAD"),t);i.fireContentChangesFinished({content:null,failureReason:[{error:e,errorMessage:t}]})});return this};h.prototype._findLoader=function(e){if(e._contentManagerResolver&&e._contentManagerResolver.settings&&e._contentManagerResolver.settings.loader){return Promise.resolve(e._contentManagerResolver.settings.loader)}if(e.getSource()){var r=e.getSourceType().toLowerCase();var t=this;switch(r){case"stream":{if(this.defaultCdsLoader==null){return new Promise(function(e){var r="sap/ui/vk/threejs/ContentDeliveryService";sap.ui.require([r],function(r){e(t.defaultCdsLoader=new r({authorizationHandler:t._authorizationHandler}))})})}return Promise.resolve(this.defaultCdsLoader)}case"vds4":{if(this.defaultMataiLoader==null){return new Promise(function(e){var r="sap/ui/vk/matai/MataiLoader";sap.ui.require([r],function(r){e(t.defaultMataiLoader=new r)})})}return Promise.resolve(this.defaultMataiLoader)}default:break}}return Promise.resolve(null)};h.prototype._loadContentResources=function(r,a){function o(e,r){if(typeof r==="string"){return(e||"")+r}return null}function i(e,r){if(!e&&!r){return true}else if(!!e^!!r){return false}else{return e.source===r.getSource()&&e.sourceType===r.getSourceType()}}function s(e,r){r._shadowContentResource=e;var t=e.nodeProxy.getNodeRef();e.name=r.getName();t.name=e.name;e.sourceId=r.getSourceId();t.sourceId=e.sourceId;function a(e,r){if(!e&&!r){return true}var t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];var a=e||t,o=r||t;for(var n=0;n<t.length;++n){if(a[n]!==o[n]){return false}}return true}if(!a(e.localMatrix,r.getLocalMatrix())){e.localMatrix=r.getLocalMatrix();t.matrix.fromArray(n.convertTo4x4(e.localMatrix));t.matrix.decompose(t.position,t.quaternion,t.scale);t.matrixWorldNeedsUpdate=true}}var d=[];var l=new Map;function u(e){var r=o(e.sourceType,e.source);var t=l.get(r);if(!t){t=[];l.set(r,t)}t.push(e);var a=e.nodeProxy.getNodeRef();a.parent.remove(a);e.children.forEach(function(e){u(e)});e.children.length=0}function h(e,a){var o=new f(e);var n=new t.Group;a.add(n);n.matrixWorldNeedsUpdate=true;o.nodeProxy=r.getDefaultNodeHierarchy().createNodeProxy(n);s(o,e);d.push(e);return o}(function r(t,a,o){var n=0;var d=e.sap.arrayDiff(t,a,i,true);d.forEach(function(e){for(;n<e.index;++n){s(t[n],a[n]);r(t[n].children,a[n].getContentResources(),t[n].nodeProxy.getNodeRef())}if(e.type==="delete"){u(t[e.index]);t.splice(e.index,1)}else if(e.type==="insert"){var i=h(a[e.index],o);t.splice(e.index,0,i);r(i.children,a[e.index].getContentResources(),i.nodeProxy.getNodeRef())}++n});for(;n<t.length;++n){s(t[n],a[n]);r(t[n].children,a[n].getContentResources(),t[n].nodeProxy.getNodeRef())}})(this._shadowContentResources,a,r.getSceneRef());var g=[];d.forEach(function(e){var t=e._shadowContentResource.nodeProxy.getNodeRef();var a=o(e.getSourceType(),e.getSource());var n=l.get(a);if(a&&n&&n.length>0){var i=n.pop();var s=i.nodeProxy.getNodeRef();for(var d=0;d<s.children.length;++d){t.add(s.children[d])}if(i.loader){e._shadowContentResource.loader=i.loader}if(i.builder){e._shadowContentResource.builder=i.builder}r.getDefaultNodeHierarchy().destroyNodeProxy(i.nodeProxy);i.nodeProxy=null}else{var u=this;g.push(this._findLoader(e).then(function(r){if(r){if(r.attachContentChangesProgress){r.attachContentChangesProgress(u._handleContentChangesProgress,u)}if(r.attachContentLoadingFinished){r.attachContentLoadingFinished(u._handleContentLoadingFinished,u)}}if(typeof r==="function"){return r(t,e,u._authorizationHandler,u._retryCount)}else if(r&&r.load){return r.load(t,e,u._authorizationHandler,u._retryCount)}else{return Promise.resolve({node:t,contentResource:e})}}))}},this);function p(e){var r=[];var a=[];c.getAllTHREENodes([e],r,a);var o=new Map;var n=new Map;r.forEach(function(e){if(e instanceof t.Mesh){if(!n.has(e.geometry.uuid)){c.disposeGeometry(e);n.set(e.geometry.uuid,true)}if(e.material){if(!o.has(e.material.uuid)){c.disposeMaterial(e.material);o.set(e.material.uuid,true)}}if(e.userData&&e.userData.originalMaterial&&e.userData.originalMaterial.uuid!==e.material.uuid&&!o.has(e.userData.originalMaterial.uuid)){c.disposeMaterial(e.userData.originalMaterial);o.set(e.userData.originalMaterial.uuid,true)}}if(e.parent){e.parent.remove(e)}});a.forEach(function(e){if(e.parent){e.parent.remove(e)}});o.clear();n.clear()}l.forEach(function(e,r){for(var t=0;t<e.length;++t){var a=e[t];p(a.nodeProxy.getNodeRef());if(a.builder){a.builder.cleanup()}if(a.loader){if(a.loader._loader&&a.loader._loader.sceneBuilder){a.loader._loader.removeContext(a.loader._loader.currentSceneInfo.id);a.loader._loader.sceneBuilder.cleanup()}if(a.loader.detachContentChangesProgress){a.loader.detachContentChangesProgress(this._handleContentChangesProgress,this)}if(a.loader.detachContentLoadingFinished){a.loader.detachContentLoadingFinished(this._handleContentLoadingFinished,this)}}}},this);if(a.length===1&&a[0].getName()==null&&a[0].getLocalMatrix()==null){a[0]._shadowContentResource.nodeProxy.getNodeRef().userData.skipIt=true}else{a.forEach(function(e){e._shadowContentResource.nodeProxy.getNodeRef().userData.skipIt=false})}return Promise.all(g)};h.prototype._initSceneWithCDSLoaderIfExists=function(e,r){if(r){var t;for(var a=0;a<r.length;a++){if(r[a]instanceof u){t=r[a].getSceneBuilder();break}}if(t){e.setSceneBuilder(t);e.getDefaultNodeHierarchy().attachNodeRemoving(function(e){var r=e.getParameter("nodeRef");if(r.userData.treeNode&&r.userData.treeNode.sid){t.decrementResourceCountersForDeletedTreeNode(r.userData.treeNode.sid)}});return true}}return false};h.prototype.destroyContent=function(e){if(e){e.destroy();this._shadowContentResources=[];if(e.loaders&&Array.isArray(e.loaders)&&e.loaders.length>0){if(e.loaders[0]._loader&&e.loaders[0]._loader.sceneBuilder){e.loaders[0]._loader.removeContext(e.loaders[0]._loader.currentSceneInfo.id);e.loaders[0]._loader.sceneBuilder.cleanup()}if(e.loaders[0].detachContentChangesProgress){e.loaders[0].detachContentChangesProgress(this._handleContentChangesProgress,this)}if(e.loaders[0].detachContentLoadingFinished){e.loaders[0].detachContentLoadingFinished(this._handleContentLoadingFinished,this)}}else if(e.builders&&Array.isArray(e.builders)){e.builders.forEach(function(e){if(e){e.cleanup()}})}}return this};h.prototype.createOrthographicCamera=function(){return new s};h.prototype.createPerspectiveCamera=function(){return new i};return h});