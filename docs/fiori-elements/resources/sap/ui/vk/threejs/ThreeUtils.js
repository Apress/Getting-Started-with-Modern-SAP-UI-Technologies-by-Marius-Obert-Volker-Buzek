/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","sap/base/Log","./MarchingCubes","../ObjectType"],function(e,r,t,a){"use strict";var i=new Float32Array(1);var n={};n._disposeMaterial=function(e){if(e.map){e.map.dispose()}if(e.lightMap){e.lightMap.dispose()}if(e.bumpMap){e.bumpMap.dispose()}if(e.normalMap){e.normalMap.dispose()}if(e.specularMap){e.specularMap.dispose()}if(e.envMap){e.envMap.dispose()}if(e.alphaMap){e.alphaMap.dispose()}if(e.emissiveMap){e.emissiveMap.dispose()}if(e.aoMap){e.aoMap.dispose()}e.dispose()};n.disposeMaterial=function(e){if(e){n._disposeMaterial(e)}};n.disposeObject=function(r){if(r instanceof e.Mesh||r instanceof e.Line||r instanceof e.Box3Helper){if(r.geometry){r.geometry.dispose()}if(r.material){n._disposeMaterial(r.material)}}};n.disposeGeometry=function(r){if(r instanceof e.Mesh||r instanceof e.Line||r instanceof e.Box3Helper){if(r.geometry){r.geometry.dispose()}}};n.getAllTHREENodes=function(t,a,i){if(!t){return}if(!a||!i){r.error("getAllTHREENodes input parameters - all3DNodes and/or allGroupNodes are undefined.");return}t.forEach(function(r){if(r instanceof e.Mesh){a.push(r)}else if(r instanceof e.Light){a.push(r)}else if(r instanceof e.Camera){a.push(r)}else if(r instanceof e.Box3Helper){a.push(r)}else if(r instanceof e.Group){i.push(r)}if(r.children&&r.children.length>0){n.getAllTHREENodes(r.children,a,i)}})};var o=new e.Vector3;var f=function(e,r){r.makeEmpty();e.updateMatrixWorld(true);e.traverse(function(e){if(e.userData.objectType===a.Hotspot||e.userData.objectType===a.PMI){return}var t;var i;var n=e.geometry;if(n!=null){if(n.isGeometry){var f=n.vertices;for(t=0,i=f.length;t<i;t++){o.copy(f[t]);o.applyMatrix4(e.matrixWorld);r.expandByPoint(o)}}else if(n.isBufferGeometry){var s=n.attributes.position;if(s!=null){var u=e.userData.renderGroup;for(t=u?u.firstVertex:0,i=u?u.lastVertex:s.count;t<i;t++){o.fromBufferAttribute(s,t).applyMatrix4(e.matrixWorld);r.expandByPoint(o)}}}}});return r};n.computeObjectOrientedBoundingBox=function(e,r){var t=e.parent;var a=e.matrix.clone();var i=e.matrixAutoUpdate;e.parent=null;e.matrix.identity();e.matrixAutoUpdate=false;f(e,r);e.matrixAutoUpdate=i;e.matrix.copy(a);e.parent=t;e.updateMatrixWorld(true);return r};n.computeClusterBoundingBoxes=function(r,t,a,i){var n=new Uint8Array(t.buffer);var o,f,s,u,l,p,d,v,c,h;var m;var g=new e.Matrix4;var b=g.elements;var M=new e.Vector3;for(var y=0,x=r.length;y<x;++y){if(i[3+y]===0){continue}var k=new e.Box3;var w=new e.Vector3;m=0;o=r[y].geometry;s=o.userData.renderInstanceCount||1;f=o.instanceIndices;for(h=0;h<2;++h){for(u=0,l=f.length;u<l;++u){p=f[u];for(d=0;d<s;++d){v=p*20;p++;if((n[v*4+3]&1)===1){b[0]=t[v+8];b[4]=t[v+9];b[8]=t[v+10];b[12]=t[v+11];b[1]=t[v+12];b[5]=t[v+13];b[9]=t[v+14];b[13]=t[v+15];b[2]=t[v+16];b[6]=t[v+17];b[10]=t[v+18];b[14]=t[v+19];for(c=0;c<8;++c){M.x=t[v+((c&1)>0?3:2)];M.y=t[v+((c&2)>0?5:4)];M.z=t[v+((c&4)>0?7:6)];M.applyMatrix4(g);if(h>0){m=Math.max(m,w.distanceToSquared(M))}else{k.expandByPoint(M)}}}}}if(h===0){if(k.isEmpty()){o.boundingBox=null;o.boundingSphere=null;break}k.getCenter(w)}else{o.boundingBox=k;o.boundingSphere=new e.Sphere(w,Math.sqrt(m))}}}};n.processUpdatedDataTexture=function(e,r,t){var a=4;var i=a*e.image.width;var n=Math.floor(r/i);var o=Math.ceil(t/i);var f=o-n;var s=0;var u=e.image.width;var l=n*i;if(f===1){s=Math.floor((r-i*n)/a);l+=s*a;u=Math.ceil((t-l)/a)}e.userData.textureUpdateParams={xOffset:s,yOffset:n,width:u,height:f,dataOffset:l};e.needsUpdate=true};n.prepareTextureUpdateResults=function(e,r){var t=3+e;if(!r){var a=new Uint32Array(t);a[0]=4294967295;return a}if(r.length>=t){return r}var i=new Uint32Array(t);i.set(r);return i};function s(e,r,t,a,i){for(var n=0,o=t.instanceIndex*20;n<i;++n,++o){if(e[o]!=a[n]){e[o]=a[n];r[3+t.clusterIndex]=1;if(o<r[0]){r[0]=o}if(o>r[1]){r[1]=o}}}}function u(e,r,t,a){var i=e.userData.renderGroup;if(i){s(t,a,i,r,1)}var n=e.children;for(var o=0,f=n.length;o<f;o++){u(n[o],r,t,a)}}n.removeNodeFromClusterRenderingRecursive=function(e,r,t){u(e,i,r,t)};n.updateTextureDataForNode=function(e,r,t,a){var i=e.userData;var n=i.renderGroup;if(n){if(n.instanceIndex===null){i.skipDuringClusterRendering=true;a[2]=1}else if(t){var o=new Uint8Array(r.buffer);o[0]=0;o[1]=0;o[2]=0;if(i.initialMaterialId!==i.materialId||i.highlightingColor||i.defaultMaterial||e.material.transparent===true){o[3]=2;i.skipDuringClusterRendering=true;a[2]=1}else if(i.highlightColor||i.tintColor){var f=e.material.emissive;var u=e.material.specular;if(f.r===.0235&&f.g===.0235&&f.b===.0235&&u.r===.0602&&u.g===.0602&&u.b===.0602){f=e.material.color;o[0]=255*f.r;o[1]=255*f.g;o[2]=255*f.b;o[3]=3;delete i.skipDuringClusterRendering}else{o[3]=2;i.skipDuringClusterRendering=true;a[2]=1}}else{o[3]=1;delete i.skipDuringClusterRendering}r[1]=0;var l=n.boundingBox;r[2]=l[0];r[3]=l[3];r[4]=l[1];r[5]=l[4];r[6]=l[2];r[7]=l[5];var p=e.matrixWorld.elements;r[8]=p[0];r[9]=p[4];r[10]=p[8];r[11]=p[12];r[12]=p[1];r[13]=p[5];r[14]=p[9];r[15]=p[13];r[16]=p[2];r[17]=p[6];r[18]=p[10];r[19]=p[14];s(t,a,n,r,20)}}else if(e.isMesh||e.isLine){a[2]=1}};function l(e,r,t,a,i,n,o,f,s){if(n===o){r[i*s*s+a*s+t]=1}if(n<o){var u=e[f[0]];f[0]++;t*=2;a*=2;i*=2;var p,d,v;for(v=0;v<2;++v){for(d=0;d<2;++d){for(p=0;p<2;++p){if((u&1<<v*4+d*2+p)!==0){l(e,r,t+p,a+d,i+v,n+1,o,f,s)}}}}}}function p(e,r){var t,a,i,n;var o=r*r;var f=true;var s;while(f){f=false;s=0;for(i=0;i<r;++i){for(a=0;a<r;++a){for(t=0;t<r;++t){if(e[i*o+a*r+t]>0){t++;for(n=r-1;n>t;--n){if(e[i*o+a*r+n]>0){for(;t<n;++t){if(e[i*o+a*r+t]===0){e[i*o+a*r+t]=1;f=true}}break}}s++;break}}}}for(i=0;i<r;++i){for(t=0;t<r;++t){for(a=0;a<r;++a){if(e[i*o+a*r+t]>0){a++;for(n=r-1;n>a;--n){if(e[i*o+n*r+t]>0){for(;a<n;++a){if(e[i*o+a*r+t]===0){e[i*o+a*r+t]=1;f=true}}break}}s++;break}}}}for(a=0;a<r;++a){for(t=0;t<r;++t){for(i=0;i<r;++i){if(e[i*o+a*r+t]>0){i++;for(n=r-1;n>i;--n){if(e[n*o+a*r+t]>0){for(;i<n;++i){if(e[i*o+a*r+t]===0){e[i*o+a*r+t]=1;f=true}}break}}s++;break}}}}}return s*2}function d(e,r,t,a){var i=r*4;var n,o,f,s;switch(e){case 0:n=[t[0],t[1],t[5],t[3],t[1],t[5],t[0],t[4],t[5],t[3],t[4],t[5]];o=0;f=0;s=1;break;case 1:n=[t[0],t[1],t[2],t[0],t[4],t[2],t[3],t[1],t[2],t[3],t[4],t[2]];o=0;f=0;s=-1;break;case 2:n=[t[0],t[4],t[5],t[3],t[4],t[5],t[0],t[4],t[2],t[3],t[4],t[2]];o=0;f=1;s=0;break;case 3:n=[t[0],t[1],t[5],t[0],t[1],t[2],t[3],t[1],t[5],t[3],t[1],t[2]];o=0;f=-1;s=0;break;case 4:n=[t[3],t[1],t[5],t[3],t[1],t[2],t[3],t[4],t[5],t[3],t[4],t[2]];o=1;f=0;s=0;break;default:n=[t[0],t[1],t[5],t[0],t[4],t[5],t[0],t[1],t[2],t[0],t[4],t[2]];o=-1;f=0;s=0;break}a.points.set(n,i*3);if(a.normals!==undefined){a.normals.set([o,f,s,o,f,s,o,f,s,o,f,s],i*3)}a.indices.set([i+0,i+1,i+2,i+2,i+1,i+3],r*6)}function v(e,r,t,a,i,n){e[0]=i[0]+r*n[0];e[1]=i[1]+t*n[1];e[2]=i[2]+a*n[2];e[3]=e[0]+n[0];e[4]=e[1]+n[1];e[5]=e[2]+n[2]}function c(e,r,t,a,i,n){var o,f,s,u;var l=r*t;var p=0;var c=[(i[3]-i[0])/r,(i[4]-i[1])/t,(i[5]-i[2])/a];var h=[0,0,0,0,0,0];for(s=0;s<a;++s){for(f=0;f<t;++f){for(o=0;o<r;++o){if(e[s*l+f*r+o]>0){v(h,o,f,s,i,c);d(5,p,h,n);p++;for(u=r-1;u>=o;--u){if(e[s*l+f*r+u]>0){v(h,u,f,s,i,c);d(4,p,h,n);p++;break}}break}}}}for(s=0;s<a;++s){for(o=0;o<r;++o){for(f=0;f<t;++f){if(e[s*l+f*r+o]>0){v(h,o,f,s,i,c);d(3,p,h,n);p++;for(u=t-1;u>=f;--u){if(e[s*l+u*r+o]>0){v(h,o,u,s,i,c);d(2,p,h,n);p++;break}}break}}}}for(f=0;f<t;++f){for(o=0;o<r;++o){for(s=0;s<a;++s){if(e[s*l+f*r+o]>0){v(h,o,f,s,i,c);d(1,p,h,n);p++;for(u=a-1;u>=s;--u){if(e[u*l+f*r+o]>0){v(h,o,f,u,i,c);d(0,p,h,n);p++;break}}break}}}}return p*4}function h(e,r,t,a,i,n){var o;if(n>0){o=false}else if(n<0){o=true}else{o=r>a||t>i}var f=o?r:a;var s=o?t:i;e.points=new Float32Array(f*3);e.indices=new Uint16Array(s*3);if(e.normals!==undefined){e.normals=new Float32Array(f*3)}if(e.uvs!==undefined){e.uvs=new Float32Array(f*2)}}function m(e,r,t,a){var i=t[0]<=2?Infinity:(a[3]-a[0])/t[0];var n=t[1]<=2?Infinity:(a[4]-a[1])/t[1];var o=t[2]<=2?Infinity:(a[5]-a[2])/t[2];var f=-1;if(i<=n&&i<=o){if(i!==Infinity){f=0}}else if(n<=i&&n<=o){if(n!==Infinity){f=1}}else if(o<=i&&o<=n){if(o!==Infinity){f=2}}if(f<0){return 0}i=t[0];n=t[1];o=t[2];var s=i*n;var u=i,l=n,p=o;var d=u*l;var v,c,h;if(f===0){t[0]=t[0]>>1;u=t[0];d=u*l;for(h=0;h<o;++h){for(c=0;c<n;++c){for(v=0;v<i;++v){r[h*d+c*u+v]=e[h*s+c*i+v*2]|e[h*s+c*i+v*2+1]}}}}if(f===1){t[1]=t[1]>>1;l=t[1];d=u*l;for(h=0;h<o;++h){for(c=0;c<n;++c){for(v=0;v<i;++v){r[h*d+c*u+v]=e[h*s+c*2*i+v]|e[h*s+(c*2+1)*i+v]}}}}if(f===2){t[2]=t[2]>>1;p=t[2];d=u*l;for(h=0;h<o;++h){for(c=0;c<n;++c){for(v=0;v<i;++v){r[h*d+c*u+v]=e[h*2*s+c*i+v]|e[(h*2+1)*s+c*i+v]}}}}var m=0;for(h=0;h<p;++h){for(c=0;c<l;++c){for(v=0;v<u;++v){if(r[h*d+c*u+v]>0){m++;break}}}}for(h=0;h<p;++h){for(v=0;v<u;++v){for(c=0;c<l;++c){if(r[h*d+c*u+v]>0){m++;break}}}}for(c=0;c<l;++c){for(v=0;v<u;++v){for(h=0;h<p;++h){if(r[h*d+c*u+v]>0){m++;break}}}}return m*2}n.buildTemporaryMesh=function(e,r,a,i,n,o,f){var s=f<=0;var u={points:null,normals:(r&3)>0?null:undefined,uvs:(r&4)>0?null:undefined,indices:null};var v=0;var g=0;var b=!n||o?0:n[0];if(!s&&(a<384||i<192)){b=0}var M=null;var y=0;if(b>0){M=new Uint8Array(Math.pow(Math.pow(2,b),3));y=Math.pow(2,b);var x=new Uint32Array(2);x[0]=1;l(n,M,0,0,0,0,b,x,y);var k=3*t.count(M,y);var w=Math.min(a,i);if(!s&&k>w){g=p(M,y);k=3*t.count(M,y)}if(s||k<=w){h(u,k,k,a,i,f);t.march(M,y,e,u.points,u.normals,u.indices);v=k}}if(v===0&&y>=2){var A=Math.floor(Math.min(a/4,i/2));if(s){A=g}var C=new Uint8Array(y*y*y/2);var I=[y,y,y];var U=false;var B=0;for(;;){if(g<=A){h(u,g*4,g*2,a,i,f);v=c(U?C:M,I[0],I[1],I[2],e,u);break}g=B===4?0:m(U?C:M,U?M:C,I,e);if(!g){break}U=!U;B++}}if(v===0){h(u,24,12,a,i,f);for(;v<6;++v){d(v,v,e,u)}v=24}var D=u.points;for(var R=v,T=D.length/3;R<T;++R){D[R*3]=D[0];D[R*3+1]=D[1];D[R*3+2]=D[2]}return u};n.updateClusterAttrib=function(e,r,t,a){var i=e.getAttribute(r);i.array.set(a,t);var n=i.updateRange;if(n.count<0){n.offset=t;n.count=a.length}else{n.count+=n.offset;n.offset=Math.min(n.offset,t);n.count=Math.max(n.count,t+a.length)-n.offset}i.needsUpdate=true};n.updateClusterIndices=function(e,r,t,a,i){var n=e.getIndex();var o=n.updateRange;if(o.count<0){o.offset=a;o.count=i}else{o.count+=o.offset;o.offset=Math.min(o.offset,a);o.count=Math.max(o.count,a+i)-o.offset}n.needsUpdate=true;var f=n.array;for(var s=0;s<i;++s){f[a+s]=t+r[s]}};n.updateClusterGeometry=function(e,r,t,a,i){if(r.length!==e.vertexCount*3||i.length!==e.indexCount){return false}var o=e.geometry;var f=e.vertexStart;n.updateClusterAttrib(o,"position",f*3,r);if(t&&t.length){n.updateClusterAttrib(o,"normal",f*3,t)}if(a&&a.length){n.updateClusterAttrib(o,"uv",f*2,a)}n.updateClusterIndices(o,i,f,e.indexStart,e.indexCount);return true};return n});